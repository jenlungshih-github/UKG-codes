/**************************************************************************************Created:	03/2025Created by:	John KingseppPurpose:	Used to return the Business structure elements			for UKG			The function returns the code and description			for each Business Structure element.  Only one of those values is passed 			node.			Special charaters as defined by UKG need to be replaced			The fields that are used for the UKG Business Structure 			o Level1 -- Organization			o Level2 -- EntityTitle			o Level3 -- ServiceLineTitle			o Level4 -- FinancialUnit			o Level5 -- FundGroup* -- 7/15/2025   Jim Shih: change from dbo to hts.  I need to test this SP in [dbo].UKG_EMPLOYEE_DATA_BUILD* -- 10/23/2025  Jim Shih: join the table from linked server health_ODS.[Health_ODS].[hcm_ods].PS_ACCT_CD_TBL**************************************************************************************/CREATE PROCEDURE [hts].[UKG_BusinessStructure_UPD]ASBEGINSET NOCOUNT ON	DECLARE @BusinessStructure TABLE (		combocode VARCHAR(9)		,Organization VARCHAR(50)		,OrganizationTitle VARCHAR(50)		,Entity VARCHAR(5)		,EntityTitle VARCHAR(250)		,ServiceLine VARCHAR(50)		,ServiceLineTitle VARCHAR(250)		,FinancialUnit VARCHAR(10)		,FinancialUnitTitle VARCHAR(250)		,FundGroup VARCHAR(10)		,FundGroupTitle VARCHAR(250)		,FundGroupTitle_Strata VARCHAR(250)		,fund VARCHAR(6)		,location VARCHAR(100)		,DepartmentRollup4ID VARCHAR(100)		)	INSERT INTO @BusinessStructure (		combocode		,Organization		,OrganizationTitle		,Entity		,EntityTitle		,ServiceLine		,ServiceLineTitle		,FinancialUnit		,FinancialUnitTitle		,FundGroup		,FundGroupTitle		,fund		,location		)	--,fund	--,location 	SELECT right('000000000' + cast(t.combocode AS VARCHAR(9)), 9) [ComboCode]		,CASE 			WHEN e.entityid IS NOT NULL				THEN 'UCSDH'			ELSE 'Non-Health'			END Organization		,CASE 			WHEN e.entityid IS NOT NULL				THEN 'UCSD Health'			ELSE 'Non-Health'			END OrganizationTitle		,a.operating_unit Entity		,CASE 			WHEN e.entityTitle IS NOT NULL				THEN e.entityTitle			ELSE oe.entityTitle			END EntityTitle		--,CASE 		--	WHEN a.operating_unit = '16130'		--		THEN deptid_cf		--	ELSE '-'		--	END ServiceLine		,CASE 			WHEN a.operating_unit = '16130'				THEN 'Health Science Miscellaneous'			ELSE 'Default'			END ServiceLine		,CASE 			WHEN a.operating_unit = '16130'				THEN 'Health Science Miscellaneous'			ELSE 'Default'			END ServiceLineTitle		,a.deptid_cf FinanacialUnit		,replace(ofu.depttitle,'/','-')  FinancialUnitTitle		,[FundGroup]		,replace(FundGroupTitle, '/', '-') FundGroupTitle		,a.fund_code		,CASE 			WHEN OPERATING_UNIT = '16143'				AND isnull(chartfield3, ' ') = ' '				THEN '000000'			ELSE chartfield3			END location	FROM hts.[UKG_ComboCodeFundGroup] t	LEFT OUTER JOIN health_ODS.[Health_ODS].[hcm_ods].PS_ACCT_CD_TBL a ON right('000000000' + cast(t.combocode AS VARCHAR(9)), 9) = a.ACCT_CD	INNER JOIN hts.UKG_ODSEntity oe ON oe.entity = a.operating_unit	LEFT JOIN hts.[UKG_EntityTitleOverrides] e ON e.entityid = a.operating_unit	LEFT JOIN hts.UKG_ODSFinancialUnits ofu ON ofu.deptid = a.deptid_cf	where cast(getdate() as date) between t.effectivestartdate and t.effectiveenddate	-- Add Service Lines	-- Health	-- Medical Center	UPDATE b	SET b.serviceline = s.financialunit		,b.servicelinetitle = replace(s.serviceline, '/', '-')	FROM @BusinessStructure b	INNER JOIN hts.[UKG_ServiceLines_MedicalCenter] s ON s.financialunit = b.financialunit	WHERE b.entity = '16242'	-- PHSO	UPDATE b	SET b.serviceline = s.financialunit		,b.servicelinetitle = replace(s.serviceline, '/', '-')	FROM @BusinessStructure b	INNER JOIN hts.[UKG_ServiceLines_PHSO] s ON s.financialunit = b.financialunit	WHERE b.entity = '16144'	-- Health Science	UPDATE b	SET b.serviceline = s.financialunit		,b.servicelinetitle = replace(s.serviceline, '/', '-')	FROM @BusinessStructure b	INNER JOIN hts.[UKG_ServiceLines_HealthSciences] s ON s.financialunit = b.financialunit	WHERE b.entity = '16130'	-- Health Pysician Group	UPDATE b	SET b.serviceline = s.fund		,b.servicelinetitle = replace(s.serviceline, '/', '-')	FROM @BusinessStructure b	INNER JOIN hts.[UKG_ServiceLines_PhysiciansGroup] s ON s.fund = b.fund	--and s.financialunit  = b.financialunit	WHERE b.entity = '16143'	-- Health Pysician Group	--	update b set b.DepartmentRollup4ID = s.DepartmentRollup4ID from 	--@BusinessStructure b inner join [StrataData] s on s.fund = b.fund	--and s.financialunit  = b.financialunit --and b.location = s.location	--where b.entity = '16143' and s.DepartmentRollup4ID <> 'Not Specified'	--add Timesheet groups titles from strata	UPDATE b	SET b.FundGrouptitle_strata = replace(s.description, '/', '-')	FROM @BusinessStructure b	INNER JOIN hts.[UKG_StrataData] s ON s.fund = b.fund		AND s.financialunit = b.financialunit		AND b.location = s.location	WHERE b.entity = '16143'	UPDATE b	SET b.FundGrouptitle_strata = s.description	FROM @BusinessStructure b	INNER JOIN hts.[UKG_StrataData] s ON s.financialunit = b.financialunit	WHERE b.entity IN (			'16144'			,'16242'			)	IF (			SELECT count('x')			FROM @BusinessStructure			) > 0	BEGIN		DELETE		FROM hts.UKG_BusinessStructure		INSERT INTO hts.UKG_BusinessStructure (			combocode			,Organization			,OrganizationTitle			,Entity			,EntityTitle			,ServiceLine			,ServiceLineTitle			,FinancialUnit			,FinancialUnitTitle			,FundGroup			,FundGroupTitle			,fund			,location			)		SELECT combocode			,Organization			,OrganizationTitle			,Entity			,EntityTitle			,ServiceLine			,ServiceLineTitle			,FinancialUnit			,FinancialUnitTitle			,FundGroup			,FundGroupTitle			,fund			,location		FROM @BusinessStructure	ENDEND

