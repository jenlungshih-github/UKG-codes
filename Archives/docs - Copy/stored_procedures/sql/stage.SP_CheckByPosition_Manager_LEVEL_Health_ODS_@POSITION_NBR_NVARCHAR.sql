    -- 1. POSITION STATUS AND DEPARTMENT VALIDATION    -- ============================================================================================    -- Check POSN_STATUS (should be 'A' for Active) and deptid in STABLE.PS_POSITION_DATA    -- This validates that the position exists and is currently active    INSERT INTO @messages        (message_text)    VALUES        ('1. Checking POSN_STATUS (should be A for Active) and deptid in STABLE.PS_POSITION_DATA');    -- Display the current check message    SELECT message_id, message_text    FROM @messages    WHERE message_id = 1;    -- Query position data, showing most recent records first    SELECT        POSN_STATUS,        deptid,        POSITION_NBR,        EFFDT,        DML_IND    FROM health_ods.[health_ods].stable.PS_POSITION_DATA    WHERE POSITION_NBR = @POSITION_NBR        AND dml_ind <> 'D'    -- Exclude deleted records    ORDER BY effdt DESC;    -- ============================================================================================    -- 2. DEPARTMENT BUDGET VALIDATION    -- ============================================================================================    -- Check deptid and budget information in PS_DEPT_BUDGET_ERN    -- This ensures the position has proper budget allocation    INSERT INTO @messages        (message_text)    VALUES        ('2. Checking deptid and budget information in health_ods.[health_ods].stable.PS_DEPT_BUDGET_ERN');    SELECT message_id, message_text    FROM @messages    WHERE message_id = 2;    -- Query budget data, ordered by fiscal year and effective date    SELECT        deptid,        POSITION_NBR,        FISCAL_YEAR,        EFFDT,        EFFSEQ,        BUDGET_SEQ,        DML_IND    FROM health_ods.[health_ods].stable.PS_DEPT_BUDGET_ERN    WHERE POSITION_NBR = @POSITION_NBR        AND dml_ind <> 'D'    -- Exclude deleted records    ORDER BY fiscal_year DESC, effdt DESC, effseq DESC, BUDGET_SEQ DESC;    -- ============================================================================================    -- 3. FINANCIAL UNIT VALIDATION    -- ============================================================================================    -- Check FDM_COMBO_CD (UCPath combination code) and FUND_CODE in CURRENT_POSITION_PRI_FIN_UNIT    -- This validates the financial structure mapping for the position    INSERT INTO @messages        (message_text)    VALUES        ('3. Checking FDM_COMBO_CD (UCPath combo code) and FUND_CODE in [RPT].[CURRENT_POSITION_PRI_FIN_UNIT]');    SELECT message_id, message_text    FROM @messages    WHERE message_id = 3;    -- Query financial unit data    SELECT        POSITION_NBR,        FDM_COMBO_CD,        FISCAL_YEAR,		dist_Pct,		FUND_CODE,        deptid,        DEPTID_CF,        DEPTID_CF_DESCR    FROM health_ods.[health_ods].[RPT].[CURRENT_POSITION_PRI_FIN_UNIT]    WHERE POSITION_NBR = @POSITION_NBR;    -- ============================================================================================    -- 4. BUSINESS STRUCTURE MAPPING VALIDATION    -- ============================================================================================    -- Check if UCPath COMBOCODE maps correctly to UKG Business Structure    -- This is critical for UKG employee data processing - missing mappings will cause employees to be filtered out    INSERT INTO @messages        (message_text)    VALUES        ('4. Checking UKG Business Structure mapping: UKG_BS.COMBOCODE = FIN.FDM_COMBO_CD');    SELECT message_id, message_text    FROM @messages    WHERE message_id = 4;    -- Query the business structure mapping    SELECT        FIN.POSITION_NBR,        FIN.FDM_COMBO_CD as UCPath_COMBOCODE,        UKG_BS.COMBOCODE as UKG_BusinessStructure_COMBOCODE,        UKG_BS.Organization,        UKG_BS.EntityTitle,        UKG_BS.ServiceLineTitle,        UKG_BS.FinancialUnit,        UKG_BS.FundGroup    FROM health_ods.[health_ods].[RPT].[CURRENT_POSITION_PRI_FIN_UNIT] FIN        LEFT JOIN [hts].[UKG_BusinessStructure] UKG_BS        ON UKG_BS.COMBOCODE = FIN.FDM_COMBO_CD    WHERE FIN.POSITION_NBR = @POSITION_NBR;    -- ============================================================================================    -- SUMMARY    -- ============================================================================================    -- Return all informational messages for reference    SELECT        message_id,        message_text    FROM @messages    ORDER BY message_id;END;-- ====================================================CREATE     PROCEDURE [stage].[SP_CheckByPosition_Manager_LEVEL_Health_ODS]    @POSITION_NBR NVARCHAR(10)AS-- Example usage:-- EXEC [stage].[SP_CheckByPosition_Manager_LEVEL_Health_ODS] @POSITION_NBR = '40749496';BEGIN    SET NOCOUNT ON;    -- Create a table variable to store messages    DECLARE @messages TABLE (        message_id INT IDENTITY(1,1),        message_text VARCHAR(MAX)    );---------------------------------------- Message template    -- 1. Investigate [POSITION_REPORTS_TO] is not null but MANAGER_EMPLID is NULL	-- Insert message    INSERT INTO @messages        (message_text)    VALUES        ('1. Investigate [POSITION_REPORTS_TO] is not null but MANAGER_EMPLID is NULL');    SELECT        message_id,        message_text    FROM @messages    where message_id=1;   --Insert Script belowWITH    PositionData    AS    (        SELECT            POSN_STATUS,            deptid,            POSITION_NBR,            EFFDT,            DML_IND,            ROW_NUMBER() OVER (PARTITION BY POSITION_NBR ORDER BY effdt DESC) as RN        FROM health_ods.[health_ods].stable.PS_POSITION_DATA        WHERE dml_ind <> 'D'    )SELECT DISTINCT top 1    imgr.[Inactive_EMPLID_To_Check],    imgr.[POSITION_NBR_To_Check],    empl.MANAGER_EMPLID,    empl.MANAGER_NAME,    empl.[POSITION_REPORTS_TO],    pd.POSN_STATUS,    pd.deptid as POSITION_DEPTID,    pd.EFFDT as POSITION_EFFDTFROM health_ods.[health_ods].[RPT].[CURRENT_EMPL_DATA] empl    INNER JOIN [stage].[UKG_EMPL_Inactive_Manager] imgr    ON empl.emplid = imgr.[Inactive_EMPLID_To_Check]        and empl.POSITION_NBR=imgr.[POSITION_NBR_To_Check]    LEFT JOIN PositionData pd    ON pd.POSITION_NBR = empl.[POSITION_REPORTS_TO]        AND pd.RN = 1where empl.MANAGER_EMPLID is NULLand empl.[POSITION_REPORTS_TO]=@POSITION_NBR;    -- 2. Check POSN_STATUS, deptid in STABLE.PS_POSITION_DATA 	-- Insert message    INSERT INTO @messages        (message_text)    VALUES        ('2. Checking POSN_STATUS (should be A) and deptid in STABLE.PS_POSITION_DATA');    SELECT        message_id,        message_text    FROM @messages    where message_id=2;   --Insert Script below    SELECT TOP 1        POSN_STATUS,        deptid,        POSITION_NBR,        EFFDT,        DML_IND    FROM health_ods.[health_ods].stable.PS_POSITION_DATA    WHERE POSITION_NBR = @POSITION_NBR        AND dml_ind <> 'D'    ORDER BY effdt DESC;    -- 3. Check from health_ods.[health_ods].[RPT].[CURRENT_EMPL_DATA] m	-- Insert message    INSERT INTO @messages        (message_text)    VALUES        ('3. Check from health_ods.[health_ods].[RPT].[CURRENT_EMPL_DATA]');    SELECT        message_id,        message_text    FROM @messages    where message_id=3;   --Insert Script belowSELECT emplid,NAME,HR_STATUS,POSITION_NBR,MANAGER_EMPLID ,[POSITION_REPORTS_TO]FROM health_ods.[health_ods].[RPT].[CURRENT_EMPL_DATA] mWHERE POSITION_NBR = @POSITION_NBR;    -- Return collected messages at the end    SELECT        message_id,        message_text    FROM @messages    ORDER BY message_id;END;

