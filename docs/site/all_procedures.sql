-- ===== dbo.UKG_EMPLOYEE_DATA_BUILD =====

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
/***************************************
                                                                                                                                                                                                                     
* Created By: May Xu	
                                                                                                                                                                                                                                        
* Table: This SP creates table [dbo].[UKG_EMPLOYEE_DATA]	to upload the employee data file to UKG
                                                                                                                                                             
* EXEC 	[dbo].UKG_EMPLOYEE_DATA_BUILD	
                                                                                                                                                                                                                       
* Performance Optimizations (9/16/2025):
                                                                                                                                                                                                                     
* - Added indexes to all temporary tables on JOIN key columns
                                                                                                                                                                                                
* - Replaced correlated subquery with direct JOIN for POSITION_NBR filtering
                                                                                                                                                                                 
* - Added index on final table for UPDATE operation
                                                                                                                                                                                                          
* - Improved query execution time significantly
                                                                                                                                                                                                              
* -- 04/04/2025 May Xu: Created
                                                                                                                                                                                                                              
* -- 04/21/2025 May Xu:Added default value 'Blank' for required fields
                                                                                                                                                                                       
* -- 04/23 2025 May Xu:Vacant manager level only go up to level 5
                                                                                                                                                                                            
* -- 05/02/2025 May Xu: added Custom Field 14	and Custom Field 15
                                                                                                                                                                                            
* -- 05/05/2025 May Xu: Changed to only add the non-ukg manager's primary job ; 
                                                                                                                                                                             
* -- 06/09/2025 Jim Shih: Replace the following,
                                                                                                                                                                                                             
		--ISNULL(EMPL.HR_STATUS, '') AS 'Employment Status', 
                                                                                                                                                                                                      
		ISNULL(EMPL.empl_Status, '') AS 'Employment Status', -- Replace EMPL.HR_STATUS with EMPL.empl_Status
                                                                                                                                                       
        --CASE WHEN NON_UKG_MANAGER_FLAG = 'T' THEN '' ELSE empl.EMPL_STATUS END AS 'Custom Field 5',
                                                                                                                                                        
		ISNULL(EMPL.HR_STATUS, '') AS 'Custom Field 5',
                                                                                                                                                                                                            
		--''  AS 'Custom Date 4',
                                                                                                                                                                                                                                  
		ISNULL(CAST(EMPL.EFFDT AS VARCHAR), '') AS 'Custom Date 4',
                                                                                                                                                                                                
*-- 06/09/2025 Jim Shih: Change the logic of Employee Classification
                                                                                                                                                                                         
        CASE WHEN NON_UKG_MANAGER_FLAG = 'T' THEN ''
                                                                                                                                                                                                         
		     WHEN EMPL.FLSA_STATUS = 'V' THEN 'N' 		     
                                                                                                                                                                                                          
			 ELSE EMPL.FLSA_STATUS END  AS 'Employee Classification',  			 
                                                                                                                                                                                           
*-- 06/09/2025 Jim Shih: Update [Custom Field 17] in [dbo].[UKG_EMPLOYEE_DATA]
                                                                                                                                                                               
      UPDATE [dbo].[UKG_EMPLOYEE_DATA]
                                                                                                                                                                                                                       
      SET [Custom Field 17] = B.differncds
                                                                                                                                                                                                                   
      FROM [dbo].[UKG_EMPLOYEE_DATA] T
                                                                                                                                                                                                                       
      INNER JOIN [stage].[UKG_tsr_differncds_V] B
                                                                                                                                                                                                            
      ON T.emplid = B.emplid AND T.jobcode = B.jobcode;	
                                                                                                                                                                                                     
*-- 06/10/2025 Jim Shih: ISNULL(CAST(UKG_ES.EFFDT AS VARCHAR), '')  AS 'Employment Status Effective Date',   -- Replace EMPL.EFFDT with UKG_ES.EFFDT  
                                                                                                       
*-- 06/18/2025 Jim Shih: Per JK, change the heading for the Fund Group from Home Business Structure Level 5 - TSG to Home Business Structure Level 5 - Fund Group	
                                                                                           
*-- 07/07/2025 Jim Shih: Custom Date Field 1 is the Probation Date and if the probation date is not found it should be filled with the hire date			
                                                                                                          
*-- 07/11/2025 May Xu: add code to create a snapshot of the view [UKG_EMPLOYEE_DATA_V] and drop any 30 days old snapshot
                                                                                                                                     
*-- 07/14/2025 Jim Shih
                                                                                                                                                                                                                                      
*-- migrate from hs-ssisp-v
                                                                                                                                                                                                                                  
*-- change SELECT  * INTO HealthTime.[STAGE].[' +  @SNAPSHOT_TABLENAME + ']' + ' FROM stage.UKG_EMPLOYEE_DATA_V' 
                                                                                                                                            
*-- to SELECT  * INTO [BCK].[' +  @SNAPSHOT_TABLENAME + ']' + ' FROM dbo.UKG_EMPLOYEE_DATA_V'
                                                                                                                                                                
*-- 07/15/2025 Jim Shih: change dbo.[BUSINESSSTRUCTURE_GET] () to [hts].[UKG_BusinessStructure]
                                                                                                                                                              
*-- 07/26/2025 Jim Shih: add troubleshooting worker type comments
                                                                                                                                                                                            
*-- 07/31/2025 Jim Shih:
                                                                                                                                                                                                                                     
*-- uncomment
                                                                                                                                                                                                                                                
*--		     WHEN  EMPL.EMPL_CLASS != 6 AND ((EMPL.HR_STATUS = 'I' AND EMPL.FTE >= 1) OR (EMPL.HR_STATUS = 'A' AND UKG_FTE.FTE_SUM >= 1))  THEN 'FT'
                                                                                                            
*--			 WHEN  EMPL.EMPL_CLASS != 6 AND ((EMPL.HR_STATUS = 'I' AND EMPL.FTE < 1) OR (EMPL.HR_STATUS = 'A' AND UKG_FTE.FTE_SUM < 1))  THEN 'PT'
                                                                                                                 
*-- 08/04/2025   Jim Shih: add DROP TABLE IF EXISTS
                                                                                                                                                                                                          
*-- SELECT 
                                                                                                                                                                                                                                                  
    @SQL_CREATE =  
                                                                                                                                                                                                                                          
        N'DROP TABLE IF EXISTS bck.[' + @SNAPSHOT_TABLENAME + ']; ' +
                                                                                                                                                                                        
        N'SELECT * INTO bck.[' + @SNAPSHOT_TABLENAME + '] FROM dbo.UKG_EMPLOYEE_DATA_V';
                                                                                                                                                                     
* -- 08/13/2025 Jim Shih: Per TSR-148, Exempt employees that had a SAL_ADMIN_PLAN of BYA that should not be included.
                                                                                                                                        
* --                      add filter in ps_job -- and (H.SAL_ADMIN_PLAN <> 'BYA' OR H.FLSA_STATUS <> 'E')
                                                                                                                                                    
* -- 08/14/2025 Jim Shih: Per JK, Add Business unit as the value of Custom Field 7 in Personal Import
                                                                                                                                                        
* -- 08/22/2025 Jim Shih: Per JK, Please exclude all BYA employees, regardless of FLSACode
                                                                                                                                                                   
* -- 08/25/2025 Jim Shih: Add CTE_exclude_BYA to identify BYA employees for exclusion
                                                                                                                                                                        
* -- 08/26/2025 Jim Shih: 
                                                                                                                                                                                                                                   
* -- Per JK, If they are a non-health reportsto then we should
                                                                                                                                                                                               
* -- create one person record for them.  As a non-employee the job information is not important.  We should include any job indicator value but only
                                                                                                         
* -- return one row per employee
                                                                                                                                                                                                                             
* -- 09/03/2025 Jim Shih: 
                                                                                                                                                                                                                                   
*--  Per JK, Employment Status Effective Date should be The effdt for the job record where the status first appears after a status change or upon new hire. Also apply this logic to the HR Status Date (Custom Date 4)
                                      
* -- 09/15/2025 Jim Shih: add termination_dt
                                                                                                                                                                                                                 
* -- 10/08/2025 Jim Shih: add action, and action_dt
                                                                                                                                                                                                          
* -- 12/01/2025 Jim Shih: replace [stage].[UKG_tsr_differncds_V] with [hts].[UKG_differncds]
                                                                                                                                                                 
* -- 12/02/2025 Jim Shih: replace [hts].[UKG_differncds] with hts.UKG_DifferentialEligibilityCodes
                                                                                                                                                           
* -- 12/02/2025 Jim Shih: Performance Optimizations - Added comprehensive indexing strategy:
                                                                                                                                                                 
*                         - Added indexes to all temporary tables (STAGE.CTE_exclude_BYA, UKG_EMPL_E_T, UKG_EMPL_M_T, UKG_EMPL_T)
                                                                                                                            
*                         - Enhanced indexing for lookup tables (UKG_COMBOCD_T, UKG_EMPL_FTE_T, UKG_EMPL_HRATE_EFFDT_T)
                                                                                                                                      
*                         - Added indexes to UKG_EMPLOYEE_DATA_TEMP for final processing operations
                                                                                                                                                          
*                         - Added indexes to [dbo].[NON_UKG_MANAGER_HISTORY] for exclusion lookups
                                                                                                                                                           
*                         - Total of 20+ new indexes to optimize JOIN and WHERE operations
                                                                                                                                                                   
* -- 12/07/2025 Jim Shih: Enhanced Custom Field 17 logic to set 'XXX' for NULL or blank values
                                                                                                                                                               
* -- 12/09/2025 Jim Shih: Added CTE check_jobcode to set Custom Field 17 to 'XXX' when setid = 'SDMED'
                                                                                                                                                       
*                         - Added check_jobcode CTE joining UKG_DifferentialEligibilityCodes with PS_UC_SHFT_ONC_ERN
                                                                                                                                         
*                         - Enhanced Custom Field 17 UPDATE logic with conditional CASE statement
                                                                                                                                                            
*                         - Refined logic: Sets 'XXX' value only when setid = 'SDMED' AND differncds IS NULL
                                                                                                                                                 
*                         - Otherwise uses standard differncds value from UKG_DifferentialEligibilityCodes
                                                                                                                                                   
* -- 01/28/2026 Jim Shih: Use stage.UKG_CURRENT_EMPL_REPORTS_TO_exclude_BYA_V to exclude BYA employees in reports_to joins
                                                                                                                                   
******************************************/
                                                                                                                                                                                                                  

                                                                                                                                                                                                                                                             
CREATE PROCEDURE [dbo].[UKG_EMPLOYEE_DATA_BUILD]
                                                                                                                                                                                                             
AS  
                                                                                                                                                                                                                                                         

                                                                                                                                                                                                                                                             
BEGIN
                                                                                                                                                                                                                                                        

                                                                                                                                                                                                                                                             
    -- EXEC [hts].[UKG_BusinessStructure_UPD] before EXEC [dbo].UKG_EMPLOYEE_DATA_BUILD
                                                                                                                                                                      
    EXEC [hts].[UKG_BusinessStructure_UPD];
                                                                                                                                                                                                                  
    -- EXEC [stage].[SP_UKG_EMPL_STATUS_LOOKUP_BUILD] before EXEC [dbo].UKG_EMPLOYEE_DATA_BUILD
                                                                                                                                                              
    EXEC [stage].[SP_UKG_EMPL_STATUS_LOOKUP_BUILD];
                                                                                                                                                                                                          
    -- EXEC [stage].[SP_UKG_HR_STATUS_LOOKUP_BUILD] before EXEC [dbo].UKG_EMPLOYEE_DATA_BUILD
                                                                                                                                                                
    EXEC [stage].[SP_UKG_HR_STATUS_LOOKUP_BUILD];
                                                                                                                                                                                                            

                                                                                                                                                                                                                                                             
    -- CTE to identify BYA employees for exclusion
                                                                                                                                                                                                           
    DROP TABLE IF EXISTS STAGE.CTE_exclude_BYA;
                                                                                                                                                                                                              

                                                                                                                                                                                                                                                             
    SELECT DISTINCT
                                                                                                                                                                                                                                          
        H.emplid
                                                                                                                                                                                                                                             
    INTO STAGE.CTE_exCLUDE_BYA
                                                                                                                                                                                                                               
    FROM health_ods.[health_ods].[stable].PS_JOB H
                                                                                                                                                                                                           
    WHERE 
                                                                                                                                                                                                                                                   
        H.JOB_INDICATOR = 'P'
                                                                                                                                                                                                                                
        AND H.DML_IND <> 'D'
                                                                                                                                                                                                                                 
        AND H.SAL_ADMIN_PLAN = 'BYA';
                                                                                                                                                                                                                        

                                                                                                                                                                                                                                                             
    -- Add index for BYA exclusion lookups
                                                                                                                                                                                                                   
    DROP INDEX IF EXISTS CTE_exclude_BYA_IDX_1 ON STAGE.CTE_exclude_BYA;
                                                                                                                                                                                     
    CREATE INDEX CTE_exclude_BYA_IDX_1 ON STAGE.CTE_exclude_BYA (emplid);
                                                                                                                                                                                    

                                                                                                                                                                                                                                                             
    -- UKG Employee population (Primary Job only):
                                                                                                                                                                                                           
    DROP TABLE IF EXISTS STAGE.UKG_EMPL_E_T;
                                                                                                                                                                                                                 

                                                                                                                                                                                                                                                             
    SELECT DISTINCT 'F' AS 'NON_UKG_MANAGER_FLAG', EMPL.*
                                                                                                                                                                                                    
    INTO STAGE.UKG_EMPL_E_T
                                                                                                                                                                                                                                  
    FROM health_ods.[health_ods].[RPT].CURRENT_EMPL_DATA	EMPL
                                                                                                                                                                                                
    WHERE 	1=1
                                                                                                                                                                                                                                               
        AND EMPL.JOB_INDICATOR = 'P'
                                                                                                                                                                                                                         
        AND (EMPL.VC_CODE = 'VCHSH' --MED CENTER
                                                                                                                                                                                                             
        OR (EMPL.DEPTID BETWEEN '002000' AND '002999' AND EMPL.DEPTID NOT IN ('002230','002231','002280') )	 -- PHSO
                                                                                                                                         
       )
                                                                                                                                                                                                                                                     
        AND ((EMPL.hr_status = 'A' 	) -- active empl
                                                                                                                                                                                                         
        OR (EMPL.hr_status = 'I' and CONVERT(DATE, effdt) >= DATEADD(DAY, -7, GETDATE()))	 --terminated empl in past 7 days
                                                                                                                                  
	   )
                                                                                                                                                                                                                                                        
        AND PAY_FREQUENCY = 'B'
                                                                                                                                                                                                                              
        AND EMPL_TYPE = 'H' -- Biweekly and hourly empl only
                                                                                                                                                                                                 
        AND NOT (EMPL.DEPTID IN ('002053','002056','003919') AND EMPL.JOBCODE IN ('000770','000771','000772','000775','000776')   )
                                                                                                                          
    --exclude ARC MSP POPULATION
                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
    --Performance Optimizations (9/16/2025):
                                                                                                                                                                                                                 
    -- Add index for performance
                                                                                                                                                                                                                             
    DROP INDEX IF EXISTS UKG_EMPL_E_T_IDX_1 ON STAGE.UKG_EMPL_E_T;
                                                                                                                                                                                           
    DROP INDEX IF EXISTS UKG_EMPL_E_T_IDX_2 ON STAGE.UKG_EMPL_E_T;
                                                                                                                                                                                           
    DROP INDEX IF EXISTS UKG_EMPL_E_T_IDX_3 ON STAGE.UKG_EMPL_E_T;
                                                                                                                                                                                           
    DROP INDEX IF EXISTS UKG_EMPL_E_T_IDX_4 ON STAGE.UKG_EMPL_E_T;
                                                                                                                                                                                           
    DROP INDEX IF EXISTS UKG_EMPL_E_T_IDX_5 ON STAGE.UKG_EMPL_E_T;
                                                                                                                                                                                           
    DROP INDEX IF EXISTS UKG_EMPL_E_T_IDX_6 ON STAGE.UKG_EMPL_E_T;
                                                                                                                                                                                           
    DROP INDEX IF EXISTS UKG_EMPL_E_T_IDX_7 ON STAGE.UKG_EMPL_E_T;
                                                                                                                                                                                           
    CREATE INDEX UKG_EMPL_E_T_IDX_1 ON STAGE.UKG_EMPL_E_T (EMPLID);
                                                                                                                                                                                          
    CREATE INDEX UKG_EMPL_E_T_IDX_2 ON STAGE.UKG_EMPL_E_T (POSITION_NBR);
                                                                                                                                                                                    
    CREATE INDEX UKG_EMPL_E_T_IDX_3 ON STAGE.UKG_EMPL_E_T (MANAGER_EMPLID);
                                                                                                                                                                                  
    CREATE INDEX UKG_EMPL_E_T_IDX_4 ON STAGE.UKG_EMPL_E_T (EMPL_RCD);
                                                                                                                                                                                        
    CREATE INDEX UKG_EMPL_E_T_IDX_5 ON STAGE.UKG_EMPL_E_T (JOBCODE);
                                                                                                                                                                                         
    CREATE INDEX UKG_EMPL_E_T_IDX_6 ON STAGE.UKG_EMPL_E_T (HR_STATUS);
                                                                                                                                                                                       
    CREATE INDEX UKG_EMPL_E_T_IDX_7 ON STAGE.UKG_EMPL_E_T (HOURLY_RT);
                                                                                                                                                                                       

                                                                                                                                                                                                                                                             
    -- update MANAGER_EMPLID to next higher level (up to level 5) if manager is not found 
                                                                                                                                                                   
    UPDATE STAGE.UKG_EMPL_E_T	
                                                                                                                                                                                                                               
   SET 	 MANAGER_EMPLID	   =
                                                                                                                                                                                                                                 
  CASE    WHEN   HPOSN.LEVEL = 'LEVEL6' AND MANAGER5_EMPLID != '' THEN MANAGER5_EMPLID
                                                                                                                                                                       
		  WHEN   HPOSN.LEVEL = 'LEVEL7' AND MANAGER6_EMPLID != ''  THEN MANAGER6_EMPLID
                                                                                                                                                                            
	      WHEN   HPOSN.LEVEL = 'LEVEL7' AND MANAGER6_EMPLID = '' AND MANAGER5_EMPLID != '' THEN MANAGER5_EMPLID
                                                                                                                                                 
	      WHEN   HPOSN.LEVEL = 'LEVEL8' AND MANAGER7_EMPLID != ''THEN MANAGER7_EMPLID
                                                                                                                                                                           
		  WHEN   HPOSN.LEVEL = 'LEVEL8' AND MANAGER7_EMPLID = '' AND MANAGER6_EMPLID != '' THEN MANAGER6_EMPLID
                                                                                                                                                    
		  WHEN   HPOSN.LEVEL = 'LEVEL8' AND MANAGER7_EMPLID = '' AND MANAGER6_EMPLID = '' AND MANAGER5_EMPLID != '' THEN MANAGER5_EMPLID
                                                                                                                           
		  WHEN   HPOSN.LEVEL = 'LEVEL9' AND MANAGER8_EMPLID != '' THEN MANAGER8_EMPLID
                                                                                                                                                                             
		  WHEN   HPOSN.LEVEL = 'LEVEL9' AND MANAGER8_EMPLID = '' AND MANAGER7_EMPLID != '' THEN MANAGER7_EMPLID
                                                                                                                                                    
		  WHEN   HPOSN.LEVEL = 'LEVEL9' AND MANAGER8_EMPLID = '' AND MANAGER7_EMPLID = '' AND MANAGER6_EMPLID != '' THEN MANAGER6_EMPLID
                                                                                                                           
		  WHEN   HPOSN.LEVEL = 'LEVEL9' AND MANAGER8_EMPLID = '' AND MANAGER7_EMPLID = '' AND MANAGER6_EMPLID = '' AND MANAGER5_EMPLID != '' THEN MANAGER5_EMPLID
                                                                                                  
		  WHEN   HPOSN.LEVEL = 'LEVEL10' AND MANAGER9_EMPLID != '' THEN MANAGER9_EMPLID
                                                                                                                                                                            
		  WHEN   HPOSN.LEVEL = 'LEVEL10' AND MANAGER9_EMPLID = '' AND MANAGER8_EMPLID != '' THEN MANAGER8_EMPLID
                                                                                                                                                   
		  WHEN   HPOSN.LEVEL = 'LEVEL10' AND MANAGER9_EMPLID = '' AND MANAGER8_EMPLID = '' AND MANAGER7_EMPLID != '' THEN MANAGER7_EMPLID
                                                                                                                          
		  WHEN   HPOSN.LEVEL = 'LEVEL10' AND MANAGER9_EMPLID = '' AND MANAGER8_EMPLID = '' AND MANAGER7_EMPLID = '' AND MANAGER6_EMPLID != '' THEN MANAGER6_EMPLID
                                                                                                 
		  WHEN   HPOSN.LEVEL = 'LEVEL10' AND MANAGER9_EMPLID = '' AND MANAGER8_EMPLID = '' AND MANAGER7_EMPLID = '' AND MANAGER6_EMPLID = '' AND MANAGER5_EMPLID != '' THEN MANAGER5_EMPLID			  
                                                                   
 ELSE   COALESCE(EMPL.MANAGER_EMPLID, '') END	
                                                                                                                                                                                                               
FROM STAGE.UKG_EMPL_E_T	  EMPL
                                                                                                                                                                                                                               
        INNER JOIN health_ods.[health_ods].[RPT].ORG_HIERARCHY_POSN	  HPOSN
                                                                                                                                                                                  
        ON HPOSN.EMPLID = EMPL.EMPLID
                                                                                                                                                                                                                        
            AND HPOSN.EMPL_RCD	= EMPL.EMPL_RCD
                                                                                                                                                                                                               
            AND EMPL.MANAGER_EMPLID IS NULL
                                                                                                                                                                                                                  

                                                                                                                                                                                                                                                             
    -- Manager outside of UKG
                                                                                                                                                                                                                                
    DROP TABLE IF EXISTS STAGE.UKG_EMPL_M_T;
                                                                                                                                                                                                                 

                                                                                                                                                                                                                                                             
    SELECT DISTINCT 'T' AS 'NON_UKG_MANAGER_FLAG', EMPL.*
                                                                                                                                                                                                    
    INTO STAGE.UKG_EMPL_M_T
                                                                                                                                                                                                                                  
    FROM health_ods.[health_ods].[RPT].CURRENT_EMPL_DATA EMPL,
                                                                                                                                                                                               
        STAGE.UKG_EMPL_E_T UKG
                                                                                                                                                                                                                               
    WHERE EMPL.EMPLID = UKG.MANAGER_EMPLID
                                                                                                                                                                                                                   
        --       and EMPL.JOB_INDICATOR = 'P'  -- 08/26/2025 JK said any job indicator is fine
                                                                                                                                                               
        AND EMPL.EMPLID NOT IN (SELECT DISTINCT EMPLID
                                                                                                                                                                                                       
        FROM STAGE.UKG_EMPL_E_T)
                                                                                                                                                                                                                             
        AND EMPL.HR_STATUS = 'A'
                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
    -- Add indexes for UKG_EMPL_M_T performance
                                                                                                                                                                                                              
    DROP INDEX IF EXISTS UKG_EMPL_M_T_IDX_1 ON STAGE.UKG_EMPL_M_T;
                                                                                                                                                                                           
    DROP INDEX IF EXISTS UKG_EMPL_M_T_IDX_2 ON STAGE.UKG_EMPL_M_T;
                                                                                                                                                                                           
    DROP INDEX IF EXISTS UKG_EMPL_M_T_IDX_3 ON STAGE.UKG_EMPL_M_T;
                                                                                                                                                                                           
    DROP INDEX IF EXISTS UKG_EMPL_M_T_IDX_4 ON STAGE.UKG_EMPL_M_T;
                                                                                                                                                                                           
    CREATE INDEX UKG_EMPL_M_T_IDX_1 ON STAGE.UKG_EMPL_M_T (EMPLID);
                                                                                                                                                                                          
    CREATE INDEX UKG_EMPL_M_T_IDX_2 ON STAGE.UKG_EMPL_M_T (POSITION_NBR);
                                                                                                                                                                                    
    CREATE INDEX UKG_EMPL_M_T_IDX_3 ON STAGE.UKG_EMPL_M_T (MANAGER_EMPLID);
                                                                                                                                                                                  
    CREATE INDEX UKG_EMPL_M_T_IDX_4 ON STAGE.UKG_EMPL_M_T (JOBCODE);
                                                                                                                                                                                         

                                                                                                                                                                                                                                                             
    -- combine UKG Empl and UKG Manager
                                                                                                                                                                                                                      
    DROP TABLE IF EXISTS STAGE.UKG_EMPL_T;
                                                                                                                                                                                                                   

                                                                                                                                                                                                                                                             
    SELECT *
                                                                                                                                                                                                                                                 
    INTO STAGE.UKG_EMPL_T
                                                                                                                                                                                                                                    
    FROM (
                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                SELECT *
                                     
            FROM STAGE.UKG_EMPL_E_T
                                                                                                                                                                                                                          
        UNION
                                                                                                                                                                                                                                                
            SELECT *
                                                                                                                                                                                                                                         
            FROM STAGE.UKG_EMPL_M_T ) TEMP
                                                                                                                                                                                                                   

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
    DROP INDEX IF EXISTS UKG_EMPL_T_IDX_1 ON HealthTime.STAGE.UKG_EMPL_T;
                                                                                                                                                                                    
    DROP INDEX IF EXISTS UKG_EMPL_T_IDX_2 ON HealthTime.STAGE.UKG_EMPL_T;
                                                                                                                                                                                    
    DROP INDEX IF EXISTS UKG_EMPL_T_IDX_3 ON HealthTime.STAGE.UKG_EMPL_T;
                                                                                                                                                                                    
    DROP INDEX IF EXISTS UKG_EMPL_T_IDX_4 ON HealthTime.STAGE.UKG_EMPL_T;
                                                                                                                                                                                    
    DROP INDEX IF EXISTS UKG_EMPL_T_IDX_5 ON HealthTime.STAGE.UKG_EMPL_T;
                                                                                                                                                                                    
    DROP INDEX IF EXISTS UKG_EMPL_T_IDX_6 ON HealthTime.STAGE.UKG_EMPL_T;
                                                                                                                                                                                    
    CREATE INDEX UKG_EMPL_T_IDX_1 ON HealthTime.STAGE.UKG_EMPL_T  (EMPLID);
                                                                                                                                                                                  
    CREATE INDEX UKG_EMPL_T_IDX_2 ON HealthTime.STAGE.UKG_EMPL_T  (POSITION_NBR);
                                                                                                                                                                            
    CREATE INDEX UKG_EMPL_T_IDX_3 ON HealthTime.STAGE.UKG_EMPL_T  (MANAGER_EMPLID);
                                                                                                                                                                          
    CREATE INDEX UKG_EMPL_T_IDX_4 ON HealthTime.STAGE.UKG_EMPL_T  (EMPL_RCD);
                                                                                                                                                                                
    CREATE INDEX UKG_EMPL_T_IDX_5 ON HealthTime.STAGE.UKG_EMPL_T  (JOBCODE);
                                                                                                                                                                                 
    CREATE INDEX UKG_EMPL_T_IDX_6 ON HealthTime.STAGE.UKG_EMPL_T  (HR_STATUS);
                                                                                                                                                                               

                                                                                                                                                                                                                                                             
    --	 Get combocode 
                                                                                                                                                                                                                                       
    DROP TABLE IF EXISTS STAGE.UKG_COMBOCD_T;
                                                                                                                                                                                                                
    SELECT FIN.POSITION_NBR, MIN(FIN.POSN_SEQ)  AS MIN_POSN_SEQ
                                                                                                                                                                                              
    INTO STAGE.UKG_COMBOCD_T
                                                                                                                                                                                                                                 
    FROM health_ods.[HEALTH_ODS].[RPT].[CURRENT_POSITION_PRI_FIN_UNIT]  FIN ,
                                                                                                                                                                                
        [hts].[UKG_BusinessStructure]  UKG_BS
                                                                                                                                                                                                                
    WHERE  UKG_BS.COMBOCODE =  FIN.FDM_COMBO_CD
                                                                                                                                                                                                              
    --AND   FIN.POSITION_NBR = 	'40776608'
                                                                                                                                                                                                                   
    GROUP BY  FIN.POSITION_NBR
                                                                                                                                                                                                                               

                                                                                                                                                                                                                                                             
    -- Add index for performance
                                                                                                                                                                                                                             
    DROP INDEX IF EXISTS UKG_COMBOCD_T_IDX_1 ON STAGE.UKG_COMBOCD_T;
                                                                                                                                                                                         
    DROP INDEX IF EXISTS UKG_COMBOCD_T_IDX_2 ON STAGE.UKG_COMBOCD_T;
                                                                                                                                                                                         
    CREATE INDEX UKG_COMBOCD_T_IDX_1 ON STAGE.UKG_COMBOCD_T (POSITION_NBR);
                                                                                                                                                                                  
    CREATE INDEX UKG_COMBOCD_T_IDX_2 ON STAGE.UKG_COMBOCD_T (MIN_POSN_SEQ);
                                                                                                                                                                                  

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
    -- UKG Empl FTE:  if employee's primary job is health, combine all active FTE, capped at 1.0 FTE. Note: if primary job is campus, then EE wont be in UKG. 
                                                                                               
    DROP TABLE IF EXISTS STAGE.UKG_EMPL_FTE_T;
                                                                                                                                                                                                               
    SELECT EMPL.EMPLID,
                                                                                                                                                                                                                                      
        SUM(EMPL.FTE)	AS FTE_SUM
                                                                                                                                                                                                                             
    INTO STAGE.UKG_EMPL_FTE_T
                                                                                                                                                                                                                                
    FROM STAGE.UKG_EMPL_T UKG_EMPL,
                                                                                                                                                                                                                          
        health_ods.[health_ods].[RPT].CURRENT_EMPL_DATA	EMPL
                                                                                                                                                                                                 
    WHERE 1=1
                                                                                                                                                                                                                                                
        AND EMPL.EMPLID = UKG_EMPL.EMPLID
                                                                                                                                                                                                                    
        AND EMPL.HR_STATUS = 'A'
                                                                                                                                                                                                                             
    GROUP BY EMPL.EMPLID
                                                                                                                                                                                                                                     

                                                                                                                                                                                                                                                             
    -- Add index for performance
                                                                                                                                                                                                                             
    DROP INDEX IF EXISTS UKG_EMPL_FTE_T_IDX_1 ON STAGE.UKG_EMPL_FTE_T;
                                                                                                                                                                                       
    DROP INDEX IF EXISTS UKG_EMPL_FTE_T_IDX_2 ON STAGE.UKG_EMPL_FTE_T;
                                                                                                                                                                                       
    CREATE INDEX UKG_EMPL_FTE_T_IDX_1 ON STAGE.UKG_EMPL_FTE_T (EMPLID);
                                                                                                                                                                                      
    CREATE INDEX UKG_EMPL_FTE_T_IDX_2 ON STAGE.UKG_EMPL_FTE_T (FTE_SUM);
                                                                                                                                                                                     

                                                                                                                                                                                                                                                             
    -- Empl Hr rate effdt : Cycle thru previous job rows to determine when last pay rate change was; use efft date from that change
                                                                                                                          
    DROP TABLE IF EXISTS STAGE.UKG_EMPL_HRATE_EFFDT_T;
                                                                                                                                                                                                       
    SELECT H.EMPLID,
                                                                                                                                                                                                                                         
        H.HOURLY_RT,
                                                                                                                                                                                                                                         
        H.EFFDT ,
                                                                                                                                                                                                                                            
        H.UPD_BT_DTM ,
                                                                                                                                                                                                                                       
        H.action, --10/8 add action, and action_dt
                                                                                                                                                                                                           
        H.action_dt,
                                                                                                                                                                                                                                         
        ROW_NUMBER() OVER (
                                                                                                                                                                                                                                  
            PARTITION BY H.EMPLID 
                                                                                                                                                                                                                           
            ORDER BY H.EFFDT ASC, UPD_BT_DTM DESC ) AS RN
                                                                                                                                                                                                    
    INTO  STAGE.UKG_EMPL_HRATE_EFFDT_T
                                                                                                                                                                                                                       
    FROM health_ods.[health_ods].[stable].PS_JOB H, STAGE.UKG_EMPL_T  L
                                                                                                                                                                                      
    WHERE H.EMPLID = L.EMPLID
                                                                                                                                                                                                                                
        AND H.EMPL_RCD = L.EMPL_RCD
                                                                                                                                                                                                                          
        AND H.HOURLY_RT = L.HOURLY_RT
                                                                                                                                                                                                                        
        AND H.JOB_INDICATOR = 'P'
                                                                                                                                                                                                                            
        AND H.DML_IND <> 'D'
                                                                                                                                                                                                                                 
        --and (H.SAL_ADMIN_PLAN <> 'BYA' OR H.FLSA_STATUS <> 'E')  -- 08/13/2025
                                                                                                                                                                             
        and (H.SAL_ADMIN_PLAN <> 'BYA')
                                                                                                                                                                                                                      
    -- 08/22/2025
                                                                                                                                                                                                                                            
    --AND H.HR_STATUS = 'A'		 -- HOW ABOUT INACTIVE ???
                                                                                                                                                                                                      

                                                                                                                                                                                                                                                             
    -- Add index for performance
                                                                                                                                                                                                                             
    DROP INDEX IF EXISTS UKG_EMPL_HRATE_EFFDT_T_IDX_1 ON STAGE.UKG_EMPL_HRATE_EFFDT_T;
                                                                                                                                                                       
    DROP INDEX IF EXISTS UKG_EMPL_HRATE_EFFDT_T_IDX_2 ON STAGE.UKG_EMPL_HRATE_EFFDT_T;
                                                                                                                                                                       
    DROP INDEX IF EXISTS UKG_EMPL_HRATE_EFFDT_T_IDX_3 ON STAGE.UKG_EMPL_HRATE_EFFDT_T;
                                                                                                                                                                       
    CREATE INDEX UKG_EMPL_HRATE_EFFDT_T_IDX_1 ON STAGE.UKG_EMPL_HRATE_EFFDT_T (EMPLID, RN);
                                                                                                                                                                  
    CREATE INDEX UKG_EMPL_HRATE_EFFDT_T_IDX_2 ON STAGE.UKG_EMPL_HRATE_EFFDT_T (HOURLY_RT);
                                                                                                                                                                   
    CREATE INDEX UKG_EMPL_HRATE_EFFDT_T_IDX_3 ON STAGE.UKG_EMPL_HRATE_EFFDT_T (EFFDT);
                                                                                                                                                                       

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
    -- TEMP table with UKG Business Structure 
                                                                                                                                                                                                               
    DROP TABLE IF EXISTS   [dbo].[UKG_EMPLOYEE_DATA_TEMP]
                                                                                                                                                                                                    
    --------------  Troubleshoot issue from here
                                                                                                                                                                                                             
    --UKG_JC.JobGroup, ukg_bs.FundGroup needed 
                                                                                                                                                                                                              
    SELECT distinct --top 10 ---- troubleshooting 10 records
                                                                                                                                                                                                 
        EMPL.DEPTID,
                                                                                                                                                                                                                                         
        empl.VC_CODE,
                                                                                                                                                                                                                                        
        fin.FDM_COMBO_CD ,
                                                                                                                                                                                                                                   
        UKG_BS.COMBOCODE,
                                                                                                                                                                                                                                    
        empl.REPORTS_TO,
                                                                                                                                                                                                                                     
        empl.MANAGER_EMPLID,
                                                                                                                                                                                                                                 
        [NON_UKG_MANAGER_FLAG], -- need this one accural
                                                                                                                                                                                                     
        empl.position_nbr,
                                                                                                                                                                                                                                   
        EMPL.EMPLID ,
                                                                                                                                                                                                                                        
        empl.EMPL_RCD,
                                                                                                                                                                                                                                       
        empl.jobcode,
                                                                                                                                                                                                                                        
        empl.POSITION_DESCR,
                                                                                                                                                                                                                                 
        empl.hr_status,
                                                                                                                                                                                                                                      
        UKG_FTE.FTE_SUM,
                                                                                                                                                                                                                                     
        empl.fte,
                                                                                                                                                                                                                                            
        empl.empl_Status, -- all the above columns for testing only	
                                                                                                                                                                                         
        UKG_JC.JobGroup, ukg_bs.FundGroup , -- added for the Location BS file
                                                                                                                                                                                
        ISNULL(EMPL.EMPLID, '')  AS 'Person Number',
                                                                                                                                                                                                         
        EMPL.LIVED_FIRST_NAME  AS 'First Name',
                                                                                                                                                                                                              
        ISNULL(CAST(EMPL.LAST_NAME AS VARCHAR), '') AS 'Last Name',
                                                                                                                                                                                          
        LEFT(EMPL.LIVED_MIDDLE_NAME,1)  AS 'Middle Initial/Name',
                                                                                                                                                                                            
        ''  AS 'Short Name',
                                                                                                                                                                                                                                 
        ''  AS 'Badge Number',
                                                                                                                                                                                                                               
        ISNULL(CAST(EMPL.HIRE_DT AS VARCHAR), '')  AS 'Hire Date',
                                                                                                                                                                                           
        ''  AS 'Birth Date',
                                                                                                                                                                                                                                 
        ''  AS 'Seniority Date',
                                                                                                                                                                                                                             
        CASE WHEN M.MANAGER_EMPLID IS NOT NULL THEN 'T' ELSE 'F' END  AS 'Manager Flag',
                                                                                                                                                                     
        COALESCE(REPLACE(PH1.phone, '/', '-'), '')   AS 'Phone 1',
                                                                                                                                                                                           
        COALESCE(REPLACE(PH2.phone, '/', '-'), '')   AS  'Phone 2',
                                                                                                                                                                                          
        CASE WHEN VC_CODE IN ('VCHSH', 'VCHSS') THEN REPLACE(EMPL.BUSN_EMAIL_ADDR, '@ucsd.edu', '@health.ucsd.edu') 
                                                                                                                                         
		     ELSE EMPL.BUSN_EMAIL_ADDR END AS 'Email',
                                                                                                                                                                                                             
        ''  AS 'Address',
                                                                                                                                                                                                                                    
        ''  AS 'City',
                                                                                                                                                                                                                                       
        ''  AS 'State',
                                                                                                                                                                                                                                      
        ''  AS 'Postal Code',
                                                                                                                                                                                                                                
        ''  AS 'Country',
                                                                                                                                                                                                                                    
        'Pacific'  AS 'Time Zone',
                                                                                                                                                                                                                           
        --	    ISNULL(EMPL.HR_STATUS, '') AS 'Employment Status', 
                                                                                                                                                                                           
        ISNULL(UKG_ES.empl_Status, '') AS 'Employment Status', -- Replace EMPL.HR_STATUS with EMPL.empl_Status
                                                                                                                                               
        ISNULL(CAST(UKG_ES.EFFDT AS VARCHAR), '')  AS 'Employment Status Effective Date', -- 9/3 Replace EMPL.EFFDT with UKG_ES.EFFDT     
                                                                                                                   
        CASE  WHEN NON_UKG_MANAGER_FLAG = 'T' THEN ''
                                                                                                                                                                                                        
		      ELSE   COALESCE(EMPL.MANAGER_EMPLID, '') END	 AS 'Reports to Manager',
                                                                                                                                                                               

                                                                                                                                                                                                                                                             
        CASE WHEN NON_UKG_MANAGER_FLAG = 'T' THEN '' ELSE EMPL.UNION_CD  END AS 'Union Code',
                                                                                                                                                                
        CASE WHEN NON_UKG_MANAGER_FLAG = 'T' THEN '' ELSE EMPL.EMPL_TYPE END AS 'Employee Type',
                                                                                                                                                             
        -- New Logic of Employee Classification		
                                                                                                                                                                                                            
        CASE WHEN NON_UKG_MANAGER_FLAG = 'T' THEN 'C'  -- OLD logic WHEN NON_UKG_MANAGER_FLAG = 'T' THEN ''
                                                                                                                                                  
		     WHEN EMPL.FLSA_STATUS = 'V' THEN 'N' 		     
                                                                                                                                                                                                          
			 ELSE EMPL.FLSA_STATUS END  AS 'Employee Classification',
                                                                                                                                                                                                 
        CASE WHEN NON_UKG_MANAGER_FLAG = 'T' THEN '' ELSE EMPL.PAY_FREQUENCY END  AS 'Pay Frequency',
                                                                                                                                                        
        CASE WHEN NON_UKG_MANAGER_FLAG = 'T' THEN ''
                                                                                                                                                                                                         
		     WHEN  EMPL.EMPL_CLASS = 6 THEN 'PD'	   
                                                                                                                                                                                                               
		     WHEN  EMPL.EMPL_CLASS != 6 AND ((EMPL.HR_STATUS = 'I' AND EMPL.FTE >= 1) OR (EMPL.HR_STATUS = 'A' AND UKG_FTE.FTE_SUM >= 1))  THEN 'FT'
                                                                                                               
			 WHEN  EMPL.EMPL_CLASS != 6 AND ((EMPL.HR_STATUS = 'I' AND EMPL.FTE < 1) OR (EMPL.HR_STATUS = 'A' AND UKG_FTE.FTE_SUM < 1))  THEN 'PT'
                                                                                                                    
			--WHEN  EMPL.EMPL_CLASS != 6 AND UKG_FTE.FTE_SUM >= 1  THEN 'FT'
                                                                                                                                                                                          
			--WHEN  EMPL.EMPL_CLASS != 6 AND  UKG_FTE.FTE_SUM < 1  THEN 'PT'
                                                                                                                                                                                          
		     ELSE EMPL.EMPL_CLASS  END AS 'Worker Type',
                                                                                                                                                                                                           
        CASE WHEN NON_UKG_MANAGER_FLAG = 'T' THEN ''
                                                                                                                                                                                                         
		     WHEN EMPL.HR_STATUS = 'I' THEN  CAST(CAST(EMPL.FTE * 100 AS NUMERIC(8,0))  AS VARCHAR)
                                                                                                                                                                
		     WHEN UKG_FTE.FTE_SUM >1  THEN '100' 		--  EMPL.HR_STATUS = 'A' AND  ??? 	 test  			 
                                                                                                                                                                  
			 ELSE CAST(CAST(UKG_FTE.FTE_SUM * 100 AS NUMERIC(8,0))  AS VARCHAR)     END AS 'FTE %',
                                                                                                                                                                   
        ''   AS 'FTE Standard Hours',
                                                                                                                                                                                                                        
        ''   AS 'FTE Full Time Hours',
                                                                                                                                                                                                                       
        ''   AS 'Standard Hours - Daily',
                                                                                                                                                                                                                    
        ''   AS 'Standard Hours - Weekly',
                                                                                                                                                                                                                   
        ''   AS 'Standard Hours - Pay Period',
                                                                                                                                                                                                               
        CASE WHEN NON_UKG_MANAGER_FLAG = 'T' THEN '' ELSE CAST( CAST(EMPL.HOURLY_RT AS NUMERIC(8,2)) AS VARCHAR) END AS 'Base Wage Rate',
                                                                                                                    
        CASE WHEN NON_UKG_MANAGER_FLAG = 'T' THEN '' ELSE ISNULL(CAST( HEFFDT.EFFDT AS VARCHAR), '') END AS 'Base Wage Rate Effective Date',
                                                                                                                 
        EMPL.EMPLID  AS 'User Account Name',
                                                                                                                                                                                                                 
        CASE WHEN EMPL.EMPL_STATUS  in ('P', 'A')  THEN 'A'	            
                                                                                                                                                                                     
		     ELSE 'I' END AS 'User Account Status',
                                                                                                                                                                                                                
        ''   AS 'User Password',
                                                                                                                                                                                                                             
        CASE WHEN NON_UKG_MANAGER_FLAG = 'T'  THEN 'Non-Health' 		     
                                                                                                                                                                                      
			 ELSE ISNULL(UKG_BS.Organization, '') END AS 'Home Business Structure Level 1 - Organization',
                                                                                                                                                            
        CASE WHEN NON_UKG_MANAGER_FLAG = 'T'  THEN '-' 		     
                                                                                                                                                                                               
		     ELSE ISNULL(UKG_BS.EntityTitle, '')  END  AS 'Home Business Structure Level 2 - Entity',
                                                                                                                                                              
        CASE WHEN NON_UKG_MANAGER_FLAG = 'T'  THEN '-'		    
                                                                                                                                                                                                 
		     ELSE  ISNULL(UKG_BS.ServiceLineTitle, '')  END  AS 'Home Business Structure Level 3 - Service Line',
                                                                                                                                                  
        CASE WHEN NON_UKG_MANAGER_FLAG = 'T' THEN '-' 
                                                                                                                                                                                                       
		     ELSE  ISNULL(UKG_BS.FinancialUnit, '')  END  AS 'Home Business Structure Level 4 - Financial Unit',
                                                                                                                                                   
        CASE WHEN NON_UKG_MANAGER_FLAG = 'T'  THEN '-' 
                                                                                                                                                                                                      
		     ELSE  ISNULL(UKG_BS.FundGroup, '')  END  AS 'Home Business Structure Level 5 - Fund Group',
                                                                                                                                                           
        ''  AS 'Home Business Structure Level 6',
                                                                                                                                                                                                            
        ''  AS 'Home Business Structure Level 7',
                                                                                                                                                                                                            
        ''  AS 'Home Business Structure Level 8',
                                                                                                                                                                                                            
        ''  AS 'Home Business Structure Level 9',
                                                                                                                                                                                                            
        CASE WHEN NON_UKG_MANAGER_FLAG = 'T' THEN 'NHRPT' ELSE ISNULL(UKG_JC.Jobgroup, '')   END AS 'Home/Primary Job',
                                                                                                                                      
        CASE WHEN NON_UKG_MANAGER_FLAG = 'T' THEN '' ELSE ISNULL(EMPL.POSITION_NBR +  '_' + CONVERT(VARCHAR, EMPL.EMPL_RCD), '') END AS 'Home Labor Category Level 1',
                                                                                       
        CASE WHEN NON_UKG_MANAGER_FLAG = 'T' THEN '' ELSE ISNULL(EMPL.JOBCODE, '')  END AS 'Home Labor Category Level 2', -- primary jobcode
                                                                                                                 
        ''  AS 'Home Labor Category Level 3',
                                                                                                                                                                                                                
        ''  AS 'Home Labor Category Level 4',
                                                                                                                                                                                                                
        ''  AS 'Home Labor Category Level 5',
                                                                                                                                                                                                                
        ''  AS 'Home Labor Category Level 6',
                                                                                                                                                                                                                
        CASE WHEN NON_UKG_MANAGER_FLAG = 'T' THEN '' ELSE ISNULL(CAST(EMPL.EFFDT AS VARCHAR), '') END  AS 'Home Job and Labor Category Effective Date', --Job EFFDT current date, or current pay period start date?
                                          
        CASE WHEN NON_UKG_MANAGER_FLAG = 'T' THEN '' ELSE empl.GP_ELIG_GRP END  AS 'Custom Field 1', --	empl.GP_ELIG_GRP?
                                                                                                                                    
        CASE WHEN NON_UKG_MANAGER_FLAG = 'T' THEN '' ELSE empl.empl_class END   AS 'Custom Field 2',
                                                                                                                                                         
        ''  AS 'Custom Field 3',
                                                                                                                                                                                                                             
        empl.PAYGROUP AS 'Custom Field 4', -- 9/15/2025
                                                                                                                                                                                                      
        --CASE WHEN NON_UKG_MANAGER_FLAG = 'T' THEN '' ELSE empl.PAYGROUP  END AS 'Custom Field 4',
                                                                                                                                                          
        --ISNULL(CAST(UKG_HS.EFFDT AS VARCHAR), '')  AS 'Custom Field 4'
                                                                                                                                                                                     
        --CASE WHEN NON_UKG_MANAGER_FLAG = 'T' THEN '' ELSE empl.EMPL_STATUS END AS 'Custom Field 5',
                                                                                                                                                        
        ISNULL(EMPL.HR_STATUS, '') AS 'Custom Field 5',
                                                                                                                                                                                                      
        ''  AS 'Custom Field 6',
                                                                                                                                                                                                                             
        empl.BUSINESS_UNIT  AS 'Custom Field 7', -- 8/14/2025
                                                                                                                                                                                                
        ''  AS 'Custom Field 8',
                                                                                                                                                                                                                             
        ''  AS 'Custom Field 9', --	 ?
                                                                                                                                                                                                                       
        CASE WHEN NON_UKG_MANAGER_FLAG = 'T' THEN '' ELSE empl.UNION_CD  END AS 'Custom Field 10', -- done
                                                                                                                                                   
        -- Re-order Custom date
                                                                                                                                                                                                                              
        CASE WHEN NON_UKG_MANAGER_FLAG = 'T' THEN ''
                                                                                                                                                                                                         
        		     WHEN NON_UKG_MANAGER_FLAG = 'F' AND PROBATION_CODE = 'P' THEN ISNULL(CAST(EMPL.PROB_END_DT AS VARCHAR), CAST(EMPL.HIRE_DT AS VARCHAR))
                                                                                                        
        			 ELSE ISNULL(CAST(EMPL.HIRE_DT AS VARCHAR), '') END AS 'Custom Date 1', --Custom Date Field 1 is the Probation Date and if the probation date is not found it should be filled with the hire date
                                                 
        CASE WHEN NON_UKG_MANAGER_FLAG = 'T' THEN ''
                                                                                                                                                                                                         
		     ELSE ISNULL(CAST(EMPL.LAST_HIRE_DT AS VARCHAR), '')  END AS 'Custom Date 2',
                                                                                                                                                                          
        ''  AS 'Custom Date 3',
                                                                                                                                                                                                                              
        --''  AS 'Custom Date 4',
                                                                                                                                                                                                                            
        ISNULL(CAST(UKG_HS.EFFDT AS VARCHAR), '') AS 'Custom Date 4', -- 9/3/2025  Replace EMPL.EFFDT with UKG_HS.EFFDT  
                                                                                                                                    
        ''  AS 'Custom Date 5',
                                                                                                                                                                                                                              
        ''  AS 'Custom Field 11', --   person type phase 1 blank, phase2 use per_org
                                                                                                                                                                         
        ''  AS 'Custom Field 12',
                                                                                                                                                                                                                            
        ''  AS 'Custom Field 13', -- done	 -- import date	 later
                                                                                                                                                                                             
        CASE WHEN NON_UKG_MANAGER_FLAG = 'T' THEN ''		     		 
                                                                                                                                                                                               
			 ELSE CAST(CAST(EMPL.FTE * 100 AS NUMERIC(8,0))  AS VARCHAR)     END AS 'Custom Field 14',
                                                                                                                                                                
        CASE WHEN NON_UKG_MANAGER_FLAG = 'T' THEN ''
                                                                                                                                                                                                         
		     WHEN EMPL.HR_STATUS = 'I' THEN  CAST(CAST(EMPL.FTE * 100 AS NUMERIC(8,0))  AS VARCHAR)
                                                                                                                                                                
		     WHEN UKG_FTE.FTE_SUM >1  THEN '100' 		 
                                                                                                                                                                                                               
			 ELSE CAST(CAST(UKG_FTE.FTE_SUM * 100 AS NUMERIC(8,0))  AS VARCHAR)     END AS 'Custom Field 15',
                                                                                                                                                         
        ''  AS 'Custom Field 16',
                                                                                                                                                                                                                            
        ''  AS 'Custom Field 17',
                                                                                                                                                                                                                            
        ''  AS 'Custom Field 18',
                                                                                                                                                                                                                            
        ''  AS 'Custom Field 19',
                                                                                                                                                                                                                            
        ''  AS 'Custom Field 20',
                                                                                                                                                                                                                            
        ''  AS 'Custom Field 21',
                                                                                                                                                                                                                            
        ''  AS 'Custom Field 22',
                                                                                                                                                                                                                            
        ''  AS 'Custom Field 23',
                                                                                                                                                                                                                            
        ''  AS 'Custom Field 24',
                                                                                                                                                                                                                            
        ''  AS 'Custom Field 25',
                                                                                                                                                                                                                            
        ''  AS 'Custom Field 26',
                                                                                                                                                                                                                            
        ''  AS 'Custom Field 27',
                                                                                                                                                                                                                            
        ''  AS 'Custom Field 28',
                                                                                                                                                                                                                            
        ''  AS 'Custom Field 29',
                                                                                                                                                                                                                            
        ''  AS 'Custom Field 30',
                                                                                                                                                                                                                            
        ''  AS 'Additional Fields for CRT lookups',
                                                                                                                                                                                                          
        empl.termination_dt,
                                                                                                                                                                                                                                 
        --9/15 add termination_dt        
                                                                                                                                                                                                                    
        empl.action,
                                                                                                                                                                                                                                         
        empl.action_dt
                                                                                                                                                                                                                                       
    --10/8 add action, and action_dt
                                                                                                                                                                                                                         
    INTO [dbo].[UKG_EMPLOYEE_DATA_TEMP]
                                                                                                                                                                                                                      
    FROM HealthTime.STAGE.UKG_EMPL_T EMPL
                                                                                                                                                                                                                    
        LEFT OUTER JOIN STAGE.UKG_EMPL_HRATE_EFFDT_T HEFFDT -- If change to INNER JOIN  , it will remove the dup
                                                                                                                                             
        ON  EMPL.EMPLID = HEFFDT.EMPLID
                                                                                                                                                                                                                      
            AND HEFFDT.RN = 1
                                                                                                                                                                                                                                
            AND HEFFDT.HOURLY_RT = EMPL.HOURLY_RT
                                                                                                                                                                                                            
--        LEFT OUTER JOIN health_ods.[health_ods].[RPT].CURRENT_EMPL_REPORTS_TO M
                                                                                                                                                                            
LEFT OUTER JOIN health_ods.[health_ods].[stage].[UKG_CURRENT_EMPL_REPORTS_TO_exclude_BYA_V] M  -- 01/28/2026 Jim Shih: Use stage.UKG_CURRENT_EMPL_REPORTS_TO_exclude_BYA_V to exclude BYA employees in reports_to joins
                                      
        ON M.MANAGER_HR_STATUS  = 'A'
                                                                                                                                                                                                                        
            AND M.MANAGER_EMPLID = EMPL.EMPLID
                                                                                                                                                                                                               
            AND M.MANAGER_POSITION_NBR = EMPL.POSITION_NBR
                                                                                                                                                                                                   
        LEFT OUTER JOIN health_ods.[health_ods].[RPT].ORG_HIERARCHY_POSN	  HPOSN
                                                                                                                                                                             
        ON HPOSN.EMPLID = EMPL.EMPLID
                                                                                                                                                                                                                        
            AND HPOSN.EMPL_RCD	= EMPL.EMPL_RCD
                                                                                                                                                                                                               
            AND EMPL.MANAGER_EMPLID IS NULL
                                                                                                                                                                                                                  
        LEFT OUTER JOIN health_ods.[health_ods].[stable].PS_PERSONAL_PHONE	PH1
                                                                                                                                                                               
        ON PH1.EMPLID = EMPL.EMPLID
                                                                                                                                                                                                                          
            AND PH1.DML_IND <> 'D'
                                                                                                                                                                                                                           
            AND PH1.PHONE_TYPE IN ('CEL2')
                                                                                                                                                                                                                   
        LEFT OUTER JOIN health_ods.[health_ods].[stable].PS_PERSONAL_PHONE	PH2
                                                                                                                                                                               
        ON PH2.EMPLID = EMPL.EMPLID
                                                                                                                                                                                                                          
            AND PH2.DML_IND <> 'D'
                                                                                                                                                                                                                           
            AND PH2.PHONE_TYPE IN ('CELL')
                                                                                                                                                                                                                   
        LEFT OUTER JOIN STAGE.UKG_EMPL_FTE_T UKG_FTE
                                                                                                                                                                                                         
        ON EMPL.EMPLID = UKG_FTE.EMPLID
                                                                                                                                                                                                                      
        LEFT OUTER JOIN health_ods.[health_ods].[RPT].[CURRENT_POSITION_PRI_FIN_UNIT] FIN
                                                                                                                                                                    
        --LEFT OUTER JOIN stage.[CURRENT_POSITION_PRI_FIN_UNIT_V] FIN
                                                                                                                                                                                        
        ON EMPL.POSITION_NBR = FIN.POSITION_NBR
                                                                                                                                                                                                              
            --AND FIN.POSN_SEQ  = 1
                                                                                                                                                                                                                          
            AND FIN.POSN_SEQ = (SELECT MIN_POSN_SEQ
                                                                                                                                                                                                          
            FROM STAGE.UKG_COMBOCD_T	T
                                                                                                                                                                                                                       
            WHERE FIN.POSITION_NBR = T.POSITION_NBR)
                                                                                                                                                                                                         
        LEFT OUTER JOIN [hts].[UKG_BusinessStructure]  UKG_BS
                                                                                                                                                                                                
        ON UKG_BS.COMBOCODE =  FIN.FDM_COMBO_CD
                                                                                                                                                                                                              
        LEFT JOIN hts.UKG_JOBCODES UKG_JC
                                                                                                                                                                                                                    
        ON UKG_JC.JOBCODE = FIN.JOBCODE
                                                                                                                                                                                                                      
        LEFT JOIN hts.UKG_JOBGROUPS UKG_JG
                                                                                                                                                                                                                   
        ON UKG_JG.JOBGROUP = UKG_JC.JOBGROUP
                                                                                                                                                                                                                 
        LEFT JOIN [stage].[UKG_EMPL_STATUS_LOOKUP] UKG_ES --09/03/2025
                                                                                                                                                                                       
        ON  EMPL.emplid= UKG_ES.emplid
                                                                                                                                                                                                                       
        LEFT JOIN [stage].[UKG_HR_STATUS_LOOKUP] UKG_HS --09/03/2025
                                                                                                                                                                                         
        ON  EMPL.emplid= UKG_HS.emplid
                                                                                                                                                                                                                       
    --where EMPL.EMPLID NOT IN (SELECT emplid
                                                                                                                                                                                                                
    --FROM STAGE.CTE_exclude_BYA)						    -- 08/25/2025        
                                                                                                                                                                                             
    ;
                                                                                                                                                                                                                                                        
    ---------------------------------------------------------------------------------------------------------------------------------- add extra steps
                                                                                                       
    EXEC [stage].[SP_UKG_EMPL_DATA_CleanUp-Step1];
                                                                                                                                                                                                           
    EXEC [stage].[SP_UKG_EMPL_Inactive_Manager_Hierarchy_LOOKUP_BUILD-Step2];
                                                                                                                                                                                
    EXEC [stage].[SP_UKG_EMPL_DATA_Update_imgr-Step3];
                                                                                                                                                                                                       
    EXEC [stage].[SP_UKG_EMPL_Update_Manager_Flag-Step4];
                                                                                                                                                                                                    
    EXEC [stage].[SP_UKG_EMPL_DATA_Update_LMS-Step5];
                                                                                                                                                                                                        

                                                                                                                                                                                                                                                             
    -- Add indexes to UKG_EMPLOYEE_DATA_TEMP for performance
                                                                                                                                                                                                 
    DROP INDEX IF EXISTS UKG_EMPLOYEE_DATA_TEMP_IDX_1 ON [dbo].[UKG_EMPLOYEE_DATA_TEMP];
                                                                                                                                                                     
    DROP INDEX IF EXISTS UKG_EMPLOYEE_DATA_TEMP_IDX_2 ON [dbo].[UKG_EMPLOYEE_DATA_TEMP];
                                                                                                                                                                     
    DROP INDEX IF EXISTS UKG_EMPLOYEE_DATA_TEMP_IDX_3 ON [dbo].[UKG_EMPLOYEE_DATA_TEMP];
                                                                                                                                                                     
    DROP INDEX IF EXISTS UKG_EMPLOYEE_DATA_TEMP_IDX_4 ON [dbo].[UKG_EMPLOYEE_DATA_TEMP];
                                                                                                                                                                     
    CREATE INDEX UKG_EMPLOYEE_DATA_TEMP_IDX_1 ON [dbo].[UKG_EMPLOYEE_DATA_TEMP] (EMPLID);
                                                                                                                                                                    
    CREATE INDEX UKG_EMPLOYEE_DATA_TEMP_IDX_2 ON [dbo].[UKG_EMPLOYEE_DATA_TEMP] (jobcode);
                                                                                                                                                                   
    CREATE INDEX UKG_EMPLOYEE_DATA_TEMP_IDX_3 ON [dbo].[UKG_EMPLOYEE_DATA_TEMP] ([Person Number]);
                                                                                                                                                           
    CREATE INDEX UKG_EMPLOYEE_DATA_TEMP_IDX_4 ON [dbo].[UKG_EMPLOYEE_DATA_TEMP] (NON_UKG_MANAGER_FLAG);
                                                                                                                                                      

                                                                                                                                                                                                                                                             
    EXEC [stage].[SP_NON_UKG_MANAGER_HISTORY_MERGE]
                                                                                                                                                                                                          
    --12/01/2025 Merges Non-UKG Manager employee (and UKG Manager with BYA) into the NON_UKG_MANAGER_HISTORY table
                                                                                                                                           
    ;
                                                                                                                                                                                                                                                        

                                                                                                                                                                                                                                                             
    -- Refresh table [hts].[UKG_DifferentialEligibilityCodes]
                                                                                                                                                                                                
    truncate table [hts].[UKG_DifferentialEligibilityCodes];
                                                                                                                                                                                                 
    insert into hts.UKG_DifferentialEligibilityCodes
                                                                                                                                                                                                         
    select distinct setid, jobcode, differncds
                                                                                                                                                                                                               
    from [hts].[UKG_differncds];
                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
    -- Update [Custom Field 17] in [dbo].[NON_UKG_MANAGER_HISTORY]
                                                                                                                                                                                           
    UPDATE [dbo].[NON_UKG_MANAGER_HISTORY]
                                                                                                                                                                                                                   
    SET [Custom Field 17] = B.differncds
                                                                                                                                                                                                                     
    FROM [dbo].[NON_UKG_MANAGER_HISTORY] T
                                                                                                                                                                                                                   
        INNER JOIN hts.UKG_DifferentialEligibilityCodes B -- 12/02/2025 Jim Shih: replace [hts].[UKG_differncds] with hts.UKG_DifferentialEligibilityCodes
                                                                                                   
        ON T.jobcode = B.jobcode;
                                                                                                                                                                                                                            

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
    -- Add index on NON_UKG_MANAGER_HISTORY for exclusion lookup performance
                                                                                                                                                                                 
    DROP INDEX IF EXISTS NON_UKG_MANAGER_HISTORY_IDX_1 ON [dbo].[NON_UKG_MANAGER_HISTORY];
                                                                                                                                                                   
    DROP INDEX IF EXISTS NON_UKG_MANAGER_HISTORY_IDX_2 ON [dbo].[NON_UKG_MANAGER_HISTORY];
                                                                                                                                                                   
    CREATE INDEX NON_UKG_MANAGER_HISTORY_IDX_1 ON [dbo].[NON_UKG_MANAGER_HISTORY] ([Person Number]);
                                                                                                                                                         
    CREATE INDEX NON_UKG_MANAGER_HISTORY_IDX_2 ON [dbo].[NON_UKG_MANAGER_HISTORY] (NOTE);
                                                                                                                                                                    

                                                                                                                                                                                                                                                             
    DROP TABLE IF EXISTS [dbo].[UKG_EMPLOYEE_DATA];
                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    select *
                                                                                                                                                                                                                                                 
    INTO [dbo].[UKG_EMPLOYEE_DATA]
                                                                                                                                                                                                                           
    from [dbo].[UKG_EMPLOYEE_DATA_TEMP]
                                                                                                                                                                                                                      
    where
                                                                                                                                                                                                                                                    
EMPLID NOT IN (SELECT emplid
                                                                                                                                                                                                                                 
        FROM STAGE.CTE_exclude_BYA) --12/01/2025 exclude BYA
                                                                                                                                                                                                 
        AND
                                                                                                                                                                                                                                                  
        EMPLID NOT IN (SELECT [Person Number]
                                                                                                                                                                                                                
        from [dbo].[NON_UKG_MANAGER_HISTORY]
                                                                                                                                                                                                                 
        where NOTE is NULL)
                                                                                                                                                                                                                                  
    --12/01/2025 exclude emplid in NON_UKG_MANAGER_HISTORY table
                                                                                                                                                                                             
    ;
                                                                                                                                                                                                                                                        

                                                                                                                                                                                                                                                             
    -- Add index for performance on the UPDATE operation
                                                                                                                                                                                                     
    DROP INDEX IF EXISTS UKG_EMPLOYEE_DATA_IDX_1 ON [dbo].[UKG_EMPLOYEE_DATA];
                                                                                                                                                                               
    CREATE INDEX UKG_EMPLOYEE_DATA_IDX_1 ON [dbo].[UKG_EMPLOYEE_DATA] (jobcode);
                                                                                                                                                                             

                                                                                                                                                                                                                                                             
    alter table [dbo].[UKG_EMPLOYEE_DATA]
                                                                                                                                                                                                                    
ALTER COLUMN [Custom Field 17] varchar(50) NULL
                                                                                                                                                                                                              
;
                                                                                                                                                                                                                                                            

                                                                                                                                                                                                                                                             
    -- CTE to check jobcode setid for SDMED exclusion
                                                                                                                                                                                                        
    WITH
                                                                                                                                                                                                                                                     
        check_jobcode
                                                                                                                                                                                                                                        
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT e.[setid]
                                                                                                                                                                                                                                 
              , e.[jobcode] 
                                                                                                                                                                                                                                 
              , erncd.[differncds]
                                                                                                                                                                                                                           
            FROM [hts].[UKG_DifferentialEligibilityCodes] erncd
                                                                                                                                                                                              
                JOIN health_ODS.[Health_ODS].hcm_ods.PS_UC_SHFT_ONC_ERN e
                                                                                                                                                                                    
                ON erncd.setid = e.setid
                                                                                                                                                                                                                     
        )
                                                                                                                                                                                                                                                    

                                                                                                                                                                                                                                                             
    -- Update [Custom Field 17] in [dbo].[UKG_EMPLOYEE_DATA]
                                                                                                                                                                                                 
    UPDATE [dbo].[UKG_EMPLOYEE_DATA]
                                                                                                                                                                                                                         
    SET [Custom Field 17] = CASE 
                                                                                                                                                                                                                            
                                WHEN check_jobcode.setid = 'SDMED' AND check_jobcode.differncds IS NULL THEN 'XXX'
                                                                                                                                           
                                ELSE B.differncds 
                                                                                                                                                                                                           
                            END
                                                                                                                                                                                                                              
    FROM [dbo].[UKG_EMPLOYEE_DATA] T
                                                                                                                                                                                                                         
        INNER JOIN hts.UKG_DifferentialEligibilityCodes B -- 12/02/2025 Jim Shih: replace [hts].[UKG_differncds] with hts.UKG_DifferentialEligibilityCodes
                                                                                                   
        ON T.jobcode = B.jobcode
                                                                                                                                                                                                                             
        LEFT JOIN check_jobcode
                                                                                                                                                                                                                              
        ON check_jobcode.jobcode = T.jobcode;
                                                                                                                                                                                                                

                                                                                                                                                                                                                                                             
    -- 12/07/2025 Jim Shih: Set Custom Field 17 to 'XXX' when NULL or blank
                                                                                                                                                                                  
    UPDATE [dbo].[UKG_EMPLOYEE_DATA]
                                                                                                                                                                                                                         
    SET [Custom Field 17] = 'XXX'
                                                                                                                                                                                                                            
    WHERE [Custom Field 17] IS NULL OR [Custom Field 17] = '';
                                                                                                                                                                                               

                                                                                                                                                                                                                                                             
    -- 7/26/2025
                                                                                                                                                                                                                                             
    -- add troubleshooting worker type comments
                                                                                                                                                                                                              
    --DROP TABLE IF EXISTS STAGE.UKG_COMBOCD_T;
                                                                                                                                                                                                              
    --DROP TABLE IF EXISTS STAGE.UKG_EMPL_FTE_T;
                                                                                                                                                                                                             
    --DROP TABLE IF EXISTS STAGE.UKG_EMPL_FTE_T;	 
                                                                                                                                                                                                           

                                                                                                                                                                                                                                                             
    -- ***LOOP TO DROP ANY 30 DAY OLD and TODAY?S UKG_EMPLOYEE_DATA_V_SNAPSHOT TABLES ***--
                                                                                                                                                                  
    DECLARE @SQL_DROP NVARCHAR(MAX)
                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    SELECT
                                                                                                                                                                                                                                                   
        @SQL_DROP = COALESCE(@SQL_DROP + ' ;', '') +       
                                                                                                                                                                                                  
         'DROP TABLE ' + QUOTENAME(S.NAME) + '.' + QUOTENAME(T.NAME)
                                                                                                                                                                                         
    FROM SYS.SCHEMAS S
                                                                                                                                                                                                                                       
        INNER JOIN SYS.TABLES T ON T.SCHEMA_ID = S.SCHEMA_ID
                                                                                                                                                                                                 
    WHERE S.NAME IN ( 'BCK')
                                                                                                                                                                                                                                 
        AND T.NAME LIKE 'UKG_EMPLOYEE_DATA_V_SNAPSHOT_%'
                                                                                                                                                                                                     
        AND ( CAST(SUBSTRING (T.NAME,30, 10 ) AS DATE) <  CAST(DATEADD(DAY,-30, GETDATE())   AS DATE) OR CAST(SUBSTRING (T.NAME,30, 10 ) AS DATE) =  CAST(GETDATE()       AS DATE) )
                                                                         

                                                                                                                                                                                                                                                             
    --PRINT @SQL_DROP  
                                                                                                                                                                                                                                      
    EXEC(@SQL_DROP)
                                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
    --*** CREATE SNAPSHOT TABLE FROM TODAY'S IVEW dbo.UKG_EMPLOYEE_DATA_V ***--
                                                                                                                                                                              

                                                                                                                                                                                                                                                             
    DECLARE @SQL_CREATE NVARCHAR(MAX)
                                                                                                                                                                                                                        
    ;
                                                                                                                                                                                                                                                        
    DECLARE @SNAPSHOT_TABLENAME NVARCHAR(50);
                                                                                                                                                                                                                

                                                                                                                                                                                                                                                             
    SET @SNAPSHOT_TABLENAME = 'UKG_EMPLOYEE_DATA_V_SNAPSHOT_'+CAST(CAST(GETDATE() AS DATE) AS CHAR(10));
                                                                                                                                                     

                                                                                                                                                                                                                                                             
    SELECT
                                                                                                                                                                                                                                                   
        @SQL_CREATE =  
                                                                                                                                                                                                                                      
        N'DROP TABLE IF EXISTS bck.[' + @SNAPSHOT_TABLENAME + ']; ' +
                                                                                                                                                                                        
        N'SELECT * INTO bck.[' + @SNAPSHOT_TABLENAME + '] FROM dbo.UKG_EMPLOYEE_DATA_V';
                                                                                                                                                                     

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
    --PRINT @SQL_CREATE;
                                                                                                                                                                                                                                     
    EXEC(@SQL_CREATE)
                                                                                                                                                                                                                                        

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
END;

-- ===== dbo.UKG_JOBGROUP_BUILD =====

                                                                                                                                                                                                                                                             
/***************************************
                                                                                                                                                                                                                     
* Created By: May Xu	
                                                                                                                                                                                                                                        
* Table: This SP creates table [dbo].UKG_JOBGROUP	to create file BS_Jobs_Import.csv
                                                                                                                                                                          
* EXEC 	[dbo].UKG_JOBGROUP_BUILD	
                                                                                                                                                                                                                            
* -- 04/28/2025 May Xu: Created
                                                                                                                                                                                                                              
* -- 07/07/2025 Jim Shih
                                                                                                                                                                                                                                     
* -- Per J.k. The Job Full Name should also be the Job Group and the Description should be the Job Code Title.
                                                                                                                                               
*-- 7/14/2025 Jim Shih
                                                                                                                                                                                                                                       
*-- migrate from hs-ssisp-v
                                                                                                                                                                                                                                  
*--  FROM EcoTime_RPT.TEST.TSR_JobGroups --> dbo.JobGroups
                                                                                                                                                                                                   
*-- 7/28/2025 Jim Shih
                                                                                                                                                                                                                                       
*-- 7/28/2025 May Xu:  add 30 day snapshot
                                                                                                                                                                                                                   
*-- from dbo.JobGroups --> [hts].[UKG_JobGroups]
                                                                                                                                                                                                             
*-- 8/4/2025   Jim Shih: add DROP TABLE IF EXISTS
                                                                                                                                                                                                            
******************************************/		
                                                                                                                                                                                                                

                                                                                                                                                                                                                                                             
CREATE PROCEDURE "dbo"."UKG_JOBGROUP_BUILD"
                                                                                                                                                                                                                  
AS  
                                                                                                                                                                                                                                                         

                                                                                                                                                                                                                                                             
BEGIN 
                                                                                                                                                                                                                                                       

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
DROP TABLE IF EXISTS [dbo].UKG_JOBGROUP;
                                                                                                                                                                                                                     

                                                                                                                                                                                                                                                             
SELECT  DISTINCT 
                                                                                                                                                                                                                                            
JOBGROUP AS [Job Name],
                                                                                                                                                                                                                                      
--JobGroupTitle AS [Job Full Name],
                                                                                                                                                                                                                          
JOBGROUP AS [Job Full Name],
                                                                                                                                                                                                                                 
JobGroupTitle AS [Job Description],
                                                                                                                                                                                                                          
'' AS [Display Order],
                                                                                                                                                                                                                                       
'1900-01-01' AS [Effective Date],
                                                                                                                                                                                                                            
'3000-01-01' AS [Expiration Date],
                                                                                                                                                                                                                           
'' AS [Color],
                                                                                                                                                                                                                                               
'' AS [Job Code],
                                                                                                                                                                                                                                            
'' AS [External ID]
                                                                                                                                                                                                                                          
INTO [dbo].UKG_JOBGROUP	
                                                                                                                                                                                                                                     
 FROM [hts].[UKG_JobGroups]
                                                                                                                                                                                                                                  
WHERE 	1=1 
                                                                                                                                                                                                                                                  

                                                                                                                                                                                                                                                             
  -- ***LOOP TO DROP ANY 30 DAY OLD and TODAY?S UKG_JOBGROUP_SNAPSHOT TABLES ***--
                                                                                                                                                                           
DECLARE @SQL_DROP NVARCHAR(MAX)   
                                                                                                                                                                                                                           
       
                                                                                                                                                                                                                                                      
SELECT 
                                                                                                                                                                                                                                                      
    @SQL_DROP = COALESCE(@SQL_DROP + ' ;', '') +       
                                                                                                                                                                                                      
         'DROP TABLE ' + QUOTENAME(S.NAME) + '.' + QUOTENAME(T.NAME)    
                                                                                                                                                                                     
    FROM SYS.SCHEMAS S      
                                                                                                                                                                                                                                 
    INNER JOIN SYS.TABLES T ON T.SCHEMA_ID = S.SCHEMA_ID       
                                                                                                                                                                                              
    WHERE S.NAME IN ( 'BCK')        
                                                                                                                                                                                                                         
     AND T.NAME LIKE 'UKG_JOBGROUP_SNAPSHOT_%' 
                                                                                                                                                                                                              
     AND ( CAST(SUBSTRING (T.NAME,23, 10 ) AS DATE) <  CAST(DATEADD(DAY,-30, GETDATE())   AS DATE)   OR CAST(SUBSTRING (T.NAME,23, 10 ) AS DATE) =  CAST(GETDATE()       AS DATE) )
                                                                          
                     
                                                                                                                                                                                                                                        
--PRINT @SQL_DROP  
                                                                                                                                                                                                                                          
EXEC(@SQL_DROP)
                                                                                                                                                                                                                                              
 
                                                                                                                                                                                                                                                            

                                                                                                                                                                                                                                                             
--*** CREATE SNAPSHOT TABLE  ***--
                                                                                                                                                                                                                           

                                                                                                                                                                                                                                                             
DECLARE @SQL_CREATE NVARCHAR(MAX) ;  
                                                                                                                                                                                                                        
DECLARE @SNAPSHOT_TABLENAME NVARCHAR(50); 
                                                                                                                                                                                                                   

                                                                                                                                                                                                                                                             
SET @SNAPSHOT_TABLENAME = 'UKG_JOBGROUP_SNAPSHOT_'+CAST(CAST(GETDATE() AS DATE) AS CHAR(10));
                                                                                                                                                                
       
                                                                                                                                                                                                                                                      
SELECT 
                                                                                                                                                                                                                                                      
    @SQL_CREATE = 
                                                                                                                                                                                                                                           
	--N'SELECT  * INTO BCK.[' +  @SNAPSHOT_TABLENAME + ']' + ' FROM dbo.UKG_JOBGROUP';    
                                                                                                                                                                      
        N'DROP TABLE IF EXISTS bck.[' + @SNAPSHOT_TABLENAME + ']; ' +
                                                                                                                                                                                        
        N'SELECT * INTO bck.[' + @SNAPSHOT_TABLENAME + '] FROM dbo.UKG_JOBGROUP';
                                                                                                                                                                            
    
                                                                                                                                                                                                                                                         
--PRINT @SQL_CREATE;
                                                                                                                                                                                                                                         
EXEC(@SQL_CREATE)
                                                                                                                                                                                                                                            
END;

-- ===== dbo.UKG_LABOR_CATEGORY_ENTRY_BUILD =====

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
 
                                                                                                                                                                                                                                                            
/***************************************
                                                                                                                                                                                                                     
* -- EXEC [dbo].[UKG_LABOR_CATEGORY_ENTRY_BUILD]
                                                                                                                                                                                                             
* Created By: May Xu	
                                                                                                                                                                                                                                        
* Table: This SP creates table [dbo].[UKG_Labor_Category_Entry] for Labor_category_entry.csv
                                                                                                                                                                 
* [dbo].[UKG_LABOR_CATEGORY_ENTRY_BUILD]	
                                                                                                                                                                                                                    
* -- 05/06/2025 May Xu: Created
                                                                                                                                                                                                                              
* -- 05/28/2025 Jim Shih: modify based on JK's document on 5/28, Updated based upon WFM Name
                                                                                                                                                                 
* -- 06/27/2025 Jim Shih: modify based on JK's document on 6/27, Updated based upon WFM Name
                                                                                                                                                                 
* -- 07/03/2025 Jim Shih: JOB_INDICATOR+ '-' + jobcode + '-' +	 POSITION_DESCR AS 'Description', Updated based upon WFM Name
                                                                                                                                 
* -- 07/28/2025 May Xu: add code to create a snapshot of the table UKG_LABOR_CATEGORY_ENTRY and drop any 30 days old snapshot
                                                                                                                                
* -- 08/04/2025 Jim Shis: FIXED special characters issue
                                                                                                                                                                                                     
* -- 08/13/2025 Jim Shih: add + '-' + BUSINESS_UNIT 
                                                                                                                                                                                                         
* -- 					 JOB_INDICATOR+ '-' + jobcode + '-' +	 POSITION_DESCR + '-' + BUSINESS_UNIT AS 'Description',  -- 8/13
                                                                                                                                             
******************************************/	 	 
                                                                                                                                                                                                              

                                                                                                                                                                                                                                                             
CREATE          PROCEDURE [dbo].[UKG_LABOR_CATEGORY_ENTRY_BUILD]
                                                                                                                                                                                             
AS  
                                                                                                                                                                                                                                                         

                                                                                                                                                                                                                                                             
BEGIN 
                                                                                                                                                                                                                                                       

                                                                                                                                                                                                                                                             
DROP TABLE IF EXISTS [dbo].UKG_LABOR_CATEGORY_ENTRY;
                                                                                                                                                                                                         

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
SELECT DISTINCT 
                                                                                                                                                                                                                                             
       POSITION_NBR + '_' + CAST(EMPL_rcd AS VARCHAR)  AS 'Labor Category Entry Name',
                                                                                                                                                                       
--       jobcode + '-' +	 POSITION_DESCR AS 'Description',  -- ODS: Job_indicator_ps_job.jobcode +'-' + ps_positiondata.descr
                                                                                                                                
	   JOB_INDICATOR+ '-' + jobcode + '-' +	 POSITION_DESCR + '-' + BUSINESS_UNIT AS 'Description',  -- 8/13
                                                                                                                                                    
       '0' AS 'InactiveFlag',
                                                                                                                                                                                                                                
--     'Position' AS 'Labor Category Name'	-- 5/6   
                                                                                                                                                                                                         
--     'Position_Record Number' AS 'Labor Category Name'  -- 5/28
                                                                                                                                                                                            
       'Position_Record_Number' AS 'Labor Category Name'  -- 6/27 from Position_Record Number to Position_Record_Number
                                                                                                                                      
INTO [dbo].UKG_LABOR_CATEGORY_ENTRY
                                                                                                                                                                                                                          
FROM health_ods.[Health_ODS].[RPT].CURRENT_EMPL_DATA EMPL
                                                                                                                                                                                                    
WHERE 1=1 
                                                                                                                                                                                                                                                   
 -- AND EMPL.JOB_INDICATOR = 'P'   
                                                                                                                                                                                                                          
  AND (EMPL.VC_CODE = 'VCHSH'   	 --MED CENTER
                                                                                                                                                                                                               
       OR (EMPL.DEPTID BETWEEN '002000' AND '002999' AND EMPL.DEPTID NOT IN ('002230','002231','002280') )	 -- PHSO
                                                                                                                                          
       )
                                                                                                                                                                                                                                                     
  AND ((EMPL.hr_status = 'A' 	) 	 -- active empl
                                                                                                                                                                                                             
       OR  (EMPL.hr_status = 'I' and CONVERT(DATE, effdt) = CONVERT(DATE, GETDATE()))	 --terminated empl today
                                                                                                                                               
	   )
                                                                                                                                                                                                                                                        
  AND PAY_FREQUENCY = 'B'	
                                                                                                                                                                                                                                   
  AND EMPL_TYPE = 'H' -- Biweekly and hourly empl only
                                                                                                                                                                                                       
  AND NOT (EMPL.DEPTID IN ('002053','002056','003919') AND EMPL.JOBCODE IN ('000770','000771','000772','000775','000776')   )	--exclude ARC MSP POPULATION
                                                                                                   

                                                                                                                                                                                                                                                             
INSERT INTO  [dbo].UKG_LABOR_CATEGORY_ENTRY  
                                                                                                                                                                                                                
( [Labor Category Entry Name], [Description], [InactiveFlag],  [Labor Category Name]) 
                                                                                                                                                                       
SELECT DISTINCT 
                                                                                                                                                                                                                                             
       JOBCODE  AS 'Labor Category Entry Name',
                                                                                                                                                                                                              
       JOBCODE_DESCR AS 'Description',
                                                                                                                                                                                                                       
       '0' AS 'InactiveFlag',
                                                                                                                                                                                                                                
--     'Jobcode' AS 'Labor Category Name' 	  -- 5/6  
                                                                                                                                                                                                        
       'HR Job Code' AS 'Labor Category Name' -- 5/28
                                                                                                                                                                                                        
FROM health_ods.[Health_ODS].[RPT].current_empl_data empl
                                                                                                                                                                                                    
where 1=1 
                                                                                                                                                                                                                                                   
  --AND EMPL.JOB_INDICATOR = 'P'   
                                                                                                                                                                                                                          
  AND (EMPL.VC_CODE = 'VCHSH'   	 --MED CENTER
                                                                                                                                                                                                               
       OR (EMPL.DEPTID BETWEEN '002000' AND '002999' AND EMPL.DEPTID NOT IN ('002230','002231','002280') )	 -- PHSO
                                                                                                                                          
       )
                                                                                                                                                                                                                                                     
  AND ((EMPL.hr_status = 'A' 	) 	 -- active empl
                                                                                                                                                                                                             
       OR  (EMPL.hr_status = 'I' and CONVERT(DATE, effdt) = CONVERT(DATE, GETDATE()))	 --terminated empl today
                                                                                                                                               
	   )
                                                                                                                                                                                                                                                        
  AND PAY_FREQUENCY = 'B'	
                                                                                                                                                                                                                                   
  AND EMPL_TYPE = 'H' -- Biweekly and hourly empl only
                                                                                                                                                                                                       
  AND NOT (EMPL.DEPTID IN ('002053','002056','003919') AND EMPL.JOBCODE IN ('000770','000771','000772','000775','000776')   )	--exclude ARC MSP POPULATION
                                                                                                   

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
-- fix special characters issue
                                                                                                                                                                                                                              
DROP TABLE if exists [stage].[UKG_LABOR_CATEGORY_ENTRY_BUILD_FIXED_SPEC_CHAR];
                                                                                                                                                                               

                                                                                                                                                                                                                                                             
    SELECT * 
                                                                                                                                                                                                                                                
    INTO [stage].[UKG_LABOR_CATEGORY_ENTRY_BUILD_FIXED_SPEC_CHAR]
                                                                                                                                                                                            
    FROM [dbo].[UKG_LABOR_CATEGORY_ENTRY_V]
                                                                                                                                                                                                                  
;
                                                                                                                                                                                                                                                            

                                                                                                                                                                                                                                                             
truncate table [dbo].[UKG_LABOR_CATEGORY_ENTRY];
                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
INSERT INTO [dbo].[UKG_LABOR_CATEGORY_ENTRY]
                                                                                                                                                                                                                 
           ([Labor Category Entry Name]
                                                                                                                                                                                                                      
           ,[Description]
                                                                                                                                                                                                                                    
 ,[InactiveFlag]
                                                                                                                                                                                                                                             
           ,[Labor Category Name])
                                                                                                                                                                                                                           
SELECT [Labor Category Entry Name]
                                                                                                                                                                                                                           
      ,[Description]
                                                                                                                                                                                                                                         
      ,[InactiveFlag]
                                                                                                                                                                                                                                        
      ,[Labor Category Name]
                                                                                                                                                                                                                                 
  FROM [stage].[UKG_LABOR_CATEGORY_ENTRY_BUILD_FIXED_SPEC_CHAR]
                                                                                                                                                                                              
;
                                                                                                                                                                                                                                                            

                                                                                                                                                                                                                                                             
    -- ***LOOP TO DROP ANY 30 DAY OLD and TODAY’S UKG_LABOR_CATEGORY_ENTRY_SNAPSHOT TABLES ***--
                                                                                                                                                             
DECLARE @SQL_DROP NVARCHAR(MAX)   
                                                                                                                                                                                                                           
       
                                                                                                                                                                                                                                                      
SELECT 
                                                                                                                                                                                                                                                      
    @SQL_DROP = COALESCE(@SQL_DROP + ' ;', '') +       
                                                                                                                                                                                                      
         'DROP TABLE ' + QUOTENAME(S.NAME) + '.' + QUOTENAME(T.NAME)    
                                                                                                                                                                                     
    FROM SYS.SCHEMAS S      
                                                                                                                                                                                                                                 
    INNER JOIN SYS.TABLES T ON T.SCHEMA_ID = S.SCHEMA_ID       
                                                                                                                                                                                              
    WHERE S.NAME IN ( 'BCK')        
                                                                                                                                                                                                                         
     AND T.NAME LIKE 'UKG_LABOR_CATEGORY_ENTRY_SNAPSHOT_%' 
                                                                                                                                                                                                  
     AND ( CAST(SUBSTRING (T.NAME,35, 10 ) AS DATE) <  CAST(DATEADD(DAY,-30, GETDATE())   AS DATE)   OR CAST(SUBSTRING (T.NAME,35, 10 ) AS DATE) =  CAST(GETDATE()       AS DATE) )
                                                                          
                     
                                                                                                                                                                                                                                        
--PRINT @SQL_DROP  
                                                                                                                                                                                                                                          
EXEC(@SQL_DROP)
                                                                                                                                                                                                                                              
 
                                                                                                                                                                                                                                                            

                                                                                                                                                                                                                                                             
--*** CREATE SNAPSHOT TABLE  ***--
                                                                                                                                                                                                                           

                                                                                                                                                                                                                                                             
DECLARE @SQL_CREATE NVARCHAR(MAX) ;  
                                                                                                                                                                                                                        
DECLARE @SNAPSHOT_TABLENAME NVARCHAR(50); 
                                                                                                                                                                                                                   

                                                                                                                                                                                                                                                             
SET @SNAPSHOT_TABLENAME = 'UKG_LABOR_CATEGORY_ENTRY_SNAPSHOT_'+CAST(CAST(GETDATE() AS DATE) AS CHAR(10));
                                                                                                                                                    

                                                                                                                                                                                                                                                             
SELECT 
                                                                                                                                                                                                                                                      
    @SQL_CREATE =  
                                                                                                                                                                                                                                          
        N'DROP TABLE IF EXISTS bck.[' + @SNAPSHOT_TABLENAME + ']; ' +
                                                                                                                                                                                        
        N'SELECT * INTO bck.[' + @SNAPSHOT_TABLENAME + '] FROM dbo.UKG_LABOR_CATEGORY_ENTRY';
                                                                                                                                                                
     
                                                                                                                                                                                                                                                        
    
                                                                                                                                                                                                                                                         
--PRINT @SQL_CREATE;
                                                                                                                                                                                                                                         
EXEC(@SQL_CREATE)
                                                                                                                                                                                                                                            
  
                                                                                                                                                                                                                                                           
END;

-- ===== dbo.UKG_LABOR_CATEGORY_ENTRY_LIST_and_PROFILE_BUILD =====

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
/***************************************
                                                                                                                                                                                                                     
* Created By: May Xu	
                                                                                                                                                                                                                                        
* Table: This SP creates table [dbo].[UKG_LABOR_CATEGORY_ENTRY_LIST] for labor_category_entry_list.csv
                                                                                                                                                       
         [dbo].UKG_LABOR_CATEGORY_PROFILE for labor_category_profile.csv
                                                                                                                                                                                     
* EXEC [dbo].UKG_LABOR_CATEGORY_ENTRY_LIST_and_PROFILE_BUILD	
                                                                                                                                                                                                
* -- 05/06/2025 May Xu: Created
                                                                                                                                                                                                                              
* -- 06/04/2025 Jim Shih: replace LIVED_LAST_FIRST_NAME with LIVED_FIRST_LAST_NAME, to avoid comma
                                                                                                                                                           
* -- 6/12/2025 Jim Shih: rename UKG_LABOR_CATEGORY_ENTRY_LIST_BUILD to UKG_LABOR_CATEGORY_ENTRY_LIST_and_PROFILE_BUILD	 
                                                                                                                                     
* -- 7/3/2025  Jim SHih:  AND Substring([Labor Category List Name], 10,  3)	= 'All' 
                                                                                                                                                                         
* -- 7/9/2025  May Xu: Change the list name and Labor category Name based on JohnK's request.
                                                                                                                                                                
* -- 7/14/2025 Jim Shih: Per JK, Please adjust the LC_Profile_Import extract to only include the _ALL for both Position and Job Code.
                                                                                                                        
*-- migrate from hs-ssisp-v
                                                                                                                                                                                                                                  
*-- 07/28/2025 May Xu: add code to create a snapshot of UKG_LABOR_CATEGORY_ENTRY_LIST and drop any 30 days old snapshot
                                                                                                                                      
*-- 8/4/2025   Jim Shih: add DROP TABLE IF EXISTS
                                                                                                                                                                                                            
*-- 9/30/2025  Jim Shih: Per Jk, Please add entries for Labor Category 3 for Non-Exempt Employees to the LC_Profile_Import.csv file
                                                                                                                          
*-- 10/01/2025 Jim Shih: Per JK, The Comp entries are only required in the Profile file and not the Entry List file
                                                                                                                                          
*-- 11/09/2025 Jim Shih: Per JK, Please remove the logic from the Labor Category Profile that adds the Comp entry added in September
                                                                                                                         
******************************************/
                                                                                                                                                                                                                  

                                                                                                                                                                                                                                                             
CREATE PROCEDURE [dbo].[UKG_LABOR_CATEGORY_ENTRY_LIST_and_PROFILE_BUILD]
                                                                                                                                                                                     
AS  
                                                                                                                                                                                                                                                         

                                                                                                                                                                                                                                                             
BEGIN
                                                                                                                                                                                                                                                        

                                                                                                                                                                                                                                                             
    DROP TABLE IF EXISTS [dbo].UKG_LABOR_CATEGORY_ENTRY_LIST;
                                                                                                                                                                                                

                                                                                                                                                                                                                                                             
    SELECT *
                                                                                                                                                                                                                                                 
    INTO  [dbo].UKG_LABOR_CATEGORY_ENTRY_LIST
                                                                                                                                                                                                                
    FROM (
                                                                                                                                                                                                                                                   
                                    SELECT DISTINCT
                                                                                                                                                                                                          
                emplid +'_POS'+ '_All'  AS 'Labor Category List Name',
                                                                                                                                                                                       
                LIVED_FIRST_LAST_NAME AS  [List Description],
                                                                                                                                                                                                
                'Position_Record_Number' AS 'Labor Category Name',
                                                                                                                                                                                           
                position_nbr + '_' + cast (empl_rcd as varchar) AS [Assigned Entry]
                                                                                                                                                                          
            FROM health_ods.[Health_ODS].[RPT].CURRENT_EMPL_DATA EMPL
                                                                                                                                                                                        
            WHERE 1=1
                                                                                                                                                                                                                                        
                -- AND EMPL.JOB_INDICATOR = 'P'   
                                                                                                                                                                                                           
                AND (EMPL.VC_CODE = 'VCHSH' --MED CENTER
                                                                                                                                                                                                     
                OR (EMPL.DEPTID BETWEEN '002000' AND '002999' AND EMPL.DEPTID NOT IN ('002230','002231','002280') )	 -- PHSO
                                                                                                                                 
   )
                                                                                                                                                                                                                                                         
                AND ((EMPL.hr_status = 'A' 	) -- active empl
                                                                                                                                                                                                 
                OR (EMPL.hr_status = 'I' and CONVERT(DATE, effdt) = CONVERT(DATE, GETDATE()))	 --terminated empl today
                                                                                                                                       
   )
                                                                                                                                                                                                                                                         
                AND PAY_FREQUENCY = 'B'
                                                                                                                                                                                                                      
                AND EMPL_TYPE = 'H' -- Biweekly and hourly empl only
                                                                                                                                                                                         
                AND NOT (EMPL.DEPTID IN ('002053','002056','003919') AND EMPL.JOBCODE IN ('000770','000771','000772','000775','000776')   )
                                                                                                                  
            --exclude ARC MSP POPULATION
                                                                                                                                                                                                                     

                                                                                                                                                                                                                                                             
        UNION
                                                                                                                                                                                                                                                
            SELECT DISTINCT
                                                                                                                                                                                                                                  
                emplid +'_POS'+ '_Secondary'  AS 'Labor Category List Name',
                                                                                                                                                                                 
                LIVED_FIRST_LAST_NAME AS  [List Description],
                                                                                                                                                                                                
                'Position_Record_Number' AS 'Labor Category Name',
                                                                                                                                                                                           
                position_nbr + '_' + cast (empl_rcd as varchar) AS [Assigned Entry]
                                                                                                                                                                          
            FROM health_ods.[Health_ODS].[RPT].current_empl_data empl
                                                                                                                                                                                        
            where 1=1
                                                                                                                                                                                                                                        
                AND EMPL.JOB_INDICATOR = 'S'
                                                                                                                                                                                                                 
                AND (EMPL.VC_CODE = 'VCHSH' --MED CENTER
                                                                                                                                                                                                     
                OR (EMPL.DEPTID BETWEEN '002000' AND '002999' AND EMPL.DEPTID NOT IN ('002230','002231','002280') )	 -- PHSO
                                                                                                                                 
   )
                                                                                                                                                                                                                                                         
                AND ((EMPL.hr_status = 'A' 	) -- active empl
                                                                                                                                                                                                 
                OR (EMPL.hr_status = 'I' and CONVERT(DATE, effdt) = CONVERT(DATE, GETDATE()))	 --terminated empl today
                                                                                                                                       
   )
                                                                                                                                                                                                                                                         
                AND PAY_FREQUENCY = 'B'
                                                                                                                                                                                                                      
                AND EMPL_TYPE = 'H' -- Biweekly and hourly empl only
                                                                                                                                                                                         
                AND NOT (EMPL.DEPTID IN ('002053','002056','003919') AND EMPL.JOBCODE IN ('000770','000771','000772','000775','000776')   )
                                                                                                                  
        --exclude ARC MSP POPULATION
                                                                                                                                                                                                                         

                                                                                                                                                                                                                                                             
        UNION
                                                                                                                                                                                                                                                
            SELECT DISTINCT
                                                                                                                                                                                                                                  
                emplid +'_JOB'+ '_All'  AS 'Labor Category List Name',
                                                                                                                                                                                       
                LIVED_FIRST_LAST_NAME AS  [List Description],
                                                                                                                                                                                                
                'HR Job Code' AS 'Labor Category Name',
                                                                                                                                                                                                      
                Jobcode AS [Assigned Entry]
                                                                                                                                                                                                                  
            FROM health_ods.[Health_ODS].[RPT].current_empl_data empl
                                                                                                                                                                                        
            where 1=1
                                                                                                                                                                                                                                        
                AND (EMPL.VC_CODE = 'VCHSH' --MED CENTER
                                                                                                                                                                                                     
                OR (EMPL.DEPTID BETWEEN '002000' AND '002999' AND EMPL.DEPTID NOT IN ('002230','002231','002280') )	 -- PHSO
                                                                                                                                 
   )
                                                                                                                                                                                                                                                         
                AND ((EMPL.hr_status = 'A' 	) -- active empl
                                                                                                                                                                                                 
                OR (EMPL.hr_status = 'I' and CONVERT(DATE, effdt) = CONVERT(DATE, GETDATE()))	 --terminated empl today
                                                                                                                                       
   )
                                                                                                                                                                                                                                                         
                AND PAY_FREQUENCY = 'B'
                                                                                                                                                                                                                      
                AND EMPL_TYPE = 'H' -- Biweekly and hourly empl only
                                                                                                                                                                                         
                AND NOT (EMPL.DEPTID IN ('002053','002056','003919') AND EMPL.JOBCODE IN ('000770','000771','000772','000775','000776')   )
                                                                                                                  
        --exclude ARC MSP POPULATION
                                                                                                                                                                                                                         

                                                                                                                                                                                                                                                             
        UNION
                                                                                                                                                                                                                                                
            SELECT DISTINCT
                                                                                                                                                                                                                                  
                emplid +'_JOB'+ '_Secondary'  AS 'Labor Category List Name',
                                                                                                                                                                                 
                LIVED_FIRST_LAST_NAME AS  [List Description],
                                                                                                                                                                                                
                'HR Job Code' AS 'Labor Category Name',
                                                                                                                                                                                                      
                Jobcode AS [Assigned Entry]
                                                                                                                                                                                                                  
            FROM health_ods.[Health_ODS].[RPT].current_empl_data empl
                                                                                                                                                                                        
            where 1=1
                                                                                                                                                                                                                                        
                AND EMPL.JOB_INDICATOR = 'S'
                                                                                                                                                                                                                 
                AND (EMPL.VC_CODE = 'VCHSH' --MED CENTER
                                                                                                                                                                                                     
                OR (EMPL.DEPTID BETWEEN '002000' AND '002999' AND EMPL.DEPTID NOT IN ('002230','002231','002280') )	 -- PHSO
                                                                                                                                 
   )
                                                                                                                                                                                                                                                         
                AND ((EMPL.hr_status = 'A' 	) -- active empl
                                                                                                                                                                                                 
                OR (EMPL.hr_status = 'I' and CONVERT(DATE, effdt) = CONVERT(DATE, GETDATE()))	 --terminated empl today
                                                                                                                                       
   )
                                                                                                                                                                                                                                                         
                AND PAY_FREQUENCY = 'B'
                                                                                                                                                                                                                      
                AND EMPL_TYPE = 'H' -- Biweekly and hourly empl only
                                                                                                                                                                                         
                AND NOT (EMPL.DEPTID IN ('002053','002056','003919') AND EMPL.JOBCODE IN ('000770','000771','000772','000775','000776')   )	--exclude ARC MSP POPULATION
                                                                                     
				
                                                                                                                                                                                                                                                         
        -- UNION -- 9/30/2025  Jim Shih: Per Jk, Please add entries for Labor Category 3 for Non-Exempt Employees
                                                                                                                                            
		-- 10/01/2025 Jim Shih: Per JK, The Comp entries are only required in the Profile file and not the Entry List file
                                                                                                                                         
            -- SELECT DISTINCT 
                                                                                                                                                                                                                              
                -- emplid  AS 'Labor Category List Name',
                                                                                                                                                                                                    
                -- LIVED_FIRST_LAST_NAME AS  [List Description],
                                                                                                                                                                                             
                -- 'Comp' AS 'Labor Category Name',
                                                                                                                                                                                                          
                -- 'Comp or Pay' AS [Assigned Entry]
                                                                                                                                                                                                         
            -- FROM health_ods.[Health_ODS].[RPT].current_empl_data empl
                                                                                                                                                                                     
            -- where 1=1
                                                                                                                                                                                                                                     
                -- AND EMPL.FLSA_STATUS = 'N'
                                                                                                                                                                                                                
                -- AND (EMPL.VC_CODE = 'VCHSH' --MED CENTER
                                                                                                                                                                                                  
                -- OR (EMPL.DEPTID BETWEEN '002000' AND '002999' AND EMPL.DEPTID NOT IN ('002230','002231','002280') )	 -- PHSO
                                                                                                                              
   -- )
                                                                                                                                                                                                                                                      
                -- AND ((EMPL.hr_status = 'A' 	) -- active empl
                                                                                                                                                                                              
                -- OR (EMPL.hr_status = 'I' and CONVERT(DATE, effdt) = CONVERT(DATE, GETDATE()))	 --terminated empl today
                                                                                                                                    
   -- )
                                                                                                                                                                                                                                                      
                -- AND PAY_FREQUENCY = 'B'
                                                                                                                                                                                                                   
                -- AND EMPL_TYPE = 'H' -- Biweekly and hourly empl only
                                                                                                                                                                                      
                -- AND NOT (EMPL.DEPTID IN ('002053','002056','003919') AND EMPL.JOBCODE IN ('000770','000771','000772','000775','000776')   )	--exclude ARC MSP POPULATION
                                                                                  
				
                                                                                                                                                                                                                                                         
 
                                                                                                                                                                                                                                                            
 ) TEMP;
                                                                                                                                                                                                                                                     
 
                                                                                                                                                                                                                                                            
-- 10/01/2025 Jim Shih: Per JK, The Comp entries are only required in the Profile file and not the Entry List file
                                                                                                                                           
 SELECT DISTINCT
                                                                                                                                                                                                                                             
    emplid  AS 'Labor Category List Name',
                                                                                                                                                                                                                   
    LIVED_FIRST_LAST_NAME AS  [List Description],
                                                                                                                                                                                                            
    'Comp' AS 'Labor Category Name',
                                                                                                                                                                                                                         
    'Comp or Pay' AS [Assigned Entry]
                                                                                                                                                                                                                        
INTO #TEMP_PH
                                                                                                                                                                                                                                                
FROM health_ods.[Health_ODS].[RPT].current_empl_data empl
                                                                                                                                                                                                    
WHERE 1=1
                                                                                                                                                                                                                                                    
    AND EMPL.FLSA_STATUS = 'N'
                                                                                                                                                                                                                               
    AND (EMPL.VC_CODE = 'VCHSH' --MED CENTER
                                                                                                                                                                                                                 
    OR (EMPL.DEPTID BETWEEN '002000' AND '002999' AND EMPL.DEPTID NOT IN ('002230','002231','002280')) ) -- PHSO
                                                                                                                                             
    AND ((EMPL.hr_status = 'A') -- active empl
                                                                                                                                                                                                               
    OR (EMPL.hr_status = 'I' and CONVERT(DATE, effdt) = CONVERT(DATE, GETDATE())) --terminated empl today
                                                                                                                                                    
    )
                                                                                                                                                                                                                                                        
    AND PAY_FREQUENCY = 'B'
                                                                                                                                                                                                                                  
    AND EMPL_TYPE = 'H' -- Biweekly and hourly empl only
                                                                                                                                                                                                     
    AND NOT (EMPL.DEPTID IN ('002053','002056','003919') AND EMPL.JOBCODE IN ('000770','000771','000772','000775','000776'))
                                                                                                                                 
--exclude ARC MSP POPULATION
                                                                                                                                                                                                                                 
;
                                                                                                                                                                                                                                                            

                                                                                                                                                                                                                                                             
    DROP TABLE IF EXISTS [dbo].UKG_LABOR_CATEGORY_PROFILE;
                                                                                                                                                                                                   

                                                                                                                                                                                                                                                             
    -- 7/14/2025 Jim Shih: Per JK, Please adjust the LC_Profile_Import extract to only include the _ALL for both Position and Job Code.
                                                                                                                      
    SELECT *
                                                                                                                                                                                                                                                 
    INTO  [dbo].UKG_LABOR_CATEGORY_PROFILE
                                                                                                                                                                                                                   
    FROM (
                                                                                                                                                                                                                                                   
                    SELECT DISTINCT
                                                                                                                                                                                                                          
                Substring([Labor Category List Name], 1,  8 ) AS 'Labor Category Profile Name',
                                                                                                                                                              
                [List Description] AS 'Profile Description',
                                                                                                                                                                                                 
                [Labor Category List Name] AS 'Labor Category List',
                                                                                                                                                                                         
                [Labor Category Name]   AS 'Labor Category List Category'
                                                                                                                                                                                    
            FROM [dbo].UKG_LABOR_CATEGORY_ENTRY_LIST
                                                                                                                                                                                                         
            WHERE [Labor Category Name] =	'HR Job Code'
                                                                                                                                                                                                      
                AND Substring([Labor Category List Name], 14,  3)	= 'All'
                                                                                                                                                                                    

                                                                                                                                                                                                                                                             
        UNION
                                                                                                                                                                                                                                                

                                                                                                                                                                                                                                                             
            SELECT DISTINCT
                                                                                                                                                                                                                                  
                Substring([Labor Category List Name], 1,  8 ) AS 'Labor Category Profile Name',
                                                                                                                                                              
                [List Description] AS 'Profile Description',
                                                                                                                                                                                                 
                [Labor Category List Name] AS 'Labor Category List',
                                                                                                                                                                                         
                [Labor Category Name]   AS 'Labor Category List Category'
                                                                                                                                                                                    
            FROM [dbo].UKG_LABOR_CATEGORY_ENTRY_LIST
                                                                                                                                                                                                         
            WHERE [Labor Category Name] =	'Position_Record_Number'
                                                                                                                                                                                           
                AND Substring([Labor Category List Name], 14,  3)	= 'All'    
                                                                                                                                                                                
				
                                                                                                                                                                                                                                                         
--        UNION -- 9/30/2025  Jim Shih: Per Jk, Please add entries for Labor Category 3 for Non-Exempt Employees
                                                                                                                                             
-- 11/09/2025 Jim Shih: Per JK, Please remove the logic from the Labor Category Profile that adds the Comp entry added in September
                                                                                                                          

                                                                                                                                                                                                                                                             
--SELECT DISTINCT
                                                                                                                                                                                                                                            
--    [Labor Category List Name] AS 'Labor Category Profile Name',
                                                                                                                                                                                           
--    [List Description] AS 'Profile Description',
                                                                                                                                                                                                           
--    'Comp or Pay' AS 'Labor Category List',
                                                                                                                                                                                                                
--    'Comp'   AS 'Labor Category List Category'
                                                                                                                                                                                                             
--FROM #TEMP_PH				
                                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    ) TEMP;
                                                                                                                                                                                                                                                  

                                                                                                                                                                                                                                                             
DROP TABLE #TEMP_PH
                                                                                                                                                                                                                                          
;
                                                                                                                                                                                                                                                            

                                                                                                                                                                                                                                                             
    -- ***LOOP TO DROP ANY 30 DAY OLD and TODAY'S UKG_LABOR_CATEGORY_ENTRY_LIST_SNAPSHOT TABLES ***--
                                                                                                                                                        
    DECLARE @SQL_DROP NVARCHAR(MAX)
                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    SELECT
                                                                                                                                                                                                                                                   
        @SQL_DROP = COALESCE(@SQL_DROP + ' ;', '') +       
                                                                                                                                                                                                  
         'DROP TABLE IF EXISTS ' + QUOTENAME(S.NAME) + '.' + QUOTENAME(T.NAME)
                                                                                                                                                                               
    FROM SYS.SCHEMAS S
                                                                                                                                                                                                                                       
        INNER JOIN SYS.TABLES T ON T.SCHEMA_ID = S.SCHEMA_ID
                                                                                                                                                                                                 
    WHERE S.NAME IN ( 'BCK')
                                                                                                                                                                                                                                 
        AND T.NAME LIKE 'UKG_LABOR_CATEGORY_ENTRY_LIST_SNAPSHOT_%'
                                                                                                                                                                                           
        AND ( CAST(SUBSTRING (T.NAME,40, 10 ) AS DATE) <  CAST(DATEADD(DAY,-30, GETDATE())   AS DATE) OR CAST(SUBSTRING (T.NAME,40, 10 ) AS DATE) =  CAST(GETDATE()       AS DATE) )
                                                                         

                                                                                                                                                                                                                                                             
    --PRINT @SQL_DROP  
                                                                                                                                                                                                                                      
    EXEC(@SQL_DROP)
                                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    --*** CREATE SNAPSHOT TABLE for UKG_LABOR_CATEGORY_ENTRY_LIST ***--
                                                                                                                                                                                      

                                                                                                                                                                                                                                                             
    DECLARE @SQL_CREATE NVARCHAR(MAX)
                                                                                                                                                                                                                        
    DECLARE @SNAPSHOT_TABLENAME NVARCHAR(50);
                                                                                                                                                                                                                

                                                                                                                                                                                                                                                             
    SET @SNAPSHOT_TABLENAME = 'UKG_LABOR_CATEGORY_ENTRY_LIST_SNAPSHOT_'+CAST(CAST(GETDATE() AS DATE) AS CHAR(10));
                                                                                                                                           

                                                                                                                                                                                                                                                             
    SELECT
                                                                                                                                                                                                                                                   
        @SQL_CREATE =  N'SELECT  * INTO BCK.[' +  @SNAPSHOT_TABLENAME + ']' + ' FROM dbo.UKG_LABOR_CATEGORY_ENTRY_LIST';
                                                                                                                                     

                                                                                                                                                                                                                                                             
    --PRINT @SQL_CREATE;
                                                                                                                                                                                                                                     
    EXEC(@SQL_CREATE)
                                                                                                                                                                                                                                        

                                                                                                                                                                                                                                                             
    -- ***LOOP TO DROP ANY 30 DAY OLD and TODAY'S UKG_LABOR_CATEGORY_PROFILE_SNAPSHOT TABLES ***--
                                                                                                                                                           

                                                                                                                                                                                                                                                             
    SET @SQL_DROP = NULL;
                                                                                                                                                                                                                                    
    -- Reset the variable for the second drop operation
                                                                                                                                                                                                      

                                                                                                                                                                                                                                                             
    SELECT
                                                                                                                                                                                                                                                   
        @SQL_DROP = COALESCE(@SQL_DROP + ' ;', '') +       
                                                                                                                                                                                                  
         'DROP TABLE IF EXISTS ' + QUOTENAME(S.NAME) + '.' + QUOTENAME(T.NAME)
                                                                                                                                                                               
    FROM SYS.SCHEMAS S
                                                                                                                                                                                                                                       
        INNER JOIN SYS.TABLES T ON T.SCHEMA_ID = S.SCHEMA_ID
                                                                                                                                                                                                 
    WHERE S.NAME IN ( 'BCK')
                                                                                                                                                                                                                                 
        AND T.NAME LIKE 'UKG_LABOR_CATEGORY_PROFILE_SNAPSHOT_%'
                                                                                                                                                                                              
        AND ( CAST(SUBSTRING (T.NAME,37, 10 ) AS DATE) <  CAST(DATEADD(DAY,-30, GETDATE())   AS DATE) OR CAST(SUBSTRING (T.NAME,37, 10 ) AS DATE) =  CAST(GETDATE()       AS DATE) )
                                                                         

                                                                                                                                                                                                                                                             
    --PRINT @SQL_DROP  
                                                                                                                                                                                                                                      
    EXEC(@SQL_DROP)
                                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    --*** CREATE SNAPSHOT TABLE  ***--	
                                                                                                                                                                                                                      

                                                                                                                                                                                                                                                             
    SET @SNAPSHOT_TABLENAME = 'UKG_LABOR_CATEGORY_PROFILE_SNAPSHOT_'+CAST(CAST(GETDATE() AS DATE) AS CHAR(10));
                                                                                                                                              

                                                                                                                                                                                                                                                             
    SELECT
                                                                                                                                                                                                                                                   
        @SQL_CREATE = 
                                                                                                                                                                                                                                       
        N'DROP TABLE IF EXISTS bck.[' + @SNAPSHOT_TABLENAME + ']; ' +
                                                                                                                                                                                        
        N'SELECT * INTO bck.[' + @SNAPSHOT_TABLENAME + '] FROM dbo.UKG_LABOR_CATEGORY_PROFILE';
                                                                                                                                                              

                                                                                                                                                                                                                                                             
    --PRINT @SQL_CREATE;
                                                                                                                                                                                                                                     
    EXEC(@SQL_CREATE)
                                                                                                                                                                                                                                        

                                                                                                                                                                                                                                                             
END;

-- ===== dbo.UKG_LOCATION_BUILD =====

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
/***************************************
                                                                                                                                                                                                                     
* Created By: May Xu	
                                                                                                                                                                                                                                        
* Table: This SP builds the UKG Business Structure table [dbo].UKG_LOCATION to create file BS_Locations_Import.csv
                                                                                                                                           
* EXEC 	[dbo].UKG_LOCATION_BUILD	
                                                                                                                                                                                                                            
* -- 04/28/2025 May Xu: Created
                                                                                                                                                                                                                              
* -- 05/05/2025 May Xu: Removed the last folder for each location level from [Parent Path]
                                                                                                                                                                   
* -- 05/07/2025 May Xu: Changed the entity to EntityTitle, serviceline to ServiceLineTitle for the [Parent Path]
                                                                                                                                             
* -- 05/14/2025 Jim Shih: For [dbo].UKG_LOCATION table, added a new column [Description] to store the description of each location level
                                                                                                                     
* -- 05/19/2025 Jim Shih: No need for Level 1 based on the meeting on 5/19/2025
                                                                                                                                                                              
* -- 07/11/2025 May Xu: add code to create a snapshot of the table UKG_LOCATION and drop any 30 days old snapshot
                                                                                                                                            
* -- 07/14/2025 Jim Shih
                                                                                                                                                                                                                                     
*-- migrate from hs-ssisp-v
                                                                                                                                                                                                                                  
* -- 07/31/2025 Jim Shih: Per JK: There were also '-' in the description field.  Special characters should  be removed from this field in the file and in the Business Structure Elements 
                                                                   
* -- 					  replace '/' with '-'
                                                                                                                                                                                                                             
* -- 08/04/2025 Jim Shis: EXEC [hts].[UKG_BusinessStructure_UPD] before EXEC [dbo].[UKG_LOCATION_BUILD]
                                                                                                                                                      
* --					  Per JK: Yes,  Call the procedure before running the statement and replace the function with the table. 
                                                                                                                                           
* --					  FIXED special characters issue
                                                                                                                                                                                                                    
******************************************/
                                                                                                                                                                                                                  

                                                                                                                                                                                                                                                             
CREATE PROCEDURE [dbo].[UKG_LOCATION_BUILD]
                                                                                                                                                                                                                  
AS  
                                                                                                                                                                                                                                                         
BEGIN 
                                                                                                                                                                                                                                                       

                                                                                                                                                                                                                                                             
-- EXEC [hts].[UKG_BusinessStructure_UPD] before EXEC [dbo].[UKG_LOCATION_BUILD]
                                                                                                                                                                             
EXEC [hts].[UKG_BusinessStructure_UPD];
                                                                                                                                                                                                                      

                                                                                                                                                                                                                                                             
DROP TABLE IF EXISTS [STAGE].UKG_LOCATION_TEMP;
                                                                                                                                                                                                              

                                                                                                                                                                                                                                                             
SELECT DISTINCT B.ORGANIZATION,
                                                                                                                                                                                                                              
        B.ORGANIZATIONTITLE, B.ENTITY, B.ENTITYTITLE, B.SERVICELINETITLE, 
                                                                                                                                                                                   
        B.SERVICELINE, B.FINANCIALUNIT, B.FINANCIALUNITTITLE,
                                                                                                                                                                                                
        B.FUNDGROUP, B.FUNDGROUPTITLE, E.JOBGROUP, J.JOBGROUPTITLE
                                                                                                                                                                                           
  INTO [STAGE].UKG_LOCATION_TEMP
                                                                                                                                                                                                                             
  FROM 
                                                                                                                                                                                                                                                      
  --dbo.[BUSINESSSTRUCTURE_GET]() B, -- comment out 8/4/2025
                                                                                                                                                                                                 
  [hts].[UKG_BusinessStructure] B,
                                                                                                                                                                                                                           
       dbo.UKG_EMPLOYEE_DATA E,
                                                                                                                                                                                                                              
       hts.UKG_JobGroups J 
                                                                                                                                                                                                                                  
 WHERE J.JOBGROUP = E.JOBGROUP
                                                                                                                                                                                                                               
   AND E.FUNDGROUP = B.FUNDGROUP 
                                                                                                                                                                                                                            
   AND E.[Home Business Structure Level 1 - Organization] != 'Non-Health';
                                                                                                                                                                                   

                                                                                                                                                                                                                                                             
-- Ensure [dbo].[UKG_LOCATION] exists before TRUNCATE
                                                                                                                                                                                                        
--IF OBJECT_ID('[dbo].[UKG_LOCATION]', 'U') IS NULL
                                                                                                                                                                                                          
--BEGIN
                                                                                                                                                                                                                                                      
--    CREATE TABLE [dbo].[UKG_LOCATION] (
                                                                                                                                                                                                                    
--        [Location Type] NVARCHAR(255),
                                                                                                                                                                                                                     
--        [Parent Path] NVARCHAR(255),
                                                                                                                                                                                                                       
--        [Location Name] NVARCHAR(255),
                                                                                                                                                                                                                     
--        [Full Name] NVARCHAR(255),
                                                                                                                                                                                                                         
--        [Description] NVARCHAR(255)
                                                                                                                                                                                                                        
--        -- Add other columns as needed to match your inserts
                                                                                                                                                                                               
--    );
                                                                                                                                                                                                                                                     
--END
                                                                                                                                                                                                                                                        
    IF OBJECT_ID('[dbo].[UKG_LOCATION]', 'U') IS NULL
                                                                                                                                                                                                        
    BEGIN
                                                                                                                                                                                                                                                    
        -- Create the UKG_LOCATION table
                                                                                                                                                                                                                     
        CREATE TABLE [dbo].[UKG_LOCATION](
                                                                                                                                                                                                                   
            [Location Type] [varchar](20) NOT NULL,
                                                                                                                                                                                                          
            [Parent Path] [varchar](100) NULL,
                                                                                                                                                                                                               
            [Location Name] [varchar](50) NULL,
                                                                                                                                                                                                              
            [Full Name] [varchar](100) NULL,
                                                                                                                                                                                                                 
            [Description] [varchar](500) NULL,
                                                                                                                                                                                                               
            [Effective Date] [varchar](10) NULL,
                                                                                                                                                                                                             
            [Expiration Date] [varchar](10) NULL,
                                                                                                                                                                                                            
            [Address] [varchar](1) NULL,
                                                                                                                                                                                                                     
            [Cost Center] [varchar](1) NULL,
                                                                                                                                                                                                                 
            [Direct Work Percent] [varchar](1) NULL,
                                                                                                                                                                                                         
            [Indirect Work Percent] [varchar](1) NULL,
                                                                                                                                                                                                       
            [Timezone] [varchar](1) NULL,
                                                                                                                                                                                                                    
            [Transferable] [varchar](1) NULL,
                                                                                                                                                                                                                
            [External ID] [varchar](1) NULL
                                                                                                                                                                                                                  
        ) ON [PRIMARY];
                                                                                                                                                                                                                                      

                                                                                                                                                                                                                                                             
        -- Add default constraints
                                                                                                                                                                                                                           
        ALTER TABLE [dbo].[UKG_LOCATION] ADD DEFAULT ('') FOR [Description];
                                                                                                                                                                                 
        ALTER TABLE [dbo].[UKG_LOCATION] ADD DEFAULT ('1900-01-01') FOR [Effective Date];
                                                                                                                                                                    
        ALTER TABLE [dbo].[UKG_LOCATION] ADD DEFAULT ('3000-01-01') FOR [Expiration Date];
                                                                                                                                                                   
        ALTER TABLE [dbo].[UKG_LOCATION] ADD DEFAULT ('') FOR [Address];
                                                                                                                                                                                     
        ALTER TABLE [dbo].[UKG_LOCATION] ADD DEFAULT ('') FOR [Cost Center];
                                                                                                                                                                                 
        ALTER TABLE [dbo].[UKG_LOCATION] ADD DEFAULT ('') FOR [Direct Work Percent];
                                                                                                                                                                         
        ALTER TABLE [dbo].[UKG_LOCATION] ADD DEFAULT ('') FOR [Indirect Work Percent];
                                                                                                                                                                       
        ALTER TABLE [dbo].[UKG_LOCATION] ADD DEFAULT ('') FOR [Timezone];
                                                                                                                                                                                    
        ALTER TABLE [dbo].[UKG_LOCATION] ADD DEFAULT ('') FOR [Transferable];
                                                                                                                                                                                
        ALTER TABLE [dbo].[UKG_LOCATION] ADD DEFAULT ('') FOR [External ID];
                                                                                                                                                                                 
        
                                                                                                                                                                                                                                                     
        PRINT 'UKG_LOCATION table created successfully.';
                                                                                                                                                                                                    
    END
                                                                                                                                                                                                                                                      
    ELSE
                                                                                                                                                                                                                                                     
    BEGIN
                                                                                                                                                                                                                                                    
        PRINT 'UKG_LOCATION table already exists. No action taken.';
                                                                                                                                                                                         
    END
                                                                                                                                                                                                                                                      

                                                                                                                                                                                                                                                             
TRUNCATE TABLE [dbo].UKG_LOCATION;
                                                                                                                                                                                                                           

                                                                                                                                                                                                                                                             
-- Organization Level 1
                                                                                                                                                                                                                                      
--INSERT INTO [dbo].UKG_LOCATION
                                                                                                                                                                                                                             
--      ([Location Type], [Parent Path], [Location Name], [Full Name], [Description]) 
                                                                                                                                                                       
--SELECT DISTINCT 'Organization', Organization, Organization, Organization, OrganizationTitle
                                                                                                                                                                
--  FROM [dbo].UKG_LOCATION_TEMP;
                                                                                                                                                                                                                            

                                                                                                                                                                                                                                                             
-- Entity Level 2
                                                                                                                                                                                                                                            
INSERT INTO [dbo].UKG_LOCATION
                                                                                                                                                                                                                               
      ([Location Type], [Parent Path], [Location Name], [Full Name], [Description]) 
                                                                                                                                                                         
SELECT DISTINCT 'Entity', Organization, EntityTitle, EntityTitle, Entity
                                                                                                                                                                                     
  FROM [STAGE].UKG_LOCATION_TEMP;
                                                                                                                                                                                                                            

                                                                                                                                                                                                                                                             
-- Service Line Level 3
                                                                                                                                                                                                                                      
INSERT INTO [dbo].UKG_LOCATION
                                                                                                                                                                                                                               
      ([Location Type], [Parent Path], [Location Name], [Full Name], [Description]) 
                                                                                                                                                                         
SELECT DISTINCT 'Service Line', Organization + '/' + EntityTitle, ServiceLineTitle, ServiceLineTitle, ServiceLineTitle
                                                                                                                                       
  FROM [STAGE].UKG_LOCATION_TEMP;
                                                                                                                                                                                                                            

                                                                                                                                                                                                                                                             
-- Financial Unit Level 4
                                                                                                                                                                                                                                    
INSERT INTO [dbo].UKG_LOCATION
                                                                                                                                                                                                                               
      ([Location Type], [Parent Path], [Location Name], [Full Name], [Description]) 
                                                                                                                                                                         
SELECT DISTINCT 'Financial Unit', Organization + '/' + EntityTitle + '/' + ServiceLineTitle, FinancialUnit, FinancialUnit, FinancialUnitTitle
                                                                                                                
  FROM [STAGE].UKG_LOCATION_TEMP;
                                                                                                                                                                                                                            

                                                                                                                                                                                                                                                             
-- Fund Group Level 5
                                                                                                                                                                                                                                        
INSERT INTO [dbo].UKG_LOCATION
                                                                                                                                                                                                                               
      ([Location Type], [Parent Path], [Location Name], [Full Name], [Description]) 
                                                                                                                                                                         
SELECT DISTINCT 'Fund Group', Organization + '/' + EntityTitle + '/' + ServiceLineTitle + '/' + FinancialUnit, FundGroup, FundGroup, FundGroupTitle
                                                                                                          
  FROM [STAGE].UKG_LOCATION_TEMP;
                                                                                                                                                                                                                            

                                                                                                                                                                                                                                                             
-- Job Group Level 6
                                                                                                                                                                                                                                         
INSERT INTO dbo.UKG_LOCATION
                                                                                                                                                                                                                                 
      ([Location Type], [Parent Path], [Location Name], [Full Name], [Description]) 
                                                                                                                                                                         
SELECT DISTINCT 'Job', Organization + '/' + EntityTitle + '/' + ServiceLineTitle + '/' + FinancialUnit + '/' + FundGroup, JOBGROUP, JOBGROUP, JOBGROUPTitle
                                                                                                  
  FROM [STAGE].UKG_LOCATION_TEMP;
                                                                                                                                                                                                                            

                                                                                                                                                                                                                                                             
-- fix special characters issue
                                                                                                                                                                                                                              
DROP TABLE if exists [stage].[UKG_LOCATION_BUILD_FIXED_SPEC_CHAR];
                                                                                                                                                                                           

                                                                                                                                                                                                                                                             
    SELECT * 
                                                                                                                                                                                                                                                
    INTO [stage].[UKG_LOCATION_BUILD_FIXED_SPEC_CHAR]
                                                                                                                                                                                                        
    FROM [dbo].[UKG_LOCATION_V]
                                                                                                                                                                                                                              
;
                                                                                                                                                                                                                                                            

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
truncate table [dbo].[UKG_LOCATION];
                                                                                                                                                                                                                         

                                                                                                                                                                                                                                                             
INSERT INTO [dbo].[UKG_LOCATION]
                                                                                                                                                                                                                             
           ([Location Type]
                                                                                                                                                                                                                                  
           ,[Parent Path]
                                                                                                                                                                                                                                    
           ,[Location Name]
                                                                                                                                                                                                                                  
           ,[Full Name]
                                                                                                                                                                                                                                      
           ,[Description]
                                                                                                                                                                                                                                    
           ,[Effective Date]
                                                                                                                                                                                                                                 
           ,[Expiration Date]
                                                                                                                                                                                                                                
           ,[Address]
                                                                                                                                                                                                                                        
           ,[Cost Center]
                                                                                                                                                                                                                                    
           ,[Direct Work Percent]
                                                                                                                                                                                                                            
           ,[Indirect Work Percent]
                                                                                                                                                                                                                          
           ,[Timezone]
                                                                                                                                                                                                                                       
           ,[Transferable]
                                                                                                                                                                                                                                   
           ,[External ID])
                                                                                                                                                                                                                                   
SELECT [Location Type]
                                                                                                                                                                                                                                       
      ,[Parent Path]
                                                                                                                                                                                                                                         
      ,[Location Name]
                                                                                                                                                                                                                                       
      ,[Full Name]
                                                                                                                                                                                                                                           
      ,[Description]
                                                                                                                                                                                                                                         
      ,[Effective Date]
                                                                                                                                                                                                                                      
      ,[Expiration Date]
                                                                                                                                                                                                                                     
      ,[Address]
                                                                                                                                                                                                                                             
      ,[Cost Center]
                                                                                                                                                                                                                                         
      ,[Direct Work Percent]
                                                                                                                                                                                                                                 
      ,[Indirect Work Percent]
                                                                                                                                                                                                                               
      ,[Timezone]
                                                                                                                                                                                                                                            
      ,[Transferable]
                                                                                                                                                                                                                                        
      ,[External ID]
                                                                                                                                                                                                                                         
  FROM [stage].[UKG_LOCATION_BUILD_FIXED_SPEC_CHAR]
                                                                                                                                                                                                          
;
                                                                                                                                                                                                                                                            

                                                                                                                                                                                                                                                             
-- ***LOOP TO DROP ANY 30 DAY OLD and TODAY?S UKG_LOCATION_SNAPSHOT TABLES ***--
                                                                                                                                                                             
DECLARE @SQL_DROP NVARCHAR(MAX)   
                                                                                                                                                                                                                           
       
                                                                                                                                                                                                                                                      
SELECT 
                                                                                                                                                                                                                                                      
    @SQL_DROP = COALESCE(@SQL_DROP + ' ;', '') +       
                                                                                                                                                                                                      
         'DROP TABLE ' + QUOTENAME(S.NAME) + '.' + QUOTENAME(T.NAME)    
                                                                                                                                                                                     
    FROM SYS.SCHEMAS S      
                                                                                                                                                                                                                                 
    INNER JOIN SYS.TABLES T ON T.SCHEMA_ID = S.SCHEMA_ID       
                                                                                                                                                                                              
    WHERE S.NAME IN ( 'STAGE')        
                                                                                                                                                                                                                       
     AND T.NAME LIKE 'UKG_LOCATION_SNAPSHOT_%' -- SNAPSHOT_ (39)
                                                                                                                                                                                             
     AND ( CAST(SUBSTRING (T.NAME,23, 10 ) AS DATE) <  CAST(DATEADD(DAY,-5, GETDATE())   AS DATE)   OR CAST(SUBSTRING (T.NAME,23, 10 ) AS DATE) =  CAST(GETDATE()       AS DATE) )
                                                                           
                     
                                                                                                                                                                                                                                        
--PRINT @SQL_DROP  
                                                                                                                                                                                                                                          
EXEC(@SQL_DROP)
                                                                                                                                                                                                                                              
 
                                                                                                                                                                                                                                                            

                                                                                                                                                                                                                                                             
--*** CREATE SNAPSHOT TABLE  ***--
                                                                                                                                                                                                                           

                                                                                                                                                                                                                                                             
DECLARE @SQL_CREATE NVARCHAR(MAX) ;  
                                                                                                                                                                                                                        
DECLARE @SNAPSHOT_TABLENAME NVARCHAR(50); 
                                                                                                                                                                                                                   

                                                                                                                                                                                                                                                             
SET @SNAPSHOT_TABLENAME = 'UKG_LOCATION_SNAPSHOT_' + CAST(CAST(GETDATE() AS DATE) AS CHAR(10));
                                                                                                                                                              

                                                                                                                                                                                                                                                             
SELECT 
                                                                                                                                                                                                                                                      
    @SQL_CREATE =  
                                                                                                                                                                                                                                          
        N'DROP TABLE IF EXISTS bck.[' + @SNAPSHOT_TABLENAME + ']; ' +
                                                                                                                                                                                        
        N'SELECT * INTO bck.[' + @SNAPSHOT_TABLENAME + '] FROM dbo.UKG_LOCATION';
                                                                                                                                                                            

                                                                                                                                                                                                                                                             
--PRINT @SQL_CREATE;
                                                                                                                                                                                                                                         
EXEC(@SQL_CREATE)
                                                                                                                                                                                                                                            

                                                                                                                                                                                                                                                             
END;

-- ===== dbo.UKG_ORG_SETS_AND_EMP_GROUPS_BUILD =====

                                                                                                                                                                                                                                                             
----------------------------------------------------------------------------------------------------
                                                                                                                                                         
-- exec [dbo].[UKG_ORG_SETS_AND_EMP_GROUPS_BUILD]
                                                                                                                                                                                                            
-- Description: This stored procedure builds the UKG_ORG_SETS and UKG_EMP_GROUPS tables based on employee data.
                                                                                                                                              
-- Version Control:
                                                                                                                                                                                                                                          
-- Date Modified  |  Author      |   Description
                                                                                                                                                                                                             
-- ---------------|--------------|----------------------------------------------------
                                                                                                                                                                       
-- 2023-07-28     | Jim Shih     | Initial version
                                                                                                                                                                                                           
-- 2025-09-11     | Jim Shih     | Added <>'' conditions for business structure columns to prevent blankvalues in 'Job in Org Set'
                                                                                                                           
----------------------------------------------------------------------------------------------------
                                                                                                                                                         
CREATE PROCEDURE "dbo"."UKG_ORG_SETS_AND_EMP_GROUPS_BUILD"
                                                                                                                                                                                                   
AS
                                                                                                                                                                                                                                                           
BEGIN
                                                                                                                                                                                                                                                        

                                                                                                                                                                                                                                                             
    DROP TABLE IF EXISTS [dbo].UKG_ORG_SETS;
                                                                                                                                                                                                                 

                                                                                                                                                                                                                                                             
    SELECT distinct
                                                                                                                                                                                                                                          
        'FG-RT-' + [Reports to Manager] AS 'Organizational Set Name'
                                                                                                                                                                                         
, 'Fund Group Org Set Reports to '+[Reports to Manager] AS 'Organizational Set Description'
                                                                                                                                                                  
, 'All' as 'Org Set Type'
                                                                                                                                                                                                                                    
, [Home Business Structure Level 1 - Organization] + '/' + [Home Business Structure Level 2 - Entity] + '/' + [Home Business Structure Level 3 - Service Line] + '/' + [Home Business Structure Level 4 - Financial Unit] + '/' + [Home Business Structure Leve
l 5 - Fund Group] AS 'Job in Org Set'
                                                                                                                                                                                                                        

                                                                                                                                                                                                                                                             
    INTO [dbo].UKG_ORG_SETS
                                                                                                                                                                                                                                  
    FROM [dbo].[UKG_EMPLOYEE_DATA]
                                                                                                                                                                                                                           
    where
                                                                                                                                                                                                                                                    
LEN('FG-RT-' + [Reports to Manager]) = 14
                                                                                                                                                                                                                    
        AND [Home Business Structure Level 1 - Organization] <> ''
                                                                                                                                                                                           
        AND [Home Business Structure Level 2 - Entity] <> ''
                                                                                                                                                                                                 
        AND [Home Business Structure Level 3 - Service Line] <> ''
                                                                                                                                                                                           
        AND [Home Business Structure Level 4 - Financial Unit] <> ''
                                                                                                                                                                                         
        AND [Home Business Structure Level 5 - Fund Group] <> ''
                                                                                                                                                                                             
    -- AND
                                                                                                                                                                                                                                                   
    -- [Reports to Manager] <> ''
                                                                                                                                                                                                                            
    -- and
                                                                                                                                                                                                                                                   
    -- MANAGER_EMPLID=10415792
                                                                                                                                                                                                                               

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
    DROP TABLE IF EXISTS [dbo].UKG_EMP_GROUPS;
                                                                                                                                                                                                               
    SELECT distinct
                                                                                                                                                                                                                                          
        [Organizational Set Name] as 'Employee Group Name'
                                                                                                                                                                                                   
, '' as 'Cost Center Pattern'
                                                                                                                                                                                                                                
, [Organizational Set Name] as 'Organizational Set'
                                                                                                                                                                                                          
, '' as 'Labor Category Profile'
                                                                                                                                                                                                                             
    INTO [dbo].UKG_EMP_GROUPS
                                                                                                                                                                                                                                
    FROM [dbo].[UKG_ORG_SETS]
                                                                                                                                                                                                                                
;
                                                                                                                                                                                                                                                            

                                                                                                                                                                                                                                                             
END

-- ===== dbo.UKG_UCPATH_ACCRUAL_BUILD =====

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
/***************************************
                                                                                                                                                                                                                     
* Created By: May Xu	
                                                                                                                                                                                                                                        
* Table: This SP creates table [dbo].UKG_UCPATH_ACCRUAL	to create file accrual_import.csv
                                                                                                                                                                    
  --Extract data from the PS_UC_AM_SS_TBL for the new accruals based upon when the quadriweekly accruals are posted. 	  
                                                                                                                                     
  --Accruals are posted to the ODS 8-10 days after the period end date and then posted to the local ODS a day later.
                                                                                                                                         
  -- Should extract for all UKG employees who were active in the period that matches the asofdate or are active on the posting date.		
                                                                                                                       
* @param @payenddt DATE: The end date of the pay period for which accruals are being processed.
                                                                                                                                                              
*                        The ASOFDATE for accruals will be determined relative to this pay period.
                                                                                                                                                           
* EXEC 	[dbo].[UKG_UCPATH_ACCRUAL_BUILD] @payenddt = '2025-10-11' -- Example date
                                                                                                                                                                            
* -- 05/09/2025 May Xu: Created
                                                                                                                                                                                                                              
* -- 05/22/2025 Jim Shih: UNION stage.UKG_INACTIVE_EMPLID_BY_PAYPERIOD, and change to AM.ASOFDATE BETWEEN DATEADD(day, -13, @payenddt) AND @payenddt   
                                                                                                      
*-- 7/16/2025 Jim Shih
                                                                                                                                                                                                                                       
*-- migrate from hs-ssisp-v
                                                                                                                                                                                                                                  
* -- 11/02/2025 Jim Shih: Modified to use CREATE TABLE instead of DROP/CREATE pattern, implemented MERGE statement 
                                                                                                                                          
*                        for insert-only operations when records don't match on hash_value. Added Inserted_DT column with GETDATE() timestamp.
                                                                                                               
* -- 11/05/2025 Jim Shih: Modify the logic, only HR_Status='A' UKG employee at the time when I generated the files
                                                                                                                                           
******************************************/
                                                                                                                                                                                                                  

                                                                                                                                                                                                                                                             
CREATE   PROCEDURE [dbo].[UKG_UCPATH_ACCRUAL_BUILD]
                                                                                                                                                                                                          
    @payenddt DATE
                                                                                                                                                                                                                                           
AS
                                                                                                                                                                                                                                                           

                                                                                                                                                                                                                                                             
BEGIN
                                                                                                                                                                                                                                                        

                                                                                                                                                                                                                                                             
    SET NOCOUNT ON;
                                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    -- as of date:  The date on which the accrual amount is effective (Today, Current Pay Period Start or Source File Effective Date)
                                                                                                                        

                                                                                                                                                                                                                                                             
    -- Create temporary table for source data
                                                                                                                                                                                                                
    CREATE TABLE #SourceData
                                                                                                                                                                                                                                 
    (
                                                                                                                                                                                                                                                        
        [EMPLID] [varchar](11) NULL,
                                                                                                                                                                                                                         
        [ASOFDATE] [date] NULL,
                                                                                                                                                                                                                              
        [PIN_NUM] [int] NULL,
                                                                                                                                                                                                                                
        [UC_PREV_BAL] [decimal](15, 2) NULL,
                                                                                                                                                                                                                 
        [UC_PRD_TAKEN] [decimal](14, 2) NULL,
                                                                                                                                                                                                                
        [UC_PRD_ACCRUAL] [decimal](14, 2) NULL,
                                                                                                                                                                                                              
        [UC_PRD_ADJUSTED] [decimal](14, 2) NULL,
                                                                                                                                                                                                             
        [UC_CURR_BAL] [decimal](14, 2) NULL,
                                                                                                                                                                                                                 
        [UC_ACCR_LIMIT] [decimal](14, 2) NULL,
                                                                                                                                                                                                               
        [UC_APR_MAX_IND] [varchar](1) NULL,
                                                                                                                                                                                                                  
        [ORDER_NUM] [int] NULL,
                                                                                                                                                                                                                              
        [CR_BT_DTM] [datetime] NULL,
                                                                                                                                                                                                                         
        [CR_BT_NBR] [numeric](18, 0) NULL,
                                                                                                                                                                                                                   
        [UPD_BT_DTM] [datetime] NULL,
                                                                                                                                                                                                                        
        [UPD_BT_NBR] [numeric](18, 0) NULL,
                                                                                                                                                                                                                  
        [ODS_VRSN_NBR] [numeric](18, 0) NULL,
                                                                                                                                                                                                                
        [hash_value] [varbinary](16) NOT NULL
                                                                                                                                                                                                                
    );
                                                                                                                                                                                                                                                       

                                                                                                                                                                                                                                                             
    -- Insert source data
                                                                                                                                                                                                                                    
    WITH
                                                                                                                                                                                                                                                     
        CombinedEmplids
                                                                                                                                                                                                                                      
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            -- Select active UKG-managed employees
                                                                                                                                                                                                           
                            SELECT DISTINCT EMPLID
                                                                                                                                                                                                           
                FROM dbo.UKG_EMPLOYEE_DATA
                                                                                                                                                                                                                   
                WHERE 
                                                                                                                                                                                                                                       
				NON_UKG_MANAGER_FLAG != 'T'
                                                                                                                                                                                                                              
				and
                                                                                                                                                                                                                                                      
				HR_STATUS='A'
                                                                                                                                                                                                                                            

                                                                                                                                                                                                                                                             
            -- UNION
                                                                                                                                                                                                                                         

                                                                                                                                                                                                                                                             
                -- -- Select employees identified as inactive or not managed under UKG for the period
                                                                                                                                                        
                -- SELECT DISTINCT EMPLID
                                                                                                                                                                                                                    
                -- FROM stage.UKG_INACTIVE_EMPLID_BY_PAYPERIOD
                                                                                                                                                                                               
            -- -- Assumes UKG_INACTIVE_EMPLID_BY_PAYPERIOD is populated correctly for the @payenddt period
                                                                                                                                                   
        )
                                                                                                                                                                                                                                                    
    INSERT INTO #SourceData
                                                                                                                                                                                                                                  
        ([EMPLID], [ASOFDATE], [PIN_NUM], [UC_PREV_BAL], [UC_PRD_TAKEN], [UC_PRD_ACCRUAL],
                                                                                                                                                                   
        [UC_PRD_ADJUSTED], [UC_CURR_BAL], [UC_ACCR_LIMIT], [UC_APR_MAX_IND], [ORDER_NUM],
                                                                                                                                                                    
        [CR_BT_DTM], [CR_BT_NBR], [UPD_BT_DTM], [UPD_BT_NBR], [ODS_VRSN_NBR], [hash_value])
                                                                                                                                                                  
    SELECT AM.[EMPLID]
                                                                                                                                                                                                                                       
      , AM.[ASOFDATE]
                                                                                                                                                                                                                                        
      , AM.[PIN_NUM]
                                                                                                                                                                                                                                         
      , AM.[UC_PREV_BAL]
                                                                                                                                                                                                                                     
      , AM.[UC_PRD_TAKEN]
                                                                                                                                                                                                                                    
      , AM.[UC_PRD_ACCRUAL]
                                                                                                                                                                                                                                  
      , AM.[UC_PRD_ADJUSTED]
                                                                                                                                                                                                                                 
      , AM.[UC_CURR_BAL]
                                                                                                                                                                                                                                     
      , AM.[UC_ACCR_LIMIT]
                                                                                                                                                                                                                                   
      , AM.[UC_APR_MAX_IND]
                                                                                                                                                                                                                                  
      , AM.[ORDER_NUM]
                                                                                                                                                                                                                                       
      , AM.[CR_BT_DTM]
                                                                                                                                                                                                                                       
      , AM.[CR_BT_NBR]
                                                                                                                                                                                                                                       
      , AM.[UPD_BT_DTM]
                                                                                                                                                                                                                                      
      , AM.[UPD_BT_NBR]
                                                                                                                                                                                                                                      
      , AM.[ODS_VRSN_NBR]
                                                                                                                                                                                                                                    
      , HASHBYTES('MD5', CONCAT(
                                                                                                                                                                                                                             
            AM.EMPLID,
                                                                                                                                                                                                                                       
          AM.ASOFDATE,
                                                                                                                                                                                                                                       
            AM.PIN_NUM,
                                                                                                                                                                                                                                      
            AM.UC_PREV_BAL,
                                                                                                                                                                                                                                  
            AM.UC_PRD_TAKEN,
                                                                                                                                                                                                                                 
            AM.UC_PRD_ACCRUAL,
                                                                                                                                                                                                                               
            AM.UC_PRD_ADJUSTED,
                                                                                                                                                                                                                              
            AM.UC_CURR_BAL,
                                                                                                                                                                                                                                  
            AM.UC_ACCR_LIMIT,
                                                                                                                                                                                                                                
            AM.UC_APR_MAX_IND,
                                                                                                                                                                                                                               
            AM.ORDER_NUM,
                                                                                                                                                                                                                                    
            AM.CR_BT_DTM,
                                                                                                                                                                                                                                    
            AM.CR_BT_NBR,
                                                                                                                                                                                                                                    
            AM.UPD_BT_DTM,
                                                                                                                                                                                                                                   
            AM.UPD_BT_NBR,
                                                                                                                                                                                                                                   
            AM.ODS_VRSN_NBR
                                                                                                                                                                                                                                  
        )) AS hash_value
                                                                                                                                                                                                                                     
    FROM health_ods.[HEALTH_ODS].STABLE.PS_UC_AM_SS_TBL AM
                                                                                                                                                                                                   
        JOIN CombinedEmplids CE ON AM.EMPLID = CE.EMPLID
                                                                                                                                                                                                     
    WHERE 	
                                                                                                                                                                                                                                                  
        1=1
                                                                                                                                                                                                                                                  
        AND AM.PIN_NUM in (262287,260269,260259,260125,260086 ,262342)
                                                                                                                                                                                       
        AND AM.ASOFDATE BETWEEN DATEADD(day, -13, @payenddt) AND @payenddt
                                                                                                                                                                                   
        and AM.DML_IND <> 'D';
                                                                                                                                                                                                                               

                                                                                                                                                                                                                                                             
    -- Perform MERGE operation - Insert records when hash_value doesn't match
                                                                                                                                                                                
    MERGE [dbo].[UKG_UCPATH_ACCRUAL] AS target
                                                                                                                                                                                                               
    USING #SourceData AS source
                                                                                                                                                                                                                              
    ON (target.[EMPLID] = source.[EMPLID]
                                                                                                                                                                                                                    
        AND target.[hash_value] = source.[hash_value])
                                                                                                                                                                                                       
    WHEN NOT MATCHED THEN
                                                                                                                                                                                                                                    
        INSERT ([EMPLID], [ASOFDATE], [PIN_NUM], [UC_PREV_BAL], [UC_PRD_TAKEN], [UC_PRD_ACCRUAL], 
                                                                                                                                                           
                [UC_PRD_ADJUSTED], [UC_CURR_BAL], [UC_ACCR_LIMIT], [UC_APR_MAX_IND], [ORDER_NUM], 
                                                                                                                                                           
                [CR_BT_DTM], [CR_BT_NBR], [UPD_BT_DTM], [UPD_BT_NBR], [ODS_VRSN_NBR], [hash_value], [Inserted_DT])
                                                                                                                                           
        VALUES (source.[EMPLID], source.[ASOFDATE], source.[PIN_NUM], source.[UC_PREV_BAL], source.[UC_PRD_TAKEN], 
                                                                                                                                          
                source.[UC_PRD_ACCRUAL], source.[UC_PRD_ADJUSTED], source.[UC_CURR_BAL], source.[UC_ACCR_LIMIT], 
                                                                                                                                            
                source.[UC_APR_MAX_IND], source.[ORDER_NUM], source.[CR_BT_DTM], source.[CR_BT_NBR], 
                                                                                                                                                        
                source.[UPD_BT_DTM], source.[UPD_BT_NBR], source.[ODS_VRSN_NBR], source.[hash_value], GETDATE());
                                                                                                                                            

                                                                                                                                                                                                                                                             
    -- Clean up temporary table
                                                                                                                                                                                                                              
    DROP TABLE #SourceData;
                                                                                                                                                                                                                                  

                                                                                                                                                                                                                                                             
END

-- ===== hts.UKG_BusinessStructure_UPD =====

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
/**************************************************************************************
                                                                                                                                                                      
Created:	03/2025
                                                                                                                                                                                                                                             
Created by:	John Kingsepp
                                                                                                                                                                                                                                    
Purpose:	Used to return the Business structure elements
                                                                                                                                                                                                      
			for UKG
                                                                                                                                                                                                                                                   
			The function returns the code and description
                                                                                                                                                                                                             
			for each Business Structure element.  Only one of those values is passed 
                                                                                                                                                                                 
			node.
                                                                                                                                                                                                                                                     
			Special charaters as defined by UKG need to be replaced
                                                                                                                                                                                                   
			The fields that are used for the UKG Business Structure 
                                                                                                                                                                                                  
			o Level1 -- Organization
                                                                                                                                                                                                                                  
			o Level2 -- EntityTitle
                                                                                                                                                                                                                                   
			o Level3 -- ServiceLineTitle
                                                                                                                                                                                                                              
			o Level4 -- FinancialUnit
                                                                                                                                                                                                                                 
			o Level5 -- FundGroup
                                                                                                                                                                                                                                     

                                                                                                                                                                                                                                                             
* -- 7/15/2025   Jim Shih: change from dbo to hts.  I need to test this SP in [dbo].UKG_EMPLOYEE_DATA_BUILD
                                                                                                                                                  
* -- 10/23/2025  Jim Shih: join the table from linked server health_ODS.[Health_ODS].[hcm_ods].PS_ACCT_CD_TBL
                                                                                                                                                
**************************************************************************************/
                                                                                                                                                                      
CREATE PROCEDURE [hts].[UKG_BusinessStructure_UPD]
                                                                                                                                                                                                           
AS
                                                                                                                                                                                                                                                           
BEGIN
                                                                                                                                                                                                                                                        
SET NOCOUNT ON
                                                                                                                                                                                                                                               

                                                                                                                                                                                                                                                             
	DECLARE @BusinessStructure TABLE (
                                                                                                                                                                                                                          
		combocode VARCHAR(9)
                                                                                                                                                                                                                                       
		,Organization VARCHAR(50)
                                                                                                                                                                                                                                  
		,OrganizationTitle VARCHAR(50)
                                                                                                                                                                                                                             
		,Entity VARCHAR(5)
                                                                                                                                                                                                                                         
		,EntityTitle VARCHAR(250)
                                                                                                                                                                                                                                  
		,ServiceLine VARCHAR(50)
                                                                                                                                                                                                                                   
		,ServiceLineTitle VARCHAR(250)
                                                                                                                                                                                                                             
		,FinancialUnit VARCHAR(10)
                                                                                                                                                                                                                                 
		,FinancialUnitTitle VARCHAR(250)
                                                                                                                                                                                                                           
		,FundGroup VARCHAR(10)
                                                                                                                                                                                                                                     
		,FundGroupTitle VARCHAR(250)
                                                                                                                                                                                                                               
		,FundGroupTitle_Strata VARCHAR(250)
                                                                                                                                                                                                                        
		,fund VARCHAR(6)
                                                                                                                                                                                                                                           
		,location VARCHAR(100)
                                                                                                                                                                                                                                     
		,DepartmentRollup4ID VARCHAR(100)
                                                                                                                                                                                                                          
		)
                                                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
	INSERT INTO @BusinessStructure (
                                                                                                                                                                                                                            
		combocode
                                                                                                                                                                                                                                                  
		,Organization
                                                                                                                                                                                                                                              
		,OrganizationTitle
                                                                                                                                                                                                                                         
		,Entity
                                                                                                                                                                                                                                                    
		,EntityTitle
                                                                                                                                                                                                                                               
		,ServiceLine
                                                                                                                                                                                                                                               
		,ServiceLineTitle
                                                                                                                                                                                                                                          
		,FinancialUnit
                                                                                                                                                                                                                                             
		,FinancialUnitTitle
                                                                                                                                                                                                                                        
		,FundGroup
                                                                                                                                                                                                                                                 
		,FundGroupTitle
                                                                                                                                                                                                                                            
		,fund
                                                                                                                                                                                                                                                      
		,location
                                                                                                                                                                                                                                                  
		)
                                                                                                                                                                                                                                                          
	--,fund
                                                                                                                                                                                                                                                     
	--,location 
                                                                                                                                                                                                                                                
	SELECT right('000000000' + cast(t.combocode AS VARCHAR(9)), 9) [ComboCode]
                                                                                                                                                                                  
		,CASE 
                                                                                                                                                                                                                                                     
			WHEN e.entityid IS NOT NULL
                                                                                                                                                                                                                               
				THEN 'UCSDH'
                                                                                                                                                                                                                                             
			ELSE 'Non-Health'
                                                                                                                                                                                                                                         
			END Organization
                                                                                                                                                                                                                                          
		,CASE 
                                                                                                                                                                                                                                                     
			WHEN e.entityid IS NOT NULL
                                                                                                                                                                                                                               
				THEN 'UCSD Health'
                                                                                                                                                                                                                                       
			ELSE 'Non-Health'
                                                                                                                                                                                                                                         
			END OrganizationTitle
                                                                                                                                                                                                                                     
		,a.operating_unit Entity
                                                                                                                                                                                                                                   
		,CASE 
                                                                                                                                                                                                                                                     
			WHEN e.entityTitle IS NOT NULL
                                                                                                                                                                                                                            
				THEN e.entityTitle
                                                                                                                                                                                                                                       
			ELSE oe.entityTitle
                                                                                                                                                                                                                                       
			END EntityTitle
                                                                                                                                                                                                                                           
		--,CASE 
                                                                                                                                                                                                                                                   
		--	WHEN a.operating_unit = '16130'
                                                                                                                                                                                                                         
		--		THEN deptid_cf
                                                                                                                                                                                                                                         
		--	ELSE '-'
                                                                                                                                                                                                                                                
		--	END ServiceLine
                                                                                                                                                                                                                                         
		,CASE 
                                                                                                                                                                                                                                                     
			WHEN a.operating_unit = '16130'
                                                                                                                                                                                                                           
				THEN 'Health Science Miscellaneous'
                                                                                                                                                                                                                      
			ELSE 'Default'
                                                                                                                                                                                                                                            
			END ServiceLine
                                                                                                                                                                                                                                           
		,CASE 
                                                                                                                                                                                                                                                     
			WHEN a.operating_unit = '16130'
                                                                                                                                                                                                                           
				THEN 'Health Science Miscellaneous'
                                                                                                                                                                                                                      
			ELSE 'Default'
                                                                                                                                                                                                                                            
			END ServiceLineTitle
                                                                                                                                                                                                                                      
		,a.deptid_cf FinanacialUnit
                                                                                                                                                                                                                                
		,replace(ofu.depttitle,'/','-')  FinancialUnitTitle
                                                                                                                                                                                                        
		,[FundGroup]
                                                                                                                                                                                                                                               
		,replace(FundGroupTitle, '/', '-') FundGroupTitle
                                                                                                                                                                                                          
		,a.fund_code
                                                                                                                                                                                                                                               
		,CASE 
                                                                                                                                                                                                                                                     
			WHEN OPERATING_UNIT = '16143'
                                                                                                                                                                                                                             
				AND isnull(chartfield3, ' ') = ' '
                                                                                                                                                                                                                       
				THEN '000000'
                                                                                                                                                                                                                                            
			ELSE chartfield3
                                                                                                                                                                                                                                          
			END location
                                                                                                                                                                                                                                              
	FROM hts.[UKG_ComboCodeFundGroup] t
                                                                                                                                                                                                                         
	LEFT OUTER JOIN health_ODS.[Health_ODS].[hcm_ods].PS_ACCT_CD_TBL a ON right('000000000' + cast(t.combocode AS VARCHAR(9)), 9) = a.ACCT_CD
                                                                                                                   
	INNER JOIN hts.UKG_ODSEntity oe ON oe.entity = a.operating_unit
                                                                                                                                                                                             
	LEFT JOIN hts.[UKG_EntityTitleOverrides] e ON e.entityid = a.operating_unit
                                                                                                                                                                                 
	LEFT JOIN hts.UKG_ODSFinancialUnits ofu ON ofu.deptid = a.deptid_cf
                                                                                                                                                                                         
	where cast(getdate() as date) between t.effectivestartdate and t.effectiveenddate
                                                                                                                                                                           

                                                                                                                                                                                                                                                             
	-- Add Service Lines
                                                                                                                                                                                                                                        
	-- Health
                                                                                                                                                                                                                                                   
	-- Medical Center
                                                                                                                                                                                                                                           
	UPDATE b
                                                                                                                                                                                                                                                    
	SET b.serviceline = s.financialunit
                                                                                                                                                                                                                         
		,b.servicelinetitle = replace(s.serviceline, '/', '-')
                                                                                                                                                                                                     
	FROM @BusinessStructure b
                                                                                                                                                                                                                                   
	INNER JOIN hts.[UKG_ServiceLines_MedicalCenter] s ON s.financialunit = b.financialunit
                                                                                                                                                                      
	WHERE b.entity = '16242'
                                                                                                                                                                                                                                    

                                                                                                                                                                                                                                                             
	-- PHSO
                                                                                                                                                                                                                                                     
	UPDATE b
                                                                                                                                                                                                                                                    
	SET b.serviceline = s.financialunit
                                                                                                                                                                                                                         
		,b.servicelinetitle = replace(s.serviceline, '/', '-')
                                                                                                                                                                                                     
	FROM @BusinessStructure b
                                                                                                                                                                                                                                   
	INNER JOIN hts.[UKG_ServiceLines_PHSO] s ON s.financialunit = b.financialunit
                                                                                                                                                                               
	WHERE b.entity = '16144'
                                                                                                                                                                                                                                    

                                                                                                                                                                                                                                                             
	-- Health Science
                                                                                                                                                                                                                                           
	UPDATE b
                                                                                                                                                                                                                                                    
	SET b.serviceline = s.financialunit
                                                                                                                                                                                                                         
		,b.servicelinetitle = replace(s.serviceline, '/', '-')
                                                                                                                                                                                                     
	FROM @BusinessStructure b
                                                                                                                                                                                                                                   
	INNER JOIN hts.[UKG_ServiceLines_HealthSciences] s ON s.financialunit = b.financialunit
                                                                                                                                                                     
	WHERE b.entity = '16130'
                                                                                                                                                                                                                                    

                                                                                                                                                                                                                                                             
	-- Health Pysician Group
                                                                                                                                                                                                                                    
	UPDATE b
                                                                                                                                                                                                                                                    
	SET b.serviceline = s.fund
                                                                                                                                                                                                                                  
		,b.servicelinetitle = replace(s.serviceline, '/', '-')
                                                                                                                                                                                                     
	FROM @BusinessStructure b
                                                                                                                                                                                                                                   
	INNER JOIN hts.[UKG_ServiceLines_PhysiciansGroup] s ON s.fund = b.fund
                                                                                                                                                                                      
	--and s.financialunit  = b.financialunit
                                                                                                                                                                                                                    
	WHERE b.entity = '16143'
                                                                                                                                                                                                                                    

                                                                                                                                                                                                                                                             
	-- Health Pysician Group
                                                                                                                                                                                                                                    
	--	update b set b.DepartmentRollup4ID = s.DepartmentRollup4ID from 
                                                                                                                                                                                         
	--@BusinessStructure b inner join [StrataData] s on s.fund = b.fund
                                                                                                                                                                                         
	--and s.financialunit  = b.financialunit --and b.location = s.location
                                                                                                                                                                                      
	--where b.entity = '16143' and s.DepartmentRollup4ID <> 'Not Specified'
                                                                                                                                                                                     
	--add Timesheet groups titles from strata
                                                                                                                                                                                                                   
	UPDATE b
                                                                                                                                                                                                                                                    
	SET b.FundGrouptitle_strata = replace(s.description, '/', '-')
                                                                                                                                                                                              
	FROM @BusinessStructure b
                                                                                                                                                                                                                                   
	INNER JOIN hts.[UKG_StrataData] s ON s.fund = b.fund
                                                                                                                                                                                                        
		AND s.financialunit = b.financialunit
                                                                                                                                                                                                                      
		AND b.location = s.location
                                                                                                                                                                                                                                
	WHERE b.entity = '16143'
                                                                                                                                                                                                                                    

                                                                                                                                                                                                                                                             
	UPDATE b
                                                                                                                                                                                                                                                    
	SET b.FundGrouptitle_strata = s.description
                                                                                                                                                                                                                 
	FROM @BusinessStructure b
                                                                                                                                                                                                                                   
	INNER JOIN hts.[UKG_StrataData] s ON s.financialunit = b.financialunit
                                                                                                                                                                                      
	WHERE b.entity IN (
                                                                                                                                                                                                                                         
			'16144'
                                                                                                                                                                                                                                                   
			,'16242'
                                                                                                                                                                                                                                                  
			)
                                                                                                                                                                                                                                                         

                                                                                                                                                                                                                                                             
	IF (
                                                                                                                                                                                                                                                        
			SELECT count('x')
                                                                                                                                                                                                                                         
			FROM @BusinessStructure
                                                                                                                                                                                                                                   
			) > 0
                                                                                                                                                                                                                                                     
	BEGIN
                                                                                                                                                                                                                                                       
		DELETE
                                                                                                                                                                                                                                                     
		FROM hts.UKG_BusinessStructure
                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
		INSERT INTO hts.UKG_BusinessStructure (
                                                                                                                                                                                                                    
			combocode
                                                                                                                                                                                                                                                 
			,Organization
                                                                                                                                                                                                                                             
			,OrganizationTitle
                                                                                                                                                                                                                                        
			,Entity
                                                                                                                                                                                                                                                   
			,EntityTitle
                                                                                                                                                                                                                                              
			,ServiceLine
                                                                                                                                                                                                                                              
			,ServiceLineTitle
                                                                                                                                                                                                                                         
			,FinancialUnit
                                                                                                                                                                                                                                            
			,FinancialUnitTitle
                                                                                                                                                                                                                                       
			,FundGroup
                                                                                                                                                                                                                                                
			,FundGroupTitle
                                                                                                                                                                                                                                           
			,fund
                                                                                                                                                                                                                                                     
			,location
                                                                                                                                                                                                                                                 
			)
                                                                                                                                                                                                                                                         
		SELECT combocode
                                                                                                                                                                                                                                           
			,Organization
                                                                                                                                                                                                                                             
			,OrganizationTitle
                                                                                                                                                                                                                                        
			,Entity
                                                                                                                                                                                                                                                   
			,EntityTitle
                                                                                                                                                                                                                                              
			,ServiceLine
                                                                                                                                                                                                                                              
			,ServiceLineTitle
                                                                                                                                                                                                                                         
			,FinancialUnit
                                                                                                                                                                                                                                            
			,FinancialUnitTitle
                                                                                                                                                                                                                                       
			,FundGroup
                                                                                                                                                                                                                                                
			,FundGroupTitle
                                                                                                                                                                                                                                           
			,fund
                                                                                                                                                                                                                                                     
			,location
                                                                                                                                                                                                                                                 
		FROM @BusinessStructure
                                                                                                                                                                                                                                    
	END
                                                                                                                                                                                                                                                         
END

-- ===== stage.EMPL_DEPT_TRANSFER_build =====

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
/*
                                                                                                                                                                                                                                                           
    Stored Procedure: [stage].[EMPL_DEPT_TRANSFER_build]
                                                                                                                                                                                                     
    Version: 2025-12-04 (Enhanced by Jim Shih)
                                                                                                                                                                                                               
    
                                                                                                                                                                                                                                                         
    VERSION HISTORY:
                                                                                                                                                                                                                                         
    - 2025-10-13: Original version - Department transfer detection only
                                                                                                                                                                                      
    - 2025-12-04: Enhanced to detect POSITION changes in addition to department changes
                                                                                                                                                                      
    
                                                                                                                                                                                                                                                         
    NEW LOGIC ADDED (2025-12-04):
                                                                                                                                                                                                                            
    - Enhanced WHERE clause to detect position changes: (DEPTID != NEXT_DEPTID OR POSITION_NBR != NEXT_POSITION_NBR)
                                                                                                                                         
    - Added NEXT_POSITION_NBR IS NOT NULL validation to ensure position transitions exist
                                                                                                                                                                    
    - Now captures position-only transfers (e.g., Position 40697565 ? 41072726 within same department)
                                                                                                                                                       
    - Addresses previous gap where position changes without department changes were missed
                                                                                                                                                                   
    - Maintains all existing department transfer logic while expanding detection capability
                                                                                                                                                                  

                                                                                                                                                                                                                                                             
    Description:
                                                                                                                                                                                                                                             
    This stored procedure builds the [STAGE].[EMPL_DEPT_TRANSFER] table, tracking department AND position transfer events for employees with detailed business logic and filters.
                                                                            
    Logic Details:
                                                                                                                                                                                                                                           
    - Identifies latest effective-dated job records for each employee and record number (EMPLID, EMPL_RCD).
                                                                                                                                                  
    - Uses LEAD() window functions to compare current and next department, VC_CODE, HR_STATUS, jobcode, position, and other attributes.
                                                                                                                      
    - Filters for department OR position changes (DEPTID != NEXT_DEPTID OR POSITION_NBR != NEXT_POSITION_NBR), only when both current and next HR_STATUS are 'A' (active).
                                                                                   
    - Includes only records for MED CENTER (VC_CODE = 'VCHSH') or PHSO (DEPTID between '002000' and '002999', excluding certain DEPTIDs).
                                                                                                                    
    - Excludes specific DEPTID/JOBCODE combinations.
                                                                                                                                                                                                         
    - Excludes transfers to MED CENTER or PHSO.
                                                                                                                                                                                                              
    - Adds a snapshot_date column to record the date of the transfer event.
                                                                                                                                                                                  
    - Adds a NOTE column (default '').
                                                                                                                                                                                                                       
    - Uses MERGE to upsert into [STAGE].[EMPL_DEPT_TRANSFER] based on EMPLID and EFFDT.
                                                                                                                                                                      
    - Results are ordered by EMPLID, EMPL_RCD, EFFDT.
                                                                                                                                                                                                        

                                                                                                                                                                                                                                                             
    Usage:
                                                                                                                                                                                                                                                   
    EXEC [stage].[EMPL_DEPT_TRANSFER_build]
                                                                                                                                                                                                                  
*/
                                                                                                                                                                                                                                                           

                                                                                                                                                                                                                                                             
CREATE     PROCEDURE [stage].[EMPL_DEPT_TRANSFER_build]
                                                                                                                                                                                                      
AS
                                                                                                                                                                                                                                                           
BEGIN
                                                                                                                                                                                                                                                        
    SET NOCOUNT ON;
                                                                                                                                                                                                                                          
    DECLARE @snapshot_date DATE = CAST(GETDATE() AS DATE);
                                                                                                                                                                                                   
    -- Build temp table with NOTE and snapshot_date
                                                                                                                                                                                                          
    WITH
                                                                                                                                                                                                                                                     
        MaxEffdt
                                                                                                                                                                                                                                             
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT EMPLID,
                                                                                                                                                                                                                                   
                EMPL_RCD,
                                                                                                                                                                                                                                    
                MAX(EFFDT) AS EFFDT
                                                                                                                                                                                                                          
            FROM health_ods.[health_ods].STABLE.PS_JOB
                                                                                                                                                                                                       
            WHERE DML_IND <> 'D'
                                                                                                                                                                                                                             
                AND EFFDT BETWEEN '7/1/2025' AND GETDATE()
                                                                                                                                                                                                   
            GROUP BY EMPLID, EMPL_RCD, MONTH(EFFDT)
                                                                                                                                                                                                          
        ),
                                                                                                                                                                                                                                                   
        EMPL_DEPT_TRANSFERS
                                                                                                                                                                                                                                  
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                JOB.EMPLID,
                                                                                                                                                                                                                                  
                JOB.EMPL_RCD,
                                                                                                                                                                                                                                
                DH.VC_CODE,
                                                                                                                                                                                                                                  
                JOB.HR_STATUS,
                                                                                                                                                                                                                               
                JOB.DEPTID,
                                                                                                                                                                                                                                  
                JOB.EFFDT,
                                                                                                                                                                                                                                   
                JOB.ACTION,
                                                                                                                                                                                                                                  
                JOB.ACTION_DT,
                                                                                                                                                                                                                               
                JOB.jobcode,
                                                                                                                                                                                                                                 
                JOB.POSITION_NBR,
                                                                                                                                                                                                                            
                LEAD(JOB.DEPTID) OVER (PARTITION BY JOB.EMPLID, JOB.EMPL_RCD ORDER BY JOB.EFFDT) AS NEXT_DEPTID,
                                                                                                                                             
                LEAD(JOB.EFFDT) OVER (PARTITION BY JOB.EMPLID, JOB.EMPL_RCD ORDER BY JOB.EFFDT) AS NEXT_EFFDT,
                                                                                                                                               
                LEAD(JOB.ACTION) OVER (PARTITION BY JOB.EMPLID, JOB.EMPL_RCD ORDER BY JOB.EFFDT) AS NEXT_ACTION,
                                                                                                                                             
                LEAD(DH.VC_CODE) OVER (PARTITION BY JOB.EMPLID, JOB.EMPL_RCD ORDER BY JOB.EFFDT) AS NEXT_VC_CODE,
                                                                                                                                            
                LEAD(DH.VC_NAME) OVER (PARTITION BY JOB.EMPLID, JOB.EMPL_RCD ORDER BY JOB.EFFDT) AS NEXT_VC_NAME,
                                                                                                                                            
                LEAD(JOB.HR_STATUS) OVER (PARTITION BY JOB.EMPLID, JOB.EMPL_RCD ORDER BY JOB.EFFDT) AS NEXT_HR_STATUS,
                                                                                                                                       
                LEAD(JOB.jobcode) OVER (PARTITION BY JOB.EMPLID, JOB.EMPL_RCD ORDER BY JOB.EFFDT) AS NEXT_jobcode,
                                                                                                                                           
                LEAD(JOB.POSITION_NBR) OVER (PARTITION BY JOB.EMPLID, JOB.EMPL_RCD ORDER BY JOB.EFFDT) AS NEXT_POSITION_NBR
                                                                                                                                  
            FROM health_ods.[health_ods].STABLE.PS_JOB JOB
                                                                                                                                                                                                   
                JOIN MaxEffdt MEP
                                                                                                                                                                                                                            
                ON JOB.EMPLID = MEP.EMPLID
                                                                                                                                                                                                                   
                    AND JOB.EMPL_RCD = MEP.EMPL_RCD
                                                                                                                                                                                                          
                    AND JOB.EFFDT = MEP.EFFDT
                                                                                                                                                                                                                
                JOIN health_ods.[health_ods].RPT.DEPARTMENT_HIERARCHY DH
                                                                                                                                                                                     
                ON JOB.DEPTID = DH.DEPTID
                                                                                                                                                                                                                    
            WHERE JOB.JOB_INDICATOR = 'P'
                                                                                                                                                                                                                    
                AND JOB.DML_IND <> 'D'
                                                                                                                                                                                                                       
                AND JOB.EFFSEQ = (
                                                                                                                                                                                                                           
                SELECT MAX(EFFSEQ)
                                                                                                                                                                                                                           
                FROM health_ods.[health_ods].STABLE.PS_JOB JOB2
                                                                                                                                                                                              
                WHERE JOB.EMPLID = JOB2.EMPLID
                                                                                                                                                                                                               
                    AND JOB.EMPL_RCD = JOB2.EMPL_RCD
                                                                                                                                                                                                         
                    AND JOB.EFFDT = JOB2.EFFDT
                                                                                                                                                                                                               
                    AND JOB2.DML_IND <> 'D'
                                                                                                                                                                                                                  
            )
                                                                                                                                                                                                                                                
        )
                                                                                                                                                                                                                                                    
    SELECT *, @snapshot_date AS snapshot_date, '' AS NOTE
                                                                                                                                                                                                    
    INTO STAGE.EMPL_DEPT_TRANSFER_TEMP
                                                                                                                                                                                                                       
    FROM EMPL_DEPT_TRANSFERS
                                                                                                                                                                                                                                 
    WHERE (DEPTID != NEXT_DEPTID OR POSITION_NBR != NEXT_POSITION_NBR) -- Detect DEPARTMENT OR POSITION changes
                                                                                                                                              
        AND NEXT_DEPTID IS NOT NULL
                                                                                                                                                                                                                          
        AND NEXT_POSITION_NBR IS NOT NULL -- Ensure next position exists
                                                                                                                                                                                     
        AND HR_STATUS = 'A'
                                                                                                                                                                                                                                  
        AND NEXT_HR_STATUS = 'A'
                                                                                                                                                                                                                             
        AND (
                                                                                                                                                                                                                                                
            VC_CODE = 'VCHSH' -- MED CENTER
                                                                                                                                                                                                                  
        OR (DEPTID BETWEEN '002000' AND '002999' AND DEPTID NOT IN ('002230','002231','002280')) -- PHSO
                                                                                                                                                     
        )
                                                                                                                                                                                                                                                    
        AND NOT (DEPTID IN ('002053','002056','003919') AND JOBCODE IN ('000770','000771','000772','000775','000776'))
                                                                                                                                       
        AND (
                                                                                                                                                                                                                                                
            NEXT_VC_CODE NOT IN ('VCHSH') -- not transferring to MED CENTER
                                                                                                                                                                                  
        AND NOT (NEXT_DEPTID BETWEEN '002000' AND '002999' AND NEXT_DEPTID NOT IN ('002230','002231','002280')) -- not transferring to PHSO
                                                                                                                  
        );
                                                                                                                                                                                                                                                   

                                                                                                                                                                                                                                                             
    -- Use MERGE to upsert into STAGE.EMPL_DEPT_TRANSFER based on EMPLID and EFFDT
                                                                                                                                                                           
    MERGE INTO STAGE.EMPL_DEPT_TRANSFER AS target
                                                                                                                                                                                                            
    USING STAGE.EMPL_DEPT_TRANSFER_TEMP AS source
                                                                                                                                                                                                            
    ON target.EMPLID = source.EMPLID AND target.EFFDT = source.EFFDT
                                                                                                                                                                                         
    -- WHEN MATCHED THEN
                                                                                                                                                                                                                                     
    --     UPDATE SET
                                                                                                                                                                                                                                        
    --         target.EMPL_RCD = source.EMPL_RCD,
                                                                                                                                                                                                            
    --         target.VC_CODE = source.VC_CODE,
                                                                                                                                                                                                              
    --         target.HR_STATUS = source.HR_STATUS,
                                                                                                                                                                                                          
    --         target.DEPTID = source.DEPTID,
                                                                                                                                                                                                                
    --         target.ACTION = source.ACTION,
                                                                                                                                                                                                                
    --         target.ACTION_DT = source.ACTION_DT,
                                                                                                                                                                                                          
    --         target.jobcode = source.jobcode,
                                                                                                                                                                                                              
    --         target.POSITION_NBR = source.POSITION_NBR,
                                                                                                                                                                                                    
    --         target.NEXT_DEPTID = source.NEXT_DEPTID,
                                                                                                                                                                                                      
    --         target.NEXT_EFFDT = source.NEXT_EFFDT,
                                                                                                                                                                                                        
    --         target.NEXT_ACTION = source.NEXT_ACTION,
                                                                                                                                                                                                      
    --         target.NEXT_VC_CODE = source.NEXT_VC_CODE,
                                                                                                                                                                                                    
    --         target.NEXT_VC_NAME = source.NEXT_VC_NAME,
                                                                                                                                                                                                    
    --         target.NEXT_HR_STATUS = source.NEXT_HR_STATUS,
                                                                                                                                                                                                
    --         target.NEXT_jobcode = source.NEXT_jobcode,
                                                                                                                                                                                                    
    --         target.NEXT_POSITION_NBR = source.NEXT_POSITION_NBR,
                                                                                                                                                                                          
    --         target.snapshot_date = source.snapshot_date,
                                                                                                                                                                                                  
    --         target.NOTE = source.NOTE
                                                                                                                                                                                                                     
    WHEN NOT MATCHED THEN
                                                                                                                                                                                                                                    
        INSERT (
                                                                                                                                                                                                                                             
            EMPLID, EMPL_RCD, VC_CODE, HR_STATUS, DEPTID, EFFDT, ACTION, ACTION_DT, jobcode, POSITION_NBR,
                                                                                                                                                   
            NEXT_DEPTID, NEXT_EFFDT, NEXT_ACTION, NEXT_VC_CODE, NEXT_VC_NAME, NEXT_HR_STATUS, NEXT_jobcode, NEXT_POSITION_NBR, snapshot_date, NOTE
                                                                                                           
        )
                                                                                                                                                                                                                                                    
        VALUES (
                                                                                                                                                                                                                                             
            source.EMPLID, source.EMPL_RCD, source.VC_CODE, source.HR_STATUS, source.DEPTID, source.EFFDT, source.ACTION, source.ACTION_DT, source.jobcode, source.POSITION_NBR,
                                                                             
            source.NEXT_DEPTID, source.NEXT_EFFDT, source.NEXT_ACTION, source.NEXT_VC_CODE, source.NEXT_VC_NAME, source.NEXT_HR_STATUS, source.NEXT_jobcode, source.NEXT_POSITION_NBR, source.snapshot_date, 'New'
                                           
        );
                                                                                                                                                                                                                                                   
    DROP TABLE IF EXISTS STAGE.EMPL_DEPT_TRANSFER_TEMP;
                                                                                                                                                                                                      
END

-- ===== stage.QA_SP_UKG_EMPLOYEE_DATA_DEBUG =====

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
CREATE   PROCEDURE [stage].[QA_SP_UKG_EMPLOYEE_DATA_DEBUG]
                                                                                                                                                                                                   
    @EMPLID VARCHAR(11) = '10816984'
                                                                                                                                                                                                                         
AS
                                                                                                                                                                                                                                                           
/***************************************
                                                                                                                                                                                                                     
* Created By: Jim Shih	
                                                                                                                                                                                                                                      
* Purpose: QA stored procedure to debug why specific employees are filtered out from UKG_EMPLOYEE_DATA
                                                                                                                                                       
* Usage: EXEC [stage].[QA_SP_UKG_EMPLOYEE_DATA_DEBUG] '10375422'
                                                                                                                                                                                             
* -- 08/25/2025 Jim Shih: Created to debug employee filtering logic
                                                                                                                                                                                          
******************************************/
                                                                                                                                                                                                                  
BEGIN
                                                                                                                                                                                                                                                        
    SET NOCOUNT ON;
                                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    PRINT '=== QA DEBUG FOR EMPLID: ' + @EMPLID + ' ===';
                                                                                                                                                                                                    
    PRINT '';
                                                                                                                                                                                                                                                

                                                                                                                                                                                                                                                             
    -- Step 1: Check if employee exists in base data
                                                                                                                                                                                                         
    PRINT '1. Checking if employee exists in health_ods.[health_ods].[RPT].CURRENT_EMPL_DATA...';
                                                                                                                                                            
    IF EXISTS (SELECT 1
                                                                                                                                                                                                                                      
    FROM health_ods.[health_ods].[RPT].CURRENT_EMPL_DATA
                                                                                                                                                                                                     
    WHERE EMPLID = @EMPLID)
                                                                                                                                                                                                                                  
    BEGIN
                                                                                                                                                                                                                                                    
        PRINT '   ? Employee found in health_ods.[health_ods].[RPT].CURRENT_EMPL_DATA';
                                                                                                                                                                      

                                                                                                                                                                                                                                                             
        SELECT
                                                                                                                                                                                                                                               
            EMPLID, JOB_INDICATOR, VC_CODE, DEPTID, hr_status, effdt,
                                                                                                                                                                                        
            PAY_FREQUENCY, EMPL_TYPE, JOBCODE
                                                                                                                                                                                                                
        FROM health_ods.[health_ods].[RPT].CURRENT_EMPL_DATA
                                                                                                                                                                                                 
        WHERE EMPLID = @EMPLID;
                                                                                                                                                                                                                              
    END
                                                                                                                                                                                                                                                      
    ELSE
                                                                                                                                                                                                                                                     
    BEGIN
                                                                                                                                                                                                                                                    
        PRINT '   ? Employee NOT found in CURRENT_EMPL_DATA';
                                                                                                                                                                                                
        RETURN;
                                                                                                                                                                                                                                              
    END
                                                                                                                                                                                                                                                      

                                                                                                                                                                                                                                                             
    PRINT '';
                                                                                                                                                                                                                                                

                                                                                                                                                                                                                                                             
    -- Step 2: Check BYA exclusion
                                                                                                                                                                                                                           
    PRINT '2. Checking BYA exclusion (CTE_exclude_BYA)...';
                                                                                                                                                                                                  
    IF EXISTS (
                                                                                                                                                                                                                                              
        SELECT 1
                                                                                                                                                                                                                                             
    FROM health_ods.[health_ods].[stable].PS_JOB H
                                                                                                                                                                                                           
    WHERE H.emplid = @EMPLID
                                                                                                                                                                                                                                 
        AND H.JOB_INDICATOR = 'P'
                                                                                                                                                                                                                            
        AND H.DML_IND <> 'D'
                                                                                                                                                                                                                                 
        AND H.SAL_ADMIN_PLAN = 'BYA'
                                                                                                                                                                                                                         
    )
                                                                                                                                                                                                                                                        
    BEGIN
                                                                                                                                                                                                                                                    
        PRINT '   ? Employee EXCLUDED due to SAL_ADMIN_PLAN = BYA';
                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
        SELECT H.emplid, H.SAL_ADMIN_PLAN, H.FLSA_STATUS, H.JOB_INDICATOR, H.DML_IND, H.EFFDT
                                                                                                                                                                
        FROM health_ods.[health_ods].[stable].PS_JOB H
                                                                                                                                                                                                       
        WHERE H.emplid = @EMPLID
                                                                                                                                                                                                                             
            AND H.JOB_INDICATOR = 'P'
                                                                                                                                                                                                                        
            AND H.DML_IND <> 'D'
                                                                                                                                                                                                                             
            AND H.SAL_ADMIN_PLAN = 'BYA';
                                                                                                                                                                                                                    
        RETURN;
                                                                                                                                                                                                                                              
    END
                                                                                                                                                                                                                                                      
    ELSE
                                                                                                                                                                                                                                                     
    BEGIN
                                                                                                                                                                                                                                                    
        PRINT '   ? Employee NOT excluded by BYA filter';
                                                                                                                                                                                                    
    END
                                                                                                                                                                                                                                                      

                                                                                                                                                                                                                                                             
    PRINT '';
                                                                                                                                                                                                                                                

                                                                                                                                                                                                                                                             
    -- Step 3: Check primary job criteria
                                                                                                                                                                                                                    
    PRINT '3. Checking primary job criteria...';
                                                                                                                                                                                                             
    DECLARE @JobIndicator VARCHAR(1), @VcCode VARCHAR(10), @DeptId VARCHAR(10), @HrStatus VARCHAR(1), 
                                                                                                                                                       
            @EffDt DATE, @PayFreq VARCHAR(1), @EmplType VARCHAR(1), @JobCode VARCHAR(10);
                                                                                                                                                                    

                                                                                                                                                                                                                                                             
    SELECT @JobIndicator = JOB_INDICATOR, @VcCode = VC_CODE, @DeptId = DEPTID,
                                                                                                                                                                               
        @HrStatus = hr_status, @EffDt = effdt, @PayFreq = PAY_FREQUENCY,
                                                                                                                                                                                     
        @EmplType = EMPL_TYPE, @JobCode = JOBCODE
                                                                                                                                                                                                            
    FROM health_ods.[health_ods].[RPT].CURRENT_EMPL_DATA
                                                                                                                                                                                                     
    WHERE EMPLID = @EMPLID;
                                                                                                                                                                                                                                  

                                                                                                                                                                                                                                                             
    -- Check each condition
                                                                                                                                                                                                                                  
    IF @JobIndicator <> 'P'
                                                                                                                                                                                                                                  
    BEGIN
                                                                                                                                                                                                                                                    
        PRINT '   ? JOB_INDICATOR is not P (Primary). Current value: ' + ISNULL(@JobIndicator, 'NULL');
                                                                                                                                                      
        RETURN;
                                                                                                                                                                                                                                              
    END
                                                                                                                                                                                                                                                      
    ELSE PRINT '   ? JOB_INDICATOR = P (Primary)';
                                                                                                                                                                                                           

                                                                                                                                                                                                                                                             
    IF @VcCode <> 'VCHSH' AND NOT (@DeptId BETWEEN '002000' AND '002999' AND @DeptId NOT IN ('002230','002231','002280'))
                                                                                                                                    
    BEGIN
                                                                                                                                                                                                                                                    
        PRINT '   ? VC_CODE/DEPTID criteria not met.';
                                                                                                                                                                                                       
        PRINT '     Valid criteria:';
                                                                                                                                                                                                                        
        PRINT '     - VC_CODE must be VCHSH (Medical Center)';
                                                                                                                                                                                               
        PRINT '     OR';
                                                                                                                                                                                                                                     
        PRINT '     - DEPTID must be between 002000 and 002999 (PHSO range)';
                                                                                                                                                                                
        PRINT '       AND DEPTID not in (002230, 002231, 002280)';
                                                                                                                                                                                           
        PRINT '     Current values: VC_CODE = ' + ISNULL(@VcCode, 'NULL') + ', DEPTID = ' + ISNULL(@DeptId, 'NULL');
                                                                                                                                         
        RETURN;
                                                                                                                                                                                                                                              
    END
                                                                                                                                                                                                                                                      
    ELSE 
                                                                                                                                                                                                                                                    
    BEGIN
                                                                                                                                                                                                                                                    
        PRINT '   ? VC_CODE/DEPTID criteria met';
                                                                                                                                                                                                            
        IF @VcCode = 'VCHSH'
                                                                                                                                                                                                                                 
            PRINT '     - Employee is in Medical Center (VC_CODE = VCHSH)';
                                                                                                                                                                                  
        ELSE
                                                                                                                                                                                                                                                 
            PRINT '     - Employee is in PHSO range (DEPTID between 002000-002999, excluding 002230,002231,002280)';
                                                                                                                                         
    END
                                                                                                                                                                                                                                                      

                                                                                                                                                                                                                                                             
    IF NOT ((@HrStatus = 'A') OR (@HrStatus = 'I' AND CONVERT(DATE, @EffDt) = CONVERT(DATE, GETDATE())))
                                                                                                                                                     
    BEGIN
                                                                                                                                                                                                                                                    
        PRINT '   ? HR_STATUS criteria not met. HR_STATUS: ' + ISNULL(@HrStatus, 'NULL') + ', EFFDT: ' + ISNULL(CONVERT(VARCHAR, @EffDt), 'NULL');
                                                                                                           
        RETURN;
                                                                                                                                                                                                                                              
    END
                                                                                                                                                                                                                                                      
    ELSE PRINT '   ? HR_STATUS criteria met';
                                                                                                                                                                                                                

                                                                                                                                                                                                                                                             
    IF @PayFreq <> 'B'
                                                                                                                                                                                                                                       
    BEGIN
                                                                                                                                                                                                                                                    
        PRINT '   ? PAY_FREQUENCY is not B (Biweekly). Current value: ' + ISNULL(@PayFreq, 'NULL');
                                                                                                                                                          
        RETURN;
                                                                                                                                                                                                                                              
    END
                                                                                                                                                                                                                                                      
    ELSE PRINT '   ? PAY_FREQUENCY = B (Biweekly)';
                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    IF @EmplType <> 'H'
                                                                                                                                                                                                                                      
    BEGIN
                                                                                                                                                                                                                                                    
        PRINT '   ? EMPL_TYPE is not H (Hourly). Current value: ' + ISNULL(@EmplType, 'NULL');
                                                                                                                                                               
        RETURN;
                                                                                                                                                                                                                                              
    END
                                                                                                                                                                                                                                                      
    ELSE PRINT '   ? EMPL_TYPE = H (Hourly)';
                                                                                                                                                                                                                

                                                                                                                                                                                                                                                             
    IF (@DeptId IN ('002053','002056','003919') AND @JobCode IN ('000770','000771','000772','000775','000776'))
                                                                                                                                              
    BEGIN
                                                                                                                                                                                                                                                    
        PRINT '   ? Employee excluded due to ARC MSP population criteria. DEPTID: ' + @DeptId + ', JOBCODE: ' + @JobCode;
                                                                                                                                    
        RETURN;
                                                                                                                                                                                                                                              
    END
                                                                                                                                                                                                                                                      
    ELSE PRINT '   ? Not excluded by ARC MSP population criteria';
                                                                                                                                                                                           

                                                                                                                                                                                                                                                             
    PRINT '';
                                                                                                                                                                                                                                                

                                                                                                                                                                                                                                                             
    -- Step 4: Check if in UKG_EMPL_E_T
                                                                                                                                                                                                                      
    PRINT '4. Checking if employee would be in STAGE.UKG_EMPL_E_T...';
                                                                                                                                                                                       
    PRINT '   ? Employee meets all UKG_EMPL_E_T criteria';
                                                                                                                                                                                                   

                                                                                                                                                                                                                                                             
    PRINT '';
                                                                                                                                                                                                                                                

                                                                                                                                                                                                                                                             
    -- Step 5: Check final query joins and conditions
                                                                                                                                                                                                        
    PRINT '5. Checking final query table joins...';
                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    -- Check if employee has business structure data
                                                                                                                                                                                                         
    SELECT
                                                                                                                                                                                                                                                   
        EMPL.EMPLID,
                                                                                                                                                                                                                                         
        FIN.POSITION_NBR,
                                                                                                                                                                                                                                    
        FIN.FDM_COMBO_CD,
                                                                                                                                                                                                                                    
        UKG_BS.COMBOCODE,
                                                                                                                                                                                                                                    
        UKG_BS.Organization,
                                                                                                                                                                                                                                 
        UKG_BS.EntityTitle,
                                                                                                                                                                                                                                  
        UKG_BS.ServiceLineTitle,
                                                                                                                                                                                                                             
        UKG_BS.FinancialUnit,
                                                                                                                                                                                                                                
        UKG_BS.FundGroup
                                                                                                                                                                                                                                     
    FROM health_ods.[health_ods].[RPT].CURRENT_EMPL_DATA EMPL
                                                                                                                                                                                                
        LEFT OUTER JOIN health_ods.[HEALTH_ODS].[RPT].[CURRENT_POSITION_PRI_FIN_UNIT] FIN
                                                                                                                                                                    
        ON EMPL.POSITION_NBR = FIN.POSITION_NBR
                                                                                                                                                                                                              
        LEFT OUTER JOIN [hts].[UKG_BusinessStructure] UKG_BS
                                                                                                                                                                                                 
        ON UKG_BS.COMBOCODE = FIN.FDM_COMBO_CD
                                                                                                                                                                                                               
    WHERE EMPL.EMPLID = @EMPLID;
                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
    PRINT '';
                                                                                                                                                                                                                                                
    PRINT '=== DEBUG COMPLETE ===';
                                                                                                                                                                                                                          
    PRINT 'If employee meets all criteria above, check for data timing issues or recent changes.';
                                                                                                                                                           

                                                                                                                                                                                                                                                             
END

-- ===== stage.SP_Check_Person_Business_Structure =====

                                                                                                                                                                                                                                                             
CREATE   PROCEDURE [stage].[SP_Check_Person_Business_Structure]
                                                                                                                                                                                              
    @emplid VARCHAR(11)
                                                                                                                                                                                                                                      
AS
                                                                                                                                                                                                                                                           
-- exec [stage].[SP_Check_Person_Business_Structure] @emplid = '10401420'
                                                                                                                                                                                    
BEGIN
                                                                                                                                                                                                                                                        
    SET NOCOUNT ON;
                                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
--SELECT p.[Person Number]
                                                                                                                                                                                                                                   
--      , p.[First Name]
                                                                                                                                                                                                                                     
--      , p.[Last Name]
                                                                                                                                                                                                                                      
--      , p.[Parent Path]
                                                                                                                                                                                                                                    
--         , bs.[Parent Path] as UKG_BusinessStructure
                                                                                                                                                                                                       
--FROM [BCK].[Person_Import_LOOKUP] p                    -- source from [dbo].[UKG_EMPLOYEE_DATA]
                                                                                                                                                            
--    LEFT JOIN [BCK].[UKG_BusinessStructure_lookup] bs  -- source from [HealthTime].[hts].[UKG_BusinessStructure]
                                                                                                                                           
--    ON p.[Parent Path] = bs.[Parent Path]
                                                                                                                                                                                                                  
--WHERE p.[Person Number] IN (
                                                                                                                                                                                                                               
--    '10401420', '10405360', '10406848', '10409321', '10413689',
                                                                                                                                                                                            
--    '10415110', '10420612', '10422674', '10438746', '10467173',
                                                                                                                                                                                            
--    '10491749', '10578994', '10624479', '10649385', '10705785',
                                                                                                                                                                                            
--    '10715715', '10730925', '10744203', '10822439'
                                                                                                                                                                                                         
--)
                                                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
    SELECT
                                                                                                                                                                                                                                                   
        empl.EMPLID,
                                                                                                                                                                                                                                         
        empl.[First Name],
                                                                                                                                                                                                                                   
        empl.[Last Name],
                                                                                                                                                                                                                                    
        empl.[Employment Status],
                                                                                                                                                                                                                            
        empl.[Home/Primary Job],
                                                                                                                                                                                                                             
        empl.DEPTID,
                                                                                                                                                                                                                                         
        empl.[Reports to Manager],
                                                                                                                                                                                                                           
        B.[Person Number],
                                                                                                                                                                                                                                   
        B.FundGroup,
                                                                                                                                                                                                                                         
        B.[Parent Path],
                                                                                                                                                                                                                                     
        B.Loaded_DT,
                                                                                                                                                                                                                                         
        CASE 
                                                                                                                                                                                                                                                
            WHEN UBS.combocode IS NOT NULL THEN 'MATCH FOUND'
                                                                                                                                                                                                
            ELSE 'NO MATCH'
                                                                                                                                                                                                                                  
        END AS BusinessStructure_Match_Status,
                                                                                                                                                                                                               
        UBS.combocode AS Matched_BusinessStructure_ComboCode
                                                                                                                                                                                                 
    FROM [dbo].[UKG_EMPLOYEE_DATA] empl
                                                                                                                                                                                                                      
        INNER JOIN stage.UKG_EMPL_Business_Structure B
                                                                                                                                                                                                       
        ON empl.EMPLID = B.[Person Number]
                                                                                                                                                                                                                   
        LEFT JOIN [hts].[UKG_BusinessStructure] UBS
                                                                                                                                                                                                          
        ON B.FundGroup = UBS.FundGroup
                                                                                                                                                                                                                       
    WHERE empl.EMPLID = @emplid;
                                                                                                                                                                                                                             
    -- Return row count for verification
                                                                                                                                                                                                                     
    IF @@ROWCOUNT = 0
                                                                                                                                                                                                                                        
    BEGIN
                                                                                                                                                                                                                                                    
        PRINT 'No employee found with EMPLID: ' + @emplid;
                                                                                                                                                                                                   
    END
                                                                                                                                                                                                                                                      
    ELSE
                                                                                                                                                                                                                                                     
    BEGIN
                                                                                                                                                                                                                                                    
        PRINT 'Employee data retrieved for EMPLID: ' + @emplid;
                                                                                                                                                                                              
    END
                                                                                                                                                                                                                                                      

                                                                                                                                                                                                                                                             
END

-- ===== stage.SP_Check_Update_A =====

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
/*
                                                                                                                                                                                                                                                           
=============================================================================
                                                                                                                                                                                
Stored Procedure: SP_Check_Update_A
                                                                                                                                                                                                                          
Description: Checks if Check_Disabled=0 for MONITOR_A before executing date updates
                                                                                                                                                                          
Version: 1.0
                                                                                                                                                                                                                                                 
Created: 2025-12-16
                                                                                                                                                                                                                                          
Created by: Jim Shih
                                                                                                                                                                                                                                         

                                                                                                                                                                                                                                                             
Logic Explanation:
                                                                                                                                                                                                                                           
1. Checks if MONITOR_A exists in [stage].[UKG_Accrual_Monitor_Schedule]
                                                                                                                                                                                      
2. Retrieves Check_Disabled value for MONITOR_A (0=enabled, 1=disabled)
                                                                                                                                                                                      
3. If Check_Disabled=1, executes sequential updates:
                                                                                                                                                                                                         
   - Update 1: Advances payenddt by 28 days
                                                                                                                                                                                                                  
   - Update 2: Sets payenddt_NEXT (+28 days) and Next_Monitor_Start_DT (+29 days)
                                                                                                                                                                            
   - Update 3: Sets Monitor_Start_DT (+1 day) and Monitor_End_DT (+25 days)
                                                                                                                                                                                  
   - Update 4: Sets MONITOR_A Check_Disabled=0 
                                                                                                                                                                                                              

                                                                                                                                                                                                                                                             
5. Provides comprehensive logging and error handling throughout process
                                                                                                                                                                                      

                                                                                                                                                                                                                                                             
Execution: EXEC [stage].[SP_Check_Update_A];
                                                                                                                                                                                                                 

                                                                                                                                                                                                                                                             
Version History:
                                                                                                                                                                                                                                             
v1.0 (2025-12-16) - Initial creation with Check_Disabled logic and cross-monitor coordination
                                                                                                                                                                
=============================================================================
                                                                                                                                                                                
*/
                                                                                                                                                                                                                                                           

                                                                                                                                                                                                                                                             
CREATE   PROCEDURE [stage].[SP_Check_Update_A]
                                                                                                                                                                                                               
AS
                                                                                                                                                                                                                                                           
BEGIN
                                                                                                                                                                                                                                                        
    SET NOCOUNT ON;
                                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    DECLARE @Check_Disabled INT;
                                                                                                                                                                                                                             
    DECLARE @MonitorExists BIT = 0;
                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    BEGIN TRY
                                                                                                                                                                                                                                                
        -- Check if MONITOR_A exists in the table
                                                                                                                                                                                                            
        IF EXISTS (SELECT 1
                                                                                                                                                                                                                                  
    FROM [stage].[UKG_Accrual_Monitor_Schedule]
                                                                                                                                                                                                              
    WHERE [Monitor] = 'MONITOR_A')
                                                                                                                                                                                                                           
        BEGIN
                                                                                                                                                                                                                                                
        SET @MonitorExists = 1;
                                                                                                                                                                                                                              

                                                                                                                                                                                                                                                             
        -- Get Check_Disabled for MONITOR_A (assuming Check_Disabled is a column in the table)
                                                                                                                                                               
        SELECT @Check_Disabled = ISNULL([Check_Disabled], -1)
                                                                                                                                                                                                
        FROM [stage].[UKG_Accrual_Monitor_Schedule]
                                                                                                                                                                                                          
        WHERE [Monitor] = 'MONITOR_A';
                                                                                                                                                                                                                       

                                                                                                                                                                                                                                                             
        PRINT 'MONITOR_A found. Check_Disabled = ' + CAST(@Check_Disabled AS VARCHAR(10));
                                                                                                                                                                   

                                                                                                                                                                                                                                                             
        -- Check if Check_Disabled = 0
                                                                                                                                                                                                                       
        IF @Check_Disabled = 1
                                                                                                                                                                                                                               
            BEGIN
                                                                                                                                                                                                                                            
            PRINT 'Condition met (Check_Disabled=1). Executing updates for MONITOR_A...';
                                                                                                                                                                    

                                                                                                                                                                                                                                                             
            -- Update 1: Update payenddt (add 28 days)
                                                                                                                                                                                                       
            UPDATE [stage].[UKG_Accrual_Monitor_Schedule]
                                                                                                                                                                                                    
                   SET [payenddt] = FORMAT(DATEADD(DAY, 28, CAST([payenddt] AS DATE)), 'yyyy-MM-dd'),
                                                                                                                                                        
                       [Update_DT] = GETDATE()
                                                                                                                                                                                                               
                 WHERE [Monitor] = 'MONITOR_A'
                                                                                                                                                                                                               
                AND [payenddt] IS NOT NULL;
                                                                                                                                                                                                                  

                                                                                                                                                                                                                                                             
            PRINT 'Update 1 completed: payenddt updated (added 28 days)';
                                                                                                                                                                                    

                                                                                                                                                                                                                                                             
            -- Update 2: Update payenddt_NEXT and Next_Monitor_Start_DT
                                                                                                                                                                                      
            UPDATE [stage].[UKG_Accrual_Monitor_Schedule]
                                                                                                                                                                                                    
                   SET [payenddt_NEXT] = FORMAT(DATEADD(DAY, 28, CAST([payenddt] AS DATE)), 'yyyy-MM-dd'),
                                                                                                                                                   
                       [Next_Monitor_Start_DT] = FORMAT(DATEADD(DAY, 29, CAST([payenddt] AS DATE)), 'yyyy-MM-dd'),
                                                                                                                                           
                       [Update_DT] = GETDATE()
                                                                                                                                                                                                               
                 WHERE [Monitor] = 'MONITOR_A'
                                                                                                                                                                                                               
                AND [payenddt] IS NOT NULL;
                                                                                                                                                                                                                  

                                                                                                                                                                                                                                                             
            PRINT 'Update 2 completed: payenddt_NEXT (added 28 days) and Next_Monitor_Start_DT (added 29 days) updated';
                                                                                                                                     

                                                                                                                                                                                                                                                             
            -- Update 3: Update Monitor_Start_DT and Monitor_End_DT
                                                                                                                                                                                          
            UPDATE [stage].[UKG_Accrual_Monitor_Schedule]
                                                                                                                                                                                                    
                   SET [Monitor_Start_DT] = FORMAT(DATEADD(DAY, 1, CAST([payenddt] AS DATE)), 'yyyy-MM-dd'),
                                                                                                                                                 
                       [Monitor_End_DT] = FORMAT(DATEADD(DAY, 23, CAST([payenddt] AS DATE)), 'yyyy-MM-dd'),
                                                                                                                                                  
                       [Update_DT] = GETDATE()
                                                                                                                                                                                                               
                 WHERE [Monitor] = 'MONITOR_A'
                                                                                                                                                                                                               
                AND [payenddt] IS NOT NULL;
                                                                                                                                                                                                                  

                                                                                                                                                                                                                                                             
            PRINT 'Update 3 completed: Monitor_Start_DT (added 1 day) and Monitor_End_DT (added 25 days) updated';
                                                                                                                                           

                                                                                                                                                                                                                                                             
            -- Update 4: Set Check_Disabled to 0 for MONITOR_A after all updates are completed
                                                                                                                                                               
            UPDATE [stage].[UKG_Accrual_Monitor_Schedule]
                                                                                                                                                                                                    
                   SET [Check_Disabled] = 0,
                                                                                                                                                                                                                 
                       [Update_DT] = GETDATE()
                                                                                                                                                                                                               
                 WHERE [Monitor] = 'MONITOR_A';
                                                                                                                                                                                                              

                                                                                                                                                                                                                                                             
            PRINT 'Update 4 completed: Check_Disabled set to 1 for MONITOR_A';
                                                                                                                                                                               

                                                                                                                                                                                                                                                             
            ---- Update 5: Set Check_Disabled to 0 for MONITOR_B (change from 1 to 0)
                                                                                                                                                                        
            --UPDATE [stage].[UKG_Accrual_Monitor_Schedule]
                                                                                                                                                                                                  
            --       SET [Check_Disabled] = 0,
                                                                                                                                                                                                               
            --           [Update_DT] = GETDATE()
                                                                                                                                                                                                             
            --     WHERE [Monitor] = 'MONITOR_B'
                                                                                                                                                                                                             
            --    AND [Check_Disabled] = 1;
                                                                                                                                                                                                                  

                                                                                                                                                                                                                                                             
            --IF @@ROWCOUNT > 0
                                                                                                                                                                                                                              
            --    PRINT 'Update 5 completed: Check_Disabled set to 0 for MONITOR_B (was 1)'
                                                                                                                                                                  
            --ELSE
                                                                                                                                                                                                                                           
            --    PRINT 'Update 5 skipped: MONITOR_B not found or Check_Disabled was not 1';
                                                                                                                                                                 
            --PRINT 'All updates for MONITOR_A completed successfully.';
                                                                                                                                                                                     
        END
                                                                                                                                                                                                                                                  
            ELSE
                                                                                                                                                                                                                                             
            BEGIN
                                                                                                                                                                                                                                            
            PRINT 'Condition not met. Check_Disabled = ' + CAST(@Check_Disabled AS VARCHAR(10)) + ' (expected 0). No updates performed.';
                                                                                                                    
        END
                                                                                                                                                                                                                                                  
    END
                                                                                                                                                                                                                                                      
        ELSE
                                                                                                                                                                                                                                                 
        BEGIN
                                                                                                                                                                                                                                                
        PRINT 'MONITOR_A not found in [stage].[UKG_Accrual_Monitor_Schedule]. No updates performed.';
                                                                                                                                                        
    END
                                                                                                                                                                                                                                                      
        
                                                                                                                                                                                                                                                     
    END TRY
                                                                                                                                                                                                                                                  
    BEGIN CATCH
                                                                                                                                                                                                                                              
        -- Error handling
                                                                                                                                                                                                                                    
        PRINT 'Error occurred: ' + ERROR_MESSAGE();
                                                                                                                                                                                                          
        PRINT 'Error Line: ' + CAST(ERROR_LINE() AS VARCHAR(10));
                                                                                                                                                                                            
        THROW;
                                                                                                                                                                                                                                               
    END CATCH
                                                                                                                                                                                                                                                
END

-- ===== stage.SP_Check_Update_B =====

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
/*
                                                                                                                                                                                                                                                           
=============================================================================
                                                                                                                                                                                
Stored Procedure: SP_Check_Update_B
                                                                                                                                                                                                                          
Description: Checks if Check_Disabled=0 for MONITOR_B before executing date updates
                                                                                                                                                                          
Version: 1.0
                                                                                                                                                                                                                                                 
Created: 2025-12-16
                                                                                                                                                                                                                                          
Created by: Jim Shih
                                                                                                                                                                                                                                         

                                                                                                                                                                                                                                                             
Logic Explanation:
                                                                                                                                                                                                                                           
1. Checks if MONITOR_B exists in [stage].[UKG_Accrual_Monitor_Schedule]
                                                                                                                                                                                      
2. Retrieves Check_Disabled value for MONITOR_B (0=enabled, 1=disabled)
                                                                                                                                                                                      
3. If Check_Disabled=0, executes sequential updates:
                                                                                                                                                                                                         
   - Update 1: Advances payenddt by 28 days
                                                                                                                                                                                                                  
   - Update 2: Sets payenddt_NEXT (+28 days) and Next_Monitor_Start_DT (+29 days)
                                                                                                                                                                            
   - Update 3: Sets Monitor_Start_DT (+1 day) and Monitor_End_DT (+25 days)
                                                                                                                                                                                  
   - Update 4: Sets MONITOR_B Check_Disabled=1 (prevents re-execution)
                                                                                                                                                                                       
   - Update 5: Sets MONITOR_A Check_Disabled=0 (enables MONITOR_A to run next)
                                                                                                                                                                               
4. Creates alternating execution pattern between MONITOR_A and MONITOR_B
                                                                                                                                                                                     
5. Provides comprehensive logging and error handling throughout process
                                                                                                                                                                                      

                                                                                                                                                                                                                                                             
Execution: EXEC [stage].[SP_Check_Update_B];
                                                                                                                                                                                                                 

                                                                                                                                                                                                                                                             
Version History:
                                                                                                                                                                                                                                             
v1.0 (2025-12-16) - Initial creation with Check_Disabled logic and cross-monitor coordination
                                                                                                                                                                
=============================================================================
                                                                                                                                                                                
*/
                                                                                                                                                                                                                                                           

                                                                                                                                                                                                                                                             
CREATE   PROCEDURE [stage].[SP_Check_Update_B]
                                                                                                                                                                                                               
AS
                                                                                                                                                                                                                                                           
BEGIN
                                                                                                                                                                                                                                                        
    SET NOCOUNT ON;
                                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    DECLARE @Check_Disabled INT;
                                                                                                                                                                                                                             
    DECLARE @MonitorExists BIT = 0;
                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    BEGIN TRY
                                                                                                                                                                                                                                                
        -- Check if MONITOR_B exists in the table
                                                                                                                                                                                                            
        IF EXISTS (SELECT 1
                                                                                                                                                                                                                                  
    FROM [stage].[UKG_Accrual_Monitor_Schedule]
                                                                                                                                                                                                              
    WHERE [Monitor] = 'MONITOR_B')
                                                                                                                                                                                                                           
        BEGIN
                                                                                                                                                                                                                                                
        SET @MonitorExists = 1;
                                                                                                                                                                                                                              

                                                                                                                                                                                                                                                             
        -- Get Check_Disabled for MONITOR_B (assuming Check_Disabled is a column in the table)
                                                                                                                                                               
        SELECT @Check_Disabled = ISNULL([Check_Disabled], -1)
                                                                                                                                                                                                
        FROM [stage].[UKG_Accrual_Monitor_Schedule]
                                                                                                                                                                                                          
        WHERE [Monitor] = 'MONITOR_B';
                                                                                                                                                                                                                       

                                                                                                                                                                                                                                                             
        PRINT 'MONITOR_B found. Check_Disabled = ' + CAST(@Check_Disabled AS VARCHAR(10));
                                                                                                                                                                   

                                                                                                                                                                                                                                                             
        -- Check if Check_Disabled = 0
                                                                                                                                                                                                                       
        IF @Check_Disabled = 0
                                                                                                                                                                                                                               
            BEGIN
                                                                                                                                                                                                                                            
            PRINT 'Condition met (Check_Disabled=0). Executing updates for MONITOR_B...';
                                                                                                                                                                    

                                                                                                                                                                                                                                                             
            -- Update 1: Update payenddt (add 28 days)
                                                                                                                                                                                                       
            UPDATE [stage].[UKG_Accrual_Monitor_Schedule]
                                                                                                                                                                                                    
                   SET [payenddt] = FORMAT(DATEADD(DAY, 28, CAST([payenddt] AS DATE)), 'yyyy-MM-dd'),
                                                                                                                                                        
                       [Update_DT] = GETDATE()
                                                                                                                                                                                                               
                 WHERE [Monitor] = 'MONITOR_B'
                                                                                                                                                                                                               
                AND [payenddt] IS NOT NULL;
                                                                                                                                                                                                                  

                                                                                                                                                                                                                                                             
            PRINT 'Update 1 completed: payenddt updated (added 28 days)';
                                                                                                                                                                                    

                                                                                                                                                                                                                                                             
            -- Update 2: Update payenddt_NEXT and Next_Monitor_Start_DT
                                                                                                                                                                                      
            UPDATE [stage].[UKG_Accrual_Monitor_Schedule]
                                                                                                                                                                                                    
                   SET [payenddt_NEXT] = FORMAT(DATEADD(DAY, 28, CAST([payenddt] AS DATE)), 'yyyy-MM-dd'),
                                                                                                                                                   
                       [Next_Monitor_Start_DT] = FORMAT(DATEADD(DAY, 29, CAST([payenddt] AS DATE)), 'yyyy-MM-dd'),
                                                                                                                                           
                       [Update_DT] = GETDATE()
                                                                                                                                                                                                               
                 WHERE [Monitor] = 'MONITOR_B'
                                                                                                                                                                                                               
                AND [payenddt] IS NOT NULL;
                                                                                                                                                                                                                  

                                                                                                                                                                                                                                                             
            PRINT 'Update 2 completed: payenddt_NEXT (added 28 days) and Next_Monitor_Start_DT (added 29 days) updated';
                                                                                                                                     

                                                                                                                                                                                                                                                             
            -- Update 3: Update Monitor_Start_DT and Monitor_End_DT
                                                                                                                                                                                          
            UPDATE [stage].[UKG_Accrual_Monitor_Schedule]
                                                                                                                                                                                                    
                   SET [Monitor_Start_DT] = FORMAT(DATEADD(DAY, 1, CAST([payenddt] AS DATE)), 'yyyy-MM-dd'),
                                                                                                                                                 
                       [Monitor_End_DT] = FORMAT(DATEADD(DAY, 23, CAST([payenddt] AS DATE)), 'yyyy-MM-dd'),
                                                                                                                                                  
                       [Update_DT] = GETDATE()
                                                                                                                                                                                                               
                 WHERE [Monitor] = 'MONITOR_B'
                                                                                                                                                                                                               
                AND [payenddt] IS NOT NULL;
                                                                                                                                                                                                                  

                                                                                                                                                                                                                                                             
            PRINT 'Update 3 completed: Monitor_Start_DT (added 1 day) and Monitor_End_DT (added 25 days) updated';
                                                                                                                                           

                                                                                                                                                                                                                                                             
            -- Update 4: Set Check_Disabled to 1 for MONITOR_B after all updates are completed
                                                                                                                                                               
            UPDATE [stage].[UKG_Accrual_Monitor_Schedule]
                                                                                                                                                                                                    
SET [Check_Disabled] = 1,
                                                                                                                                                                                                                                    
                       [Update_DT] = GETDATE()
                                                                                                                                                                                                               
                 WHERE [Monitor] = 'MONITOR_B';
                                                                                                                                                                                                              

                                                                                                                                                                                                                                                             
            PRINT 'Update 4 completed: Check_Disabled set to 1 for MONITOR_B';
                                                                                                                                                                               

                                                                                                                                                                                                                                                             
            -- Update 5: Set Check_Disabled to 0 for MONITOR_A (change from 1 to 0)
                                                                                                                                                                          
            UPDATE [stage].[UKG_Accrual_Monitor_Schedule]
                                                                                                                                                                                                    
                   SET [Check_Disabled] = 0,
                                                                                                                                                                                                                 
                       [Update_DT] = GETDATE()
                                                                                                                                                                                                               
                 WHERE [Monitor] = 'MONITOR_A'
                                                                                                                                                                                                               
                AND [Check_Disabled] = 1;
                                                                                                                                                                                                                    

                                                                                                                                                                                                                                                             
            IF @@ROWCOUNT > 0
                                                                                                                                                                                                                                
                PRINT 'Update 5 completed: Check_Disabled set to 0 for MONITOR_A (was 1)'
                                                                                                                                                                    
            ELSE
                                                                                                                                                                                                                                             
                PRINT 'Update 5 skipped: MONITOR_A not found or Check_Disabled was not 1';
                                                                                                                                                                   
            PRINT 'All updates for MONITOR_B completed successfully.';
                                                                                                                                                                                       
        END
                                                                                                                                                                                                                                                  
            ELSE
                                                                                                                                                                                                                                             
            BEGIN
                                                                                                                                                                                                                                            
            PRINT 'Condition not met. Check_Disabled = ' + CAST(@Check_Disabled AS VARCHAR(10)) + ' (expected 0). No updates performed.';
                                                                                                                    
        END
                                                                                                                                                                                                                                                  
    END
                                                                                                                                                                                                                                                      
        ELSE
                                                                                                                                                                                                                                                 
        BEGIN
                                                                                                                                                                                                                                                
        PRINT 'MONITOR_B not found in [stage].[UKG_Accrual_Monitor_Schedule]. No updates performed.';
                                                                                                                                                        
    END
                                                                                                                                                                                                                                                      
        
                                                                                                                                                                                                                                                     
    END TRY
                                                                                                                                                                                                                                                  
    BEGIN CATCH
                                                                                                                                                                                                                                              
        -- Error handling
                                                                                                                                                                                                                                    
        PRINT 'Error occurred: ' + ERROR_MESSAGE();
                                                                                                                                                                                                          
        PRINT 'Error Line: ' + CAST(ERROR_LINE() AS VARCHAR(10));
                                                                                                                                                                                            
        THROW;
                                                                                                                                                                                                                                               
    END CATCH
                                                                                                                                                                                                                                                
END

-- ===== stage.SP_CheckByPosition_Health_ODS =====

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
----------------------------------------------------------------------------------------------------
                                                                                                                                                         
-- Stored Procedure: [stage].[SP_CheckByPosition_Health_ODS]
                                                                                                                                                                                                 
-- Description: This stored procedure performs comprehensive checks on a position number
                                                                                                                                                                     
--              across multiple Health ODS tables to validate position data integrity and
                                                                                                                                                                    
--              business structure mappings used in UKG employee data processing.
                                                                                                                                                                            
--
                                                                                                                                                                                                                                                           
-- Purpose: Used for troubleshooting and validating position data when employees are
                                                                                                                                                                         
--          filtered out of UKG_EMPLOYEE_DATA_BUILD due to missing or invalid position
                                                                                                                                                                       
--          information.
                                                                                                                                                                                                                                     
--
                                                                                                                                                                                                                                                           
-- Checks Performed:
                                                                                                                                                                                                                                         
-- 1. Position status and department in PS_POSITION_DATA
                                                                                                                                                                                                     
-- 2. Department budget information in PS_DEPT_BUDGET_ERN
                                                                                                                                                                                                    
-- 3. Financial unit information in CURRENT_POSITION_PRI_FIN_UNIT
                                                                                                                                                                                            
-- 4. Business structure mapping between UCPath and UKG systems
                                                                                                                                                                                              
--
                                                                                                                                                                                                                                                           
-- Version Control:
                                                                                                                                                                                                                                          
-- Date Modified  |  Author      |   Description
                                                                                                                                                                                                             
-- ---------------|--------------|----------------------------------------------------
                                                                                                                                                                       
-- 2025-09-06     | Jim Shih     | Initial creation for position data validation
                                                                                                                                                                             
----------------------------------------------------------------------------------------------------
                                                                                                                                                         

                                                                                                                                                                                                                                                             
CREATE     PROCEDURE [stage].[SP_CheckByPosition_Health_ODS]
                                                                                                                                                                                                 
    @POSITION_NBR NVARCHAR(10)
                                                                                                                                                                                                                               
AS
                                                                                                                                                                                                                                                           
-- Example usage:
                                                                                                                                                                                                                                            
-- EXEC [stage].[SP_CheckByPosition_Health_ODS] @POSITION_NBR = '40686393';
                                                                                                                                                                                  
--
                                                                                                                                                                                                                                                           
-- Parameters:
                                                                                                                                                                                                                                               
-- @POSITION_NBR: The position number to check across all related tables
                                                                                                                                                                                     
BEGIN
                                                                                                                                                                                                                                                        
    SET NOCOUNT ON;
                                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    -- Create a table variable to store informational messages
                                                                                                                                                                                               
    DECLARE @messages TABLE (
                                                                                                                                                                                                                                
        message_id INT IDENTITY(1,1),
                                                                                                                                                                                                                        
        message_text VARCHAR(MAX)
                                                                                                                                                                                                                            
    );
                                                                                                                                                                                                                                                       

                                                                                                                                                                                                                                                             
    -- ============================================================================================
                                                                                                                                                          
    -- 1. POSITION STATUS AND DEPARTMENT VALIDATION
                                                                                                                                                                                                          
    -- ============================================================================================
                                                                                                                                                          
    -- Check POSN_STATUS (should be 'A' for Active) and deptid in STABLE.PS_POSITION_DATA
                                                                                                                                                                    
    -- This validates that the position exists and is currently active
                                                                                                                                                                                       
    INSERT INTO @messages
                                                                                                                                                                                                                                    
        (message_text)
                                                                                                                                                                                                                                       
    VALUES
                                                                                                                                                                                                                                                   
        ('1. Checking POSN_STATUS (should be A for Active) and deptid in STABLE.PS_POSITION_DATA');
                                                                                                                                                          

                                                                                                                                                                                                                                                             
    -- Display the current check message
                                                                                                                                                                                                                     
    SELECT message_id, message_text
                                                                                                                                                                                                                          
    FROM @messages
                                                                                                                                                                                                                                           
    WHERE message_id = 1;
                                                                                                                                                                                                                                    

                                                                                                                                                                                                                                                             
    -- Query position data, showing most recent records first
                                                                                                                                                                                                
    SELECT
                                                                                                                                                                                                                                                   
        POSN_STATUS,
                                                                                                                                                                                                                                         
        deptid,
                                                                                                                                                                                                                                              
        POSITION_NBR,
                                                                                                                                                                                                                                        
        EFFDT,
                                                                                                                                                                                                                                               
        DML_IND
                                                                                                                                                                                                                                              
    FROM health_ods.[health_ods].stable.PS_POSITION_DATA
                                                                                                                                                                                                     
    WHERE POSITION_NBR = @POSITION_NBR
                                                                                                                                                                                                                       
        AND dml_ind <> 'D'
                                                                                                                                                                                                                                   
    -- Exclude deleted records
                                                                                                                                                                                                                               
    ORDER BY effdt DESC;
                                                                                                                                                                                                                                     

                                                                                                                                                                                                                                                             
    -- ============================================================================================
                                                                                                                                                          
    -- 2. DEPARTMENT BUDGET VALIDATION
                                                                                                                                                                                                                       
    -- ============================================================================================
                                                                                                                                                          
    -- Check deptid and budget information in PS_DEPT_BUDGET_ERN
                                                                                                                                                                                             
    -- This ensures the position has proper budget allocation
                                                                                                                                                                                                
    INSERT INTO @messages
                                                                                                                                                                                                                                    
        (message_text)
                                                                                                                                                                                                                                       
    VALUES
                                                                                                                                                                                                                                                   
        ('2. Checking deptid and budget information in health_ods.[health_ods].stable.PS_DEPT_BUDGET_ERN');
                                                                                                                                                  

                                                                                                                                                                                                                                                             
    SELECT message_id, message_text
                                                                                                                                                                                                                          
    FROM @messages
                                                                                                                                                                                                                                           
    WHERE message_id = 2;
                                                                                                                                                                                                                                    

                                                                                                                                                                                                                                                             
    -- Query budget data, ordered by fiscal year and effective date
                                                                                                                                                                                          
    SELECT
                                                                                                                                                                                                                                                   
        deptid,
                                                                                                                                                                                                                                              
        POSITION_NBR,
                                                                                                                                                                                                                                        
        FISCAL_YEAR,
                                                                                                                                                                                                                                         
        EFFDT,
                                                                                                                                                                                                                                               
        EFFSEQ,
                                                                                                                                                                                                                                              
        BUDGET_SEQ,
                                                                                                                                                                                                                                          
        DML_IND
                                                                                                                                                                                                                                              
    FROM health_ods.[health_ods].stable.PS_DEPT_BUDGET_ERN
                                                                                                                                                                                                   
    WHERE POSITION_NBR = @POSITION_NBR
                                                                                                                                                                                                                       
        AND dml_ind <> 'D'
                                                                                                                                                                                                                                   
    -- Exclude deleted records
                                                                                                                                                                                                                               
    ORDER BY fiscal_year DESC, effdt DESC, effseq DESC, BUDGET_SEQ DESC;
                                                                                                                                                                                     

                                                                                                                                                                                                                                                             
    -- ============================================================================================
                                                                                                                                                          
    -- 3. FINANCIAL UNIT VALIDATION
                                                                                                                                                                                                                          
    -- ============================================================================================
                                                                                                                                                          
    -- Check FDM_COMBO_CD (UCPath combination code) and FUND_CODE in CURRENT_POSITION_PRI_FIN_UNIT
                                                                                                                                                           
    -- This validates the financial structure mapping for the position
                                                                                                                                                                                       
    INSERT INTO @messages
                                                                                                                                                                                                                                    
        (message_text)
                                                                                                                                                                                                                                       
    VALUES
                                                                                                                                                                                                                                                   
        ('3. Checking FDM_COMBO_CD (UCPath combo code) and FUND_CODE in [RPT].[CURRENT_POSITION_PRI_FIN_UNIT]');
                                                                                                                                             

                                                                                                                                                                                                                                                             
    SELECT message_id, message_text
                                                                                                                                                                                                                          
    FROM @messages
                                                                                                                                                                                                                                           
    WHERE message_id = 3;
                                                                                                                                                                                                                                    

                                                                                                                                                                                                                                                             
    -- Query financial unit data
                                                                                                                                                                                                                             
    SELECT
                                                                                                                                                                                                                                                   
        POSITION_NBR,
                                                                                                                                                                                                                                        
        FDM_COMBO_CD,
                                                                                                                                                                                                                                        
        FISCAL_YEAR,
                                                                                                                                                                                                                                         
		dist_Pct,
                                                                                                                                                                                                                                                  
		FUND_CODE,
                                                                                                                                                                                                                                                 
        deptid,
                                                                                                                                                                                                                                              
        DEPTID_CF,
                                                                                                                                                                                                                                           
        DEPTID_CF_DESCR
                                                                                                                                                                                                                                      
    FROM health_ods.[health_ods].[RPT].[CURRENT_POSITION_PRI_FIN_UNIT]
                                                                                                                                                                                       
    WHERE POSITION_NBR = @POSITION_NBR;
                                                                                                                                                                                                                      

                                                                                                                                                                                                                                                             
    -- ============================================================================================
                                                                                                                                                          
    -- 4. BUSINESS STRUCTURE MAPPING VALIDATION
                                                                                                                                                                                                              
    -- ============================================================================================
                                                                                                                                                          
    -- Check if UCPath COMBOCODE maps correctly to UKG Business Structure
                                                                                                                                                                                    
    -- This is critical for UKG employee data processing - missing mappings will cause employees to be filtered out
                                                                                                                                          
    INSERT INTO @messages
                                                                                                                                                                                                                                    
        (message_text)
                                                                                                                                                                                                                                       
    VALUES
                                                                                                                                                                                                                                                   
        ('4. Checking UKG Business Structure mapping: UKG_BS.COMBOCODE = FIN.FDM_COMBO_CD');
                                                                                                                                                                 

                                                                                                                                                                                                                                                             
    SELECT message_id, message_text
                                                                                                                                                                                                                          
    FROM @messages
                                                                                                                                                                                                                                           
    WHERE message_id = 4;
                                                                                                                                                                                                                                    

                                                                                                                                                                                                                                                             
    -- Query the business structure mapping
                                                                                                                                                                                                                  
    SELECT
                                                                                                                                                                                                                                                   
        FIN.POSITION_NBR,
                                                                                                                                                                                                                                    
        FIN.FDM_COMBO_CD as UCPath_COMBOCODE,
                                                                                                                                                                                                                
        UKG_BS.COMBOCODE as UKG_BusinessStructure_COMBOCODE,
                                                                                                                                                                                                 
        UKG_BS.Organization,
                                                                                                                                                                                                                                 
        UKG_BS.EntityTitle,
                                                                                                                                                                                                                                  
        UKG_BS.ServiceLineTitle,
                                                                                                                                                                                                                             
        UKG_BS.FinancialUnit,
                                                                                                                                                                                                                                
        UKG_BS.FundGroup
                                                                                                                                                                                                                                     
    FROM health_ods.[health_ods].[RPT].[CURRENT_POSITION_PRI_FIN_UNIT] FIN
                                                                                                                                                                                   
        LEFT JOIN [hts].[UKG_BusinessStructure] UKG_BS
                                                                                                                                                                                                       
        ON UKG_BS.COMBOCODE = FIN.FDM_COMBO_CD
                                                                                                                                                                                                               
    WHERE FIN.POSITION_NBR = @POSITION_NBR;
                                                                                                                                                                                                                  

                                                                                                                                                                                                                                                             
    -- ============================================================================================
                                                                                                                                                          
    -- SUMMARY
                                                                                                                                                                                                                                               
    -- ============================================================================================
                                                                                                                                                          
    -- Return all informational messages for reference
                                                                                                                                                                                                       
    SELECT
                                                                                                                                                                                                                                                   
        message_id,
                                                                                                                                                                                                                                          
        message_text
                                                                                                                                                                                                                                         
    FROM @messages
                                                                                                                                                                                                                                           
    ORDER BY message_id;
                                                                                                                                                                                                                                     

                                                                                                                                                                                                                                                             
END;

-- ===== stage.SP_CheckByPosition_Manager_LEVEL_Health_ODS =====

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
CREATE     PROCEDURE [stage].[SP_CheckByPosition_Manager_LEVEL_Health_ODS]
                                                                                                                                                                                   
    @POSITION_NBR NVARCHAR(10)
                                                                                                                                                                                                                               
AS
                                                                                                                                                                                                                                                           
-- Example usage:
                                                                                                                                                                                                                                            
-- EXEC [stage].[SP_CheckByPosition_Manager_LEVEL_Health_ODS] @POSITION_NBR = '40749496';
                                                                                                                                                                    
BEGIN
                                                                                                                                                                                                                                                        
    SET NOCOUNT ON;
                                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    -- Create a table variable to store messages
                                                                                                                                                                                                             
    DECLARE @messages TABLE (
                                                                                                                                                                                                                                
        message_id INT IDENTITY(1,1),
                                                                                                                                                                                                                        
        message_text VARCHAR(MAX)
                                                                                                                                                                                                                            
    );
                                                                                                                                                                                                                                                       

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
--------------------------------------
                                                                                                                                                                                                                       
-- Message template
                                                                                                                                                                                                                                          
    -- 1. Investigate [POSITION_REPORTS_TO] is not null but MANAGER_EMPLID is NULL
                                                                                                                                                                           
	-- Insert message
                                                                                                                                                                                                                                           
    INSERT INTO @messages
                                                                                                                                                                                                                                    
        (message_text)
                                                                                                                                                                                                                                       
    VALUES
                                                                                                                                                                                                                                                   
        ('1. Investigate [POSITION_REPORTS_TO] is not null but MANAGER_EMPLID is NULL');
                                                                                                                                                                     

                                                                                                                                                                                                                                                             
    SELECT
                                                                                                                                                                                                                                                   
        message_id,
                                                                                                                                                                                                                                          
        message_text
                                                                                                                                                                                                                                         
    FROM @messages
                                                                                                                                                                                                                                           
    where message_id=1;
                                                                                                                                                                                                                                      

                                                                                                                                                                                                                                                             
   --Insert Script below
                                                                                                                                                                                                                                     
WITH
                                                                                                                                                                                                                                                         
    PositionData
                                                                                                                                                                                                                                             
    AS
                                                                                                                                                                                                                                                       
    (
                                                                                                                                                                                                                                                        
        SELECT
                                                                                                                                                                                                                                               
            POSN_STATUS,
                                                                                                                                                                                                                                     
            deptid,
                                                                                                                                                                                                                                          
            POSITION_NBR,
                                                                                                                                                                                                                                    
            EFFDT,
                                                                                                                                                                                                                                           
            DML_IND,
                                                                                                                                                                                                                                         
            ROW_NUMBER() OVER (PARTITION BY POSITION_NBR ORDER BY effdt DESC) as RN
                                                                                                                                                                          
        FROM health_ods.[health_ods].stable.PS_POSITION_DATA
                                                                                                                                                                                                 
        WHERE dml_ind <> 'D'
                                                                                                                                                                                                                                 
    )
                                                                                                                                                                                                                                                        
SELECT DISTINCT top 1
                                                                                                                                                                                                                                        
    imgr.[Inactive_EMPLID_To_Check],
                                                                                                                                                                                                                         
    imgr.[POSITION_NBR_To_Check],
                                                                                                                                                                                                                            
    empl.MANAGER_EMPLID,
                                                                                                                                                                                                                                     
    empl.MANAGER_NAME,
                                                                                                                                                                                                                                       
    empl.[POSITION_REPORTS_TO],
                                                                                                                                                                                                                              
    pd.POSN_STATUS,
                                                                                                                                                                                                                                          
    pd.deptid as POSITION_DEPTID,
                                                                                                                                                                                                                            
    pd.EFFDT as POSITION_EFFDT
                                                                                                                                                                                                                               
FROM health_ods.[health_ods].[RPT].[CURRENT_EMPL_DATA] empl
                                                                                                                                                                                                  
    INNER JOIN [stage].[UKG_EMPL_Inactive_Manager] imgr
                                                                                                                                                                                                      
    ON empl.emplid = imgr.[Inactive_EMPLID_To_Check]
                                                                                                                                                                                                         
        and empl.POSITION_NBR=imgr.[POSITION_NBR_To_Check]
                                                                                                                                                                                                   
    LEFT JOIN PositionData pd
                                                                                                                                                                                                                                
    ON pd.POSITION_NBR = empl.[POSITION_REPORTS_TO]
                                                                                                                                                                                                          
        AND pd.RN = 1
                                                                                                                                                                                                                                        
where empl.MANAGER_EMPLID is NULL
                                                                                                                                                                                                                            
and empl.[POSITION_REPORTS_TO]=@POSITION_NBR
                                                                                                                                                                                                                 
;
                                                                                                                                                                                                                                                            
    -- 2. Check POSN_STATUS, deptid in STABLE.PS_POSITION_DATA 
                                                                                                                                                                                              
	-- Insert message
                                                                                                                                                                                                                                           
    INSERT INTO @messages
                                                                                                                                                                                                                                    
        (message_text)
                                                                                                                                                                                                                                       
    VALUES
                                                                                                                                                                                                                                                   
        ('2. Checking POSN_STATUS (should be A) and deptid in STABLE.PS_POSITION_DATA');
                                                                                                                                                                     

                                                                                                                                                                                                                                                             
    SELECT
                                                                                                                                                                                                                                                   
        message_id,
                                                                                                                                                                                                                                          
        message_text
                                                                                                                                                                                                                                         
    FROM @messages
                                                                                                                                                                                                                                           
    where message_id=2;
                                                                                                                                                                                                                                      

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
   --Insert Script below
                                                                                                                                                                                                                                     
    SELECT TOP 1
                                                                                                                                                                                                                                             
        POSN_STATUS,
                                                                                                                                                                                                                                         
        deptid,
                                                                                                                                                                                                                                              
        POSITION_NBR,
                                                                                                                                                                                                                                        
        EFFDT,
                                                                                                                                                                                                                                               
        DML_IND
                                                                                                                                                                                                                                              
    FROM health_ods.[health_ods].stable.PS_POSITION_DATA
                                                                                                                                                                                                     
    WHERE POSITION_NBR = @POSITION_NBR
                                                                                                                                                                                                                       
        AND dml_ind <> 'D'
                                                                                                                                                                                                                                   
    ORDER BY effdt DESC;
                                                                                                                                                                                                                                     

                                                                                                                                                                                                                                                             
    -- 3. Check from health_ods.[health_ods].[RPT].[CURRENT_EMPL_DATA] m
                                                                                                                                                                                     
	-- Insert message
                                                                                                                                                                                                                                           
    INSERT INTO @messages
                                                                                                                                                                                                                                    
        (message_text)
                                                                                                                                                                                                                                       
    VALUES
                                                                                                                                                                                                                                                   
        ('3. Check from health_ods.[health_ods].[RPT].[CURRENT_EMPL_DATA]');
                                                                                                                                                                                 

                                                                                                                                                                                                                                                             
    SELECT
                                                                                                                                                                                                                                                   
        message_id,
                                                                                                                                                                                                                                          
        message_text
                                                                                                                                                                                                                                         
    FROM @messages
                                                                                                                                                                                                                                           
    where message_id=3;
                                                                                                                                                                                                                                      

                                                                                                                                                                                                                                                             
   --Insert Script below
                                                                                                                                                                                                                                     
SELECT 
                                                                                                                                                                                                                                                      
emplid
                                                                                                                                                                                                                                                       
,NAME
                                                                                                                                                                                                                                                        
,HR_STATUS
                                                                                                                                                                                                                                                   
,POSITION_NBR
                                                                                                                                                                                                                                                
,MANAGER_EMPLID 
                                                                                                                                                                                                                                             
,[POSITION_REPORTS_TO]
                                                                                                                                                                                                                                       
FROM health_ods.[health_ods].[RPT].[CURRENT_EMPL_DATA] m
                                                                                                                                                                                                     
WHERE 
                                                                                                                                                                                                                                                       
POSITION_NBR = @POSITION_NBR
                                                                                                                                                                                                                                 
;
                                                                                                                                                                                                                                                            

                                                                                                                                                                                                                                                             
    -- Return collected messages at the end
                                                                                                                                                                                                                  
    SELECT
                                                                                                                                                                                                                                                   
        message_id,
                                                                                                                                                                                                                                          
        message_text
                                                                                                                                                                                                                                         
    FROM @messages
                                                                                                                                                                                                                                           
    ORDER BY message_id;
                                                                                                                                                                                                                                     

                                                                                                                                                                                                                                                             
END;

-- ===== stage.SP_Create_Position_Trace_Analysis =====

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
create     PROCEDURE [stage].[SP_Create_Position_Trace_Analysis]
                                                                                                                                                                                             
AS
                                                                                                                                                                                                                                                           
-- exec [stage].[SP_Create_Position_Trace_Analysis]
                                                                                                                                                                                                          
/***************************************
                                                                                                                                                                                                                     
* Created By: Jim Shih	
                                                                                                                                                                                                                                      
* Purpose: Create position trace analysis based on inactive manager data with position level tracking
                                                                                                                                                        
* Table: Processes data from [stage].[UKG_EMPL_Inactive_Manager] and creates temp1 table
                                                                                                                                                                     
* To_Trace_Up_1 Logic: If L.POSN_LEVEL is NULL, then To_Trace_Up_1 = 'yes', otherwise 'no'
                                                                                                                                                                   
* -- 08/31/2025 Jim Shih: Created based on 16.sql query
                                                                                                                                                                                                      
******************************************/
                                                                                                                                                                                                                  
BEGIN
                                                                                                                                                                                                                                                        
    SET NOCOUNT ON;
                                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    -- Drop temp table if it exists
                                                                                                                                                                                                                          
    IF OBJECT_ID('tempdb..#temp1', 'U') IS NOT NULL 
                                                                                                                                                                                                         
        DROP TABLE #temp1;
                                                                                                                                                                                                                                   

                                                                                                                                                                                                                                                             
    -- Create temp table with additional To_Trace_Up_1 column
                                                                                                                                                                                                
    CREATE TABLE #temp1
                                                                                                                                                                                                                                      
    (
                                                                                                                                                                                                                                                        
        POSITION_NBR_To_Check VARCHAR(20),
                                                                                                                                                                                                                   
        MANAGER_POSITION_NBR VARCHAR(20),
                                                                                                                                                                                                                    
        POSN_LEVEL VARCHAR(10),
                                                                                                                                                                                                                              
        To_Trace_Up_1 VARCHAR(3)
                                                                                                                                                                                                                             
    );
                                                                                                                                                                                                                                                       

                                                                                                                                                                                                                                                             
    PRINT 'Starting Position Trace Analysis...';
                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
    -- Insert data into temp table with To_Trace_Up_1 logic
                                                                                                                                                                                                  
    WITH
                                                                                                                                                                                                                                                     
        PositionData
                                                                                                                                                                                                                                         
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                POSN_STATUS,
                                                                                                                                                                                                                                 
                deptid,
                                                                                                                                                                                                                                      
                POSITION_NBR,
                                                                                                                                                                                                                                
                EFFDT,
                                                                                                                                                                                                                                       
                DML_IND,
                                                                                                                                                                                                                                     
                ROW_NUMBER() OVER (PARTITION BY POSITION_NBR ORDER BY effdt DESC) as RN
                                                                                                                                                                      
            FROM health_ods.[health_ods].stable.PS_POSITION_DATA
                                                                                                                                                                                             
            WHERE dml_ind <> 'D'
                                                                                                                                                                                                                             
        )
                                                                                                                                                                                                                                                    
    INSERT INTO #temp1
                                                                                                                                                                                                                                       
        (POSITION_NBR_To_Check, MANAGER_POSITION_NBR, POSN_LEVEL, To_Trace_Up_1)
                                                                                                                                                                             
    SELECT DISTINCT
                                                                                                                                                                                                                                          
        imgr.POSITION_NBR_To_Check as POSITION_NBR_To_Check,
                                                                                                                                                                                                 
        empl.[POSITION_REPORTS_TO] as MANAGER_POSITION_NBR,
                                                                                                                                                                                                  
        L.POSN_LEVEL,
                                                                                                                                                                                                                                        
        CASE 
                                                                                                                                                                                                                                                
            WHEN L.POSN_LEVEL IS NULL THEN 'yes'
                                                                                                                                                                                                             
            ELSE 'no'
                                                                                                                                                                                                                                        
        END as To_Trace_Up_1
                                                                                                                                                                                                                                 
    FROM [stage].[UKG_EMPL_Inactive_Manager] imgr
                                                                                                                                                                                                            
        LEFT JOIN health_ods.[health_ods].[RPT].[CURRENT_EMPL_DATA] empl
                                                                                                                                                                                     
        ON empl.emplid = imgr.[Inactive_EMPLID_To_Check]
                                                                                                                                                                                                     
            AND empl.POSITION_NBR = imgr.POSITION_NBR_To_Check
                                                                                                                                                                                               
        LEFT JOIN PositionData pd
                                                                                                                                                                                                                            
        ON pd.POSITION_NBR = empl.[POSITION_REPORTS_TO]
                                                                                                                                                                                                      
            AND pd.RN = 1
                                                                                                                                                                                                                                    
        LEFT JOIN [stage].[UKG_EMPL_HIERARCHY_POSN_LOOKUP] L
                                                                                                                                                                                                 
        ON empl.[POSITION_REPORTS_TO] = L.POSITION_NBR;
                                                                                                                                                                                                      

                                                                                                                                                                                                                                                             
    -- Show temp1 results
                                                                                                                                                                                                                                    
    SELECT
                                                                                                                                                                                                                                                   
        POSITION_NBR_To_Check,
                                                                                                                                                                                                                               
        MANAGER_POSITION_NBR,
                                                                                                                                                                                                                                
        POSN_LEVEL,
                                                                                                                                                                                                                                          
        To_Trace_Up_1
                                                                                                                                                                                                                                        
    FROM #temp1
                                                                                                                                                                                                                                              
    ORDER BY POSITION_NBR_To_Check;
                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    -- Create temp2 by joining To_Trace_Up_1='yes' records with Level 1 analysis data
                                                                                                                                                                        
    IF OBJECT_ID('tempdb..#temp2', 'U') IS NOT NULL 
                                                                                                                                                                                                         
        DROP TABLE #temp2;
                                                                                                                                                                                                                                   

                                                                                                                                                                                                                                                             
    WITH
                                                                                                                                                                                                                                                     
        JobData
                                                                                                                                                                                                                                              
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                J.POSITION_NBR,
                                                                                                                                                                                                                              
                J.EMPLID,
                                                                                                                                                                                                                                    
                J.HR_STATUS,
                                                                                                                                                                                                                                 
                J.EMPL_RCD,
                                                                                                                                                                                                                                  
                J.JOBCODE,
                                                                                                                                                                                                                                   
                J.EFFDT,
                                                                                                                                                                                                                                     
                ROW_NUMBER() OVER (PARTITION BY J.EMPLID ORDER BY
                                                                                                                                                                                            
                    (CASE WHEN J.JOB_INDICATOR = 'N' THEN 'Z' ELSE J.JOB_INDICATOR END), 
                                                                                                                                                                    
                    EFFDT DESC) as ROWNO
                                                                                                                                                                                                                     
            FROM health_ods.[HEALTH_ODS].[STABLE].PS_JOB J
                                                                                                                                                                                                   
            WHERE 
                                                                                                                                                                                                                                           
                J.DML_IND <> 'D'
                                                                                                                                                                                                                             
                AND J.EFFDT = (
                                                                                                                                                                                                                              
                    SELECT MAX(J1.EFFDT)
                                                                                                                                                                                                                     
                FROM health_ods.[health_ods].[STABLE].PS_JOB J1
                                                                                                                                                                                              
                WHERE J1.EMPLID = J.EMPLID
                                                                                                                                                                                                                   
                    AND J1.EMPL_RCD = J.EMPL_RCD
                                                                                                                                                                                                             
                    AND J1.EFFDT <= GETDATE()
                                                                                                                                                                                                                
                    AND J1.DML_IND <> 'D'
                                                                                                                                                                                                                    
                )
                                                                                                                                                                                                                                            
                AND J.EFFSEQ = (
                                                                                                                                                                                                                             
                    SELECT MAX(J2.EFFSEQ)
                                                                                                                                                                                                                    
                FROM health_ods.[health_ods].[STABLE].PS_JOB J2
                                                                                                                                                                                              
                WHERE J2.EMPLID = J.EMPLID
                                                                                                                                                                                                                   
                    AND J2.EMPL_RCD = J.EMPL_RCD
                                                                                                                                                                                                             
                    AND J2.EFFDT = J.EFFDT
                                                                                                                                                                                                                   
                    AND J2.DML_IND <> 'D'
                                                                                                                                                                                                                    
           )
                                                                                                                                                                                                                                                 
        ),
                                                                                                                                                                                                                                                   
        JobDataFiltered
                                                                                                                                                                                                                                      
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                POSITION_NBR,
                                                                                                                                                                                                                                
                EMPLID,
                                                                                                                                                                                                                                      
                HR_STATUS,
                                                                                                                                                                                                                                   
                EMPL_RCD,
                                                                                                                                                                                                                                    
                JOBCODE,
                                                                                                                                                                                                                                     
                EFFDT,
                                                                                                                                                                                                                                       
                ROWNO
                                                                                                                                                                                                                                        
            FROM JobData
                                                                                                                                                                                                                                     
            WHERE ROWNO = 1
                                                                                                                                                                                                                                  
        ),
                                                                                                                                                                                                                                                   
        CurrentEmplData
                                                                                                                                                                                                                                      
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                empl.POSITION_NBR,
                                                                                                                                                                                                                           
                empl.Reports_To,
                                                                                                                                                                                                                             
                empl.HR_STATUS,
                                                                                                                                                                                                                              
                empl.emplid,
                                                                                                                                                                                                                                 
                empl.EMPL_RCD,
                                                                                                                                                                                                                               
                empl.EFFDT,
                                                                                                                                                                                                                                  
                ROW_NUMBER() OVER (PARTITION BY empl.emplid ORDER BY empl.EFFDT DESC) as RN_EMPL
                                                                                                                                                             
            FROM health_ods.[health_ods].[RPT].[CURRENT_EMPL_DATA] EMPL
                                                                                                                                                                                      
        ),
                                                                                                                                                                                                                                                   
        CurrentEmplDataFiltered
                                                                                                                                                                                                                              
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                POSITION_NBR,
                                                                                                                                                                                                                                
                Reports_To,
                                                                                                                                                                                                                                  
                HR_STATUS,
                                                                                                                                                                                                                                   
                emplid,
                                                                                                                                                                                                                                      
                EMPL_RCD,
                                                                                                                                                                                                                                    
                EFFDT,
                                                                                                                                                                                                                                       
                RN_EMPL
                                                                                                                                                                                                                                      
            FROM CurrentEmplData
                                                                                                                                                                                                                             
            WHERE RN_EMPL = 1
                                                                                                                                                                                                                                
        ),
                                                                                                                                                                                                                                                   
        PositionData
                                                                                                                                                                                                                                         
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                POSN_STATUS,
                                                                                                                                                                                                                                 
                deptid,
                                                                                                                                                                                                                                      
                POSITION_NBR,
                                                                                                                                                                                                                                
                EFFDT,
                                                                                                                                                                                                                                       
                DML_IND,
                                                                                                                                                                                                                                     
                ROW_NUMBER() OVER (PARTITION BY POSITION_NBR ORDER BY effdt DESC) as RN
                                                                                                                                                                      
            FROM health_ods.[health_ods].stable.PS_POSITION_DATA
                                                                                                                                                                                             
            WHERE dml_ind <> 'D'
                                                                                                                                                                                                                             
        ),
                                                                                                                                                                                                                                                   
        CTE_Position_HR_Status
                                                                                                                                                                                                                               
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                jd.POSITION_NBR,
                                                                                                                                                                                                                             
                jd.EMPLID,
                                                                                                                                                                                                                                   
                empl.HR_STATUS,
                                                                                                                                                                                                                              
                pd.POSN_STATUS,
                                                                                                                                                                                                                              
                pd.EFFDT as POSITION_EFFDT,
                                                                                                                                                                                                                  
                empl.EFFDT as EMPL_EFFDT,
                                                                                                                                                                                                                    
                ROW_NUMBER() OVER (PARTITION BY jd.POSITION_NBR ORDER BY empl.EFFDT DESC) as RN_FINAL
                                                                                                                                                        
            FROM JobDataFiltered jd
                                                                                                                                                                                                                          
                JOIN PositionData pd ON pd.POSITION_NBR = jd.POSITION_NBR
                                                                                                                                                                                    
                JOIN CurrentEmplDataFiltered empl ON empl.POSITION_NBR = jd.POSITION_NBR
                                                                                                                                                                     
            WHERE 
                                                                                                                                                                                                                                           
                pd.RN = 1
                                                                                                                                                                                                                                    
        ),
                                                                                                                                                                                                                                                   
        CTE_Position_HR_Status_Final
                                                                                                                                                                                                                         
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                POSITION_NBR,
                                                                                                                                                                                                                                
                EMPLID,
                                                                                                                                                                                                                                      
                HR_STATUS,
                                                                                                                                                                                                                                   
                POSN_STATUS,
                                                                                                                                                                                                                                 
                POSITION_EFFDT,
                                                                                                                                                                                                                              
                EMPL_EFFDT
                                                                                                                                                                                                                                   
            FROM CTE_Position_HR_Status
                                                                                                                                                                                                                      
            WHERE RN_FINAL = 1
                                                                                                                                                                                                                               
        ),
                                                                                                                                                                                                                                                   
        CTE_Hierarchy_Posn_Level
                                                                                                                                                                                                                             
        -- Note that this CTE is added to get POSN_LEVEL for manager positions is NULL, means JOB_INDICATOR is not 'P' or'N'
                                                                                                                                 
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                empl.emplid,
                                                                                                                                                                                                                                 
                empl.POSITION_NBR,
                                                                                                                                                                                                                           
                EMPL.JOB_INDICATOR,
                                                                                                                                                                                                                          
                HPOSN.LEVEL as POSN_LEVEL,
                                                                                                                                                                                                                   
                GETDATE() AS UPDATED_DT
                                                                                                                                                                                                                      
            FROM health_ods.health_ods.[RPT].[CURRENT_EMPL_DATA] EMPL
                                                                                                                                                                                        
                JOIN health_ods.[RPT].ORG_HIERARCHY_POSN HPOSN
                                                                                                                                                                                               
                ON HPOSN.EMPLID = EMPL.EMPLID
                                                                                                                                                                                                                
                    AND HPOSN.EMPL_RCD = EMPL.EMPL_RCD
                                                                                                                                                                                                       
            WHERE empl.HR_STATUS='A'
                                                                                                                                                                                                                         
        )
                                                                                                                                                                                                                                                    
    SELECT DISTINCT
                                                                                                                                                                                                                                          
        t1.POSITION_NBR_To_Check,
                                                                                                                                                                                                                            
        t1.MANAGER_POSITION_NBR,
                                                                                                                                                                                                                             
        t1.POSN_LEVEL,
                                                                                                                                                                                                                                       
        t1.To_Trace_Up_1,
                                                                                                                                                                                                                                    
        t1.MANAGER_POSITION_NBR as MANAGER_POSITION_NBR_L1,
                                                                                                                                                                                                  
        CTE_Position_HR_Status_Final.EMPLID as MANAGER_EMPLID,
                                                                                                                                                                                               
        CTE_Position_HR_Status_Final.HR_STATUS as MANAGER_HR_STATUS,
                                                                                                                                                                                         
        CTE_Position_HR_Status_Final.POSN_STATUS as MANAGER_POSN_STATUS,
                                                                                                                                                                                     
        COALESCE(L.POSN_LEVEL, L2.POSN_LEVEL) as MANAGER_POSN_LEVEL,
                                                                                                                                                                                         
        CASE 
                                                                                                                                                                                                                                                
            WHEN CTE_Position_HR_Status_Final.EMPLID IS NULL THEN 'missing in PS_JOB'
                                                                                                                                                                        
            WHEN COALESCE(L.POSN_LEVEL, L2.POSN_LEVEL) IS NULL
                                                                                                                                                                                               
            AND CTE_Position_HR_Status_Final.HR_STATUS = 'A'
                                                                                                                                                                                                 
            AND CTE_Position_HR_Status_Final.POSN_STATUS = 'A' THEN 'missing POSN_LEVEL in ORG_HIERARCHY_POSN'
                                                                                                                                               
            ELSE ''
                                                                                                                                                                                                                                          
        END as NOTE,
                                                                                                                                                                                                                                         
        CASE 
                                                                                                                                                                                                                                                
            WHEN CTE_Position_HR_Status_Final.HR_STATUS = 'A' OR CTE_Position_HR_Status_Final.HR_STATUS IS NULL THEN 'no'
                                                                                                                                    
            ELSE 'yes'
                                                                                                                                                                                                                                       
        END as To_Trace_Up_2
                                                                                                                                                                                                                                 

                                                                                                                                                                                                                                                             
    INTO #temp2
                                                                                                                                                                                                                                              
    FROM #temp1 t1
                                                                                                                                                                                                                                           
        LEFT JOIN CTE_Position_HR_Status_Final ON t1.MANAGER_POSITION_NBR = CTE_Position_HR_Status_Final.POSITION_NBR
                                                                                                                                        
        LEFT JOIN [stage].[UKG_EMPL_HIERARCHY_POSN_LOOKUP] L ON t1.MANAGER_POSITION_NBR = L.POSITION_NBR
                                                                                                                                                     
        LEFT JOIN CTE_Hierarchy_Posn_Level L2 ON t1.MANAGER_POSITION_NBR = L2.POSITION_NBR
                                                                                                                                                                   
    WHERE t1.To_Trace_Up_1 = 'yes';
                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    -- Show temp2 results
                                                                                                                                                                                                                                    
    SELECT
                                                                                                                                                                                                                                                   
        POSITION_NBR_To_Check,
                                                                                                                                                                                                                               
        MANAGER_POSITION_NBR,
                                                                                                                                                                                                                                
        POSN_LEVEL,
                                                                                                                                                                                                                                          
        To_Trace_Up_1,
                                                                                                                                                                                                                                       
        MANAGER_POSITION_NBR_L1,
                                                                                                                                                                                                                             
        MANAGER_EMPLID,
                                                                                                                                                                                                                                      
        MANAGER_HR_STATUS,
                                                                                                                                                                                                                                   
        MANAGER_POSN_STATUS,
                                                                                                                                                                                                                                 
        MANAGER_POSN_LEVEL,
                                                                                                                                                                                                                                  
        To_Trace_Up_2,
                                                                                                                                                                                                                                       
        NOTE
                                                                                                                                                                                                                                                 
    FROM #temp2
                                                                                                                                                                                                                                              
    ORDER BY POSITION_NBR_To_Check;
                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    -- Create temp3 by joining To_Trace_Up_2='yes' records with Level 2 analysis data
                                                                                                                                                                        
    IF OBJECT_ID('tempdb..#temp3', 'U') IS NOT NULL 
                                                                                                                                                                                                         
        DROP TABLE #temp3;
                                                                                                                                                                                                                                   

                                                                                                                                                                                                                                                             
    WITH
                                                                                                                                                                                                                                                     
        JobData_L2
                                                                                                                                                                                                                                           
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                J.POSITION_NBR,
                                                                                                                                                                                                                              
                J.EMPLID,
                                                                                                                                                                                                                                    
                J.HR_STATUS,
                                                                                                                                                                                                                                 
                J.EMPL_RCD,
                                                                                                                                                                                                                                  
                J.JOBCODE,
                                                                                                                                                                                                                                   
                J.EFFDT,
                                                                                                                                                                                                                                     
                ROW_NUMBER() OVER (PARTITION BY J.EMPLID ORDER BY
                                                                                                                                                                                            
                    (CASE WHEN J.JOB_INDICATOR = 'N' THEN 'Z' ELSE J.JOB_INDICATOR END), 
                                                                                                                                                                    
                    EFFDT DESC) as ROWNO
                                                                                                                                                                                                                     
            FROM health_ods.[HEALTH_ODS].[STABLE].PS_JOB J
                                                                                                                                                                                                   
            WHERE 
                                                                                                                                                                                                                                           
                J.DML_IND <> 'D'
                                                                                                                                                                                                                             
                AND J.EFFDT = (
                                                                                                                                                                                                                              
                    SELECT MAX(J1.EFFDT)
                                                                                                                                                                                                                     
                FROM health_ods.[health_ods].[STABLE].PS_JOB J1
                                                                                                                                                                                              
                WHERE J1.EMPLID = J.EMPLID
                                                                                                                                                                                                                   
                    AND J1.EMPL_RCD = J.EMPL_RCD
                                                                                                                                                                                                             
                    AND J1.EFFDT <= GETDATE()
                                                                                                                                                                                                                
                    AND J1.DML_IND <> 'D'
                                                                                                                                                                                                                    
                )
                                                                                                                                                                                                                                            
                AND J.EFFSEQ = (
                                                                                                                                                                                                                             
                    SELECT MAX(J2.EFFSEQ)
                                                                                                                                                                                                                    
                FROM health_ods.[health_ods].[STABLE].PS_JOB J2
                                                                                                                                                                                              
                WHERE J2.EMPLID = J.EMPLID
                                                                                                                                                                                                                   
                    AND J2.EMPL_RCD = J.EMPL_RCD
                                                                                                                                                                                                             
                    AND J2.EFFDT = J.EFFDT
                                                                                                                                                                                                                   
                    AND J2.DML_IND <> 'D'
                                                                                                                                                                                                                    
                )
                                                                                                                                                                                                                                            
        ),
                                                                                                                                                                                                                                                   
        JobDataFiltered_L2
                                                                                                                                                                                                                                   
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                POSITION_NBR,
                                                                                                                                                                                                                                
                EMPLID,
                                                                                                                                                                                                                                      
                HR_STATUS,
                                                                                                                                                                                                                                   
                EMPL_RCD,
                                                                                                                                                                                                                                    
                JOBCODE,
                                                                                                                                                                                                                                     
                EFFDT,
                                                                                                                                                                                                                                       
                ROWNO
                                                                                                                                                                                                                                        
            FROM JobData_L2
                                                                                                                                                                                                                                  
            WHERE ROWNO = 1
                                                                                                                                                                                                                                  
        ),
                                                                                                                                                                                                                                                   
        CurrentEmplData_L2
                                                                                                                                                                                                                                   
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                empl.POSITION_NBR,
                                                                                                                                                                                                                           
                empl.Reports_To,
                                                                                                                                                                                                                             
                empl.HR_STATUS,
                                                                                                                                                                                                                              
                empl.emplid,
                                                                                                                                                                                                                                 
                empl.EMPL_RCD,
                                                                                                                                                                                                                               
                empl.EFFDT,
                                                                                                                                                                                                                                  
                ROW_NUMBER() OVER (PARTITION BY empl.emplid ORDER BY empl.EFFDT DESC) as RN_EMPL
                                                                                                                                                             
            FROM health_ods.[health_ods].[RPT].[CURRENT_EMPL_DATA] EMPL
                                                                                                                                                                                      
        ),
                                                                                                                                                                                                                                                   
        CurrentEmplDataFiltered_L2
                                                                                                                                                                                                                           
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                POSITION_NBR,
                                                                                                                                                                                                                                
                Reports_To,
                                                                                                                                                                                                                                  
                HR_STATUS,
                                                                                                                                                                                                                                   
                emplid,
                                                                                                                                                                                                                                      
                EMPL_RCD,
                                                                                                                                                                                                                                    
                EFFDT,
                                                                                                                                                                                                                                       
                RN_EMPL
                                                                                                                                                                                                                                      
            FROM CurrentEmplData_L2
                                                                                                                                                                                                                          
            WHERE RN_EMPL = 1
                                                                                                                                                                                                                                
        ),
                                                                                                                                                                                                                                                   
        PositionData_L2
                                                                                                                                                                                                                                      
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                POSN_STATUS,
                                                                                                                                                                                                                                 
                deptid,
                                                                                                                                                                                                                                      
                POSITION_NBR,
                                                                                                                                                                                                                                
                EFFDT,
                                                                                                                                                                                                                                       
                DML_IND,
                                                                                                                                                                                                                                     
                ROW_NUMBER() OVER (PARTITION BY POSITION_NBR ORDER BY effdt DESC) as RN
                                                                                                                                                                      
            FROM health_ods.[health_ods].stable.PS_POSITION_DATA
                                                                                                                                                                                             
            WHERE dml_ind <> 'D'
                                                                                                                                                                                                                             
        ),
                                                                                                                                                                                                                                                   
       CTE_Position_HR_Status_L2
                                                                                                                                                                                                                             
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                jd.POSITION_NBR,
                                                                                                                                                                                                                             
                jd.EMPLID,
                                                                                                                                                                                                                                   
                empl.HR_STATUS,
                                                                                                                                                                                                                              
                pd.POSN_STATUS,
                                                                                                                                                                                                                              
                pd.EFFDT as POSITION_EFFDT,
                                                                                                                                                                                                                  
                empl.EFFDT as EMPL_EFFDT,
                                                                                                                                                                                                                    
                empl.Reports_To,
                                                                                                                                                                                                                             
                jd2.EMPLID as Manager_EMPLID,
                                                                                                                                                                                                                
                jd2.HR_STATUS as Manager_HR_STATUS,
                                                                                                                                                                                                          
                pd2.POSN_STATUS as Manager_POSN_STATUS,
                                                                                                                                                                                                      
                ROW_NUMBER() OVER (PARTITION BY jd.POSITION_NBR ORDER BY empl.EFFDT DESC) as RN_FINAL
                                                                                                                                                        
            FROM JobDataFiltered_L2 jd
                                                                                                                                                                                                                       
                JOIN PositionData_L2 pd ON pd.POSITION_NBR = jd.POSITION_NBR
                                                                                                                                                                                 
                JOIN CurrentEmplDataFiltered_L2 empl ON empl.POSITION_NBR = jd.POSITION_NBR
                                                                                                                                                                  
                LEFT JOIN JobDataFiltered_L2 jd2 ON jd2.POSITION_NBR = empl.Reports_To
                                                                                                                                                                       
                LEFT JOIN PositionData_L2 pd2 ON pd2.POSITION_NBR = empl.Reports_To AND pd2.RN = 1
                                                                                                                                                           
            WHERE 
                                                                                                                                                                                                                                           
                pd.RN = 1
                                                                                                                                                                                                                                    
        ),
                                                                                                                                                                                                                                                   
        CTE_Position_HR_Status_L2_Final
                                                                                                                                                                                                                      
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                POSITION_NBR,
                                                                                                                                                                                                                                
                EMPLID,
                                                                                                                                                                                                                                      
                HR_STATUS,
                                                                                                                                                                                                                                   
                POSN_STATUS,
                                                                                                                                                                                                                                 
                POSITION_EFFDT,
                                                                                                                                                                                                                              
                EMPL_EFFDT,
                                                                                                                                                                                                                                  
                Reports_To,
                                                                                                                                                                                                                                  
                Manager_EMPLID,
                                                                                                                                                                                                                              
                Manager_HR_STATUS,
                                                                                                                                                                                                                           
                Manager_POSN_STATUS
                                                                                                                                                                                                                          
            FROM CTE_Position_HR_Status_L2
                                                                                                                                                                                                                   
            WHERE RN_FINAL = 1
                                                                                                                                                                                                                               
        ),
                                                                                                                                                                                                                                                   
        CTE_Hierarchy_Posn_Level_L2
                                                                                                                                                                                                                          
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                empl.emplid,
                                                                                                                                                                                                                                 
                empl.POSITION_NBR,
                                                                                                                                                                                                                           
                EMPL.JOB_INDICATOR,
                                                                                                                                                                                                                          
                HPOSN.LEVEL as POSN_LEVEL,
                                                                                                                                                                                                                   
                GETDATE() AS UPDATED_DT
                                                                                                                                                                                                                      
            FROM health_ods.health_ods.[RPT].[CURRENT_EMPL_DATA] EMPL
                                                                                                                                                                                        
                JOIN health_ods.[RPT].ORG_HIERARCHY_POSN HPOSN
                                                                                                                                                                                               
                ON HPOSN.EMPLID = EMPL.EMPLID
                                                                                                                                                                                                                
                    AND HPOSN.EMPL_RCD = EMPL.EMPL_RCD
                                                                                                                                                                                                       
            WHERE empl.HR_STATUS='A'
                                                                                                                                                                                                                         
        )
                                                                                                                                                                                                                                                    
    SELECT DISTINCT
                                                                                                                                                                                                                                          
        t2.POSITION_NBR_To_Check,
                                                                                                                                                                                                                            
        t2.MANAGER_POSITION_NBR,
                                                                                                                                                                                                                             
        t2.POSN_LEVEL,
                                                                                                                                                                                                                                       
        t2.To_Trace_Up_1,
                                                                                                                                                                                                                                    
        t2.MANAGER_POSITION_NBR_L1,
                                                                                                                                                                                                                          
        t2.MANAGER_EMPLID,
                                                                                                                                                                                                                                   
        t2.MANAGER_HR_STATUS,
                                                                                                                                                                                                                                
        t2.MANAGER_POSN_STATUS,
                                                                                                                                                                                                                              
        t2.MANAGER_POSN_LEVEL,
                                                                                                                                                                                                                               
        t2.To_Trace_Up_2,
                                                                                                                                                                                                                                    
        t2.NOTE as NOTE_L1,
                                                                                                                                                                                                                                  
        CTE_Position_HR_Status_L2_Final.REPORTS_TO as MANAGER_POSITION_NBR_L2,
                                                                                                                                                                               
        CTE_Position_HR_Status_L2_Final.Manager_EMPLID as MANAGER_EMPLID_L2,
                                                                                                                                                                                 
        CTE_Position_HR_Status_L2_Final.Manager_HR_STATUS as MANAGER_HR_STATUS_L2,
                                                                                                                                                                           
        CTE_Position_HR_Status_L2_Final.Manager_POSN_STATUS as MANAGER_POSN_STATUS_L2,
                                                                                                                                                                       
        COALESCE(L2.POSN_LEVEL, L3.POSN_LEVEL) as MANAGER_POSN_LEVEL_L2,
                                                                                                                                                                                     
        CASE 
                                                                                                                                                                                                                                                
            WHEN CTE_Position_HR_Status_L2_Final.Manager_EMPLID IS NULL THEN 'missing in PS_JOB'
                                                                                                                                                             
            WHEN COALESCE(L2.POSN_LEVEL, L3.POSN_LEVEL) IS NULL
                                                                                                                                                                                              
            AND CTE_Position_HR_Status_L2_Final.Manager_EMPLID = 'A'
                                                                                                                                                                                         
            AND CTE_Position_HR_Status_L2_Final.Manager_POSN_STATUS = 'A' THEN 'missing POSN_LEVEL in ORG_HIERARCHY_POSN'
                                                                                                                                    
            ELSE ''
                                                                                                                                                                                                                                          
        END as NOTE_L2,
                                                                                                                                                                                                                                      
        CASE 
                                                                                                                                                                                                                                                
            WHEN CTE_Position_HR_Status_L2_Final.Manager_HR_STATUS = 'A' OR CTE_Position_HR_Status_L2_Final.Manager_HR_STATUS IS NULL THEN 'no'
                                                                                                              
            ELSE 'yes'
                                                                                                                                                                                                                                       
        END as To_Trace_Up_3
                                                                                                                                                                                                                                 
    INTO #temp3
                                                                                                                                                                                                                                              
    FROM #temp2 t2
                                                                                                                                                                                                                                           
        --    LEFT JOIN CTE_Position_HR_Status_L2_Final ON t2.MANAGER_EMPLID = CTE_Position_HR_Status_L2_Final.EMPLID
                                                                                                                                        
        LEFT JOIN CTE_Position_HR_Status_L2_Final ON t2.MANAGER_POSITION_NBR_L1 = CTE_Position_HR_Status_L2_Final.POSITION_NBR
                                                                                                                               
        LEFT JOIN [stage].[UKG_EMPL_HIERARCHY_POSN_LOOKUP] L2 ON CTE_Position_HR_Status_L2_Final.REPORTS_TO = L2.POSITION_NBR
                                                                                                                                
        LEFT JOIN CTE_Hierarchy_Posn_Level_L2 L3 ON CTE_Position_HR_Status_L2_Final.REPORTS_TO = L3.POSITION_NBR
    WHERE t2.To_Trace_Up_2 = 'yes';
                                                                                                        

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
    SELECT *
                                                                                                                                                                                                                                                 
    FROM #temp3
                                                                                                                                                                                                                                              
    ORDER BY POSITION_NBR_To_Check;
                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    -- Create temp4 by joining To_Trace_Up_3='yes' records with Level 3 analysis data
                                                                                                                                                                        
    IF OBJECT_ID('tempdb..#temp4', 'U') IS NOT NULL 
                                                                                                                                                                                                         
        DROP TABLE #temp4;
                                                                                                                                                                                                                                   

                                                                                                                                                                                                                                                             
    WITH
                                                                                                                                                                                                                                                     
        JobData_L3
                                                                                                                                                                                                                                           
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                J.POSITION_NBR,
                                                                                                                                                                                                                              
                J.EMPLID,
                                                                                                                                                                                                                                    
                J.HR_STATUS,
                                                                                                                                                                                                                                 
                J.EMPL_RCD,
                                                                                                                                                                                                                                  
                J.JOBCODE,
                                                                                                                                                                                                                                   
                J.EFFDT,
                                                                                                                                                                                                                                     
                ROW_NUMBER() OVER (PARTITION BY J.EMPLID ORDER BY
                                                                                                                                                                                            
                    (CASE WHEN J.JOB_INDICATOR = 'N' THEN 'Z' ELSE J.JOB_INDICATOR END), 
                                                                                                                                                                    
                    EFFDT DESC) as ROWNO
                                                                                                                                                                                                                     
            FROM health_ods.[HEALTH_ODS].[STABLE].PS_JOB J
                                                                                                                                                                                                   
            WHERE 
                                                                                                                                                                                                                                           
                J.DML_IND <> 'D'
                                                                                                                                                                                                                             
                AND J.EFFDT = (
                                                                                                                                                                                                                              
                    SELECT MAX(J1.EFFDT)
                                                                                                                                                                                                                     
                FROM health_ods.[health_ods].[STABLE].PS_JOB J1
                                                                                                                                                                                              
                WHERE J1.EMPLID = J.EMPLID
                                                                                                                                                                                                                   
                    AND J1.EMPL_RCD = J.EMPL_RCD
                                                                                                                                                                                                             
                    AND J1.EFFDT <= GETDATE()
                                                                                                                                                                                                                
                    AND J1.DML_IND <> 'D'
                                                                                                                                                                                                                    
                )
                                                                                                                                                                                                                                            
                AND J.EFFSEQ = (
                                                                                                                                                                                                                             
                    SELECT MAX(J2.EFFSEQ)
                                                                                                                                                                                                                    
                FROM health_ods.[health_ods].[STABLE].PS_JOB J2
                                                                                                                                                                                              
                WHERE J2.EMPLID = J.EMPLID
                                                                                                                                                                                                                   
                    AND J2.EMPL_RCD = J.EMPL_RCD
                                                                                                                                                                                                             
                    AND J2.EFFDT = J.EFFDT
                                                                                                                                                                                                                   
                    AND J2.DML_IND <> 'D'
                                                                                                                                                                                                                    
                )
                                                                                                                                                                                                                                            
        ),
                                                                                                                                                                                                                                                   
        JobDataFiltered_L3
                                                                                                                                                                                                                                   
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                POSITION_NBR,
                                                                                                                                                                                                                                
                EMPLID,
                                                                                                                                                                                                                                      
                HR_STATUS,
                                                                                                                                                                                                                                   
                EMPL_RCD,
                                                                                                                                                                                                                                    
                JOBCODE,
                                                                                                                                                                                                                                     
                EFFDT,
                                                                                                                                                                                                                                       
                ROWNO
                                                                                                                                                                                                                                        
            FROM JobData_L3
                                                                                                                                                                                                                                  
            WHERE ROWNO = 1
                                                                                                                                                                                                                                  
        ),
                                                                                                                                                                                                                                                   
        CurrentEmplData_L3
                                                                                                                                                                                                                                   
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                empl.POSITION_NBR,
                                                                                                                                                                                                                           
                empl.Reports_To,
                                                                                                                                                                                                                             
                empl.HR_STATUS,
                                                                                                                                                                                                                              
                empl.emplid,
                                                                                                                                                                                                                                 
                empl.EMPL_RCD,
                                                                                                                                                                                                                               
                empl.EFFDT,
                                                                                                                                                                                                                                  
                ROW_NUMBER() OVER (PARTITION BY empl.emplid ORDER BY empl.EFFDT DESC) as RN_EMPL
                                                                                                                                                             
            FROM health_ods.[health_ods].[RPT].[CURRENT_EMPL_DATA] EMPL
                                                                                                                                                                                      
        ),
                                                                                                                                                                                                                                                   
        CurrentEmplDataFiltered_L3
                                                                                                                                                                                                                           
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                POSITION_NBR,
                                                                                                                                                                                                                                
                Reports_To,
                                                                                                                                                                                                                                  
                HR_STATUS,
                                                                                                                                                                                                                                   
                emplid,
                                                                                                                                                                                                                                      
                EMPL_RCD,
                                                                                                                                                                                                                                    
                EFFDT,
                                                                                                                                                                                                                                       
                RN_EMPL
                                                                                                                                                                                                                                      
            FROM CurrentEmplData_L3
                                                                                                                                                                                                                          
            WHERE RN_EMPL = 1
                                                                                                                                                                                                                                
        ),
                                                                                                                                                                                                                                                   
        PositionData_L3
                                                                                                                                                                                                                                      
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                POSN_STATUS,
                                                                                                                                                                                                                                 
                deptid,
                                                                                                                                                                                                                                      
                POSITION_NBR,
                                                                                                                                                                                                                                
                EFFDT,
                                                                                                                                                                                                                                       
                DML_IND,
                                                                                                                                                                                                                                     
                ROW_NUMBER() OVER (PARTITION BY POSITION_NBR ORDER BY effdt DESC) as RN
                                                                                                                                                                      
            FROM health_ods.[health_ods].stable.PS_POSITION_DATA
                                                                                                                                                                                             
            WHERE dml_ind <> 'D'
                                                                                                                                                                                                                             
        ),
                                                                                                                                                                                                                                                   
        CTE_Position_HR_Status_L3
                                                                                                                                                                                                                            
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                jd.POSITION_NBR,
                                                                                                                                                                                                                             
                jd.EMPLID,
                                                                                                                                                                                                                                   
                empl.HR_STATUS,
                                                                                                                                                                                                                              
                pd.POSN_STATUS,
                                                                                                                                                                                                                              
                pd.EFFDT as POSITION_EFFDT,
                                                                                                                                                                                                                  
                empl.EFFDT as EMPL_EFFDT,
                                                                                                                                                                                                                    
                empl.Reports_To,
                                                                                                                                                                                                                             
                jd2.EMPLID as Manager_EMPLID,
                                                                                                                                                                                                                
                jd2.HR_STATUS as Manager_HR_STATUS,
                                                                                                                                                                                                          
                pd2.POSN_STATUS as Manager_POSN_STATUS,
                                                                                                                                                                                                      
                ROW_NUMBER() OVER (PARTITION BY jd.POSITION_NBR ORDER BY empl.EFFDT DESC) as RN_FINAL
                                                                                                                                                        
            FROM JobDataFiltered_L3 jd
                                                                                                                                                                                                                       
                JOIN PositionData_L3 pd ON pd.POSITION_NBR = jd.POSITION_NBR
                                                                                                                                                                                 
                JOIN CurrentEmplDataFiltered_L3 empl ON empl.POSITION_NBR = jd.POSITION_NBR
                                                                                                                                                                  
                LEFT JOIN JobDataFiltered_L3 jd2 ON jd2.POSITION_NBR = empl.Reports_To
                                                                                                                                                                       
                LEFT JOIN PositionData_L3 pd2 ON pd2.POSITION_NBR = empl.Reports_To AND pd2.RN = 1
                                                                                                                                                           
            WHERE 
                                                                                                                                                                                                                                           
                pd.RN = 1
                                                                                                                                                                                                                                    
        ),
                                                                                                                                                                                                                                                   
        CTE_Position_HR_Status_L3_Final
                                                                                                                                                                                                                      
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                POSITION_NBR,
                                                                                                                                                                                                                                
                EMPLID,
                                                                                                                                                                                                                                      
                HR_STATUS,
                                                                                                                                                                                                                                   
                POSN_STATUS,
                                                                                                                                                                                                                                 
                POSITION_EFFDT,
                                                                                                                                                                                                                              
                EMPL_EFFDT,
                                                                                                                                                                                                                                  
                Reports_To,
                                                                                                                                                                                                                                  
                Manager_EMPLID,
                                                                                                                                                                                                                              
                Manager_HR_STATUS,
                                                                                                                                                                                                                           
                Manager_POSN_STATUS
                                                                                                                                                                                                                          
            FROM CTE_Position_HR_Status_L3
                                                                                                                                                                                                                   
            WHERE RN_FINAL = 1
                                                                                                                                                                                                                               
        ),
                                                                                                                                                                                                                                                   
        CTE_Hierarchy_Posn_Level_L3
                                                                                                                                                                                                                          
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                empl.emplid,
                                                                                                                                                                                                                                 
                empl.POSITION_NBR,
                                                                                                                                                                                                                           
                EMPL.JOB_INDICATOR,
                                                                                                                                                                                                                          
                HPOSN.LEVEL as POSN_LEVEL,
                                                                                                                                                                                                                   
                GETDATE() AS UPDATED_DT
                                                                                                                                                                                                                      
            FROM health_ods.health_ods.[RPT].[CURRENT_EMPL_DATA] EMPL
                                                                                                                                                                                        
                JOIN health_ods.[RPT].ORG_HIERARCHY_POSN HPOSN
                                                                                                                                                                                               
                ON HPOSN.EMPLID = EMPL.EMPLID
                                                                                                                                                                                                                
                    AND HPOSN.EMPL_RCD = EMPL.EMPL_RCD
                                                                                                                                                                                                       
            WHERE empl.HR_STATUS='A'
                                                                                                                                                                                                                         
        )
                                                                                                                                                                                                                                                    
    SELECT DISTINCT
                                                                                                                                                                                                                                          
        t3.POSITION_NBR_To_Check,
                                                                                                                                                                                                                            
        t3.MANAGER_POSITION_NBR_L2 as MANAGER_POSITION_NBR,
                                                                                                                                                                                                  
        t3.POSN_LEVEL,
                                                                                                                                                                                                                                       
        t3.To_Trace_Up_1,
                                                                                                                                                                                                                                    
        t3.MANAGER_POSITION_NBR_L1,
                                                                                                                                                                                                                          
        t3.MANAGER_EMPLID,
                                                                                                                                                                                                                                   
        t3.MANAGER_HR_STATUS,
                                                                                                                                                                                                                                
        t3.MANAGER_POSN_STATUS,
                                                                                                                                                                                                                              
        t3.MANAGER_POSN_LEVEL,
                                                                                                                                                                                                                               
        t3.To_Trace_Up_2,
                                                                                                                                                                                                                                    
        t3.NOTE_L1,
                                                                                                                                                                                                                                          
        t3.MANAGER_POSITION_NBR_L2,
                                                                                                                                                                                                                          
        t3.MANAGER_EMPLID_L2,
                                                                                                                                                                                                                                
        t3.MANAGER_HR_STATUS_L2,
                                                                                                                                                                                                                             
        t3.MANAGER_POSN_STATUS_L2,
                                                                                                                                                                                                                           
        t3.MANAGER_POSN_LEVEL_L2,
                                                                                                                                                                                                                            
        t3.To_Trace_Up_3,
                                                                                                                                                                                                                                    
        t3.NOTE_L2,
                                                                                                                                                                                                                                          
        CTE_Position_HR_Status_L3_Final.REPORTS_TO as MANAGER_POSITION_NBR_L3,
                                                                                                                                                                               
        CTE_Position_HR_Status_L3_Final.Manager_EMPLID as MANAGER_EMPLID_L3,
                                                                                                                                                                                 
        CTE_Position_HR_Status_L3_Final.Manager_HR_STATUS as MANAGER_HR_STATUS_L3,
                                                                                                                                                                           
        CTE_Position_HR_Status_L3_Final.Manager_POSN_STATUS as MANAGER_POSN_STATUS_L3,
                                                                                                                                                                       
        COALESCE(L3.POSN_LEVEL, L4.POSN_LEVEL) as MANAGER_POSN_LEVEL_L3,
                                                                                                                                                                                     
        CASE 
                                                                                                                                                                                                                                                
            WHEN CTE_Position_HR_Status_L3_Final.Manager_EMPLID IS NULL THEN 'missing in PS_JOB'
                                                                                                                                                             
            WHEN COALESCE(L3.POSN_LEVEL, L4.POSN_LEVEL) IS NULL
                                                                                                                                                                                              
            AND CTE_Position_HR_Status_L3_Final.Manager_HR_STATUS = 'A'
                                                                                                                                                                                      
            AND CTE_Position_HR_Status_L3_Final.Manager_POSN_STATUS = 'A' THEN 'missing POSN_LEVEL in ORG_HIERARCHY_POSN'
                                                                                                                                    
            ELSE ''
                                                                                                                                                                                                                                          
        END as NOTE_L3,
                                                                                                                                                                                                                                      
        CASE 
                                                                                                                                                                                                                                                
            WHEN CTE_Position_HR_Status_L3_Final.Manager_HR_STATUS = 'A' OR CTE_Position_HR_Status_L3_Final.Manager_HR_STATUS IS NULL THEN 'no'
                                                                                                              
            ELSE 'yes'
                                                                                                                                                                                                                                       
        END as To_Trace_Up_4
                                                                                                                                                                                                                                 
    INTO #temp4
                                                                                                                                                                                                                                              
    FROM #temp3 t3
                                                                                                                                                                                                                                           
        LEFT JOIN CTE_Position_HR_Status_L3_Final ON t3.MANAGER_POSITION_NBR_L2 = CTE_Position_HR_Status_L3_Final.POSITION_NBR
                                                                                                                               
        LEFT JOIN [stage].[UKG_EMPL_HIERARCHY_POSN_LOOKUP] L3 ON CTE_Position_HR_Status_L3_Final.REPORTS_TO = L3.POSITION_NBR
                                                                                                                                
        LEFT JOIN CTE_Hierarchy_Posn_Level_L3 L4 ON CTE_Position_HR_Status_L3_Final.REPORTS_TO = L4.POSITION_NBR
                                                                                                                                             
    WHERE t3.To_Trace_Up_3 = 'yes';
                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    SELECT *
                                                                                                                                                                                                                                                 
    FROM #temp4
                                                                                                                                                                                                                                              
    ORDER BY POSITION_NBR_To_Check;
                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    -- Create temp5 by joining To_Trace_Up_4='yes' records with Level 4 analysis data
                                                                                                                                                                        
    IF OBJECT_ID('tempdb..#temp5', 'U') IS NOT NULL 
                                                                                                                                                                                                         
        DROP TABLE #temp5;
                                                                                                                                                                                                                                   

                                                                                                                                                                                                                                                             
    WITH
                                                                                                                                                                                                                                                     
        JobData_L4
                                                                                                                                                                                                                                           
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                J.POSITION_NBR,
                                                                                                                                                                                                                              
                J.EMPLID,
                                                                                                                                                                                                                                    
                J.HR_STATUS,
                                                                                                                                                                                                                                 
                J.EMPL_RCD,
                                                                                                                                                                                                                                  
                J.JOBCODE,
                                                                                                                                                                                                                                   
                J.EFFDT,
                                                                                                                                                                                                                                     
                ROW_NUMBER() OVER (PARTITION BY J.EMPLID ORDER BY
                                                                                                                                                                                            
                    (CASE WHEN J.JOB_INDICATOR = 'N' THEN 'Z' ELSE J.JOB_INDICATOR END), 
                                                                                                                                                                    
                    EFFDT DESC) as ROWNO
                                                                                                                                                                                                                     
            FROM health_ods.[HEALTH_ODS].[STABLE].PS_JOB J
                                                                                                                                                                                                   
            WHERE 
                                                                                                                                                                                                                                           
              J.DML_IND <> 'D'
                                                                                                                                                                                                                               
                AND J.EFFDT = (
                                                                                                                                                                                                                              
                    SELECT MAX(J1.EFFDT)
                                                                                                                                                                                                                     
                FROM health_ods.[health_ods].[STABLE].PS_JOB J1
                                                                                                                                                                                              
                WHERE J1.EMPLID = J.EMPLID
                                                                                                                                                                                                                   
                    AND J1.EMPL_RCD = J.EMPL_RCD
                                                                                                                                                                                                             
                    AND J1.EFFDT <= GETDATE()
                                                                                                                                                                                                                
                    AND J1.DML_IND <> 'D'
                                                                                                                                                                                                                    
                )
                                                                                                                                                                                                                                            
                AND J.EFFSEQ = (
                                                                                                                                                                                                                             
                    SELECT MAX(J2.EFFSEQ)
                                                                                                                                                                                                                    
                FROM health_ods.[health_ods].[STABLE].PS_JOB J2
                                                                                                                                                                                              
                WHERE J2.EMPLID = J.EMPLID
                                                                                                                                                                                                                   
                    AND J2.EMPL_RCD = J.EMPL_RCD
                                                                                                                                                                                                             
                    AND J2.EFFDT = J.EFFDT
                                                                                                                                                                                                                   
                    AND J2.DML_IND <> 'D'
                                                                                                                                                                                                                    
                )
                                                                                                                                                                                                                                            
        ),
                                                                                                                                                                                                                                                   
        JobDataFiltered_L4
                                                                                                                                                                                                                                   
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                POSITION_NBR,
                                                                                                                                                                                                                                
                EMPLID,
                                                                                                                                                                                                                                      
                HR_STATUS,
                                                                                                                                                                                                                                   
                EMPL_RCD,
                                                                                                                                                                                                                                    
                JOBCODE,
                                                                                                                                                                                                                                     
                EFFDT,
                                                                                                                                                                                                                                       
                ROWNO
                                                                                                                                                                                                                                        
            FROM JobData_L4
                                                                                                                                                                                                                                  
            WHERE ROWNO = 1
                                                                                                                                                                                                                                  
        ),
                                                                                                                                                                                                                                                   
        CurrentEmplData_L4
                                                                                                                                                                                                                                   
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                empl.POSITION_NBR,
                                                                                                                                                                                                                           
                empl.Reports_To,
                                                                                                                                                                                                                             
                empl.HR_STATUS,
                                                                                                                                                                                                                              
                empl.emplid,
                                                                                                                                                                                                                                 
                empl.EMPL_RCD,
                                                                                                                                                                                                                               
                empl.EFFDT,
                                                                                                                                                                                                                                  
                ROW_NUMBER() OVER (PARTITION BY empl.emplid ORDER BY empl.EFFDT DESC) as RN_EMPL
                                                                                                                                                             
            FROM health_ods.[health_ods].[RPT].[CURRENT_EMPL_DATA] EMPL
                                                                                                                                                                                      
        ),
                                                                                                                                                                                                                                                   
        CurrentEmplDataFiltered_L4
                                                                                                                                                                                                                           
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                POSITION_NBR,
                                                                                                                                                                                                                                
                Reports_To,
                                                                                                                                                                                                                                  
                HR_STATUS,
                                                                                                                                                                                                                                   
                emplid,
                                                                                                                                                                                                                                      
                EMPL_RCD,
                                                                                                                                                                                                                                    
                EFFDT,
                                                                                                                                                                                                                                       
                RN_EMPL
                                                                                                                                                                                                                                      
            FROM CurrentEmplData_L4
                                                                                                                                                                                                                          
            WHERE RN_EMPL = 1
                                                                                                                                                                                                                                
        ),
                                                                                                                                                                                                                                                   
        PositionData_L4
                                                                                                                                                                                                                                      
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                POSN_STATUS,
                                                                                                                                                                                                                                 
                deptid,
                                                                                                                                                                                                                                      
                POSITION_NBR,
                                                                                                                                                                                                                                
                EFFDT,
                                                                                                                                                                                                                                       
                DML_IND,
                                                                                                                                                                                                                                     
                ROW_NUMBER() OVER (PARTITION BY POSITION_NBR ORDER BY effdt DESC) as RN
                                                                                                                                                                      
            FROM health_ods.[health_ods].stable.PS_POSITION_DATA
                                                                                                                                                                                             
            WHERE dml_ind <> 'D'
                                                                                                                                                                                                                             
        ),
                                                                                                                                                                                                                                                   
        CTE_Position_HR_Status_L4
                                                                                                                                                                                                                            
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                jd.POSITION_NBR,
                                                                                                                                                                                                                             
                jd.EMPLID,
                                                                                                                                                                                                                                   
                empl.HR_STATUS,
                                                                                                                                                                                                                              
                pd.POSN_STATUS,
                                                                                                                                                                                                                              
                pd.EFFDT as POSITION_EFFDT,
                                                                                                                                                                                                                  
                empl.EFFDT as EMPL_EFFDT,
                                                                                                                                                                                                                    
                empl.Reports_To,
                                                                                                                                                                                                                             
                jd2.EMPLID as Manager_EMPLID,
                                                                                                                                                                                                                
                jd2.HR_STATUS as Manager_HR_STATUS,
                                                                                                                                                                                                          
                pd2.POSN_STATUS as Manager_POSN_STATUS,
                                                                                                                                                                                                      
                ROW_NUMBER() OVER (PARTITION BY jd.POSITION_NBR ORDER BY empl.EFFDT DESC) as RN_FINAL
                                                                                                                                                        
            FROM JobDataFiltered_L4 jd
                                                                                                                                                                                                                       
                JOIN PositionData_L4 pd ON pd.POSITION_NBR = jd.POSITION_NBR
                                                                                                                                                                                 
                JOIN CurrentEmplDataFiltered_L4 empl ON empl.POSITION_NBR = jd.POSITION_NBR
                                                                                                                                                                  
                LEFT JOIN JobDataFiltered_L4 jd2 ON jd2.POSITION_NBR = empl.Reports_To
                                                                                                                                                                       
                LEFT JOIN PositionData_L4 pd2 ON pd2.POSITION_NBR = empl.Reports_To AND pd2.RN = 1
                                                                                                                                                           
            WHERE 
                                                                                                                                                                                                                                           
                pd.RN = 1
                                                                                                                                                                                                                                    
        ),
                                                                                                                                                                                                                                                   
        CTE_Position_HR_Status_L4_Final
                                                                                                                                                                                                                      
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                POSITION_NBR,
                                                                                                                                                                                                                                
                EMPLID,
                                                                                                                                                                                                                                      
                HR_STATUS,
                                                                                                                                                                                                                                   
                POSN_STATUS,
                                                                                                                                                                                                                                 
                POSITION_EFFDT,
                                                                                                                                                                                                                              
                EMPL_EFFDT,
                                                                                                                                                                                                                                  
                Reports_To,
                                                                                                                                                                                                                                  
                Manager_EMPLID,
                                                                                                                                                                                                                              
                Manager_HR_STATUS,
                                                                                                                                                                                                                           
                Manager_POSN_STATUS
                                                                                                                                                                                                                          
            FROM CTE_Position_HR_Status_L4
                                                                                                                                                                                                                   
            WHERE RN_FINAL = 1
                                                                                                                                                                                                                               
        ),
                                                                                                                                                                                                                                                   
        CTE_Hierarchy_Posn_Level_L4
                                                                                                                                                                                                                          
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                empl.emplid,
                                                                                                                                                                                                                                 
                empl.POSITION_NBR,
                                                                                                                                                                                                                           
                EMPL.JOB_INDICATOR,
                                                                                                                                                                                                                          
                HPOSN.LEVEL as POSN_LEVEL,
                                                                                                                                                                                                                   
                GETDATE() AS UPDATED_DT
                                                                                                                                                                                                                      
            FROM health_ods.health_ods.[RPT].[CURRENT_EMPL_DATA] EMPL
                                                                                                                                                                                        
                JOIN health_ods.[RPT].ORG_HIERARCHY_POSN HPOSN
                                                                                                                                                                                               
                ON HPOSN.EMPLID = EMPL.EMPLID
                                                                                                                                                                                                                
                    AND HPOSN.EMPL_RCD = EMPL.EMPL_RCD
                                                                                                                                                                                                       
            WHERE empl.HR_STATUS='A'
                                                                                                                                                                                                                         
        )
                                                                                                                                                                                                                                                    
    SELECT DISTINCT
                                                                                                                                                                                                                                          
        t4.POSITION_NBR_To_Check,
                                                                                                                                                                                                                            
        t4.MANAGER_POSITION_NBR_L3 as MANAGER_POSITION_NBR,
                                                                                                                                                                                                  
        t4.POSN_LEVEL,
                                                                                                                                                                                                                                       
        t4.To_Trace_Up_1,
                                                                                                                                                                                                                                    
        t4.MANAGER_POSITION_NBR_L1,
                                                                                                                                                                                                                          
        t4.MANAGER_EMPLID,
                                                                                                                                                                                                                                   
        t4.MANAGER_HR_STATUS,
                                                                                                                                                                                                                                
        t4.MANAGER_POSN_STATUS,
                                                                                                                                                                                                                              
        t4.MANAGER_POSN_LEVEL,
                                                                                                                                                                                                                               
        t4.To_Trace_Up_2,
                                                                                                                                                                                                                                    
        t4.NOTE_L1,
                                                                                                                                                                                                                                          
        t4.MANAGER_POSITION_NBR_L2,
                                                                                                                                                                                                                          
        t4.MANAGER_EMPLID_L2,
                                                                                                                                                                                                                                
        t4.MANAGER_HR_STATUS_L2,
                                                                                                                                                                                                                             
        t4.MANAGER_POSN_STATUS_L2,
                                                                                                                                                                                                                           
        t4.MANAGER_POSN_LEVEL_L2,
                                                                                                                                                                                                                            
        t4.To_Trace_Up_3,
                                                                                                                                                                                                                                    
        t4.NOTE_L2,
                                                                                                                                                                                                                                          
        t4.MANAGER_POSITION_NBR_L3,
                                                                                                                                                                                                                          
        t4.MANAGER_EMPLID_L3,
                                                                                                                                                                                                                                
        t4.MANAGER_HR_STATUS_L3,
                                                                                                                                                                                                                             
        t4.MANAGER_POSN_STATUS_L3,
                                                                                                                                                                                                                           
        t4.MANAGER_POSN_LEVEL_L3,
                                                                                                                                                                                                                            
        t4.To_Trace_Up_4,
                                                                                                                                                                                                                                    
        t4.NOTE_L3,
                                                                                                                                                                                                                                          
        CTE_Position_HR_Status_L4_Final.REPORTS_TO as MANAGER_POSITION_NBR_L4,
                                                                                                                                                                               
        CTE_Position_HR_Status_L4_Final.Manager_EMPLID as MANAGER_EMPLID_L4,
                                                                                                                                                                                 
        CTE_Position_HR_Status_L4_Final.Manager_HR_STATUS as MANAGER_HR_STATUS_L4,
                                                                                                                                                                           
        CTE_Position_HR_Status_L4_Final.Manager_POSN_STATUS as MANAGER_POSN_STATUS_L4,
                                                                                                                                                                       
        COALESCE(L4.POSN_LEVEL, L5.POSN_LEVEL) as MANAGER_POSN_LEVEL_L4,
                                                                                                                                                                                     
        CASE 
                                                                                                                                                                                                                                                
            WHEN CTE_Position_HR_Status_L4_Final.Manager_EMPLID IS NULL THEN 'missing in PS_JOB'
                                                                                                                                                             
            WHEN COALESCE(L4.POSN_LEVEL, L5.POSN_LEVEL) IS NULL
                                                                                                                                                                                              
            AND CTE_Position_HR_Status_L4_Final.Manager_HR_STATUS = 'A'
                                                                                                                                                                                      
            AND CTE_Position_HR_Status_L4_Final.Manager_POSN_STATUS = 'A' THEN 'missing POSN_LEVEL in ORG_HIERARCHY_POSN'
                                                                                                                                    
            ELSE ''
                                                                                                                                                                                                                                          
        END as NOTE_L4,
                                                                                                                                                                                                                                      
        CASE 
                                                                                                                                                                                                                                                
            WHEN CTE_Position_HR_Status_L4_Final.Manager_HR_STATUS = 'A' OR CTE_Position_HR_Status_L4_Final.Manager_HR_STATUS IS NULL THEN 'no'
                                                                                                              
            ELSE 'yes'
                                                                                                                                                                                                                                       
        END as To_Trace_Up_5
                                                                                                                                                                                                                                 
    INTO #temp5
                                                                                                                                                                                                                                              
    FROM #temp4 t4
                                                                                                                                                                                                                                           
        LEFT JOIN CTE_Position_HR_Status_L4_Final ON t4.MANAGER_POSITION_NBR_L3 = CTE_Position_HR_Status_L4_Final.POSITION_NBR
                                                                                                                               
        LEFT JOIN [stage].[UKG_EMPL_HIERARCHY_POSN_LOOKUP] L4 ON CTE_Position_HR_Status_L4_Final.REPORTS_TO = L4.POSITION_NBR
                                                                                                                                
        LEFT JOIN CTE_Hierarchy_Posn_Level_L4 L5 ON CTE_Position_HR_Status_L4_Final.REPORTS_TO = L5.POSITION_NBR
                                                                                                                                             
    WHERE t4.To_Trace_Up_4 = 'yes';
                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    SELECT *
                                                                                                                                                                                                                                                 
    FROM #temp5
                                                                                                                                                                                                                                              
    ORDER BY POSITION_NBR_To_Check;
                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
    PRINT 'Position Trace Analysis completed successfully.';
                                                                                                                                                                                                 
    PRINT 'Temp tables #temp1, #temp2, #temp3, #temp4, and #temp5 are available for further analysis in this session.';
                                                                                                                                      

                                                                                                                                                                                                                                                             
END

-- ===== stage.SP_NON_UKG_MANAGER_HISTORY_MERGE =====

                                                                                                                                                                                                                                                             
/***************************************
                                                                                                                                                                                                                     
* Stored Procedure: [stage].[SP_NON_UKG_MANAGER_HISTORY_MERGE]
                                                                                                                                                                                               
* Created By: GitHub Copilot
                                                                                                                                                                                                                                 
* Created Date: 12/03/2025
                                                                                                                                                                                                                                   
* Purpose: Merge Non-UKG Manager data from UKG_EMPLOYEE_DATA_TEMP into NON_UKG_MANAGER_HISTORY table
                                                                                                                                                         
*          using composite key matching on [Person Number] AND [Manager Flag]
                                                                                                                                                                                
* 
                                                                                                                                                                                                                                                           
* Business Logic:
                                                                                                                                                                                                                                            
* - Sources data from UKG_EMPLOYEE_DATA_TEMP where NON_UKG_MANAGER_FLAG='T' OR Manager Flag='T' with BYA exclusions
                                                                                                                                          
* - Uses MERGE operation with composite key: [Person Number] AND [Manager Flag]
                                                                                                                                                                              
* - Only inserts new records when no match exists (WHEN NOT MATCHED BY TARGET)
                                                                                                                                                                               
* - Preserves historical snapshots with snapshot_date timestamp
                                                                                                                                                                                              
* - Includes comprehensive error handling and transaction management
                                                                                                                                                                                         
* 
                                                                                                                                                                                                                                                           
* Composite Key Logic:
                                                                                                                                                                                                                                       
* - [Person Number]: Unique employee identifier from source system
                                                                                                                                                                                           
* - [Manager Flag]: Manager status flag ('T'/'F') to track manager role changes over time
                                                                                                                                                                    
* - This allows tracking of manager flag changes for the same person as separate historical records
                                                                                                                                                          
* 
                                                                                                                                                                                                                                                           
* Data Sources:
                                                                                                                                                                                                                                              
* - [dbo].[UKG_EMPLOYEE_DATA_TEMP]: Primary employee data source
                                                                                                                                                                                             
* - STAGE.CTE_EXCLUDE_BYA: Exclusion list for BYA (specific business rule)
                                                                                                                                                                                   
* 
                                                                                                                                                                                                                                                           
* Target Table:
                                                                                                                                                                                                                                              
* - [dbo].[NON_UKG_MANAGER_HISTORY]: Historical tracking table for non-UKG managers
                                                                                                                                                                          
* 
                                                                                                                                                                                                                                                           
* Performance Considerations:
                                                                                                                                                                                                                                
* - Uses MERGE for optimal performance with large datasets
                                                                                                                                                                                                   
* - Composite key indexing on target table recommended for performance
                                                                                                                                                                                       
* - Transaction-wrapped for data consistency
                                                                                                                                                                                                                 
* 
                                                                                                                                                                                                                                                           
* Usage: EXEC [stage].[SP_NON_UKG_MANAGER_HISTORY_MERGE]
                                                                                                                                                                                                     
* 
                                                                                                                                                                                                                                                           
* Dependencies:
                                                                                                                                                                                                                                              
* - [dbo].[UKG_EMPLOYEE_DATA_TEMP] table must exist and be populated
                                                                                                                                                                                         
* - STAGE.CTE_EXCLUDE_BYA view/table must exist
                                                                                                                                                                                                              
* - [dbo].[NON_UKG_MANAGER_HISTORY] target table must exist
                                                                                                                                                                                                  
* 
                                                                                                                                                                                                                                                           
* Expected Output:
                                                                                                                                                                                                                                           
* - Summary of records inserted
                                                                                                                                                                                                                              
* - Error handling with detailed messaging
                                                                                                                                                                                                                   
* - Transaction rollback on failure
                                                                                                                                                                                                                          
* 
                                                                                                                                                                                                                                                           
* Created: 12/03/2025 - Initial creation with MERGE logic and composite key matching
                                                                                                                                                                         
* Updated: 12/16/2025 - Added Custom Field 9 update logic to set 'T' for all manager records
                                                                                                                                                                 
*                      - Updates [Custom Field 9] = 'T' WHERE [Manager Flag] = 'T'
                                                                                                                                                                           
*                      - Applied after MERGE operation and before transaction commit
                                                                                                                                                                         
*                      - Added hash_value calculation and column to INSERT operation
                                                                                                                                                                         
*                      - Fixed NULL constraint error for hash_value column
                                                                                                                                                                                   
* Updated: 01/22/2026 - Added deletion marking when source no longer contains composite key
                                                                                                                                                                  
*                      - Restrict deletion marking to active records (NOTE IS NULL)
                                                                                                                                                                          
*                      - MERGE clause updated: WHEN NOT MATCHED BY SOURCE AND TARGET.[NOTE] IS NULL THEN UPDATE SET [NOTE]='D', [snapshot_date]=GETDATE()
                                                                                                    
* Updated: 01/28/2026 - Added logic to mark rows with T.[NOTE] = 'P' when source EMPLID matches target EMPLID but NON_UKG_MANAGER_FLAG changes from 'T' to 'F'.
                                                                                              
* Updated: 02/03/2026 - mark NOTE='P' when source EMPLID matches target EMPLID and NON_UKG_MANAGER_FLAG changes from 'T' to 'F'; excluded rows where NOTE='D'.
                                                                                               
*
                                                                                                                                                                                                                                                            
* Technical Details:
                                                                                                                                                                                                                                         
* - Version: 1.4 (2026-01-28)
                                                                                                                                                                                                                                
* - Added logic to handle cases where the NON_UKG_MANAGER_FLAG changes from 'T' to 'F' for matching EMPLID between source and target.
                                                                                                                        
* - Updates the [NOTE] column to 'P' and sets [Update_DT] to GETDATE() for such rows.
                                                                                                                                                                        
* - Ensures accurate tracking of changes in manager status for historical records.
                                                                                                                                                                           
*
                                                                                                                                                                                                                                                            
* - Version: 1.3 (2026-01-23)
                                                                                                                                                                                                                                
* - Hashing: HASHBYTES('md5', CONCAT(EMPLID, DEPTID, VC_CODE, hr_status, empl_Status, termination_dt, action, action_dt)) stored in [hash_value]
                                                                                                             
* - Composite key for insert logic: [Person Number], [Manager Flag]
                                                                                                                                                                                          
* - NOTE column semantics: NULL = active, 'D' = deleted, 'I' = inserted, 'P' = pending (used when marking target rows not present in source)
                                                                                                                 
* - Update_DT: [Update_DT] [date] NULL is populated with GETDATE() when inserting or marking deletions/reactivations
                                                                                                                                         
* - Deletion-marking behavior: rows missing from source and currently active are updated to set [Employment Status]='T', [Employment Status Effective Date]=FORMAT(GETDATE(), 'yyyy-MM-dd'), [Update_DT]=GETDATE(), [NOTE]='P' and [Manager Flag]='F'
        
* - Reactivation logic: when a source row matches a target row with NOTE='D' and identical [hash_value], the procedure updates the deleted row's [Update_DT] and inserts a new active history record from SourceData
                                         
* - MERGE replacement: MERGE was replaced with explicit INSERT/UPDATE operations to avoid MERGE parsing issues in T-SQL
                                                                                                                                      
* - Transactional: Operation is wrapped in a transaction with TRY/CATCH and THROW for error propagation
                                                                                                                                                      
* - Performance: SourceData CTE reads from [dbo].[UKG_EMPLOYEE_DATA_TEMP]; ensure indexes exist on EMPLID, jobcode, [Person Number]; recommended indexes on target: ([Person Number], [Manager Flag]), [NOTE], [Update_DT], [hash_value]
                     

                                                                                                                                                                                                                                                             
* - 2026-01-23: Version 1.3 - Changed deletion-marking to set Employment Status and NOTE='P', update [Update_DT], set Manager Flag to 'F'; added header/version update
                                                                                       
* - 2026-01-23: Version 1.2 - Added reactivation logic (update [Update_DT] and insert new active row when source matches a deleted target with same hash); replaced MERGE with INSERT/UPDATE; added duplicate-prevention for reactivated inserts
             
* - 2026-01-22: Added deletion marking to MERGE; limited to active rows; no additional hash history column added
                                                                                                                                             
* - 12/16/2025: Added Custom Field 9 update logic and hash_value calculation
                                                                                                                                                                                 
******************************************/
                                                                                                                                                                                                                  

                                                                                                                                                                                                                                                             
CREATE   PROCEDURE [stage].[SP_NON_UKG_MANAGER_HISTORY_MERGE]
                                                                                                                                                                                                
AS
                                                                                                                                                                                                                                                           
BEGIN
                                                                                                                                                                                                                                                        
    SET NOCOUNT ON;
                                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    DECLARE @RecordsInserted INT = 0;
                                                                                                                                                                                                                        
    DECLARE @RecordsDeleted INT = 0;
                                                                                                                                                                                                                         
    DECLARE @ErrorMessage NVARCHAR(4000);
                                                                                                                                                                                                                    

                                                                                                                                                                                                                                                             
    BEGIN TRY
                                                                                                                                                                                                                                                
        BEGIN TRANSACTION;
                                                                                                                                                                                                                                   
        
                                                                                                                                                                                                                                                     
        -- MERGE operation to insert only new records based on composite key
                                                                                                                                                                                 
        WITH
                                                                                                                                                                                                                                                 
        SourceData
                                                                                                                                                                                                                                           
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT [DEPTID]
                                                                                                                                                                                                                                  
                  , [VC_CODE]
                                                                                                                                                                                                                                
                  , [FDM_COMBO_CD]
                                                                                                                                                                                                                           
                  , [COMBOCODE]
                                                                                                                                                                                                                              
                  , [REPORTS_TO]
                                                                                                                                                                                                                             
                  , [MANAGER_EMPLID]
                                                                                                                                                                                                                         
                  , [NON_UKG_MANAGER_FLAG]
                                                                                                                                                                                                                   
                  , [position_nbr]
                                                                                                                                                                                                                           
                  , [EMPLID]
                                                                                                                                                                                                                                 
                  , [EMPL_RCD]
                                                                                                                                                                                                                               
                  , [jobcode]
                                                                                                                                                                                                                                
                  , [POSITION_DESCR]
                                                                                                                                                                                                                         
                  , [hr_status]
                                                                                                                                                                                                                              
                  , [FTE_SUM]
                                                                                                                                                                                                                                
                  , [fte]
                                                                                                                                                                                                                                    
                  , [empl_Status]
                                                                                                                                                                                                                            
                  , [JobGroup]
                                                                                                                                                                                                                               
                  , [FundGroup]
                                                                                                                                                                                                                              
                  , [Person Number]
                                                                                                                                                                                                                          
                  , [First Name]
                                                                                                                                                                                                                             
                  , [Last Name]
                                                                                                                                                                                                                              
                  , [Middle Initial/Name]
                                                                                                                                                                                                                    
                  , [Short Name]
                                                                                                                                                                                                                             
                  , [Badge Number]
                                                                                                                                                                                                                           
                  , [Hire Date]
                                                                                                                                                                                                                              
                  , [Birth Date]
                                                                                                                                                                                                                             
                  , [Seniority Date]
                                                                                                                                                                                                                         
                  , [Manager Flag]
                                                                                                                                                                                                                           
                  , [Phone 1]
                                                                                                                                                                                                                                
                  , [Phone 2]
                                                                                                                                                                                                                                
                  , [Email]
                                                                                                                                                                                                                                  
                  , [Address]
                                                                                                                                                                                                                                
                  , [City]
                                                                                                                                                                                                                                   
                  , [State]
                                                                                                                                                                                                                                  
                  , [Postal Code]
                                                                                                                                                                                                                            
                  , [Country]
                                                                                                                                                                                                                                
                  , [Time Zone]
                                                                                                                                                                                                                              
                  , [Employment Status]
                                                                                                                                                                                                                      
                  , [Employment Status Effective Date]
                                                                                                                                                                                                       
                  , [Reports to Manager]
                                                                                                                                                                                                                     
                  , [Union Code]
                                                                                                                                                                                                                             
                  , [Employee Type]
                                                                                                                                                                                                                          
                  , [Employee Classification]
                                                                                                                                                                                                                
                  , [Pay Frequency]
                                                                                                                                                                                                                          
                  , [Worker Type]
                                                                                                                                                                                                                            
                  , [FTE %]
                                                                                                                                                                                                                                  
                  , [FTE Standard Hours]
                                                                                                                                                                                                                     
                  , [FTE Full Time Hours]
                                                                                                                                                                                                                    
                  , [Standard Hours - Daily]
                                                                                                                                                                                                                 
                  , [Standard Hours - Weekly]
                                                                                                                                                                                                                
                  , [Standard Hours - Pay Period]
                                                                                                                                                                                                            
                  , [Base Wage Rate]
                                                                                                                                                                                                                         
                  , [Base Wage Rate Effective Date]
                                                                                                                                                                                                          
                  , [User Account Name]
                                                                                                                                                                                                                      
                  , [User Account Status]
                                                                                                                                                                                                                    
                  , [User Password]
                                                                                                                                                                                                                          
                  , [Home Business Structure Level 1 - Organization]
                                                                                                                                                                                         
                  , [Home Business Structure Level 2 - Entity]
                                                                                                                                                                                               
                  , [Home Business Structure Level 3 - Service Line]
                                                                                                                                                                                         
                  , [Home Business Structure Level 4 - Financial Unit]
                                                                                                                                                                                       
                  , [Home Business Structure Level 5 - Fund Group]
                                                                                                                                                                                           
                  , [Home Business Structure Level 6]
                                                                                                                                                                                                        
                  , [Home Business Structure Level 7]
                                                                                                                                                                                                        
                  , [Home Business Structure Level 8]
                                                                                                                                                                                                        
                  , [Home Business Structure Level 9]
                                                                                                                                                                                                        
                  , [Home/Primary Job]
                                                                                                                                                                                                                       
                  , [Home Labor Category Level 1]
                                                                                                                                                                                                            
                  , [Home Labor Category Level 2]
                                                                                                                                                                                                            
                  , [Home Labor Category Level 3]
                                                                                                                                                                                                            
                  , [Home Labor Category Level 4]
                                                                                                                                                                                                            
                  , [Home Labor Category Level 5]
                                                                                                                                                                                                            
                  , [Home Labor Category Level 6]
                                                                                                                                                                                                            
                  , [Home Job and Labor Category Effective Date]
                                                                                                                                                                                             
                  , [Custom Field 1]
                                                                                                                                                                                                                         
                  , [Custom Field 2]
                                                                                                                                                                                                                         
                  , [Custom Field 3]
                                                                                                                                                                                                                         
                  , [Custom Field 4]
                                                                                                                                                                                                                         
                  , [Custom Field 5]
                                                                                                                                                                                                                         
                  , [Custom Field 6]
                                                                                                                                                                                                                         
                  , [Custom Field 7]
                                                                                                                                                                                                                         
                  , [Custom Field 8]
                                                                                                                                                                                                                         
                  , [Custom Field 9]
                                                                                                                                                                                                                         
                  , [Custom Field 10]
                                                                                                                                                                                                                        
                  , [Custom Date 1]
                                                                                                                                                                                                                          
                  , [Custom Date 2]
                                                                                                                                                                                                                          
                  , [Custom Date 3]
                                                                                                                                                                                                                          
                  , [Custom Date 4]
                                                                                                                                                                                                                          
                  , [Custom Date 5]
                                                                                                                                                                                                                          
                  , [Custom Field 11]
                                                                                                                                                                                                                        
                  , [Custom Field 12]
                                                                                                                                                                                                                        
                  , [Custom Field 13]
                                                                                                                                                                                                                        
                  , [Custom Field 14]
                                                                                                                                                                                                                        
                  , [Custom Field 15]
                                                                                                                                                                                                                        
                  , [Custom Field 16]
                                                                                                                                                                                                                        
                  , [Custom Field 17]
                                                                                                                                                                                                                        
                  , [Custom Field 18]
                                                                                                                                                                                                                        
                  , [Custom Field 19]
                                                                                                                                                                                                                        
                  , [Custom Field 20]
                                                                                                                                                                                                                        
                  , [Custom Field 21]
                                                                                                                                                                                                                        
                  , [Custom Field 22]
                                                                                                                                                                                                                        
                  , [Custom Field 23]
                                                                                                                                                                                                                        
                  , [Custom Field 24]
                                                                                                                                                                                                                        
                  , [Custom Field 25]
                                                                                                                                                                                                                        
                  , [Custom Field 26]
                                                                                                                                                                                                                        
                  , [Custom Field 27]
                                                                                                                                                                                                                        
                  , [Custom Field 28]
                                                                                                                                                                                                                        
                  , [Custom Field 29]
                                                                                                                                                                                                                        
                  , [Custom Field 30]
                                                                                                                                                                                                                        
                  , [Additional Fields for CRT lookups]
                                                                                                                                                                                                      
                  , [termination_dt]
                                                                                                                                                                                                                         
                  , [action]
                                                                                                                                                                                                                                 
                  , [action_dt]
                                                                                                                                                                                                                              
                  , HASHBYTES('md5', CONCAT([EMPLID], [DEPTID], [VC_CODE], [hr_status], [empl_Status], [termination_dt], [action], [action_dt])) AS [hash_value]
                                                                                             
                  , GETDATE() as [Update_DT]
                                                                                                                                                                                                                 
            FROM [dbo].[UKG_EMPLOYEE_DATA_TEMP]
                                                                                                                                                                                                              
            WHERE [NON_UKG_MANAGER_FLAG]='T'
                                                                                                                                                                                                                 
                OR ([Manager Flag]='T' AND [Person Number] IN (
                                                                                                                                                                                              
                       SELECT emplid
                                                                                                                                                                                                                         
                FROM STAGE.CTE_EXCLUDE_BYA
                                                                                                                                                                                                                   
                   ))
                                                                                                                                                                                                                                        
        )
                                                                                                                                                                                                                                                    
    -- replaced MERGE with INSERT to avoid MERGE parsing issues
                                                                                                                                                                                              
    INSERT INTO [dbo].[NON_UKG_MANAGER_HISTORY]
                                                                                                                                                                                                              
        (
                                                                                                                                                                                                                                                    
        [DEPTID]
                                                                                                                                                                                                                                             
        , [VC_CODE]
                                                                                                                                                                                                                                          
        , [FDM_COMBO_CD]
                                                                                                                                                                                                                                     
        , [COMBOCODE]
                                                                                                                                                                                                                                        
        , [REPORTS_TO]
                                                                                                                                                                                                                                       
        , [MANAGER_EMPLID]
                                                                                                                                                                                                                                   
        , [NON_UKG_MANAGER_FLAG]
                                                                                                                                                                                                                             
        , [position_nbr]
                                                                                                                                                                                                                                     
        , [EMPLID]
                                                                                                                                                                                                                                           
        , [EMPL_RCD]
                                                                                                                                                                                                                                         
        , [jobcode]
                                                                                                                                                                                                                                          
        , [POSITION_DESCR]
                                                                                                                                                                                                                                   
        , [hr_status]
                                                                                                                                                                                                                                        
        , [FTE_SUM]
                                                                                                                                                                                                                                          
        , [fte]
                                                                                                                                                                                                                                              
        , [empl_Status]
                                                                                                                                                                                                                                      
        , [JobGroup]
                                                                                                                                                                                                                                         
        , [FundGroup]
                                                                                                                                                                                                                                        
        , [Person Number]
                                                                                                                                                                                                                                    
        , [First Name]
                                                                                                                                                                                                                                       
        , [Last Name]
                                                                                                                                                                                                                                        
        , [Middle Initial/Name]
                                                                                                                                                                                                                              
        , [Short Name]
                                                                                                                                                                                                                                       
        , [Badge Number]
                                                                                                                                                                                                                                     
        , [Hire Date]
                                                                                                                                                                                                                                        
        , [Birth Date]
                                                                                                                                                                                                                                       
        , [Seniority Date]
                                                                                                                                                                                                                                   
        , [Manager Flag]
                                                                                                                                                                                                                                     
        , [Phone 1]
                                                                                                                                                                                                                                          
        , [Phone 2]
                                                                                                                                                                                                                                          
        , [Email]
                                                                                                                                                                                                                                            
        , [Address]
                                                                                                                                                                                                                                          
        , [City]
                                                                                                                                                                                                                                             
        , [State]
                                                                                                                                                                                                                                            
        , [Postal Code]
                                                                                                                                                                                                                                      
        , [Country]
                                                                                                                                                                                                                                          
        , [Time Zone]
                                                                                                                                                                                                                                        
        , [Employment Status]
                                                                                                                                                                                                                                
        , [Employment Status Effective Date]
                                                                                                                                                                                                                 
        , [Reports to Manager]
                                                                                                                                                                                                                               
        , [Union Code]
                                                                                                                                                                                                                                       
        , [Employee Type]
                                                                                                                                                                                                                                    
        , [Employee Classification]
                                                                                                                                                                                                                          
        , [Pay Frequency]
                                                                                                                                                                                                                                    
        , [Worker Type]
                                                                                                                                                                                                                                      
        , [FTE %]
                                                                                                                                                                                                                                            
        , [FTE Standard Hours]
                                                                                                                                                                                                                               
        , [FTE Full Time Hours]
                                                                                                                                                                                                                              
        , [Standard Hours - Daily]
                                                                                                                                                                                                                           
        , [Standard Hours - Weekly]
                                                                                                                                                                                                                          
        , [Standard Hours - Pay Period]
                                                                                                                                                                                                                      
        , [Base Wage Rate]
                                                                                                                                                                                                                                   
        , [Base Wage Rate Effective Date]
                                                                                                                                                                                                                    
        , [User Account Name]
                                                                                                                                                                                                                                
        , [User Account Status]
                                                                                                                                                                                                                              
        , [User Password]
                                                                                                                                                                                                                                    
        , [Home Business Structure Level 1 - Organization]
                                                                                                                                                                                                   
        , [Home Business Structure Level 2 - Entity]
                                                                                                                                                                                                         
        , [Home Business Structure Level 3 - Service Line]
                                                                                                                                                                                                   
        , [Home Business Structure Level 4 - Financial Unit]
                                                                                                                                                                                                 
        , [Home Business Structure Level 5 - Fund Group]
                                                                                                                                                                                                     
        , [Home Business Structure Level 6]
                                                                                                                                                                                                                  
        , [Home Business Structure Level 7]
                                                                                                                                                                                                                  
        , [Home Business Structure Level 8]
                                                                                                                                                                                                                  
        , [Home Business Structure Level 9]
                                                                                                                                                                                                                  
        , [Home/Primary Job]
                                                                                                                                                                                                                                 
        , [Home Labor Category Level 1]
                                                                                                                                                                                                                      
        , [Home Labor Category Level 2]
                                                                                                                                                                                                                      
        , [Home Labor Category Level 3]
                                                                                                                                                                                                                      
        , [Home Labor Category Level 4]
                                                                                                                                                                                                                      
        , [Home Labor Category Level 5]
                                                                                                                                                                                                                      
        , [Home Labor Category Level 6]
                                                                                                                                                                                                                      
        , [Home Job and Labor Category Effective Date]
                                                                                                                                                                                                       
        , [Custom Field 1]
                                                                                                                                                                                                                                   
        , [Custom Field 2]
                                                                                                                                                                                                                                   
        , [Custom Field 3]
                                                                                                                                                                                                                                   
        , [Custom Field 4]
                                                                                                                                                                                                                                   
        , [Custom Field 5]
                                                                                                                                                                                                                                   
        , [Custom Field 6]
                                                                                                                                                                                                                                   
        , [Custom Field 7]
                                                                                                                                                                                                                                   
        , [Custom Field 8]
                                                                                                                                                                                                                                   
        , [Custom Field 9]
                                                                                                                                                                                                                                   
        , [Custom Field 10]
                                                                                                                                                                                                                                  
        , [Custom Date 1]
                                                                                                                                                                                                                                    
        , [Custom Date 2]
                                                                                                                                                                                                                                    
        , [Custom Date 3]
                                                                                                                                                                                                                                    
        , [Custom Date 4]
                                                                                                                                                                                                                                    
        , [Custom Date 5]
                                                                                                                                                                                                                                    
        , [Custom Field 11]
                                                                                                                                                                                                                                  
        , [Custom Field 12]
                                                                                                                                                                                                                                  
        , [Custom Field 13]
                                                                                                                                                                                                                                  
        , [Custom Field 14]
                                                                                                                                                                                                                                  
        , [Custom Field 15]
                                                                                                                                                                                                                                  
        , [Custom Field 16]
                                                                                                                                                                                                                                  
        , [Custom Field 17]
                                                                                                                                                                                                                                  
        , [Custom Field 18]
                                                                                                                                                                                                                                  
        , [Custom Field 19]
                                                                                                                                                                                                                                  
        , [Custom Field 20]
                                                                                                                                                                                                                                  
        , [Custom Field 21]
                                                                                                                                                                                                                                  
        , [Custom Field 22]
                                                                                                                                                                                                                                  
        , [Custom Field 23]
                                                                                                                                                                                                                                  
        , [Custom Field 24]
                                                                                                                                                                                                                                  
        , [Custom Field 25]
                                                                                                                                                                                                                                  
        , [Custom Field 26]
                                                                                                                                                                                                                                  
        , [Custom Field 27]
                                                                                                                                                                                                                                  
        , [Custom Field 28]
                                                                                                                                                                                                                                  
        , [Custom Field 29]
                                                                                                                                                                                                                                  
        , [Custom Field 30]
                                                                                                                                                                                                                                  
        , [Additional Fields for CRT lookups]
                                                                                                                                                                                                                
        , [termination_dt]
                                                                                                                                                                                                                                   
        , [action]
                                                                                                                                                                                                                                           
        , [action_dt]
                                                                                                                                                                                                                                        
        , [hash_value]
                                                                                                                                                                                                                                       
        , [Update_DT]
                                                                                                                                                                                                                                        
        )
                                                                                                                                                                                                                                                    
    SELECT
                                                                                                                                                                                                                                                   
        [DEPTID]
                                                                                                                                                                                                                                             
        , [VC_CODE]
                                                                                                                                                                                                                                          
        , [FDM_COMBO_CD]
                                                                                                                                                                                                                                     
        , [COMBOCODE]
                                                                                                                                                                                                                                        
        , [REPORTS_TO]
                                                                                                                                                                                                                                       
        , [MANAGER_EMPLID]
                                                                                                                                                                                                                                   
        , [NON_UKG_MANAGER_FLAG]
                                                                                                                                                                                                                             
        , [position_nbr]
                                                                                                                                                                                                                                     
        , [EMPLID]
                                                                                                                                                                                                                                           
        , [EMPL_RCD]
                                                                                                                                                                                                                                         
        , [jobcode]
                                                                                                                                                                                                                                          
        , [POSITION_DESCR]
                                                                                                                                                                                                                                   
        , [hr_status]
                                                                                                                                                                                                                                        
        , [FTE_SUM]
                                                                                                                                                                                                                                          
        , [fte]
                                                                                                                                                                                                                                              
        , [empl_Status]
                                                                                                                                                                                                                                      
        , [JobGroup]
                                                                                                                                                                                                                                         
        , [FundGroup]
                                                                                                                                                                                                                                        
        , [Person Number]
                                                                                                                                                                                                                                    
        , [First Name]
                                                                                                                                                                                                                                       
        , [Last Name]
                                                                                                                                                                                                                                        
        , [Middle Initial/Name]
                                                                                                                                                                                                                              
        , [Short Name]
                                                                                                                                                                                                                                       
        , [Badge Number]
                                                                                                                                                                                                                                     
        , [Hire Date]
                                                                                                                                                                                                                                        
        , [Birth Date]
                                                                                                                                                                                                                                       
        , [Seniority Date]
                                                                                                                                                                                                                                   
        , [Manager Flag]
                                                                                                                                                                                                                                     
        , [Phone 1]
                                                                                                                                                                                                                                          
        , [Phone 2]
                                                                                                                                                                                                                                          
        , [Email]
                                                                                                                                                                                                                                            
        , [Address]
                                                                                                                                                                                                                                          
        , [City]
                                                                                                                                                                                                                                             
        , [State]
                                                                                                                                                                                                                                            
        , [Postal Code]
                                                                                                                                                                                                                                      
        , [Country]
                                                                                                                                                                                                                                          
        , [Time Zone]
                                                                                                                                                                                                                                        
        , [Employment Status]
                                                                                                                                                                                                                                
        , [Employment Status Effective Date]
                                                                                                                                                                                                                 
        , [Reports to Manager]
                                                                                                                                                                                                                               
        , [Union Code]
                                                                                                                                                                                                                                       
        , [Employee Type]
                                                                                                                                                                                                                                    
        , [Employee Classification]
                                                                                                                                                                                                                          
        , [Pay Frequency]
                                                                                                                                                                                                                                    
        , [Worker Type]
                                                                                                                                                                                                                                      
        , [FTE %]
                                                                                                                                                                                                                                            
        , [FTE Standard Hours]
                                                                                                                                                                                                                               
        , [FTE Full Time Hours]
                                                                                                                                                                                                                              
        , [Standard Hours - Daily]
                                                                                                                                                                                                                           
        , [Standard Hours - Weekly]
                                                                                                                                                                                                                          
        , [Standard Hours - Pay Period]
                                                                                                                                                                                                                      
        , [Base Wage Rate]
                                                                                                                                                                                                                                   
        , [Base Wage Rate Effective Date]
                                                                                                                                                                                                                    
        , [User Account Name]
                                                                                                                                                                                                                                
        , [User Account Status]
                                                                                                                                                                                                                              
        , [User Password]
                                                                                                                                                                                                                                    
        , [Home Business Structure Level 1 - Organization]
                                                                                                                                                                                                   
        , [Home Business Structure Level 2 - Entity]
                                                                                                                                                                                                         
        , [Home Business Structure Level 3 - Service Line]
                                                                                                                                                                                                   
        , [Home Business Structure Level 4 - Financial Unit]
                                                                                                                                                                                                 
        , [Home Business Structure Level 5 - Fund Group]
                                                                                                                                                                                                     
        , [Home Business Structure Level 6]
                                                                                                                                                                                                                  
        , [Home Business Structure Level 7]
                                                                                                                                                                                                                  
        , [Home Business Structure Level 8]
                                                                                                                                                                                                                  
        , [Home Business Structure Level 9]
                                                                                                                                                                                                                  
        , [Home/Primary Job]
                                                                                                                                                                                                                                 
        , [Home Labor Category Level 1]
                                                                                                                                                                                                                      
        , [Home Labor Category Level 2]
                                                                                                                                                                                                                      
        , [Home Labor Category Level 3]
                                                                                                                                                                                                                      
        , [Home Labor Category Level 4]
                                                                                                                                                                                                                      
        , [Home Labor Category Level 5]
                                                                                                                                                                                                                      
        , [Home Labor Category Level 6]
                                                                                                                                                                                                                      
        , [Home Job and Labor Category Effective Date]
                                                                                                                                                                                                       
        , [Custom Field 1]
                                                                                                                                                                                                                                   
        , [Custom Field 2]
                                                                                                                                                                                                                                   
        , [Custom Field 3]
                                                                                                                                                                                                                                   
        , [Custom Field 4]
                                                                                                                                                                                                                                   
        , [Custom Field 5]
                                                                                                                                                                                                                                   
        , [Custom Field 6]
                                                                                                                                                                                                                                   
        , [Custom Field 7]
                                                                                                                                                                                                                                   
        , [Custom Field 8]
                                                                                                                                                                                                                                   
        , [Custom Field 9]
                                                                                                                                                                                                                                   
        , [Custom Field 10]
                                                                                                                                                                                                                                  
        , [Custom Date 1]
                                                                                                                                                                                                                                    
        , [Custom Date 2]
                                                                                                                                                                                                                                    
        , [Custom Date 3]
                                                                                                                                                                                                                                    
        , [Custom Date 4]
                                                                                                                                                                                                                                    
        , [Custom Date 5]
                                                                                                                                                                                                                                    
        , [Custom Field 11]
                                                                                                                                                                                                                                  
        , [Custom Field 12]
                                                                                                                                                                                                                                  
        , [Custom Field 13]
                                                                                                                                                                                                                                  
        , [Custom Field 14]
                                                                                                                                                                                                                                  
        , [Custom Field 15]
                                                                                                                                                                                                                                  
        , [Custom Field 16]
                                                                                                                                                                                                                                  
        , [Custom Field 17]
                                                                                                                                                                                                                                  
        , [Custom Field 18]
                                                                                                                                                                                                                                  
        , [Custom Field 19]
                                                                                                                                                                                                                                  
        , [Custom Field 20]
                                                                                                                                                                                                                                  
        , [Custom Field 21]
                                                                                                                                                                                                                                  
        , [Custom Field 22]
                                                                                                                                                                                                                                  
        , [Custom Field 23]
                                                                                                                                                                                                                                  
        , [Custom Field 24]
                                                                                                                                                                                                                                  
        , [Custom Field 25]
                                                                                                                                                                                                                                  
        , [Custom Field 26]
                                                                                                                                                                                                                                  
        , [Custom Field 27]
                                                                                                                                                                                                                                  
        , [Custom Field 28]
                                                                                                                                                                                                                                  
        , [Custom Field 29]
                                                                                                                                                                                                                                  
        , [Custom Field 30]
                                                                                                                                                                                                                                  
        , [Additional Fields for CRT lookups]
                                                                                                                                                                                                                
        , [termination_dt]
                                                                                                                                                                                                                                   
        , [action]
                                                                                                                                                                                                                                           
        , [action_dt]
                                                                                                                                                                                                                                        
        , [hash_value]
                                                                                                                                                                                                                                       
        , [Update_DT]
                                                                                                                                                                                                                                        
    FROM SourceData S
                                                                                                                                                                                                                                        
    WHERE NOT EXISTS (
                                                                                                                                                                                                                                       
            SELECT 1
                                                                                                                                                                                                                                         
    FROM [dbo].[NON_UKG_MANAGER_HISTORY] T
                                                                                                                                                                                                                   
    WHERE T.[Person Number] = S.[Person Number] AND T.[Manager Flag] = S.[Manager Flag]
                                                                                                                                                                      
        );
                                                                                                                                                                                                                                                   

                                                                                                                                                                                                                                                             
        -- end MERGE
                                                                                                                                                                                                                                         
        ;
                                                                                                                                                                                                                                                    

                                                                                                                                                                                                                                                             
        SET @RecordsInserted = @@ROWCOUNT;
                                                                                                                                                                                                                   
        
                                                                                                                                                                                                                                                     
        -- Update Custom Field 9 to 'T' for all manager records
                                                                                                                                                                                              
        UPDATE [dbo].[NON_UKG_MANAGER_HISTORY]
                                                                                                                                                                                                               
        SET [Custom Field 9] = 'T'
                                                                                                                                                                                                                           
        WHERE [Manager Flag] = 'T';
                                                                                                                                                                                                                          
        
                                                                                                                                                                                                                                                     
        -- Mark rows T.[NOTE] = 'P', not present in the source, will be updated to 'D' as deleted (active only), in SSIS
                                                                                                                                     
        UPDATE T
                                                                                                                                                                                                                                             
        SET T.[Employment Status] = 'T'
                                                                                                                                                                                                                      
        ,T.[Manager Flag]= 'F'
                                                                                                                                                                                                                               
            , T.[Employment Status Effective Date] = FORMAT(GETDATE(), 'yyyy-MM-dd')
                                                                                                                                                                         
            , T.[Update_DT] = GETDATE()
                                                                                                                                                                                                                      
            , T.[NOTE] = 'P'
                                                                                                                                                                                                                                 
        FROM [dbo].[NON_UKG_MANAGER_HISTORY] T
                                                                                                                                                                                                               
        LEFT JOIN (
                                                                                                                                                                                                                                          
            SELECT [Person Number], [Manager Flag]
                                                                                                                                                                                                           
        FROM [dbo].[UKG_EMPLOYEE_DATA_TEMP]
                                                                                                                                                                                                                  
        WHERE [NON_UKG_MANAGER_FLAG] = 'T'
                                                                                                                                                                                                                   
            OR ([Manager Flag] = 'T' AND [Person Number] IN (SELECT emplid
                                                                                                                                                                                   
            FROM STAGE.CTE_EXCLUDE_BYA))
                                                                                                                                                                                                                     
        ) S
                                                                                                                                                                                                                                                  
        ON T.[Person Number] = S.[Person Number]
                                                                                                                                                                                                             
            AND T.[Manager Flag] = S.[Manager Flag]
                                                                                                                                                                                                          
        WHERE S.[Person Number] IS NULL
                                                                                                                                                                                                                      
        AND T.[NOTE] IS NULL;
                                                                                                                                                                                                                                

                                                                                                                                                                                                                                                             
        SET @RecordsDeleted = @@ROWCOUNT;
                                                                                                                                                                                                                    

                                                                                                                                                                                                                                                             
        -- Mark NOTE='P' when source EMPLID matches target EMPLID and NON_UKG_MANAGER_FLAG changes from 'T' to 'F'; excluded rows where NOTE='D'.
                                                                                                            
        UPDATE T
                                                                                                                                                                                                                                             
        SET T.[NOTE] = 'P',
                                                                                                                                                                                                                                  
            T.[Update_DT] = GETDATE()
                                                                                                                                                                                                                        
        FROM [dbo].[NON_UKG_MANAGER_HISTORY] T
                                                                                                                                                                                                               
        JOIN [dbo].[UKG_EMPLOYEE_DATA_TEMP] S
                                                                                                                                                                                                                
        ON T.[EMPLID] = S.[EMPLID]
                                                                                                                                                                                                                           
        WHERE T.[NON_UKG_MANAGER_FLAG] = 'T'
                                                                                                                                                                                                                 
        AND S.[NON_UKG_MANAGER_FLAG] = 'F'
                                                                                                                                                                                                                   
        AND ISNULL(T.[NOTE], '') <> 'D';
                                                                                                                                                                                                                     

                                                                                                                                                                                                                                                             
        COMMIT TRANSACTION;
                                                                                                                                                                                                                                  
        
                                                                                                                                                                                                                                                     
        -- Return summary information
                                                                                                                                                                                                                        
        SELECT
                                                                                                                                                                                                                                               
        'NON_UKG_MANAGER_HISTORY Merge Completed' AS Status,
                                                                                                                                                                                                 
        @RecordsInserted AS RecordsInserted,
                                                                                                                                                                                                                 
        @RecordsDeleted AS RecordsDeleted,
                                                                                                                                                                                                                   
        GETDATE() AS CompletedDateTime;
                                                                                                                                                                                                                      
            
                                                                                                                                                                                                                                                 
        -- Show sample of inserted records for verification
                                                                                                                                                                                                  
        IF @RecordsInserted > 0
                                                                                                                                                                                                                              
        BEGIN
                                                                                                                                                                                                                                                
        PRINT 'Sample of newly inserted records:';
                                                                                                                                                                                                           
        SELECT TOP 10
                                                                                                                                                                                                                                        
            [Person Number],
                                                                                                                                                                                                                                 
            [EMPLID],
                                                                                                                                                                                                                                        
            [First Name] + ' ' + [Last Name] AS Employee_Name,
                                                                                                                                                                                               
            [Manager Flag],
                                                                                                                                                                                                                                  
            [NON_UKG_MANAGER_FLAG],
                                                                                                                                                                                                                          
            [position_nbr],
                                                                                                                                                                                                                                  
            [Update_DT]
                                                                                                                                                                                                                                      
        FROM [dbo].[NON_UKG_MANAGER_HISTORY]
                                                                                                                                                                                                                 
        WHERE [Update_DT] >= DATEADD(MINUTE, -5, GETDATE())
                                                                                                                                                                                                  
        ORDER BY [Update_DT] DESC;
                                                                                                                                                                                                                           
    END
                                                                                                                                                                                                                                                      
        ELSE
                                                                                                                                                                                                                                                 
        BEGIN
                                                                                                                                                                                                                                                
        PRINT 'No new records to insert - all records already exist based on composite key match.';
                                                                                                                                                          
    END
                                                                                                                                                                                                                                                      
          
                                                                                                                                                                                                                                                   
    END TRY
                                                                                                                                                                                                                                                  
    BEGIN CATCH
                                                                                                                                                                                                                                              
        IF @@TRANCOUNT > 0
                                                                                                                                                                                                                                   
            ROLLBACK TRANSACTION;
                                                                                                                                                                                                                            
            
                                                                                                                                                                                                                                                 
        SET @ErrorMessage = ERROR_MESSAGE();
                                                                                                                                                                                                                 
        
                                                                                                                                                                                                                                                     
        SELECT
                                                                                                                                                                                                                                               
        'NON_UKG_MANAGER_HISTORY Merge Failed' AS Status,
                                                                                                                                                                                                    
        @ErrorMessage AS ErrorMessage,
                                                                                                                                                                                                                       
        ERROR_NUMBER() AS ErrorNumber,
                                                                                                                                                                                                                       
        ERROR_SEVERITY() AS ErrorSeverity,
                                                                                                                                                                                                                   
        ERROR_STATE() AS ErrorState,
                                                                                                                                                                                                                         
        GETDATE() AS ErrorDateTime;
                                                                                                                                                                                                                          
            
                                                                                                                                                                                                                                                 
        -- Re-raise the error
                                                                                                                                                                                                                                
        THROW;
                                                                                                                                                                                                                                               
    END CATCH
                                                                                                                                                                                                                                                
END

-- ===== stage.SP_PRE_Check_Update_A =====

                                                                                                                                                                                                                                                             
/*
                                                                                                                                                                                                                                                           
=============================================================================
                                                                                                                                                                                
Stored Procedure: SP_PRE_Check_Update_A
                                                                                                                                                                                                                      
Description: Date-based auto-management for MONITOR_A - enables/disables based on schedule
                                                                                                                                                                   
Version: 1.0
                                                                                                                                                                                                                                                 
Created: 2025-12-25
                                                                                                                                                                                                                                          
Created by: Jim Shih
                                                                                                                                                                                                                                         

                                                                                                                                                                                                                                                             
Logic Explanation:
                                                                                                                                                                                                                                           
0. Date-based Auto-Management for MONITOR_A:
                                                                                                                                                                                                                 
   - If today = Monitor_Start_DT AND Check_Disabled=1 ? Set Check_Disabled=0 (auto-enable)
                                                                                                                                                                   
   - If today = Monitor_End_DT ? Set Check_Disabled=1 (auto-disable)
                                                                                                                                                                                         
1. Provides logging for all date-based status changes
                                                                                                                                                                                                        
2. Updates Update_DT timestamp for audit trail
                                                                                                                                                                                                               

                                                                                                                                                                                                                                                             
Purpose: Pre-execution step to automatically manage MONITOR_A availability based on configured dates
                                                                                                                                                         

                                                                                                                                                                                                                                                             
Execution: EXEC [stage].[SP_PRE_Check_Update_A];
                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
Version History:
                                                                                                                                                                                                                                             
v1.0 (2025-12-25) - Initial creation with date-based auto-enable/disable logic for MONITOR_A
                                                                                                                                                                 
=============================================================================
                                                                                                                                                                                
*/
                                                                                                                                                                                                                                                           

                                                                                                                                                                                                                                                             
CREATE   PROCEDURE [stage].[SP_PRE_Check_Update_A]
                                                                                                                                                                                                           
AS
                                                                                                                                                                                                                                                           
BEGIN
                                                                                                                                                                                                                                                        
    SET NOCOUNT ON;
                                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    DECLARE @Today VARCHAR(10) = FORMAT(GETDATE(), 'yyyy-MM-dd');
                                                                                                                                                                                            
    DECLARE @UpdatesCount INT = 0;
                                                                                                                                                                                                                           

                                                                                                                                                                                                                                                             
    BEGIN TRY
                                                                                                                                                                                                                                                
        PRINT 'SP_PRE_Check_Update_A starting - Today: ' + @Today;
                                                                                                                                                                                           
        
                                                                                                                                                                                                                                                     
        -- Check if today is Monitor_Start_DT and Check_Disabled is 1, then set to 0 (enable)
                                                                                                                                                                
        UPDATE [stage].[UKG_Accrual_Monitor_Schedule]
                                                                                                                                                                                                        
           SET [Check_Disabled] = 0,
                                                                                                                                                                                                                         
               [Update_DT] = GETDATE()
                                                                                                                                                                                                                       
         WHERE [Monitor] = 'MONITOR_A'
                                                                                                                                                                                                                       
        AND [Monitor_Start_DT] = @Today
                                                                                                                                                                                                                      
        AND [Check_Disabled] = 1;
                                                                                                                                                                                                                            
        
                                                                                                                                                                                                                                                     
        IF @@ROWCOUNT > 0
                                                                                                                                                                                                                                    
        BEGIN
                                                                                                                                                                                                                                                
        SET @UpdatesCount = @UpdatesCount + @@ROWCOUNT;
                                                                                                                                                                                                      
        PRINT 'Date Logic: Check_Disabled set to 0 for MONITOR_A (today matches Monitor_Start_DT)';
                                                                                                                                                          
    END
                                                                                                                                                                                                                                                      

                                                                                                                                                                                                                                                             
        -- Check if today is Monitor_End_DT, then set Check_Disabled to 1 (disable)
                                                                                                                                                                          
        UPDATE [stage].[UKG_Accrual_Monitor_Schedule]
                                                                                                                                                                                                        
           SET [Check_Disabled] = 1,
                                                                                                                                                                                                                         
               [Update_DT] = GETDATE()
                                                                                                                                                                                                                       
         WHERE [Monitor] = 'MONITOR_A'
                                                                                                                                                                                                                       
        AND [Monitor_End_DT] = @Today;
                                                                                                                                                                                                                       
        
                                                                                                                                                                                                                                                     
        IF @@ROWCOUNT > 0
                                                                                                                                                                                                                                    
        BEGIN
                                                                                                                                                                                                                                                
        SET @UpdatesCount = @UpdatesCount + @@ROWCOUNT;
                                                                                                                                                                                                      
        PRINT 'Date Logic: Check_Disabled set to 1 for MONITOR_A (today matches Monitor_End_DT)';
                                                                                                                                                            
    END
                                                                                                                                                                                                                                                      

                                                                                                                                                                                                                                                             
        -- Summary
                                                                                                                                                                                                                                           
        IF @UpdatesCount = 0
                                                                                                                                                                                                                                 
            PRINT 'No date-based updates required for MONITOR_A today.';
                                                                                                                                                                                     
        ELSE
                                                                                                                                                                                                                                                 
            PRINT 'Date-based updates completed for MONITOR_A. Total updates: ' + CAST(@UpdatesCount AS VARCHAR(10));
                                                                                                                                        
            
                                                                                                                                                                                                                                                 
        PRINT 'SP_PRE_Check_Update_A completed successfully.';
                                                                                                                                                                                               
        
                                                                                                                                                                                                                                                     
    END TRY
                                                                                                                                                                                                                                                  
    BEGIN CATCH
                                                                                                                                                                                                                                              
        -- Error handling
                                                                                                                                                                                                                                    
        PRINT 'Error occurred in SP_PRE_Check_Update_A: ' + ERROR_MESSAGE();
                                                                                                                                                                                 
        PRINT 'Error Line: ' + CAST(ERROR_LINE() AS VARCHAR(10));
                                                                                                                                                                                            
        THROW;
                                                                                                                                                                                                                                               
    END CATCH
                                                                                                                                                                                                                                                
END

-- ===== stage.SP_PRE_Check_Update_B =====

                                                                                                                                                                                                                                                             
/*
                                                                                                                                                                                                                                                           
=============================================================================
                                                                                                                                                                                
Stored Procedure: SP_PRE_Check_Update_B
                                                                                                                                                                                                                      
Description: Date-based auto-management for MONITOR_B - enables/disables based on schedule
                                                                                                                                                                   
Version: 1.0
                                                                                                                                                                                                                                                 
Created: 2025-12-25
                                                                                                                                                                                                                                          
Created by: Jim Shih
                                                                                                                                                                                                                                         

                                                                                                                                                                                                                                                             
Logic Explanation:
                                                                                                                                                                                                                                           
0. Date-based Auto-Management for MONITOR_B:
                                                                                                                                                                                                                 
   - If today = Monitor_Start_DT AND Check_Disabled=1 ? Set Check_Disabled=0 (auto-enable)
                                                                                                                                                                   
   - If today = Monitor_End_DT ? Set Check_Disabled=1 (auto-disable)
                                                                                                                                                                                         
1. Provides logging for all date-based status changes
                                                                                                                                                                                                        
2. Updates Update_DT timestamp for audit trail
                                                                                                                                                                                                               

                                                                                                                                                                                                                                                             
Purpose: Pre-execution step to automatically manage MONITOR_B availability based on configured dates
                                                                                                                                                         

                                                                                                                                                                                                                                                             
Execution: EXEC [stage].[SP_PRE_Check_Update_B];
                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
Version History:
                                                                                                                                                                                                                                             
v1.0 (2025-12-25) - Initial creation with date-based auto-enable/disable logic for MONITOR_B
                                                                                                                                                                 
=============================================================================
                                                                                                                                                                                
*/
                                                                                                                                                                                                                                                           

                                                                                                                                                                                                                                                             
CREATE   PROCEDURE [stage].[SP_PRE_Check_Update_B]
                                                                                                                                                                                                           
AS
                                                                                                                                                                                                                                                           
BEGIN
                                                                                                                                                                                                                                                        
    SET NOCOUNT ON;
                                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    DECLARE @Today VARCHAR(10) = FORMAT(GETDATE(), 'yyyy-MM-dd');
                                                                                                                                                                                            
    DECLARE @UpdatesCount INT = 0;
                                                                                                                                                                                                                           

                                                                                                                                                                                                                                                             
    BEGIN TRY
                                                                                                                                                                                                                                                
        PRINT 'SP_PRE_Check_Update_B starting - Today: ' + @Today;
                                                                                                                                                                                           
        
                                                                                                                                                                                                                                                     
        -- Check if today is Monitor_Start_DT and Check_Disabled is 1, then set to 0 (enable)
                                                                                                                                                                
        UPDATE [stage].[UKG_Accrual_Monitor_Schedule]
                                                                                                                                                                                                        
           SET [Check_Disabled] = 0,
                                                                                                                                                                                                                         
               [Update_DT] = GETDATE()
                                                                                                                                                                                                                       
         WHERE [Monitor] = 'MONITOR_B'
                                                                                                                                                                                                                       
        AND [Monitor_Start_DT] = @Today
                                                                                                                                                                                                                      
        AND [Check_Disabled] = 1;
                                                                                                                                                                                                                            
        
                                                                                                                                                                                                                                                     
        IF @@ROWCOUNT > 0
                                                                                                                                                                                                                                    
        BEGIN
                                                                                                                                                                                                                                                
        SET @UpdatesCount = @UpdatesCount + @@ROWCOUNT;
                                                                                                                                                                                                      
        PRINT 'Date Logic: Check_Disabled set to 0 for MONITOR_B (today matches Monitor_Start_DT)';
                                                                                                                                                          
    END
                                                                                                                                                                                                                                                      

                                                                                                                                                                                                                                                             
        -- Check if today is Monitor_End_DT, then set Check_Disabled to 1 (disable)
                                                                                                                                                                          
        UPDATE [stage].[UKG_Accrual_Monitor_Schedule]
                                                                                                                                                                                                        
           SET [Check_Disabled] = 1,
                                                                                                                                                                                                                         
               [Update_DT] = GETDATE()
                                                                                                                                                                                                                       
         WHERE [Monitor] = 'MONITOR_B'
                                                                                                                                                                                                                       
        AND [Monitor_End_DT] = @Today;
                                                                                                                                                                                                                       
        
                                                                                                                                                                                                                                                     
        IF @@ROWCOUNT > 0
                                                                                                                                                                                                                                    
        BEGIN
                                                                                                                                                                                                                                                
        SET @UpdatesCount = @UpdatesCount + @@ROWCOUNT;
                                                                                                                                                                                                      
        PRINT 'Date Logic: Check_Disabled set to 1 for MONITOR_B (today matches Monitor_End_DT)';
                                                                                                                                                            
    END
                                                                                                                                                                                                                                                      

                                                                                                                                                                                                                                                             
        -- Summary
                                                                                                                                                                                                                                           
        IF @UpdatesCount = 0
                                                                                                                                                                                                                                 
            PRINT 'No date-based updates required for MONITOR_B today.';
                                                                                                                                                                                     
        ELSE
                                                                                                                                                                                                                                                 
            PRINT 'Date-based updates completed for MONITOR_B. Total updates: ' + CAST(@UpdatesCount AS VARCHAR(10));
                                                                                                                                        
            
                                                                                                                                                                                                                                                 
        PRINT 'SP_PRE_Check_Update_B completed successfully.';
                                                                                                                                                                                               
        
                                                                                                                                                                                                                                                     
    END TRY
                                                                                                                                                                                                                                                  
    BEGIN CATCH
                                                                                                                                                                                                                                              
        -- Error handling
                                                                                                                                                                                                                                    
        PRINT 'Error occurred in SP_PRE_Check_Update_B: ' + ERROR_MESSAGE();
                                                                                                                                                                                 
        PRINT 'Error Line: ' + CAST(ERROR_LINE() AS VARCHAR(10));
                                                                                                                                                                                            
        THROW;
                                                                                                                                                                                                                                               
    END CATCH
                                                                                                                                                                                                                                                
END

-- ===== stage.SP_UKG_Accrual_Update_Final_Step =====

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
/*
                                                                                                                                                                                                                                                           
=============================================================================
                                                                                                                                                                                
Stored Procedure: stage.SP_UKG_Accrual_Update_Final_Step
                                                                                                                                                                                                     
Description: Final step in UKG accrual processing - updates records with 
                                                                                                                                                                                    
             processed flag and pay end date
                                                                                                                                                                                                                 
Version: 1.0
                                                                                                                                                                                                                                                 
Created: 2025-11-04
                                                                                                                                                                                                                                          
Created by: Jim Shih
                                                                                                                                                                                                                                         
Exec Method: exec stage.SP_UKG_Accrual_Update_Final_Step @payenddt='2025-10-25'
                                                                                                                                                                              
=============================================================================
                                                                                                                                                                                
*/
                                                                                                                                                                                                                                                           

                                                                                                                                                                                                                                                             
CREATE   PROCEDURE [stage].[SP_UKG_Accrual_Update_Final_Step]
                                                                                                                                                                                                
    @payenddt DATE -- = '2025-10-25'
                                                                                                                                                                                                                         
-- Pay end date parameter with default value
                                                                                                                                                                                                                 
AS
                                                                                                                                                                                                                                                           
BEGIN
                                                                                                                                                                                                                                                        
    SET NOCOUNT ON;
                                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    BEGIN TRY
                                                                                                                                                                                                                                                
        -- Logic: Update all unprocessed accrual records (where NOTE IS NULL)
                                                                                                                                                                                
        -- Set NOTE to 'P' (Processed) and assign the pay end date
                                                                                                                                                                                           
        UPDATE [dbo].[UKG_UCPATH_ACCRUAL]
                                                                                                                                                                                                                    
           SET NOTE = 'P'                    -- Mark as Processed
                                                                                                                                                                                            
              ,payenddt = @payenddt          -- Set pay end date
                                                                                                                                                                                             
         WHERE NOTE IS NULL;                 -- Only update unprocessed records
                                                                                                                                                                              
        
                                                                                                                                                                                                                                                     
        -- Return number of records updated
                                                                                                                                                                                                                  
        PRINT 'Records updated: ' + CAST(@@ROWCOUNT AS VARCHAR(10));
                                                                                                                                                                                         
        
                                                                                                                                                                                                                                                     
    END TRY
                                                                                                                                                                                                                                                  
    BEGIN CATCH
                                                                                                                                                                                                                                              
        -- Error handling
                                                                                                                                                                                                                                    
        PRINT 'Error occurred: ' + ERROR_MESSAGE();
                                                                                                                                                                                                          
        THROW;
                                                                                                                                                                                                                                               
    END CATCH
                                                                                                                                                                                                                                                
END

-- ===== stage.SP_UKG_BusinessStructure_lookup_BUILD =====
/*
                                                                                                                                                                                                                                                           
================================================================================
                                                                                                                                                                             
STORED PROCEDURE: stage.SP_UKG_BusinessStructure_lookup_BUILD
                                                                                                                                                                                                
VERSION: 2.0
                                                                                                                                                                                                                                                 
CREATED BY: Jim Shih
                                                                                                                                                                                                                                         
CREATED DATE: December 18, 2025
                                                                                                                                                                                                                              
PURPOSE: Build UKG Business Structure lookup table for QA purposes
                                                                                                                                                                                           
         Creates hierarchical parent path strings from business structure data
                                                                                                                                                                               
DEPENDENCIES: HealthTime.hts.UKG_BusinessStructure table
                                                                                                                                                                                                     
OUTPUTS: stage.UKG_BusinessStructure_lookup table
                                                                                                                                                                                                            
NOTES: Excludes 'Non-Health' organization records
                                                                                                                                                                                                            
       Parent Path format: Organization/EntityTitle/ServiceLineTitle/FinancialUnit/FundGroup
                                                                                                                                                                 
EXECUTION: EXEC stage.SP_UKG_BusinessStructure_lookup_BUILD
                                                                                                                                                                                                  
           -- No parameters required, procedure handles all table creation internally
                                                                                                                                                                        
================================================================================
                                                                                                                                                                             
*/
                                                                                                                                                                                                                                                           

                                                                                                                                                                                                                                                             
CREATE   PROCEDURE stage.SP_UKG_BusinessStructure_lookup_BUILD
                                                                                                                                                                                               
AS
                                                                                                                                                                                                                                                           
BEGIN
                                                                                                                                                                                                                                                        
    SET NOCOUNT ON;
                                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    -- QA Step 1: Drop existing lookup table if present to ensure clean rebuild
                                                                                                                                                                              
    -- This prevents data integrity issues and ensures fresh data load
                                                                                                                                                                                       
    IF OBJECT_ID('stage.UKG_BusinessStructure_lookup', 'U') IS NOT NULL
                                                                                                                                                                                      
    BEGIN
                                                                                                                                                                                                                                                    
        DROP TABLE stage.UKG_BusinessStructure_lookup;
                                                                                                                                                                                                       
        PRINT 'Existing stage.UKG_BusinessStructure_lookup table dropped for rebuild.';
                                                                                                                                                                      
    END
                                                                                                                                                                                                                                                      

                                                                                                                                                                                                                                                             
    -- QA Step 2: Create the hierarchical lookup table
                                                                                                                                                                                                       
    -- Concatenates business structure hierarchy into a single parent path string
                                                                                                                                                                            
    -- Format: Organization/EntityTitle/ServiceLineTitle/FinancialUnit/FundGroup
                                                                                                                                                                             
    SELECT
                                                                                                                                                                                                                                                   
        [Organization] + '/' +
                                                                                                                                                                                                                               
          [EntityTitle] + '/' +
                                                                                                                                                                                                                              
          [ServiceLineTitle] + '/' +
                                                                                                                                                                                                                         
          [FinancialUnit] + '/' +
                                                                                                                                                                                                                            
          [FundGroup] AS [Parent Path]
                                                                                                                                                                                                                       
    INTO stage.UKG_BusinessStructure_lookup
                                                                                                                                                                                                                  
    FROM [HealthTime].[hts].[UKG_BusinessStructure]
                                                                                                                                                                                                          
    WHERE Organization != 'Non-Health';
                                                                                                                                                                                                                      
    -- QA Filter: Exclude Non-Health organizations per business requirements
                                                                                                                                                                                 

                                                                                                                                                                                                                                                             
    -- QA Step 3: Verify table creation and provide feedback
                                                                                                                                                                                                 
    DECLARE @RecordCount INT = @@ROWCOUNT;
                                                                                                                                                                                                                   
    PRINT 'Table stage.UKG_BusinessStructure_lookup has been successfully created.';
                                                                                                                                                                         
    PRINT 'Records processed: ' + CAST(@RecordCount AS VARCHAR(10));
                                                                                                                                                                                         
    PRINT 'QA Note: Non-Health organization records excluded as per business rules.';
                                                                                                                                                                        
END

-- ===== stage.SP_UKG_EMPL_Business_Structure_Lookup_Build =====

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
CREATE           PROCEDURE [stage].[SP_UKG_EMPL_Business_Structure_Lookup_Build]
                                                                                                                                                                             
AS
                                                                                                                                                                                                                                                           
/*
                                                                                                                                                                                                                                                           
    File: SP_UKG_EMPL_Business_Structure_Lookup_Build.sql
                                                                                                                                                                                                    
    Version: 2025-09-06
                                                                                                                                                                                                                                      

                                                                                                                                                                                                                                                             
    Description:
                                                                                                                                                                                                                                             
    This stored procedure [stage].[SP_UKG_EMPL_Business_Structure_Lookup_Build] is designed to create or refresh the lookup table [stage].[UKG_EMPL_Business_Structure] in the HealthTime database.
                                                          
    - Drops the existing lookup table if it exists.
                                                                                                                                                                                                          
    - Creates a new table by selecting relevant columns from [dbo].[UKG_EMPLOYEE_DATA], including a concatenated business structure path.
                                                                                                                    
    - Excludes records where the organization is 'Non-Health'.
                                                                                                                                                                                               
    - Adds a Loaded_DT column to record the load timestamp for each row.
                                                                                                                                                                                     
    - Prints a confirmation message upon successful creation.
                                                                                                                                                                                                

                                                                                                                                                                                                                                                             
    Usage:
                                                                                                                                                                                                                                                   
    EXEC [stage].[SP_UKG_EMPL_Business_Structure_Lookup_Build]
                                                                                                                                                                                               
*/
                                                                                                                                                                                                                                                           

                                                                                                                                                                                                                                                             
-- exec [stage].[SP_UKG_EMPL_Business_Structure_Lookup_Build]
                                                                                                                                                                                                
BEGIN
                                                                                                                                                                                                                                                        
    SET NOCOUNT ON;
                                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    -- Drop the table if it exists
                                                                                                                                                                                                                           
    IF OBJECT_ID('stage.UKG_EMPL_Business_Structure', 'U') IS NOT NULL
                                                                                                                                                                                       
    BEGIN
                                                                                                                                                                                                                                                    
        DROP TABLE stage.UKG_EMPL_Business_Structure;
                                                                                                                                                                                                        
    END
                                                                                                                                                                                                                                                      

                                                                                                                                                                                                                                                             
    -- Create the lookup table
                                                                                                                                                                                                                               
    SELECT --top 10
                                                                                                                                                                                                                                          
        [Person Number]
                                                                                                                                                                                                                                      
          , [First Name]
                                                                                                                                                                                                                                     
          , [Last Name]
                                                                                                                                                                                                                                      
    	  , [Home Business Structure Level 5 - Fund Group] as FundGroup
                                                                                                                                                                                         
          , [Home Business Structure Level 1 - Organization] + '/' +
                                                                                                                                                                                         
          [Home Business Structure Level 2 - Entity] + '/' +
                                                                                                                                                                                                 
          [Home Business Structure Level 3 - Service Line] + '/' +
                                                                                                                                                                                           
          [Home Business Structure Level 4 - Financial Unit] + '/' +
                                                                                                                                                                                         
          [Home Business Structure Level 5 - Fund Group] AS [Parent Path]
                                                                                                                                                                                    
    INTO stage.UKG_EMPL_Business_Structure
                                                                                                                                                                                                                   

                                                                                                                                                                                                                                                             
    FROM [dbo].[UKG_EMPLOYEE_DATA]
                                                                                                                                                                                                                           
    WHERE [Home Business Structure Level 1 - Organization] != 'Non-Health';
                                                                                                                                                                                  

                                                                                                                                                                                                                                                             
    -- Add Loaded_DT column and update with current date
                                                                                                                                                                                                     
    ALTER TABLE stage.UKG_EMPL_Business_Structure ADD Loaded_DT DATETIME;
                                                                                                                                                                                    
    UPDATE stage.UKG_EMPL_Business_Structure SET Loaded_DT = GETDATE();
                                                                                                                                                                                      

                                                                                                                                                                                                                                                             
    PRINT 'Table stage.UKG_EMPL_Business_Structure has been successfully created.';
                                                                                                                                                                          
END

-- ===== stage.SP_UKG_EMPL_DATA_CleanUp-Step1 =====

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
/***************************************
                                                                                                                                                                                                                     
* Stored Procedure: [stage].[* EXEC [stage].[SP_UKG_EMPL_DATA_CleanUp-Step1]]
                                                                                                                                                                                
* Purpose: Clean up duplicate employee records in UKG_EMPLOYEE_DATA table
                                                                                                                                                                                    
* 
                                                                                                                                                                                                                                                           
* Logic:
                                                                                                                                                                                                                                                     
* 1. Identifies employees with duplicate records (same EMPLID appearing multiple times)
                                                                                                                                                                      
* 2. For duplicate employees, removes records where FTE = 0 (zero FTE positions)
                                                                                                                                                                             
* 3. Keeps records with non-zero FTE values as these represent active positions
                                                                                                                                                                              
* 4. Uses transaction control to ensure data integrity
                                                                                                                                                                                                       
* 5. Provides detailed logging of cleanup operations
                                                                                                                                                                                                         
* 
                                                                                                                                                                                                                                                           
* Example execution:
                                                                                                                                                                                                                                         
* EXEC [stage].[* EXEC [stage].[SP_UKG_EMPL_DATA_CleanUp-Step1]]
                                                                                                                                                                                             
* 
                                                                                                                                                                                                                                                           
* Created: 9/5/2025
                                                                                                                                                                                                                                          
* Modified: 9/5/2025 - Added comprehensive logging and error handling
                                                                                                                                                                                        
* Modified: 12/02/2025 Jim Shih - Replace [dbo].[UKG_EMPLOYEE_DATA] with [dbo].[UKG_EMPLOYEE_DATA_TEMP]
                                                                                                                                                      
******************************************/
                                                                                                                                                                                                                  

                                                                                                                                                                                                                                                             
CREATE       PROCEDURE [stage].[SP_UKG_EMPL_DATA_CleanUp-Step1]
                                                                                                                                                                                              
AS
                                                                                                                                                                                                                                                           
BEGIN
                                                                                                                                                                                                                                                        
    SET NOCOUNT ON;
                                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    DECLARE @RowsDeleted INT = 0;
                                                                                                                                                                                                                            
    DECLARE @ErrorMessage NVARCHAR(4000);
                                                                                                                                                                                                                    

                                                                                                                                                                                                                                                             
    BEGIN TRY
                                                                                                                                                                                                                                                
        BEGIN TRANSACTION;
                                                                                                                                                                                                                                   
        
                                                                                                                                                                                                                                                     
        PRINT 'Starting cleanup of duplicate employee records with FTE = 0...';
                                                                                                                                                                              
        
                                                                                                                                                                                                                                                     
        WITH
                                                                                                                                                                                                                                                 
        duplicate_employees
                                                                                                                                                                                                                                  
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT emplid, count(emplid) as emp_count
                                                                                                                                                                                                        
            FROM [dbo].[UKG_EMPLOYEE_DATA_TEMP]
                                                                                                                                                                                                              
            GROUP BY emplid
                                                                                                                                                                                                                                  
            HAVING count(emplid) > 1
                                                                                                                                                                                                                         
        ),
                                                                                                                                                                                                                                                   
        records_to_delete
                                                                                                                                                                                                                                    
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                empl.emplid,
                                                                                                                                                                                                                                 
                empl.position_nbr,
                                                                                                                                                                                                                           
                empl.FTE
                                                                                                                                                                                                                                     
            FROM duplicate_employees de
                                                                                                                                                                                                                      
                JOIN [dbo].[UKG_EMPLOYEE_DATA_TEMP] empl
                                                                                                                                                                                                     
                ON empl.emplid = de.emplid
                                                                                                                                                                                                                   
            WHERE empl.FTE = 0
                                                                                                                                                                                                                               
        )
                                                                                                                                                                                                                                                    
            DELETE ukg_empl
                                                                                                                                                                                                                                  
            FROM [dbo].[UKG_EMPLOYEE_DATA_TEMP] ukg_empl
                                                                                                                                                                                                     
        JOIN records_to_delete rtd
                                                                                                                                                                                                                           
        ON ukg_empl.emplid = rtd.emplid
                                                                                                                                                                                                                      
            AND ukg_empl.position_nbr = rtd.position_nbr;
                                                                                                                                                                                                    

                                                                                                                                                                                                                                                             
        SET @RowsDeleted = @@ROWCOUNT;
                                                                                                                                                                                                                       

                                                                                                                                                                                                                                                             
        PRINT 'Duplicate records with FTE = 0 deleted: ' + CAST(@RowsDeleted AS VARCHAR(10));
                                                                                                                                                                
        
                                                                                                                                                                                                                                                     
        COMMIT TRANSACTION;
                                                                                                                                                                                                                                  
        
                                                                                                                                                                                                                                                     
        PRINT 'Cleanup operations completed successfully.';
                                                                                                                                                                                                  
        PRINT 'Total records deleted: ' + CAST(@RowsDeleted AS VARCHAR(10));
                                                                                                                                                                                 
        
                                                                                                                                                                                                                                                     
    END TRY
                                                                                                                                                                                                                                                  
    BEGIN CATCH
                                                                                                                                                                                                                                              
        ROLLBACK TRANSACTION;
                                                                                                                                                                                                                                
        
                                                                                                                                                                                                                                                     
        SET @ErrorMessage = ERROR_MESSAGE();
                                                                                                                                                                                                                 
        PRINT 'Error occurred during cleanup operation: ' + @ErrorMessage;
                                                                                                                                                                                   
        PRINT 'Transaction has been rolled back.';
                                                                                                                                                                                                           
        
                                                                                                                                                                                                                                                     
        -- Re-throw the error
                                                                                                                                                                                                                                
        THROW;
                                                                                                                                                                                                                                               
    END CATCH
                                                                                                                                                                                                                                                
END

-- ===== stage.SP_UKG_EMPL_DATA_Update_imgr-Step3 =====

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
/***************************************
                                                                                                                                                                                                                     
* Stored Procedure: [stage].[SP_UKG_EMPL_DATA_Update_imgr-Step3]
                                                                                                                                                                                             
* Purpose: Update "Reports to Manager" field in UKG_EMPLOYEE_DATA based on comprehensive inactive manager hierarchy analysis
                                                                                                                                 
* 
                                                                                                                                                                                                                                                           
* Performance Optimizations (12/03/2025):
                                                                                                                                                                                                                    
* - Added comprehensive indexing strategy for #InactiveManagerHierarchy temporary table:
                                                                                                                                                                     
*   * Clustered Index: IX_InactiveManagerHierarchy_Position (POSITION_NBR_To_Check) - Primary JOIN optimization
                                                                                                                                              
*   * Nonclustered Index: IX_InactiveManagerHierarchy_Manager (MANAGER_POSITION_NBR) - Manager lookup optimization
                                                                                                                                           
*   * Nonclustered Index: IX_InactiveManagerHierarchy_Level (Hierarchy_Level) - Level filtering optimization
                                                                                                                                                 
*   * Covering Index: IX_InactiveManagerHierarchy_Covering (MANAGER_POSITION_NBR) INCLUDE (POSN_LEVEL, Hierarchy_Level) - Verification query optimization
                                                                                                    
* - Total: 4 performance indexes for optimal UPDATE and verification operations
                                                                                                                                                                              
* - Optimized execution plans for large-scale manager relationship updates
                                                                                                                                                                                   
* 
                                                                                                                                                                                                                                                           
* Logic Overview:
                                                                                                                                                                                                                                            
* 1. Creates temporary table from inactive manager hierarchy lookup data with comprehensive multi-level tracing
                                                                                                                                              
* 2. Uses advanced UNION logic to handle five hierarchy scenarios:
                                                                                                                                                                                           
*    - Level 0: Direct manager replacement (To_Trace_Up_1 = 'no')
                                                                                                                                                                                            
*    - Level 1: One-level trace-up (To_Trace_Up_1 = 'yes', To_Trace_Up_2 = 'no')
                                                                                                                                                                             
*    - Level 2: Two-level trace-up (To_Trace_Up_1-2 = 'yes', To_Trace_Up_3 = 'no')
                                                                                                                                                                           
*    - Level 3: Three-level trace-up (To_Trace_Up_1-3 = 'yes', To_Trace_Up_4 = 'no')
                                                                                                                                                                         
*    - Level 4: Four-level trace-up (To_Trace_Up_1-4 = 'yes')
                                                                                                                                                                                                
* 3. Updates UKG_EMPLOYEE_DATA with correct active manager information from any hierarchy level
                                                                                                                                                              
* 4. Provides comprehensive logging, validation, and error handling throughout the process
                                                                                                                                                                   
* 
                                                                                                                                                                                                                                                           
* Business Logic:
                                                                                                                                                                                                                                            
* - Filters for manager positions at LEVEL5-LEVEL9 (executive/senior management levels)
                                                                                                                                                                      
* - Handles complex scenarios where multiple management levels are inactive
                                                                                                                                                                                  
* - Traces up organizational hierarchy up to 4 levels to find active managers
                                                                                                                                                                                
* - Ensures data integrity through transaction control and comprehensive validation checks
                                                                                                                                                                   
* - Provides detailed before/after verification of updated records
                                                                                                                                                                                           
* 
                                                                                                                                                                                                                                                           
* Multi-Level Hierarchy Processing:
                                                                                                                                                                                                                          
* - MANAGER_POSITION_NBR: Direct manager (Level 0)
                                                                                                                                                                                                           
* - MANAGER_POSITION_NBR_L1: First level trace-up manager (Level 1)
                                                                                                                                                                                          
* - MANAGER_POSITION_NBR_L2: Second level trace-up manager (Level 2)
                                                                                                                                                                                         
* - MANAGER_POSITION_NBR_L3: Third level trace-up manager (Level 3)
                                                                                                                                                                                          
* - MANAGER_POSITION_NBR_L4: Fourth level trace-up manager (Level 4)
                                                                                                                                                                                         
* 
                                                                                                                                                                                                                                                           
* Transaction Control:
                                                                                                                                                                                                                                       
* - Uses BEGIN/COMMIT/ROLLBACK for comprehensive data integrity
                                                                                                                                                                                              
* - Validates expected vs actual record counts with detailed error reporting
                                                                                                                                                                                 
* - Comprehensive error handling with detailed logging and rollback capabilities
                                                                                                                                                                             
* - Temporary table cleanup to ensure no resource leaks
                                                                                                                                                                                                      
* 
                                                                                                                                                                                                                                                           
* Dependencies:
                                                                                                                                                                                                                                              
* - [stage].[UKG_EMPL_Inactive_Manager_Hierarchy] - Multi-level hierarchy analysis lookup table
                                                                                                                                                              
* - [dbo].[UKG_EMPLOYEE_DATA_TEMP] - Target table for manager relationship updates
                                                                                                                                                                           
* 
                                                                                                                                                                                                                                                           
* Example execution:
                                                                                                                                                                                                                                         
* EXEC [stage].[SP_UKG_EMPL_DATA_Update_imgr-Step3]
                                                                                                                                                                                                          
* 
                                                                                                                                                                                                                                                           
* Created: 09/05/2025 Jim Shih
                                                                                                                                                                                                                               
* Modified: 09/05/2025 Jim Shih - Added comprehensive multi-level hierarchy processing and documentation
                                                                                                                                                     
* Performance Optimizations (09/17/2025):
                                                                                                                                                                                                                    
* - Changed UNION to UNION ALL to eliminate duplicate elimination overhead
                                                                                                                                                                                   
* - Added clustered index on temp table for faster joins
                                                                                                                                                                                                     
* - Consolidated count and preview queries into single operation
                                                                                                                                                                                             
* - Added Hierarchy_Level column for better performance tracking
                                                                                                                                                                                             
* - Optimized verification queries to reduce redundant table scans
                                                                                                                                                                                           
* - Added temp table cleanup in error handling to prevent resource leaks
                                                                                                                                                                                     
* - Streamlined transaction control and error handling logic
                                                                                                                                                                                                 
* Modified: 12/02/2025 Jim Shih - Replace [dbo].[UKG_EMPLOYEE_DATA] with [dbo].[UKG_EMPLOYEE_DATA_TEMP]
                                                                                                                                                      
* Modified: 12/03/2025 Jim Shih - Added comprehensive indexing strategy with 4 performance indexes for optimal UPDATE operations
                                                                                                                             
******************************************/
                                                                                                                                                                                                                  

                                                                                                                                                                                                                                                             
CREATE   PROCEDURE [stage].[SP_UKG_EMPL_DATA_Update_imgr-Step3]
                                                                                                                                                                                              
AS
                                                                                                                                                                                                                                                           
BEGIN
                                                                                                                                                                                                                                                        
    SET NOCOUNT ON;
                                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    /****** Update UKG_EMPLOYEE_DATA based on Inactive Manager Hierarchy Analysis ******/
                                                                                                                                                                    

                                                                                                                                                                                                                                                             
    BEGIN TRANSACTION;
                                                                                                                                                                                                                                       

                                                                                                                                                                                                                                                             
    BEGIN TRY
                                                                                                                                                                                                                                                
    -- Create a temp table to store the hierarchy data for reuse with optimized structure
                                                                                                                                                                    
    IF OBJECT_ID('tempdb..#InactiveManagerHierarchy', 'U') IS NOT NULL 
                                                                                                                                                                                      
        DROP TABLE #InactiveManagerHierarchy;
                                                                                                                                                                                                                

                                                                                                                                                                                                                                                             
--Performance Optimizations (09/17/2025):
                                                                                                                                                                                                                    
    -- Optimized CTE with consolidated UNION logic and direct temp table creation
                                                                                                                                                                            
    WITH
                                                                                                                                                                                                                                                     
        InactiveManagerHierarchy
                                                                                                                                                                                                                             
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            -- Level 0: Direct manager replacement
                                                                                                                                                                                                           
                                                                SELECT
                                                                                                                                                                                       
                    H.POSITION_NBR_To_Check,
                                                                                                                                                                                                                 
                    H.MANAGER_POSITION_NBR,
                                                                                                                                                                                                                  
                    H.POSN_LEVEL,
                                                                                                                                                                                                                            
                    0 as Hierarchy_Level
                                                                                                                                                                                                                     
                FROM [stage].[UKG_EMPL_Inactive_Manager_Hierarchy] H
                                                                                                                                                                                         
                WHERE H.POSN_LEVEL IN ('LEVEL5', 'LEVEL6', 'LEVEL7', 'LEVEL8', 'LEVEL9')
                                                                                                                                                                     
                    AND H.To_Trace_Up_1 = 'no'
                                                                                                                                                                                                               

                                                                                                                                                                                                                                                             
            UNION ALL
                                                                                                                                                                                                                                        

                                                                                                                                                                                                                                                             
                -- Level 1: One-level trace-up
                                                                                                                                                                                                               
                SELECT
                                                                                                                                                                                                                                       
                    H.POSITION_NBR_To_Check,
                                                                                                                                                                                                                 
                    H.MANAGER_POSITION_NBR_L1,
                                                                                                                                                                                                               
                    H.MANAGER_POSN_LEVEL_L1,
                                                                                                                                                                                                                 
                    1 as Hierarchy_Level
                                                                                                                                                                                                                     
                FROM [stage].[UKG_EMPL_Inactive_Manager_Hierarchy] H
                                                                                                                                                                                         
                WHERE H.MANAGER_POSN_LEVEL_L1 IN ('LEVEL5', 'LEVEL6', 'LEVEL7', 'LEVEL8', 'LEVEL9')
                                                                                                                                                          
                    AND H.To_Trace_Up_1 = 'yes'
                                                                                                                                                                                                              
                    AND H.To_Trace_Up_2 = 'no'
                                                                                                                                                                                                               
                    AND H.NOTE_L1 IS NULL
                                                                                                                                                                                                                    

                                                                                                                                                                                                                                                             
            UNION ALL
                                                                                                                                                                                                                                        

                                                                                                                                                                                                                                                             
                -- Level 2: Two-level trace-up
                                                                                                                                                                                                               
                SELECT
                                                                                                                                                                                                                                       
                    H.POSITION_NBR_To_Check,
                                                                                                                                                                                                                 
                    H.MANAGER_POSITION_NBR_L2,
                                                                                                                                                                                                               
                    H.MANAGER_POSN_LEVEL_L2,
                                                                                                                                                                                                                 
                    2 as Hierarchy_Level
                                                                                                                                                                                                                     
                FROM [stage].[UKG_EMPL_Inactive_Manager_Hierarchy] H
                                                                                                                                                                                         
                WHERE H.MANAGER_POSN_LEVEL_L2 IN ('LEVEL5', 'LEVEL6', 'LEVEL7', 'LEVEL8', 'LEVEL9')
                                                                                                                                                          
                    AND H.To_Trace_Up_1 = 'yes'
                                                                                                                                                                                                              
                    AND H.To_Trace_Up_2 = 'yes'
                                                                                                                                                                                                              
                    AND H.To_Trace_Up_3 = 'no'
                                                                                                                                                                                                               
                    AND H.NOTE_L2 IS NULL
                                                                                                                                                                                                                    

                                                                                                                                                                                                                                                             
            UNION ALL
                                                                                                                                                                                                                                        

                                                                                                                                                                                                                                                             
                -- Level 3: Three-level trace-up
                                                                                                                                                                                                             
                SELECT
                                                                                                                                                                                                                                       
                    H.POSITION_NBR_To_Check,
                                                                                                                                                                                                                 
                    H.MANAGER_POSITION_NBR_L3,
                                                                                                                                                                                                               
                    H.MANAGER_POSN_LEVEL_L3,
                                                                                                                                                                                                                 
                    3 as Hierarchy_Level
                                                                                                                                                                                                                     
                FROM [stage].[UKG_EMPL_Inactive_Manager_Hierarchy] H
                                                                                                                                                                                         
                WHERE H.MANAGER_POSN_LEVEL_L3 IN ('LEVEL5', 'LEVEL6', 'LEVEL7', 'LEVEL8', 'LEVEL9')
                                                                                                                                                          
                    AND H.To_Trace_Up_1 = 'yes'
                                                                                                                                                                                                              
                    AND H.To_Trace_Up_2 = 'yes'
                                                                                                                                                                                                              
                    AND H.To_Trace_Up_3 = 'yes'
                                                                                                                                                                                                              
                    AND H.To_Trace_Up_4 = 'no'
                                                                                                                                                                                                               
                    AND H.NOTE_L3 IS NULL
                                                                                                                                                                                                                    

                                                                                                                                                                                                                                                             
            UNION ALL
                                                                                                                                                                                                                                        

                                                                                                                                                                                                                                                             
                -- Level 4: Four-level trace-up
                                                                                                                                                                                                              
                SELECT
                                                                                                                                                                                                                                       
                    H.POSITION_NBR_To_Check,
                                                                                                                                                                                                                 
                    H.MANAGER_POSITION_NBR_L4,
                                                                                                                                                                                                               
                    H.MANAGER_POSN_LEVEL_L4,
                                                                                                                                                                                                                 
                    4 as Hierarchy_Level
                                                                                                                                                                                                                     
                FROM [stage].[UKG_EMPL_Inactive_Manager_Hierarchy] H
                                                                                                                                                                                         
                WHERE H.MANAGER_POSN_LEVEL_L4 IN ('LEVEL5', 'LEVEL6', 'LEVEL7', 'LEVEL8', 'LEVEL9')
                                                                                                                                                          
                    AND H.To_Trace_Up_1 = 'yes'
                                                                                                                                                                                                              
                    AND H.To_Trace_Up_2 = 'yes'
                                                                                                                                                                                                              
                    AND H.To_Trace_Up_3 = 'yes'
                                                                                                                                                                                                              
                    AND H.To_Trace_Up_4 = 'yes'
                                                                                                                                                                                                              
                    AND H.NOTE_L4 IS NULL
                                                                                                                                                                                                                    
        )
                                                                                                                                                                                                                                                    
    SELECT
                                                                                                                                                                                                                                                   
        POSITION_NBR_To_Check,
                                                                                                                                                                                                                               
        MANAGER_POSITION_NBR,
                                                                                                                                                                                                                                
        POSN_LEVEL,
                                                                                                                                                                                                                                          
        Hierarchy_Level
                                                                                                                                                                                                                                      
    INTO #InactiveManagerHierarchy
                                                                                                                                                                                                                           
    FROM InactiveManagerHierarchy;
                                                                                                                                                                                                                           

                                                                                                                                                                                                                                                             
    -- Add comprehensive indexing strategy for optimal performance
                                                                                                                                                                                           
    CREATE CLUSTERED INDEX IX_InactiveManagerHierarchy_Position ON #InactiveManagerHierarchy (POSITION_NBR_To_Check);
                                                                                                                                        
    CREATE NONCLUSTERED INDEX IX_InactiveManagerHierarchy_Manager ON #InactiveManagerHierarchy (MANAGER_POSITION_NBR);
                                                                                                                                       
    CREATE NONCLUSTERED INDEX IX_InactiveManagerHierarchy_Level ON #InactiveManagerHierarchy (Hierarchy_Level);
                                                                                                                                              
    CREATE NONCLUSTERED INDEX IX_InactiveManagerHierarchy_Covering ON #InactiveManagerHierarchy (MANAGER_POSITION_NBR) 
                                                                                                                                      
        INCLUDE (POSN_LEVEL, Hierarchy_Level);
                                                                                                                                                                                                               

                                                                                                                                                                                                                                                             
    -- Optimized: Single query to get count and show preview of records to be updated
                                                                                                                                                                        
    DECLARE @RecordsToUpdate INT = 0;
                                                                                                                                                                                                                        

                                                                                                                                                                                                                                                             
    -- Get count separately (variable assignment must be in its own SELECT)
                                                                                                                                                                                  
    SELECT @RecordsToUpdate = COUNT(*)
                                                                                                                                                                                                                       
    FROM [dbo].[UKG_EMPLOYEE_DATA_TEMP] empl
                                                                                                                                                                                                                 
        INNER JOIN #InactiveManagerHierarchy CTE
                                                                                                                                                                                                             
        ON CTE.POSITION_NBR_To_Check = empl.[Reports to Manager];
                                                                                                                                                                                            

                                                                                                                                                                                                                                                             
    -- Preview records to be updated (separate data-retrieval statement)
                                                                                                                                                                                     
    SELECT DISTINCT
                                                                                                                                                                                                                                          
        'Records to be updated:' AS Info,
                                                                                                                                                                                                                    
        empl.[Reports to Manager] AS Current_Reports_To,
                                                                                                                                                                                                     
        CTE.MANAGER_POSITION_NBR AS New_Reports_To,
                                                                                                                                                                                                          
        CTE.POSN_LEVEL,
                                                                                                                                                                                                                                      
        CTE.Hierarchy_Level
                                                                                                                                                                                                                                  
    FROM [dbo].[UKG_EMPLOYEE_DATA_TEMP] empl
                                                                                                                                                                                                                 
        INNER JOIN #InactiveManagerHierarchy CTE
                                                                                                                                                                                                             
        ON CTE.POSITION_NBR_To_Check = empl.[Reports to Manager]
                                                                                                                                                                                             
    ORDER BY Current_Reports_To;
                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
    PRINT 'Number of records to update: ' + CAST(@RecordsToUpdate AS VARCHAR(10));
                                                                                                                                                                           
    
                                                                                                                                                                                                                                                         
    -- Perform the optimized update with single join
                                                                                                                                                                                                         
    UPDATE empl
                                                                                                                                                                                                                                              
    SET 
                                                                                                                                                                                                                                                     
        [Reports to Manager] = CTE.MANAGER_POSITION_NBR
                                                                                                                                                                                                      
    FROM [dbo].[UKG_EMPLOYEE_DATA_TEMP] empl
                                                                                                                                                                                                                 
        INNER JOIN #InactiveManagerHierarchy CTE
                                                                                                                                                                                                             
        ON CTE.POSITION_NBR_To_Check = empl.[Reports to Manager];
                                                                                                                                                                                            
    
                                                                                                                                                                                                                                                         
    -- Verify the update count
                                                                                                                                                                                                                               
    DECLARE @RecordsUpdated INT = @@ROWCOUNT;
                                                                                                                                                                                                                
    PRINT 'Number of records updated: ' + CAST(@RecordsUpdated AS VARCHAR(10));
                                                                                                                                                                              
    
                                                                                                                                                                                                                                                         
    -- Optimized validation using simple comparison
                                                                                                                                                                                                          
    IF @RecordsUpdated <> @RecordsToUpdate
                                                                                                                                                                                                                   
    BEGIN
                                                                                                                                                                                                                                                    
        PRINT 'ERROR: Mismatch in expected vs actual updated records!';
                                                                                                                                                                                      
        PRINT 'Expected: ' + CAST(@RecordsToUpdate AS VARCHAR(10));
                                                                                                                                                                                          
        PRINT 'Actual: ' + CAST(@RecordsUpdated AS VARCHAR(10));
                                                                                                                                                                                             
        ROLLBACK TRANSACTION;
                                                                                                                                                                                                                                
        RETURN;
                                                                                                                                                                                                                                              
    END
                                                                                                                                                                                                                                                      
    
                                                                                                                                                                                                                                                         
    -- Optimized verification: Show sample of updated records
                                                                                                                                                                                                
    PRINT 'Updated records verification (sample):';
                                                                                                                                                                                                          
    SELECT TOP 5
                                                                                                                                                                                                                                             
        empl.[Reports to Manager] AS Updated_Reports_To,
                                                                                                                                                                                                     
        empl.[EMPLID] AS Employee_ID,
                                                                                                                                                                                                                        
        empl.[First Name] + ', ' + empl.[Last Name] AS Employee_Name,
                                                                                                                                                                                        
        CTE.Hierarchy_Level
                                                                                                                                                                                                                                  
    FROM [dbo].[UKG_EMPLOYEE_DATA_TEMP] empl
                                                                                                                                                                                                                 
        INNER JOIN #InactiveManagerHierarchy CTE
                                                                                                                                                                                                             
        ON CTE.MANAGER_POSITION_NBR = empl.[Reports to Manager]
                                                                                                                                                                                              
    ORDER BY CTE.Hierarchy_Level DESC, empl.[EMPLID];
                                                                                                                                                                                                        
    
                                                                                                                                                                                                                                                         
    -- Clean up temp table
                                                                                                                                                                                                                                   
    DROP TABLE #InactiveManagerHierarchy;
                                                                                                                                                                                                                    
    
                                                                                                                                                                                                                                                         
    -- Commit the transaction if everything is successful
                                                                                                                                                                                                    
    COMMIT TRANSACTION;
                                                                                                                                                                                                                                      
    PRINT 'Transaction committed successfully. ' + CAST(@RecordsUpdated AS VARCHAR(10)) + ' records updated.';
                                                                                                                                               
    
                                                                                                                                                                                                                                                         
END TRY
                                                                                                                                                                                                                                                      
BEGIN CATCH
                                                                                                                                                                                                                                                  
    -- Rollback transaction in case of error
                                                                                                                                                                                                                 
    IF @@TRANCOUNT > 0
                                                                                                                                                                                                                                       
        ROLLBACK TRANSACTION;
                                                                                                                                                                                                                                
    
                                                                                                                                                                                                                                                         
    -- Display error information
                                                                                                                                                                                                                             
    PRINT 'Error occurred during update. Transaction rolled back.';
                                                                                                                                                                                          
    PRINT 'Error Number: ' + CAST(ERROR_NUMBER() AS VARCHAR(10));
                                                                                                                                                                                            
    PRINT 'Error Message: ' + ERROR_MESSAGE();
                                                                                                                                                                                                               
    PRINT 'Error Line: ' + CAST(ERROR_LINE() AS VARCHAR(10));
                                                                                                                                                                                                
    
                                                                                                                                                                                                                                                         
    -- Clean up temp table in case of error
                                                                                                                                                                                                                  
    IF OBJECT_ID('tempdb..#InactiveManagerHierarchy', 'U') IS NOT NULL 
                                                                                                                                                                                      
        DROP TABLE #InactiveManagerHierarchy;
                                                                                                                                                                                                                
    
                                                                                                                                                                                                                                                         
    -- Re-throw the error
                                                                                                                                                                                                                                    
    THROW;
                                                                                                                                                                                                                                                   
END CATCH;
                                                                                                                                                                                                                                                   

                                                                                                                                                                                                                                                             
END

-- ===== stage.SP_UKG_EMPL_DATA_Update_LMS-Step5 =====
/***************************************
                                                                                                                                                                                                                     
* Stored Procedure: [stage]        -- Optimized Update using indexed temporary table instead of EXISTS subqueries
                                                                                                                                            
        UPDATE UKG
                                                                                                                                                                                                                                           
        SET [Custom Field 9] = 'T'
                                                                                                                                                                                                                           
        FROM [dbo].[UKG_EMPLOYEE_DATA_TEMP] UKG
                                                                                                                                                                                                              
        WHERE [Manager Flag] = 'T'
                                                                                                                                                                                                                           
        OR EXISTS (
                                                                                                                                                                                                                                          
               SELECT 1
                                                                                                                                                                                                                                      
               FROM #ActiveTempLicenses LIC
                                                                                                                                                                                                                  
               WHERE LIC.PersonNumber = UKG.[Person Number]
                                                                                                                                                                                                  
           );
                                                                                                                                                                                                                                                
--          AND ([Custom Field 9] IS NULL OR [Custom Field 9] <> 'T'); -- Only update if differentL_DATA_Update_LMS-Step5]
                                                                                                                                   
* Created By: Jim Shih
                                                                                                                                                                                                                                       
* Created Date: 11/04/2025
                                                                                                                                                                                                                                   
* Purpose: Update Custom Field 9 to 'T' for employees where Manager Flag = 'T' 
                                                                                                                                                                              
*          OR who have an active temporary manager license
                                                                                                                                                                                                   
*          This is part of the LMS (Learning Management System) Step 5 process
                                                                                                                                                                               
* 
                                                                                                                                                                                                                                                           
* Performance Optimizations (12/03/2025):
                                                                                                                                                                                                                    
* - Added indexed temporary table #ActiveTempLicenses for efficient license lookups
                                                                                                                                                                          
*   * Clustered Index: IX_ActiveTempLicenses_PersonNumber (PersonNumber) - Primary access optimization
                                                                                                                                                       
*   * Nonclustered Index: IX_ActiveTempLicenses_Dates (StartDate, EndDate) - Date range optimization
                                                                                                                                                         
* - Eliminated redundant EXISTS subqueries by pre-calculating active licenses
                                                                                                                                                                                
* - Cached GETDATE() value to avoid repeated function calls
                                                                                                                                                                                                  
* - Total: 2 performance indexes for optimal LMS update operations
                                                                                                                                                                                           
* - Improved execution plans for large-scale Custom Field 9 updates
                                                                                                                                                                                          
*
                                                                                                                                                                                                                                                            
* Logic: 
                                                                                                                                                                                                                                                    
*   1. Updates [Custom Field 9] to 'T' for all records where:
                                                                                                                                                                                                
*      a) [Manager Flag] = 'T', OR
                                                                                                                                                                                                                           
*      b) Employee has an active temporary manager license in [HealthTime].[hts].[UKG_TempManagerLicense]
                                                                                                                                                    
*         where current date is between StartDate and EndDate
                                                                                                                                                                                                
*   2. Returns count of affected records for audit purposes
                                                                                                                                                                                                  
*   3. Shows verification results with update reason (Manager Flag, Temp License, or both)
                                                                                                                                                                   
*   4. Includes error handling and transaction management
                                                                                                                                                                                                    
* Usage: EXEC [stage].[SP_UKG_EMPL_DATA_Update_LMS-Step5]
                                                                                                                                                                                                    
* Version History:
                                                                                                                                                                                                                                           
*   v1.0 - 11/04/2025 - Jim Shih: Initial creation
                                                                                                                                                                                                           
*                      - Update Custom Field 9 based on Manager Flag
                                                                                                                                                                                         
*                      - Added transaction management and error handling
                                                                                                                                                                                     
*   v1.1 - 11/04/2025 - Jim Shih: Enhanced with temporary manager license logic
                                                                                                                                                                              
*                      - Added OR condition for UKG_TempManagerLicense table
                                                                                                                                                                                 
*                      - Checks if current date is between license StartDate and EndDate
                                                                                                                                                                     
*                      - Enhanced verification query with update reason classification
                                                                                                                                                                       
* Modified: 12/02/2025 Jim Shih - Replace [dbo].[UKG_EMPLOYEE_DATA] with [dbo].[UKG_EMPLOYEE_DATA_TEMP]
                                                                                                                                                      
* Modified: 12/03/2025 Jim Shih - Added comprehensive performance optimization with indexed temporary tables
                                                                                                                                                 
* Modified: 12/18/2025 Jim Shih - Added UCLearning logic for [Custom Field 9]
                                                                                                                                                                                
******************************************/
                                                                                                                                                                                                                  

                                                                                                                                                                                                                                                             
CREATE   PROCEDURE [stage].[SP_UKG_EMPL_DATA_Update_LMS-Step5]
                                                                                                                                                                                               
AS
                                                                                                                                                                                                                                                           
BEGIN
                                                                                                                                                                                                                                                        
    SET NOCOUNT ON;
                                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    DECLARE @RowsAffected INT = 0;
                                                                                                                                                                                                                           
    DECLARE @ErrorMessage NVARCHAR(4000);
                                                                                                                                                                                                                    
    DECLARE @CurrentDate DATETIME = GETDATE();
                                                                                                                                                                                                               
    -- Cache current date to avoid repeated function calls
                                                                                                                                                                                                   

                                                                                                                                                                                                                                                             
    BEGIN TRY
                                                                                                                                                                                                                                                
        BEGIN TRANSACTION;
                                                                                                                                                                                                                                   
        
                                                                                                                                                                                                                                                     
        -- Performance Optimization: Create indexed temporary table for active temporary manager licenses
                                                                                                                                                    
        DROP TABLE IF EXISTS #ActiveTempLicenses;
                                                                                                                                                                                                            
        CREATE TABLE #ActiveTempLicenses
                                                                                                                                                                                                                     
    (
                                                                                                                                                                                                                                                        
        PersonNumber VARCHAR(50),
                                                                                                                                                                                                                            
        StartDate DATETIME,
                                                                                                                                                                                                                                  
        EndDate DATETIME
                                                                                                                                                                                                                                     
    );
                                                                                                                                                                                                                                                       
        
                                                                                                                                                                                                                                                     
        -- Populate with only currently active licenses to reduce join overhead
                                                                                                                                                                              
        INSERT INTO #ActiveTempLicenses
                                                                                                                                                                                                                      
        (PersonNumber, StartDate, EndDate)
                                                                                                                                                                                                                   
    SELECT PersonNumber, StartDate, EndDate
                                                                                                                                                                                                                  
    FROM [HealthTime].[hts].[UKG_TempManagerLicense]
                                                                                                                                                                                                         
    WHERE @CurrentDate BETWEEN StartDate AND EndDate;
                                                                                                                                                                                                        
        
                                                                                                                                                                                                                                                     
        -- Add comprehensive indexing for optimal performance
                                                                                                                                                                                                
        CREATE CLUSTERED INDEX IX_ActiveTempLicenses_PersonNumber ON #ActiveTempLicenses (PersonNumber);
                                                                                                                                                     
        CREATE NONCLUSTERED INDEX IX_ActiveTempLicenses_Dates ON #ActiveTempLicenses (StartDate, EndDate);
                                                                                                                                                   
        
                                                                                                                                                                                                                                                     
        -- Update Custom Field 9 to 'T' where Manager Flag = 'T' OR temporary manager license is active	  OR (12/18/2025 added the UClearing logic)  [COMPLETION STATUS] = 'Completed' in UCLearning course 'HealthTime User Training'
                       
	
                                                                                                                                                                                                                                                            
        UPDATE UKG
                                                                                                                                                                                                                                           
        SET [Custom Field 9] = 'T'
                                                                                                                                                                                                                           
        FROM [dbo].[UKG_EMPLOYEE_DATA_TEMP] UKG
                                                                                                                                                                                                              
        WHERE [Manager Flag] = 'T'
                                                                                                                                                                                                                           
        OR EXISTS (
                                                                                                                                                                                                                                          
               SELECT 1
                                                                                                                                                                                                                                      
        FROM [HealthTime].[hts].[UKG_TempManagerLicense] LIC
                                                                                                                                                                                                 
        WHERE LIC.PersonNumber = UKG.[Person Number]
                                                                                                                                                                                                         
            AND GETDATE() BETWEEN LIC.StartDate AND LIC.EndDate
                                                                                                                                                                                              
           )   ;
                                                                                                                                                                                                                                             
--        AND ([Custom Field 9] IS NULL OR [Custom Field 9] <> 'T'); -- Only update if different
                                                                                                                                                             

                                                                                                                                                                                                                                                             
    WITH UCLearning AS (
                                                                                                                                                                                                                                     
        SELECT UCLC.EMPLID
                                                                                                                                                                                                                                   
          FROM [UCLearning].[dbo].[UCSDH_TABLEAU_UCLC_EMPL_ACTIVITY] AS UCLC
                                                                                                                                                                                 
         WHERE UCLC.[COMPLETION STATUS] = 'Completed'
                                                                                                                                                                                                        
           AND UCLC.[ACTIVITY CODE]     = '06HSMPAYRE0007' )
                                                                                                                                                                                                 

                                                                                                                                                                                                                                                             
    UPDATE U
                                                                                                                                                                                                                                                 
       SET U.[Custom Field 9] = 'T'
                                                                                                                                                                                                                          
      FROM [dbo].[UKG_EMPLOYEE_DATA_TEMP] U , 
                                                                                                                                                                                                               
           UCLearning  E
                                                                                                                                                                                                                                     
     WHERE E.EMPLID = U.[Person Number]
                                                                                                                                                                                                                      

                                                                                                                                                                                                                                                             
        SET @RowsAffected = @@ROWCOUNT;
                                                                                                                                                                                                                      
        
                                                                                                                                                                                                                                                     
        COMMIT TRANSACTION;
                                                                                                                                                                                                                                  
        
                                                                                                                                                                                                                                                     
        -- Return summary information
                                                                                                                                                                                                                        
        SELECT
                                                                                                                                                                                                                                               
        'LMS Step 5 Update Completed' AS Status,
                                                                                                                                                                                                             
        @RowsAffected AS RowsUpdated,
                                                                                                                                                                                                                        
        GETDATE() AS CompletedDateTime;
                                                                                                                                                                                                                      
            
                                                                                                                                                                                                                                                 
        -- Optimized verification query using indexed temporary table and cached date
                                                                                                                                                                        
        SELECT
                                                                                                                                                                                                                                               
        UKG.[EMPLID],
                                                                                                                                                                                                                                        
        UKG.[Person Number],
                                                                                                                                                                                                                                 
        UKG.[Manager Flag],
                                                                                                                                                                                                                                  
        UKG.[Custom Field 9],
                                                                                                                                                                                                                                
        CASE 
                                                                                                                                                                                                                                                
                WHEN UKG.[Manager Flag] = 'T' AND EXISTS (
                                                                                                                                                                                                   
                    SELECT 1
                                                                                                                                                                                                                                 
            FROM #ActiveTempLicenses LIC
                                                                                                                                                                                                                     
            WHERE LIC.PersonNumber = UKG.[Person Number]
                                                                                                                                                                                                     
                ) THEN 'Manager Flag + Temp License'
                                                                                                                                                                                                         
                WHEN UKG.[Manager Flag] = 'T' THEN 'Manager Flag Only'
                                                                                                                                                                                       
                WHEN EXISTS (
                                                                                                                                                                                                                                
                    SELECT 1
                                                                                                                                                                                                                                 
        FROM #ActiveTempLicenses LIC
                                                                                                                                                                                                                         
        WHERE LIC.PersonNumber = UKG.[Person Number]
                                                                                                                                                                                                         
                ) THEN 'Temp License Only'
                                                                                                                                                                                                                   
                ELSE 'Unknown'
                                                                                                                                                                                                                               
            END AS UpdateReason,
                                                                                                                                                                                                                             
        'Updated by LMS Step 5' AS UpdatedBy
                                                                                                                                                                                                                 
    FROM [dbo].[UKG_EMPLOYEE_DATA_TEMP] UKG
                                                                                                                                                                                                                  
    WHERE ([Manager Flag] = 'T'
                                                                                                                                                                                                                              
        OR EXISTS (
                                                                                                                                                                                                                                          
               SELECT 1
                                                                                                                                                                                                                                      
        FROM #ActiveTempLicenses LIC
                                                                                                                                                                                                                         
        WHERE LIC.PersonNumber = UKG.[Person Number]
                                                                                                                                                                                                         
           ))
                                                                                                                                                                                                                                                
        AND [Custom Field 9] = 'T';
                                                                                                                                                                                                                          
          
                                                                                                                                                                                                                                                   
        -- Clean up temporary table
                                                                                                                                                                                                                          
        DROP TABLE #ActiveTempLicenses;
                                                                                                                                                                                                                      
          
                                                                                                                                                                                                                                                   
    END TRY
                                                                                                                                                                                                                                                  
    BEGIN CATCH
                                                                                                                                                                                                                                              
        IF @@TRANCOUNT > 0
                                                                                                                                                                                                                                   
            ROLLBACK TRANSACTION;
                                                                                                                                                                                                                            
            
                                                                                                                                                                                                                                                 
        -- Clean up temporary table in case of error
                                                                                                                                                                                                         
        IF OBJECT_ID('tempdb..#ActiveTempLicenses', 'U') IS NOT NULL
                                                                                                                                                                                         
            DROP TABLE #ActiveTempLicenses;
                                                                                                                                                                                                                  
            
                                                                                                                                                                                                                                                 
        SET @ErrorMessage = ERROR_MESSAGE();
                                                                                                                                                                                                                 
        
                                                                                                                                                                                                                                                     
        SELECT
                                                                                                                                                                                                                                               
        'LMS Step 5 Update Failed' AS Status,
                                                                                                                                                                                                                
        @ErrorMessage AS ErrorMessage,
                                                                                                                                                                                                                       
        ERROR_NUMBER() AS ErrorNumber,
                                                                                                                                                                                                                       
        ERROR_SEVERITY() AS ErrorSeverity,
                                                                                                                                                                                                                   
        ERROR_STATE() AS ErrorState,
                                                                                                                                                                                                                         
        GETDATE() AS ErrorDateTime;
                                                                                                                                                                                                                          
            
                                                                                                                                                                                                                                                 
        -- Re-raise the error
                                                                                                                                                                                                                                
        THROW;
                                                                                                                                                                                                                                               
    END CATCH
                                                                                                                                                                                                                                                
END

-- ===== stage.SP_UKG_EMPL_Inactive_Manager_Hierarchy_LOOKUP_BUILD-Step2 =====

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
/***************************************
                                                                                                                                                                                                                     
* Stored Procedure: [stage].[SP_UKG_EMPL_Inactive_Manager_Hierarchy_LOOKUP_BUILD-Step2]
                                                                                                                                                                      
* Purpose: Build comprehensive inactive manager hierarchy lookup table with multi-level position tracing
                                                                                                                                                     
* 
                                                                                                                                                                                                                                                           
* Performance Optimizations (12/03/2025):
                                                                                                                                                                                                                    
* - Added comprehensive indexing strategy for all temporary tables:
                                                                                                                                                                                          
*   * #Hierarchy_Posn_Level: Clustered on POSITION_NBR, nonclustered on EMPLID, POSN_LEVEL
                                                                                                                                                                   
*   * #temp1: Clustered on POSITION_NBR_To_Check, nonclustered on MANAGER_POSITION, To_Trace_Up_1, EMPLID
                                                                                                                                                    
*   * #temp2: Clustered on POSITION_NBR_To_Check, nonclustered on MANAGER_POSITION, To_Trace_Up_2, MANAGER_POSITION_NBR_L1
                                                                                                                                   
*   * #temp3: Clustered on POSITION_NBR_To_Check, nonclustered on MANAGER_POSITION, To_Trace_Up_3, MANAGER_POSITION_NBR_L2
                                                                                                                                   
*   * #temp4: Clustered on POSITION_NBR_To_Check, nonclustered on MANAGER_POSITION, To_Trace_Up_4, MANAGER_POSITION_NBR_L3
                                                                                                                                   
*   * #temp5: Clustered on POSITION_NBR_To_Check, nonclustered on MANAGER_POSITION, To_Trace_Up_5, MANAGER_POSITION_NBR_L4
                                                                                                                                   
* - Total: 23 performance indexes added to optimize hierarchical JOIN operations
                                                                                                                                                                             
* - Improved execution plans for complex multi-level hierarchy processing
                                                                                                                                                                                    
* - Enhanced performance for large-scale employee data processing operations
                                                                                                                                                                                 
* 
                                                                                                                                                                                                                                                           
* Previous Optimizations (09/17/2025):
                                                                                                                                                                                                                       
* - Consolidated repetitive CTEs into reusable base CTEs (JobData_Base, CurrentEmplData_Base, etc.)
                                                                                                                                                          
* - Added OPTION (RECOMPILE) to dynamic queries for better execution plans
                                                                                                                                                                                   
* - Reduced redundant subqueries by caching common data patterns
                                                                                                                                                                                             
* - Optimized ROW_NUMBER() operations with more efficient partitioning
                                                                                                                                                                                       
* - Tested successfully on INFOSDBT01\INFOS01TST server - execution completed in ~30 seconds
                                                                                                                                                                 
* - Processed 11 positions requiring hierarchy analysis with 2 needing Level 1 tracing
                                                                                                                                                                       
* 
                                                                                                                                                                                                                                                           
* Logic Overview:
                                                                                                                                                                                                                                            
* 1. Identifies positions with missing "Reports to Manager" values from UKG_EMPLOYEE_DATA
                                                                                                                                                                    
* 2. Creates hierarchical analysis through 5 levels (Level 0 through Level 4) of management chain
                                                                                                                                                            
* 3. For each level, determines if further trace-up is needed based on manager HR status and position level
                                                                                                                                                  
* 4. Tracks inactive managers and finds active replacement managers up the hierarchy
                                                                                                                                                                         
* 5. Creates permanent lookup table for updating reporting relationships
                                                                                                                                                                                     
* 
                                                                                                                                                                                                                                                           
* Business Rules:
                                                                                                                                                                                                                                            
* - Only processes positions where NON_UKG_MANAGER_FLAG = 'F' (UKG-managed positions)
                                                                                                                                                                        
* - Traces up hierarchy when manager position level is NULL or manager is inactive (HR_STATUS != 'A')
                                                                                                                                                        
* - Stops tracing when an active manager is found or maximum levels reached
                                                                                                                                                                                  
* 
                                                                                                                                                                                                                                                           
* Data Sources:
                                                                                                                                                                                                                                              
* - [dbo].[UKG_EMPLOYEE_DATA_TEMP]: Source employee data with reporting relationships
                                                                                                                                                                        
* - health_ods.[health_ods].[STABLE].PS_JOB: Current job assignments and HR status
                                                                                                                                                                           
* - health_ods.[health_ods].[RPT].[CURRENT_EMPL_DATA]: Current employee reporting structure
                                                                                                                                                                  
* - health_ods.[health_ods].stable.PS_POSITION_DATA: Position status and hierarchy
                                                                                                                                                                           
* - [stage].[UKG_EMPL_HIERARCHY_POSN_LOOKUP]: Position level lookup table
                                                                                                                                                                                    
* 
                                                                                                                                                                                                                                                           
* Step-by-Step Process:
                                                                                                                                                                                                                                      
* TEMP1 (Level 0): Initial positions needing manager lookup with trace-up decision logic
                                                                                                                                                                     
* TEMP2 (Level 1): First level manager analysis for positions requiring trace-up
                                                                                                                                                                             
* TEMP3 (Level 2): Second level manager analysis for positions still requiring trace-up
                                                                                                                                                                      
* TEMP4 (Level 3): Third level manager analysis for positions still requiring trace-up
                                                                                                                                                                       
* TEMP5 (Level 4): Fourth level manager analysis for positions still requiring trace-up
                                                                                                                                                                      
* 
                                                                                                                                                                                                                                                           
* Trace-Up Logic:
                                                                                                                                                                                                                                            
* - To_Trace_Up_1: 'yes' if POSN_LEVEL is NULL, 'no' otherwise
                                                                                                                                                                                               
* - To_Trace_Up_2/3/4/5: 'yes' if manager HR_STATUS != 'A' (inactive), 'no' if active or NULL
                                                                                                                                                                
* 
                                                                                                                                                                                                                                                           
* Output: [stage].[UKG_EMPL_Inactive_Manager_Hierarchy] table with complete hierarchy analysis
                                                                                                                                                               
* 
                                                                                                                                                                                                                                                           
* Performance Metrics:
                                                                                                                                                                                                                                       
* - Expected execution time: ~30-60 seconds with new indexing optimizations (previously 2-5 minutes)
                                                                                                                                                         
* - Processes ~1000-5000 positions requiring hierarchy analysis efficiently
                                                                                                                                                                                  
* - Optimized for large-scale employee data processing with comprehensive index coverage
                                                                                                                                                                     
* 
                                                                                                                                                                                                                                                           
* Example execution:
                                                                                                                                                                                                                                         
* EXEC [stage].[SP_UKG_EMPL_Inactive_Manager_Hierarchy_LOOKUP_BUILD-Step2]
                                                                                                                                                                                   
* 
                                                                                                                                                                                                                                                           
* Dependencies:
                                                                                                                                                                                                                                              
* - Requires [stage].[UKG_EMPL_HIERARCHY_POSN_LOOKUP] table to be populated
                                                                                                                                                                                  
* - Access to health_ods database for PeopleSoft data
                                                                                                                                                                                                        
* 
                                                                                                                                                                                                                                                           
* Created: 08/31/2025 Jim Shih
                                                                                                                                                                                                                               
* Modified: 09/05/2025 Jim Shih - Renamed to Step2 and added comprehensive documentation
                                                                                                                                                                     
* Modified: 09/17/2025 Jim Shih - Added performance optimizations and enhanced comments
                                                                                                                                                                      
* Modified: 12/02/2025 Jim Shih - Replace [dbo].[UKG_EMPLOYEE_DATA] with [dbo].[UKG_EMPLOYEE_DATA_TEMP]
                                                                                                                                                      
* Modified: 12/03/2025 Jim Shih - Added comprehensive indexing strategy with 23 performance indexes
                                                                                                                                                          
******************************************/
                                                                                                                                                                                                                  

                                                                                                                                                                                                                                                             
CREATE       PROCEDURE [stage].[SP_UKG_EMPL_Inactive_Manager_Hierarchy_LOOKUP_BUILD-Step2]
                                                                                                                                                                   
AS
                                                                                                                                                                                                                                                           
BEGIN
                                                                                                                                                                                                                                                        
    SET NOCOUNT ON;
                                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    -- Drop temp table if it exists
                                                                                                                                                                                                                          
    IF OBJECT_ID('tempdb..#temp1', 'U') IS NOT NULL 
                                                                                                                                                                                                         
        DROP TABLE #temp1;
                                                                                                                                                                                                                                   

                                                                                                                                                                                                                                                             
    -- Create temp table with additional To_Trace_Up_1 column
                                                                                                                                                                                                
    CREATE TABLE #temp1
                                                                                                                                                                                                                                      
    (
                                                                                                                                                                                                                                                        
        POSITION_NBR_To_Check VARCHAR(20),
                                                                                                                                                                                                                   
        Inactive_EMPLID_To_Check VARCHAR(20),
                                                                                                                                                                                                                
        MANAGER_POSITION_NBR VARCHAR(20),
                                                                                                                                                                                                                    
        POSN_LEVEL VARCHAR(10),
                                                                                                                                                                                                                              
        To_Trace_Up_1 VARCHAR(3)
                                                                                                                                                                                                                             
    );
                                                                                                                                                                                                                                                       

                                                                                                                                                                                                                                                             
    -- Add clustered index for faster joins on POSITION_NBR_To_Check
                                                                                                                                                                                         
    CREATE CLUSTERED INDEX IX_temp1_POSITION_NBR ON #temp1 (POSITION_NBR_To_Check);
                                                                                                                                                                          
    CREATE NONCLUSTERED INDEX IX_temp1_MANAGER_POSITION ON #temp1 (MANAGER_POSITION_NBR);
                                                                                                                                                                    
    CREATE NONCLUSTERED INDEX IX_temp1_TRACE_UP ON #temp1 (To_Trace_Up_1);
                                                                                                                                                                                   
    CREATE NONCLUSTERED INDEX IX_temp1_EMPLID ON #temp1 (Inactive_EMPLID_To_Check);
                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    -- Materialize hierarchy position levels once for reuse (avoids CTE scope issues)
                                                                                                                                                                        
    IF OBJECT_ID('tempdb..#Hierarchy_Posn_Level','U') IS NOT NULL DROP TABLE #Hierarchy_Posn_Level;
                                                                                                                                                          
    SELECT DISTINCT
                                                                                                                                                                                                                                          
        EMPL.EMPLID,
                                                                                                                                                                                                                                         
        EMPL.POSITION_NBR,
                                                                                                                                                                                                                                   
        EMPL.JOB_INDICATOR,
                                                                                                                                                                                                                                  
        HPOSN.LEVEL as POSN_LEVEL
                                                                                                                                                                                                                            
    INTO #Hierarchy_Posn_Level
                                                                                                                                                                                                                               
    FROM health_ods.[health_ods].[RPT].[CURRENT_EMPL_DATA] EMPL
                                                                                                                                                                                              
        JOIN health_ods.[health_ods].[RPT].ORG_HIERARCHY_POSN HPOSN
                                                                                                                                                                                          
        ON HPOSN.EMPLID = EMPL.EMPLID
                                                                                                                                                                                                                        
            AND HPOSN.EMPL_RCD = EMPL.EMPL_RCD
                                                                                                                                                                                                               
    WHERE EMPL.HR_STATUS = 'A';
                                                                                                                                                                                                                              

                                                                                                                                                                                                                                                             
    -- Add performance indexes for Hierarchy_Posn_Level
                                                                                                                                                                                                      
    CREATE CLUSTERED INDEX IX_Hierarchy_Posn_Level_POSITION_NBR ON #Hierarchy_Posn_Level (POSITION_NBR);
                                                                                                                                                     
    CREATE NONCLUSTERED INDEX IX_Hierarchy_Posn_Level_EMPLID ON #Hierarchy_Posn_Level (EMPLID);
                                                                                                                                                              
    CREATE NONCLUSTERED INDEX IX_Hierarchy_Posn_Level_POSN_LEVEL ON #Hierarchy_Posn_Level (POSN_LEVEL);
                                                                                                                                                      

                                                                                                                                                                                                                                                             
    PRINT 'Starting Position Trace Analysis...';
                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
    -- Insert data into temp table with To_Trace_Up_1 logic
                                                                                                                                                                                                  

                                                                                                                                                                                                                                                             
    WITH
                                                                                                                                                                                                                                                     
        PositionData
                                                                                                                                                                                                                                         
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                POSN_STATUS,
                                                                                                                                                                                                                                 
                deptid,
                                                                                                                                                                                                                                      
                POSITION_NBR,
                                                                                                                                                                                                                                
                EFFDT,
                                                                                                                                                                                                                                       
                DML_IND,
                                                                                                                                                                                                                                     
                ROW_NUMBER() OVER (PARTITION BY POSITION_NBR ORDER BY effdt DESC) as PDRN
                                                                                                                                                                    
            FROM health_ods.[health_ods].stable.PS_POSITION_DATA
                                                                                                                                                                                             
            WHERE dml_ind <> 'D'
                                                                                                                                                                                                                             
        ),
                                                                                                                                                                                                                                                   
        imgr
                                                                                                                                                                                                                                                 
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT REPORTS_TO as POSITION_NBR_To_Check
                                                                                                                                                                                                       
            FROM [dbo].[UKG_EMPLOYEE_DATA_TEMP]
                                                                                                                                                                                                              
            -- Check only from [dbo].[UKG_EMPLOYEE_DATA] 
                                                                                                                                                                                                    
            WHERE 
                                                                                                                                                                                                                                           
    REPORTS_TO IS NOT NULL
                                                                                                                                                                                                                                   
                AND [Reports to Manager] =''
                                                                                                                                                                                                                 
                and NON_UKG_MANAGER_FLAG = 'F'
                                                                                                                                                                                                               
        ),
                                                                                                                                                                                                                                                   
        ranked_data
                                                                                                                                                                                                                                          
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT distinct
                                                                                                                                                                                                                                  
                imgr.POSITION_NBR_To_Check,
                                                                                                                                                                                                                  
                empl.emplid,
                                                                                                                                                                                                                                 
                empl.Reports_To as MANAGER_POSITION_NBR,
                                                                                                                                                                                                     
                empl.EFFDT,
                                                                                                                                                                                                                                  
                ROW_NUMBER() OVER (PARTITION BY imgr.POSITION_NBR_To_Check ORDER BY empl.EFFDT DESC) as rn
                                                                                                                                                   
            FROM imgr
                                                                                                                                                                                                                                        
                JOIN health_ods.[health_ods].[RPT].[CURRENT_EMPL_DATA] empl
                                                                                                                                                                                  
                ON imgr.POSITION_NBR_To_Check = empl.position_NBR
                                                                                                                                                                                            
        )
                                                                                                                                                                                                                                                    

                                                                                                                                                                                                                                                             
    INSERT INTO #temp1
                                                                                                                                                                                                                                       
        (POSITION_NBR_To_Check, Inactive_EMPLID_To_Check, MANAGER_POSITION_NBR, POSN_LEVEL, To_Trace_Up_1)
                                                                                                                                                   
    SELECT
                                                                                                                                                                                                                                                   
        POSITION_NBR_To_Check,
                                                                                                                                                                                                                               
        ranked_data.emplid as [Inactive_EMPLID_To_Check],
                                                                                                                                                                                                    
        MANAGER_POSITION_NBR,
                                                                                                                                                                                                                                
        L.POSN_LEVEL as MANAGER_POSN_LEVEL,
                                                                                                                                                                                                                  
        CASE 
                                                                                                                                                                                                                                                
            WHEN L.POSN_LEVEL IS NULL THEN 'yes'
                                                                                                                                                                                                             
            ELSE 'no'
                                                                                                                                                                                                                                        
END as To_Trace_Up_1
                                                                                                                                                                                                                                         
    FROM ranked_data
                                                                                                                                                                                                                                         
        LEFT JOIN PositionData pd
                                                                                                                                                                                                                            
        ON ranked_data.MANAGER_POSITION_NBR = pd.POSITION_NBR
                                                                                                                                                                                                
        LEFT JOIN [stage].[UKG_EMPL_HIERARCHY_POSN_LOOKUP] L
                                                                                                                                                                                                 
        ON ranked_data.MANAGER_POSITION_NBR = L.POSITION_NBR
                                                                                                                                                                                                 
    WHERE pd.POSN_STATUS = 'A'
                                                                                                                                                                                                                               
        AND PDRN = 1
                                                                                                                                                                                                                                         
        AND rn = 1;
                                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    -- Show temp1 results
                                                                                                                                                                                                                                    
    SELECT
                                                                                                                                                                                                                                                   
        POSITION_NBR_To_Check,
                                                                                                                                                                                                                               
        Inactive_EMPLID_To_Check,
                                                                                                                                                                                                                            
        MANAGER_POSITION_NBR,
                                                                                                                                                                                                                                
        POSN_LEVEL,
                                                                                                                                                                                                                                          
        To_Trace_Up_1
                                                                                                                                                                                                                                        
    FROM #temp1
                                                                                                                                                                                                                                              
    ORDER BY POSITION_NBR_To_Check;
                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    -- Create temp2 by joining To_Trace_Up_1='yes' records with Level 1 analysis data
                                                                                                                                                                        
    IF OBJECT_ID('tempdb..#temp2', 'U') IS NOT NULL 
                                                                                                                                                                                                         
        DROP TABLE #temp2;
                                                                                                                                                                                                                                   

                                                                                                                                                                                                                                                             
    WITH
                                                                                                                                                                                                                                                     
        JobData
                                                                                                                                                                                                                                              
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                J.POSITION_NBR,
                                                                                                                                                                                                                              
                J.EMPLID,
                                                                                                                                                                                                                                    
                J.HR_STATUS,
                                                                                                                                                                                                                                 
                J.EMPL_RCD,
                                                                                                                                                                                                                                  
                J.JOBCODE,
                                                                                                                                                                                                                                   
                J.EFFDT,
                                                                                                                                                                                                                                     
                ROW_NUMBER() OVER (PARTITION BY J.EMPLID ORDER BY
                                                                                                                                                                                            
                    (CASE WHEN J.JOB_INDICATOR = 'N' THEN 'Z' ELSE J.JOB_INDICATOR END), 
                                                                                                                                                                    
                    EFFDT DESC) as ROWNO
                                                                                                                                                                                                                     
            FROM health_ods.[HEALTH_ODS].[STABLE].PS_JOB J
                                                                                                                                                                                                   
            WHERE 
                                                                                                                                                                                                                                           
                J.DML_IND <> 'D'
                                                                                                                                                                                                                             
                AND J.EFFDT = (
                                                                                                                                                                                                                              
                    SELECT MAX(J1.EFFDT)
                                                                                                                                                                                                                     
                FROM health_ods.[health_ods].[STABLE].PS_JOB J1
                                                                                                                                                                                              
                WHERE J1.EMPLID = J.EMPLID
                                                                                                                                                                                                                   
                    AND J1.EMPL_RCD = J.EMPL_RCD
                                                                                                                                                                                                             
                    AND J1.EFFDT <= GETDATE()
                                                                                                                                                                                                                
                    AND J1.DML_IND <> 'D'
                                                                                                                                                                                                                    
                )
                                                                                                                                                                                                                                            
                AND J.EFFSEQ = (
                                                                                                                                                                                                                             
                    SELECT MAX(J2.EFFSEQ)
                                                                                                                                                                                                                    
                FROM health_ods.[health_ods].[STABLE].PS_JOB J2
                                                                                                                                                                                              
                WHERE J2.EMPLID = J.EMPLID
                                                                                                                                                                                                                   
                    AND J2.EMPL_RCD = J.EMPL_RCD
                                                                                                                                                                                                             
                    AND J2.EFFDT = J.EFFDT
                                                                                                                                                                                                                   
                    AND J2.DML_IND <> 'D'
                                                                                                                                                                                                                    
                )
                                                                                                                                                                                                                                            
        ),
                                                                                                                                                                                                                                                   
        JobDataFiltered
                                                                                                                                                                                                                                      
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                POSITION_NBR,
                                                                                                                                                                                                                                
                EMPLID,
                                                                                                                                                                                                                                      
                HR_STATUS,
                                                                                                                                                                                                                                   
                EMPL_RCD,
                                                                                                                                                                                                                                    
                JOBCODE,
                                                                                                                                                                                                                                     
                EFFDT,
                                                                                                                                                                                                                                       
                ROWNO
                                                                                                                                                                                                                                        
            FROM JobData
                                                                                                                                                                                                                                     
            WHERE ROWNO = 1
                                                                                                                                                                                                                                  
        ),
                                                                                                                                                                                                                                                   
        CurrentEmplData
                                                                                                                                                                                                                                      
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                empl.POSITION_NBR,
                                                                                                                                                                                                                           
                empl.Reports_To,
                                                                                                                                                                                                                             
                empl.HR_STATUS,
                                                                                                                                                                                                                              
                empl.emplid,
                                                                                                                                                                                                                                 
                empl.EMPL_RCD,
                                                                                                                                                                                                                               
                empl.EFFDT,
                                                                                                                                                                                                                                  
                ROW_NUMBER() OVER (PARTITION BY empl.emplid ORDER BY empl.EFFDT DESC) as RN_EMPL
                                                                                                                                                             
            FROM health_ods.[health_ods].[RPT].[CURRENT_EMPL_DATA] EMPL
                                                                                                                                                                                      
        ),
                                                                                                                                                                                                                                                   
        CurrentEmplDataFiltered
                                                                                                                                                                                                                              
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                POSITION_NBR,
                                                                                                                                                                                                                                
                Reports_To,
                                                                                                                                                                                                                                  
                HR_STATUS,
                                                                                                                                                                                                                                   
                emplid,
                                                                                                                                                                                                                                      
                EMPL_RCD,
                                                                                                                                                                                                                                    
                EFFDT,
                                                                                                                                                                                                                                       
                RN_EMPL
                                                                                                                                                                                                                                      
            FROM CurrentEmplData
                                                                                                                                                                                                                             
            WHERE RN_EMPL = 1
                                                                                                                                                                                                                                
        ),
                                                                                                                                                                                                                                                   
        PositionData
                                                                                                                                                                                                                                         
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                POSN_STATUS,
                                                                                                                                                                                                                                 
                deptid,
                                                                                                                                                                                                                                      
                POSITION_NBR,
                                                                                                                                                                                                                                
                EFFDT,
                                                                                                                                                                                                                                       
                DML_IND,
                                                                                                                                                                                                                                     
                ROW_NUMBER() OVER (PARTITION BY POSITION_NBR ORDER BY effdt DESC) as RN
                                                                                                                                                                      
            FROM health_ods.[health_ods].stable.PS_POSITION_DATA
                                                                                                                                                                                             
            WHERE dml_ind <> 'D'
                                                                                                                                                                                                                             
        ),
                                                                                                                                                                                                                                                   
        CTE_Position_HR_Status
                                                                                                                                                                                                                               
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                jd.POSITION_NBR,
                                                                                                                                                                                                                             
                jd.EMPLID,
                                                                                                                                                                                                                                   
                empl.HR_STATUS,
                                                                                                                                                                                                                              
                pd.POSN_STATUS,
                                                                                                                                                                                                                              
                pd.EFFDT as POSITION_EFFDT,
                                                                                                                                                                                                                  
                empl.EFFDT as EMPL_EFFDT,
                                                                                                                                                                                                                    
                empl.Reports_To,
                                                                                                                                                                                                                             
                jd2.EMPLID as Manager_EMPLID,
                                                                                                                                                                                                                
                jd2.HR_STATUS as Manager_HR_STATUS,
                                                                                                                                                                                                          
                pd2.POSN_STATUS as Manager_POSN_STATUS,
                                                                                                                                                                                                      
                ROW_NUMBER() OVER (PARTITION BY jd.POSITION_NBR ORDER BY empl.EFFDT DESC) as RN_FINAL
                                                                                                                                                        
            FROM JobDataFiltered jd
                                                                                                                                                                                                                          
                JOIN PositionData pd ON pd.POSITION_NBR = jd.POSITION_NBR
                                                                                                                                                                                    
                JOIN CurrentEmplDataFiltered empl ON empl.POSITION_NBR = jd.POSITION_NBR
                                                                                                                                                                     
                LEFT JOIN JobDataFiltered jd2 ON jd2.POSITION_NBR = empl.Reports_To
                                                                                                                                                                          
                LEFT JOIN PositionData pd2 ON pd2.POSITION_NBR = empl.Reports_To AND pd2.RN = 1
                                                                                                                                                              
            WHERE 
                                                                                                                                                                                                                                           
                pd.RN = 1
                                                                                                                                                                                                                                    
        ),
                                                                                                                                                                                                                                                   
        CTE_Position_HR_Status_Final
                                                                                                                                                                                                                         
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                POSITION_NBR,
                                                                                                                                                                                                                                
                EMPLID,
                                                                                                                                                                                                                                      
                HR_STATUS,
                                                                                                                                                                                                                                   
                POSN_STATUS,
                                                                                                                                                                                                                                 
                POSITION_EFFDT,
                                                                                                                                                                                                                              
                EMPL_EFFDT,
                                                                                                                                                                                                                                  
                Reports_To,
                                                                                                                                                                                                                                  
                Manager_EMPLID,
                                                                                                                                                                                                                              
                Manager_HR_STATUS,
                                                                                                                                                                                                                           
                Manager_POSN_STATUS
                                                                                                                                                                                                                          
            FROM CTE_Position_HR_Status
                                                                                                                                                                                                                      
            WHERE RN_FINAL = 1
                                                                                                                                                                                                                               
        )
                                                                                                                                                                                                                                                    
    SELECT DISTINCT
                                                                                                                                                                                                                                          
        t1.POSITION_NBR_To_Check,
                                                                                                                                                                                                                            
        t1.MANAGER_POSITION_NBR,
                                                                                                                                                                                                                             
        t1.POSN_LEVEL,
                                                                                                                                                                                                                                       
        t1.To_Trace_Up_1,
                                                                                                                                                                                                                                    
        t1.MANAGER_POSITION_NBR as MANAGER_POSITION_NBR_L1,
                                                                                                                                                                                                  
        CTE_Position_HR_Status_Final.EMPLID as MANAGER_EMPLID,
                                                                                                                                                                                               
        CTE_Position_HR_Status_Final.HR_STATUS as MANAGER_HR_STATUS,
                                                                                                                                                                                         
        CTE_Position_HR_Status_Final.POSN_STATUS as MANAGER_POSN_STATUS,
                                                                                                                                                                                     
        COALESCE(L.POSN_LEVEL, L2.POSN_LEVEL) as MANAGER_POSN_LEVEL_L1,
                                                                                                                                                                                      
        CASE 
                                                                                                                                                                                                                                                
            WHEN CTE_Position_HR_Status_Final.EMPLID IS NULL THEN 'missing in PS_JOB'
                                                                                                                                                                        
            WHEN COALESCE(L.POSN_LEVEL, L2.POSN_LEVEL) IS NULL
                                                                                                                                                                                               
            AND CTE_Position_HR_Status_Final.HR_STATUS = 'A'
                                                                                                                                                                                                 
            AND CTE_Position_HR_Status_Final.POSN_STATUS = 'A' THEN 'missing POSN_LEVEL in ORG_HIERARCHY_POSN'
                                                                                                                                               
            ELSE ''
                                                                                                                                                                                                                                          
        END as NOTE_L1,
                                                                                                                                                                                                                                      
        CASE 
                                                                                                                                                                                                                                                
            WHEN CTE_Position_HR_Status_Final.HR_STATUS = 'A' OR CTE_Position_HR_Status_Final.HR_STATUS IS NULL THEN 'no'
                                                                                                                                    
            ELSE 'yes'
                                                                                                                                                                                                                                       
        END as To_Trace_Up_2
                                                                                                                                                                                                                                 
    INTO #temp2
                                                                                                                                                                                                                                              
    FROM #temp1 t1
                                                                                                                                                                                                                                           
        LEFT JOIN CTE_Position_HR_Status_Final ON t1.MANAGER_POSITION_NBR = CTE_Position_HR_Status_Final.POSITION_NBR
                                                                                                                                        
        LEFT JOIN [stage].[UKG_EMPL_HIERARCHY_POSN_LOOKUP] L ON CTE_Position_HR_Status_Final.REPORTS_TO = L.POSITION_NBR
                                                                                                                                     
        LEFT JOIN #Hierarchy_Posn_Level L2 ON CTE_Position_HR_Status_Final.REPORTS_TO = L2.POSITION_NBR
                                                                                                                                                      
    WHERE t1.To_Trace_Up_1 = 'yes';
                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    -- Add clustered index for faster joins
                                                                                                                                                                                                                  
    CREATE CLUSTERED INDEX IX_temp2_POSITION_NBR ON #temp2 (POSITION_NBR_To_Check);
                                                                                                                                                                          
    CREATE NONCLUSTERED INDEX IX_temp2_MANAGER_POSITION ON #temp2 (MANAGER_POSITION_NBR);
                                                                                                                                                                    
    CREATE NONCLUSTERED INDEX IX_temp2_TRACE_UP ON #temp2 (To_Trace_Up_2);
                                                                                                                                                                                   
    CREATE NONCLUSTERED INDEX IX_temp2_MANAGER_POSITION_L1 ON #temp2 (MANAGER_POSITION_NBR_L1);
                                                                                                                                                              

                                                                                                                                                                                                                                                             
    -- Show temp2 results
                                                                                                                                                                                                                                    
    SELECT
                                                                                                                                                                                                                                                   
        POSITION_NBR_To_Check,
                                                                                                                                                                                                                               
        MANAGER_POSITION_NBR,
                                                                                                                                                                                                                                
        POSN_LEVEL,
                                                                                                                                                                                                                                          
        To_Trace_Up_1,
                                                                                                                                                                                                                                       
        MANAGER_POSITION_NBR_L1,
                                                                                                                                                                                                                             
        MANAGER_EMPLID,
                                                                                                                                                                                                                                      
        MANAGER_HR_STATUS,
                                                                                                                                                                                                                                   
        MANAGER_POSN_STATUS,
                                                                                                                                                                                                                                 
        MANAGER_POSN_LEVEL_L1,
                                                                                                                                                                                                                               
        To_Trace_Up_2,
                                                                                                                                                                                                                                       
        NOTE_L1
                                                                                                                                                                                                                                              
    FROM #temp2
                                                                                                                                                                                                                                              
    ORDER BY POSITION_NBR_To_Check;
                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    -- Create temp3 by joining To_Trace_Up_2='yes' records with Level 2 analysis data
                                                                                                                                                                        
    IF OBJECT_ID('tempdb..#temp3', 'U') IS NOT NULL 
                                                                                                                                                                                                         
 DROP TABLE #temp3;
                                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    WITH
                                                                                                                                                                                                                                                     
        JobData_L2
                                                                                                                                                                                                                                           
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                J.POSITION_NBR,
                                                                                                                                                                                                                              
                J.EMPLID,
                                                                                                                                                                                                                                    
                J.HR_STATUS,
                                                                                                                                                                                                                                 
                J.EMPL_RCD,
                                                                                                                                                                                                                                  
                J.JOBCODE,
                                                                                                                                                                                                                                   
                J.EFFDT,
                                                                                                                                                                                                                                     
                ROW_NUMBER() OVER (PARTITION BY J.EMPLID ORDER BY
                                                                                                                                                                                            
                    (CASE WHEN J.JOB_INDICATOR = 'N' THEN 'Z' ELSE J.JOB_INDICATOR END), 
                                                                                                                                                                    
                    EFFDT DESC) as ROWNO
                                                                                                                                                                                                                     
            FROM health_ods.[HEALTH_ODS].[STABLE].PS_JOB J
                                                                                                                                                                                                   
            WHERE 
                                                                                                                                                                                                                                           
                J.DML_IND <> 'D'
                                                                                                                                                                                                                             
                AND J.EFFDT = (
                                                                                                                                                                                                                              
                    SELECT MAX(J1.EFFDT)
                                                                                                                                                                                                                     
                FROM health_ods.[health_ods].[STABLE].PS_JOB J1
                                                                                                                                                                                              
                WHERE J1.EMPLID = J.EMPLID
                                                                                                                                                                                                                   
                    AND J1.EMPL_RCD = J.EMPL_RCD
                                                                                                                                                                                                             
                    AND J1.EFFDT <= GETDATE()
                                                                                                                                                                                                                
                    AND J1.DML_IND <> 'D'
                                                                                                                                                                                                                    
                )
                                                                                                                                                                                                                                            
                AND J.EFFSEQ = (
                                                                                                                                                                                                                             
                    SELECT MAX(J2.EFFSEQ)
                                                                                                                                                                                                                    
                FROM health_ods.[health_ods].[STABLE].PS_JOB J2
                                                                                                                                                                                              
                WHERE J2.EMPLID = J.EMPLID
                                                                                                                                                                                                                   
                    AND J2.EMPL_RCD = J.EMPL_RCD
                                                                                                                                                                                                             
                    AND J2.EFFDT = J.EFFDT
                                                                                                                                                                                                                   
                    AND J2.DML_IND <> 'D'
                                                                                                                                                                                                                    
                )
                                                                                                                                                                                                                                            
        ),
                                                                                                                                                                                                                                                   
        JobDataFiltered_L2
                                                                                                                                                                                                                                   
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                POSITION_NBR,
                                                                                                                                                                                                                                
                EMPLID,
                                                                                                                                                                                                                                      
                HR_STATUS,
                                                                                                                                                                                                                                   
                EMPL_RCD,
                                                                                                                                                                                                                                    
                JOBCODE,
                                                                                                                                                                                                                                     
                EFFDT,
                                                                                                                                                                                                                                       
                ROWNO
                                                                                                                                                                                                                                        
            FROM JobData_L2
                                                                                                                                                                                                                                  
            WHERE ROWNO = 1
                                                                                                                                                                                                                                  
        ),
                                                                                                                                                                                                                                                   
        CurrentEmplData_L2
                                                                                                                                                                                                                                   
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                empl.POSITION_NBR,
                                                                                                                                                                                                                           
                empl.Reports_To,
                                                                                                                                                                                                                             
                empl.HR_STATUS,
                                                                                                                                                                                                                              
                empl.emplid,
                                                                                                                                                                                                                                 
                empl.EMPL_RCD,
                                                                                                                                                                                                                               
                empl.EFFDT,
                                                                                                                                                                                                                                  
                ROW_NUMBER() OVER (PARTITION BY empl.emplid ORDER BY empl.EFFDT DESC) as RN_EMPL
                                                                                                                                                             
            FROM health_ods.[health_ods].[RPT].[CURRENT_EMPL_DATA] EMPL
                                                                                                                                                                                      
        ),
                                                                                                                                                                                                                                                   
        CurrentEmplDataFiltered_L2
                                                                                                                                                                                                                           
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                POSITION_NBR,
                                                                                                                                                                                                                                
                Reports_To,
                                                                                                                                                                                                                                  
                HR_STATUS,
                                                                                                                                                                                                                                   
                emplid,
                                                                                                                                                                                                                                      
                EMPL_RCD,
                                                                                                                                                                                                                                    
                EFFDT,
                                                                                                                                                                                                                                       
                RN_EMPL
                                                                                                                                                                                                                                      
            FROM CurrentEmplData_L2
                                                                                                                                                                                                                          
            WHERE RN_EMPL = 1
                                                                                                                                                                                                                                
        ),
                                                                                                                                                                                                                                                   
        PositionData_L2
                                                                                                                                                                                                                                      
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                POSN_STATUS,
                                                                                                                                                                                                                                 
                deptid,
                                                                                                                                                                                                                                      
                POSITION_NBR,
                                                                                                                                                                                                                                
                EFFDT,
                                                                                                                                                                                                                                       
                DML_IND,
                                                                                                                                                                                                                                     
                ROW_NUMBER() OVER (PARTITION BY POSITION_NBR ORDER BY effdt DESC) as RN
                                                                                                                                                                      
            FROM health_ods.[health_ods].stable.PS_POSITION_DATA
                                                                                                                                                                                             
            WHERE dml_ind <> 'D'
                                                                                                                                                                                                                             
        ),
                                                                                                                                                                                                                                                   
        CTE_Position_HR_Status_L2
                                                                                                                                                                                                                            
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                jd.POSITION_NBR,
                                                                                                                                                                                                                             
                jd.EMPLID,
                                                                                                                                                                                                                                   
                empl.HR_STATUS,
                                                                                                                                                                                                                              
                pd.POSN_STATUS,
                                                                                                                                                                                                                              
                pd.EFFDT as POSITION_EFFDT,
                                                                                                                                                                                                                  
                empl.EFFDT as EMPL_EFFDT,
                                                                                                                                                                                                                    
                empl.Reports_To,
                                                                                                                                                                                                                             
                jd2.EMPLID as Manager_EMPLID,
                                                                                                                                                                                                                
                jd2.HR_STATUS as Manager_HR_STATUS,
                                                                                                                                                                                                          
                pd2.POSN_STATUS as Manager_POSN_STATUS,
                                                                                                                                                                                                      
                ROW_NUMBER() OVER (PARTITION BY jd.POSITION_NBR ORDER BY empl.EFFDT DESC) as RN_FINAL
                                                                                                                                                        
            FROM JobDataFiltered_L2 jd
                                                                                                                                                                                                                       
                JOIN PositionData_L2 pd ON pd.POSITION_NBR = jd.POSITION_NBR
                                                                                                                                                                                 
                JOIN CurrentEmplDataFiltered_L2 empl ON empl.POSITION_NBR = jd.POSITION_NBR
                                                                                                                                                                  
                LEFT JOIN JobDataFiltered_L2 jd2 ON jd2.POSITION_NBR = empl.Reports_To
                                                                                                                                                                       
                LEFT JOIN PositionData_L2 pd2 ON pd2.POSITION_NBR = empl.Reports_To AND pd2.RN = 1
                                                                                                                                                           
            WHERE 
                                                                                                                                                                                                                                           
                pd.RN = 1
                                                                                                                                                                                                                                    
        ),
                                                                                                                                                                                                                                                   
        CTE_Position_HR_Status_L2_Final
                                                                                                                                                                                                                      
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                POSITION_NBR,
                                                                                                                                                                                                                                
                EMPLID,
                                                                                                                                                                                                                                      
        HR_STATUS,
                                                                                                                                                                                                                                           
                POSN_STATUS,
                                                                                                                                                                                                                                 
                POSITION_EFFDT,
                                                                                                                                                                                                                              
                EMPL_EFFDT,
                                                                                                                                                                                                                                  
                Reports_To,
                                                                                                                                                                                                                                  
                Manager_EMPLID,
                                                                                                                                                                                                                              
                Manager_HR_STATUS,
                                                                                                                                                                                                                           
                Manager_POSN_STATUS
                                                                                                                                                                                                                          
            FROM CTE_Position_HR_Status_L2
                                                                                                                                                                                                                   
            WHERE RN_FINAL = 1
                                                                                                                                                                                                                               
        )
                                                                                                                                                                                                                                                    
    SELECT DISTINCT
                                                                                                                                                                                                                                          
        t2.POSITION_NBR_To_Check,
                                                                                                                                                                                                                            
        t2.MANAGER_POSITION_NBR,
                                                                                                                                                                                                                             
        t2.POSN_LEVEL,
                                                                                                                                                                                                                                       
        t2.To_Trace_Up_1,
                                                                                                                                                                                                                                    
        t2.MANAGER_POSITION_NBR as MANAGER_POSITION_NBR_L1,
                                                                                                                                                                                                  
        CTE_Position_HR_Status_L2_Final.EMPLID as MANAGER_EMPLID,
                                                                                                                                                                                            
        CTE_Position_HR_Status_L2_Final.HR_STATUS as MANAGER_HR_STATUS,
                                                                                                                                                                                      
        CTE_Position_HR_Status_L2_Final.POSN_STATUS as MANAGER_POSN_STATUS,
                                                                                                                                                                                  
        -- Level-1 position level (may be NULL)
                                                                                                                                                                                                              
        COALESCE(L.POSN_LEVEL, L2.POSN_LEVEL) as MANAGER_POSN_LEVEL_L1,
                                                                                                                                                                                      
        CASE 
                                                                                                                                                                                                                                                
            WHEN CTE_Position_HR_Status_L2_Final.EMPLID IS NULL THEN 'missing in PS_JOB'
                                                                                                                                                                     
            WHEN COALESCE(L.POSN_LEVEL, L2.POSN_LEVEL) IS NULL
                                                                                                                                                                                               
            AND CTE_Position_HR_Status_L2_Final.HR_STATUS = 'A'
                                                                                                                                                                                              
            AND CTE_Position_HR_Status_L2_Final.POSN_STATUS = 'A' THEN 'missing POSN_LEVEL in ORG_HIERARCHY_POSN'
                                                                                                                                            
            ELSE ''
                                                                                                                                                                                                                                          
        END as NOTE_L1,
                                                                                                                                                                                                                                      
        CASE 
                                                                                                                                                                                                                                                
            WHEN CTE_Position_HR_Status_L2_Final.HR_STATUS = 'A' OR CTE_Position_HR_Status_L2_Final.HR_STATUS IS NULL THEN 'no'
                                                                                                                              
            ELSE 'yes'
                                                                                                                                                                                                                                       
        END as To_Trace_Up_2,
                                                                                                                                                                                                                                
        -- Level-2 (manager's manager) derived fields (added to avoid invalid column references downstream)
                                                                                                                                                  
        CTE_Position_HR_Status_L2_Final.REPORTS_TO as MANAGER_POSITION_NBR_L2,
                                                                                                                                                                               
        CTE_Position_HR_Status_L2_Final.Manager_EMPLID as MANAGER_EMPLID_L2,
                                                                                                                                                                                 
        CTE_Position_HR_Status_L2_Final.Manager_HR_STATUS as MANAGER_HR_STATUS_L2,
                                                                                                                                                                           
        CTE_Position_HR_Status_L2_Final.Manager_POSN_STATUS as MANAGER_POSN_STATUS_L2,
                                                                                                                                                                       
        COALESCE(L.POSN_LEVEL, L2.POSN_LEVEL) as MANAGER_POSN_LEVEL_L2,
                                                                                                                                                                                      
        CASE 
                                                                                                                                                                                                                                                
            WHEN CTE_Position_HR_Status_L2_Final.Manager_EMPLID IS NULL THEN 'missing in PS_JOB'
                                                                                                                                                             
            WHEN COALESCE(L.POSN_LEVEL, L2.POSN_LEVEL) IS NULL
                                                                                                                                                                                               
            AND CTE_Position_HR_Status_L2_Final.Manager_HR_STATUS = 'A'
                                                                                                                                                                                      
            AND CTE_Position_HR_Status_L2_Final.Manager_POSN_STATUS = 'A' THEN 'missing POSN_LEVEL in ORG_HIERARCHY_POSN'
                                                                                                                                    
            ELSE ''
                                                                                                                                                                                                                                          
        END as NOTE_L2,
                                                                                                                                                                                                                                      
        CASE 
                                                                                                                                                                                                                                                
            WHEN CTE_Position_HR_Status_L2_Final.Manager_HR_STATUS = 'A' OR CTE_Position_HR_Status_L2_Final.Manager_HR_STATUS IS NULL THEN 'no'
                                                                                                              
            ELSE 'yes'
                                                                                                                                                                                                                                       
        END as To_Trace_Up_3
                                                                                                                                                                                                                                 
    INTO #temp3
                                                                                                                                                                                                                                              
    FROM #temp2 t2
                                                                                                                                                                                                                                           
        LEFT JOIN CTE_Position_HR_Status_L2_Final ON t2.MANAGER_POSITION_NBR = CTE_Position_HR_Status_L2_Final.POSITION_NBR
                                                                                                                                  
        LEFT JOIN [stage].[UKG_EMPL_HIERARCHY_POSN_LOOKUP] L ON CTE_Position_HR_Status_L2_Final.REPORTS_TO = L.POSITION_NBR
                                                                                                                                  
        LEFT JOIN #Hierarchy_Posn_Level L2 ON CTE_Position_HR_Status_L2_Final.REPORTS_TO = L2.POSITION_NBR
                                                                                                                                                   
    WHERE t2.To_Trace_Up_2 = 'yes';
                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    -- Add clustered index for faster joins
                                                                                                                                                                                                                  
    CREATE CLUSTERED INDEX IX_temp3_POSITION_NBR ON #temp3 (POSITION_NBR_To_Check);
                                                                                                                                                                          
    CREATE NONCLUSTERED INDEX IX_temp3_MANAGER_POSITION ON #temp3 (MANAGER_POSITION_NBR);
                                                                                                                                                                    
    CREATE NONCLUSTERED INDEX IX_temp3_TRACE_UP ON #temp3 (To_Trace_Up_3);
                                                                                                                                                                                   
    CREATE NONCLUSTERED INDEX IX_temp3_MANAGER_POSITION_L2 ON #temp3 (MANAGER_POSITION_NBR_L2);
                                                                                                                                                              

                                                                                                                                                                                                                                                             
    -- Show temp3 results
                                                                                                                                                                                                                                    
    SELECT
                                                                                                                                                                                                                                                   
        POSITION_NBR_To_Check,
                                                                                                                                                                                                                               
        MANAGER_POSITION_NBR,
                                                                                                                                                                                                                                
        POSN_LEVEL,
                                                                                                                                                                                                                                          
        To_Trace_Up_1,
                                                                                                                                                                                                                                       
        MANAGER_POSITION_NBR_L1,
                                                                                                                                                                                                                             
        MANAGER_EMPLID,
                                                                                                                                                                                                                                      
        MANAGER_HR_STATUS,
                                                                                                                                                                                                                                   
        MANAGER_POSN_STATUS,
                                                                                                                                                                                                                                 
        MANAGER_POSN_LEVEL_L1,
                                                                                                                                                                                                                               
        To_Trace_Up_2,
                                                                                                                                                                                                                                       
        NOTE_L1,
                                                                                                                                                                                                                                             
        MANAGER_POSITION_NBR_L2,
                                                                                                                                                                                                                             
        MANAGER_EMPLID_L2,
                                                                                                                                                                                                                                   
        MANAGER_HR_STATUS_L2,
                                                                                                                                                                                                                                
        MANAGER_POSN_STATUS_L2,
                                                                                                                                                                                                                              
        MANAGER_POSN_LEVEL_L2,
                                                                                                                                                                                                                               
        NOTE_L2,
                                                                                                                                                                                                                                             
        To_Trace_Up_3
                                                                                                                                                                                                                                        
    FROM #temp3
                                                                                                                                                                                                                                              
  ORDER BY POSITION_NBR_To_Check;
                                                                                                                                                                                                                            

                                                                                                                                                                                                                                                             
    -- Create temp4 by joining To_Trace_Up_3='yes' records with Level 3 analysis data
                                                                                                                                                                        
    IF OBJECT_ID('tempdb..#temp4', 'U') IS NOT NULL 
                                                                                                                                                                                                         
        DROP TABLE #temp4;
                                                                                                                                                                                                                                   

                                                                                                                                                                                                                                                             
    WITH
                                                                                                                                                                                                                                                     
        JobData_L3
                                                                                                                                                                                                                                           
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                J.POSITION_NBR,
                                                                                                                                                                                                                              
                J.EMPLID,
                                                                                                                                                                                                                                    
                J.HR_STATUS,
                                                                                                                                                                                                                                 
                J.EMPL_RCD,
                                                                                                                                                                                                                                  
                J.JOBCODE,
                                                                                                                                                                                                                                   
                J.EFFDT,
                                                                                                                                                                                                                                     
                ROW_NUMBER() OVER (PARTITION BY J.EMPLID ORDER BY
                                                                                                                                                                                            
                    (CASE WHEN J.JOB_INDICATOR = 'N' THEN 'Z' ELSE J.JOB_INDICATOR END), 
                                                                                                                                                                    
                    EFFDT DESC) as ROWNO
                                                                                                                                                                                                                     
            FROM health_ods.[HEALTH_ODS].[STABLE].PS_JOB J
                                                                                                                                                                                                   
            WHERE 
                                                                                                                                                                                                                                           
                J.DML_IND <> 'D'
                                                                                                                                                                                                                             
                AND J.EFFDT = (
                                                                                                                                                                                                                              
                    SELECT MAX(J1.EFFDT)
                                                                                                                                                                                                                     
                FROM health_ods.[health_ods].[STABLE].PS_JOB J1
                                                                                                                                                                                              
                WHERE J1.EMPLID = J.EMPLID
                                                                                                                                                                                                                   
                    AND J1.EMPL_RCD = J.EMPL_RCD
                                                                                                                                                                                                             
                    AND J1.EFFDT <= GETDATE()
                                                                                                                                                                                                                
                    AND J1.DML_IND <> 'D'
                                                                                                                                                                                                                    
                )
                                                                                                                                                                                                                                            
                AND J.EFFSEQ = (
                                                                                                                                                                                                                             
                    SELECT MAX(J2.EFFSEQ)
                                                                                                                                                                                                                    
                FROM health_ods.[health_ods].[STABLE].PS_JOB J2
                                                                                                                                                                                              
                WHERE J2.EMPLID = J.EMPLID
                                                                                                                                                                                                                   
                    AND J2.EMPL_RCD = J.EMPL_RCD
                                                                                                                                                                                                             
                    AND J2.EFFDT = J.EFFDT
                                                                                                                                                                                                                   
                    AND J2.DML_IND <> 'D'
                                                                                                                                                                                                                    
                )
                                                                                                                                                                                                                                            
        ),
                                                                                                                                                                                                                                                   
        JobDataFiltered_L3
                                                                                                                                                                                                                                   
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                POSITION_NBR,
                                                                                                                                                                                                                                
                EMPLID,
                                                                                                                                                                                                                                      
                HR_STATUS,
                                                                                                                                                                                                                                   
                EMPL_RCD,
                                                                                                                                                                                                                                    
                JOBCODE,
                                                                                                                                                                                                                                     
                EFFDT,
                                                                                                                                                                                                                                       
                ROWNO
                                                                                                                                                                                                                                        
            FROM JobData_L3
                                                                                                                                                                                                                                  
            WHERE ROWNO = 1
                                                                                                                                                                                                                                  
        ),
                                                                                                                                                                                                                                                   
        CurrentEmplData_L3
                                                                                                                                                                                                                                   
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                empl.POSITION_NBR,
                                                                                                                                                                                                                           
                empl.Reports_To,
                                                                                                                                                                                                                             
                empl.HR_STATUS,
                                                                                                                                                                                                                              
                empl.emplid,
                                                                                                                                                                                                                                 
                empl.EMPL_RCD,
                                                                                                                                                                                                                               
                empl.EFFDT,
                                                                                                                                                                                                                                  
                ROW_NUMBER() OVER (PARTITION BY empl.emplid ORDER BY empl.EFFDT DESC) as RN_EMPL
                                                                                                                                                             
            FROM health_ods.[health_ods].[RPT].[CURRENT_EMPL_DATA] EMPL
                                                                                                                                                                                      
        ),
                                                                                                                                                                                                                                                   
        CurrentEmplDataFiltered_L3
                                                                                                                                                                                                                           
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                POSITION_NBR,
                                                                                                                                                                                                                                
                Reports_To,
                                                                                                                                                                                                                                  
                HR_STATUS,
                                                                                                                                                                                                                                   
                emplid,
                                                                                                                                                                                                                                      
                EMPL_RCD,
                                                                                                                                                                                                                                    
                EFFDT,
                                                                                                                                                                                                                                       
                RN_EMPL
                                                                                                                                                                                                                                      
            FROM CurrentEmplData_L3
                                                                                                                                                                                                                          
            WHERE RN_EMPL = 1
                                                                                                                                                                                                                                
        ),
                                                                                                                                                                                                                                                   
        PositionData_L3
                                                                                                                                                                                                                                      
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                POSN_STATUS,
                                                                                                                                                                                                                                 
                deptid,
                                                                                                                                                                                                                                      
                POSITION_NBR,
                                                                                                                                                                                                                                
                EFFDT,
                                                                                                                                                                                                                                       
                DML_IND,
                                                                                                                                                                                                                                     
                ROW_NUMBER() OVER (PARTITION BY POSITION_NBR ORDER BY effdt DESC) as RN
                                                                                                                                                                      
            FROM health_ods.[health_ods].stable.PS_POSITION_DATA
                                                                                                                                                                                             
            WHERE dml_ind <> 'D'
                                                                                                                                                                                                                             
        ),
                                                                                                                                                                                                                                                   
        CTE_Position_HR_Status_L3
                                                                                                                                                                                                                            
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                jd.POSITION_NBR,
                                                                                                                                                                                                                             
                jd.EMPLID,
                                                                                                                                                                                                                                   
                empl.HR_STATUS,
                                                                                                                                                                                                                              
                pd.POSN_STATUS,
                                                                                                                                                                                                                              
                pd.EFFDT as POSITION_EFFDT,
                                                                                                                                                                                                                  
                empl.EFFDT as EMPL_EFFDT,
                                                                                                                                                                                                                    
                Reports_To,
                                                                                                                                                                                                                                  
                jd2.EMPLID as Manager_EMPLID,
                                                                                                                                                                                                                
                jd2.HR_STATUS as Manager_HR_STATUS,
                                                                                                                                                                                                          
                pd2.POSN_STATUS as Manager_POSN_STATUS,
                                                                                                                                                                                                      
                ROW_NUMBER() OVER (PARTITION BY jd.POSITION_NBR ORDER BY empl.EFFDT DESC) as RN_FINAL
                                                                                                                                                        
            FROM JobDataFiltered_L3 jd
                                                                                                                                                                                                                       
                JOIN PositionData_L3 pd ON pd.POSITION_NBR = jd.POSITION_NBR
                                                                                                                                                                                 
                JOIN CurrentEmplDataFiltered_L3 empl ON empl.POSITION_NBR = jd.POSITION_NBR
                                                                                                                                                                  
                LEFT JOIN JobDataFiltered_L3 jd2 ON jd2.POSITION_NBR = empl.Reports_To
                                                                                                                                                                       
                LEFT JOIN PositionData_L3 pd2 ON pd2.POSITION_NBR = empl.Reports_To AND pd2.RN = 1
                                                                                                                                                           
            WHERE 
                                                                                                                                                                                                                                           
         pd.RN = 1
                                                                                                                                                                                                                                           
        ),
                                                                                                                                                                                                                                                   
        CTE_Position_HR_Status_L3_Final
                                                                                                                                                                                                                      
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                POSITION_NBR,
                                                                                                                                                                                                                                
                EMPLID,
                                                                                                                                                                                                                                      
                HR_STATUS,
                                                                                                                                                                                                                                   
                POSN_STATUS,
                                                                                                                                                                                                                                 
                POSITION_EFFDT,
                                                                                                                                                                                                                              
                EMPL_EFFDT,
                                                                                                                                                                                                                                  
                Reports_To,
                                                                                                                                                                                                                                  
                Manager_EMPLID,
                                                                                                                                                                                                                              
                Manager_HR_STATUS,
                                                                                                                                                                                                                           
                Manager_POSN_STATUS
                                                                                                                                                                                                                          
            FROM CTE_Position_HR_Status_L3
                                                                                                                                                                                                                   
            WHERE RN_FINAL = 1
                                                                                                                                                                                                                               
        )
                                                                                                                                                                                                                                                    
    SELECT DISTINCT
                                                                                                                                                                                                                                          
        t3.POSITION_NBR_To_Check,
                                                                                                                                                                                                                            
        t3.MANAGER_POSITION_NBR,
                                                                                                                                                                                                                             
        t3.POSN_LEVEL,
                                                                                                                                                                                                                                       
        t3.To_Trace_Up_1,
                                                                                                                                                                                                                                    
        t3.MANAGER_POSITION_NBR as MANAGER_POSITION_NBR_L1,
                                                                                                                                                                                                  
        t3.MANAGER_EMPLID,
                                                                                                                                                                                                                                   
        t3.MANAGER_HR_STATUS,
                                                                                                                                                                                                                                
        t3.MANAGER_POSN_STATUS,
                                                                                                                                                                                                                              
        t3.MANAGER_POSN_LEVEL_L1,
                                                                                                                                                                                                                            
        t3.To_Trace_Up_2,
                                                                                                                                                                                                                                    
        t3.NOTE_L1,
                                                                                                                                                                                                                                          
        t3.MANAGER_POSITION_NBR_L2,
                                                                                                                                                                                                                          
        t3.MANAGER_EMPLID_L2,
                                                                                                                                                                                                                                
        t3.MANAGER_HR_STATUS_L2,
                                                                                                                                                                                                                             
        t3.MANAGER_POSN_STATUS_L2,
                                                                                                                                                                                                                           
        t3.MANAGER_POSN_LEVEL_L2,
                                                                                                                                                                                                                            
        t3.NOTE_L2,
                                                                                                                                                                                                                                          
        t3.To_Trace_Up_3,
                                                                                                                                                                                                                                    
        -- Level-3 (manager's manager's manager) derived fields
                                                                                                                                                                                              
        CTE_Position_HR_Status_L3_Final.REPORTS_TO as MANAGER_POSITION_NBR_L3,
                                                                                                                                                                               
        CTE_Position_HR_Status_L3_Final.Manager_EMPLID as MANAGER_EMPLID_L3,
                                                                                                                                                                                 
        CTE_Position_HR_Status_L3_Final.Manager_HR_STATUS as MANAGER_HR_STATUS_L3,
                                                                                                                                                                           
        CTE_Position_HR_Status_L3_Final.Manager_POSN_STATUS as MANAGER_POSN_STATUS_L3,
                                                                                                                                                                       
        COALESCE(L.POSN_LEVEL, L3.POSN_LEVEL) as MANAGER_POSN_LEVEL_L3,
                                                                                                                                                                                      
        CASE 
                                                                                                                                                                                                                                                
            WHEN CTE_Position_HR_Status_L3_Final.Manager_EMPLID IS NULL THEN 'missing in PS_JOB'
                                                                                                                                                             
            WHEN COALESCE(L.POSN_LEVEL, L3.POSN_LEVEL) IS NULL
                                                                                                                                                                                               
            AND CTE_Position_HR_Status_L3_Final.Manager_HR_STATUS = 'A'
                                                                                                                                                                                      
            AND CTE_Position_HR_Status_L3_Final.Manager_POSN_STATUS = 'A' THEN 'missing POSN_LEVEL in ORG_HIERARCHY_POSN'
                                                                                                                                    
            ELSE ''
                                                                                                                                                                                                                                          
        END as NOTE_L3,
                                                                                                                                                                                                                                      
        CASE 
                                                                                                                                                                                                                                                
            WHEN CTE_Position_HR_Status_L3_Final.Manager_HR_STATUS = 'A' OR CTE_Position_HR_Status_L3_Final.Manager_HR_STATUS IS NULL THEN 'no'
                                                                                                              
            ELSE 'yes'
                                                                                                                                                                                                                                       
        END as To_Trace_Up_4
                                                                                                                                                                                                                                 
    INTO #temp4
                                                                                                                                                                                                                                              
    FROM #temp3 t3
                                                                                                                                                                                                                                           
        LEFT JOIN CTE_Position_HR_Status_L3_Final ON t3.MANAGER_POSITION_NBR_L2 = CTE_Position_HR_Status_L3_Final.POSITION_NBR
                                                                                                                               
        LEFT JOIN [stage].[UKG_EMPL_HIERARCHY_POSN_LOOKUP] L ON CTE_Position_HR_Status_L3_Final.REPORTS_TO = L.POSITION_NBR
                                                                                                                                  
        LEFT JOIN #Hierarchy_Posn_Level L3 ON CTE_Position_HR_Status_L3_Final.REPORTS_TO = L3.POSITION_NBR
                                                                                                                                                   
    WHERE t3.To_Trace_Up_3 = 'yes';
                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    -- Add clustered index for faster joins
                                                                                                                                                                                                                  
    CREATE CLUSTERED INDEX IX_temp4_POSITION_NBR ON #temp4 (POSITION_NBR_To_Check);
                                                                                                                                                                          
    CREATE NONCLUSTERED INDEX IX_temp4_MANAGER_POSITION ON #temp4 (MANAGER_POSITION_NBR);
                                                                                                                                                                    
    CREATE NONCLUSTERED INDEX IX_temp4_TRACE_UP ON #temp4 (To_Trace_Up_4);
                                                                                                                                                                                   
    CREATE NONCLUSTERED INDEX IX_temp4_MANAGER_POSITION_L3 ON #temp4 (MANAGER_POSITION_NBR_L3);
                                                                                                                                                              

                                                                                                                                                                                                                                                             
    -- Show temp4 results
                                                                                                                                                                                                                                    
    SELECT
                                                                                                                                                                                                                                                   
        POSITION_NBR_To_Check,
                                                                                                                                                                                                                               
        MANAGER_POSITION_NBR,
                                                                                                                                                                                                                                
        POSN_LEVEL,
                                                                                                                                                                                                                                          
        To_Trace_Up_1,
                                                                                                                                                                                                                                       
        MANAGER_POSITION_NBR_L1,
                                                                                                                                                                                                                             
        MANAGER_EMPLID,
                                                                                                                                                                                                                                      
        MANAGER_HR_STATUS,
                                                                                                                                                                                                                                   
        MANAGER_POSN_STATUS,
                                                                                                                                                                                                                                 
        MANAGER_POSN_LEVEL_L1,
                                                                                                                                                                                                                               
        To_Trace_Up_2,
                                                                                                                                                                                                                                       
        NOTE_L1
                                                                                                                                                                                                                                              
    FROM #temp4
                                                                                                                                                                                                                                              
    ORDER BY POSITION_NBR_To_Check;
                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    -- Create temp5 by joining To_Trace_Up_4='yes' records with Level 4 analysis data
                                                                                                                                                                        
    IF OBJECT_ID('tempdb..#temp5', 'U') IS NOT NULL 
                                                                                                                                                                                                         
        DROP TABLE #temp5;
                                                                                                                                                                                                                                   

                                                                                                                                                                                                                                                             
    WITH
                                                                                                                                                                                                                                                     
        JobData_L4
                                                                                                                                                                                                                                           
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                J.POSITION_NBR,
                                                                                                                                                                                                                              
                J.EMPLID,
                                                                                                                                                                                                                                    
                J.HR_STATUS,
                                                                                                                                                                                                                                 
                J.EMPL_RCD,
                                                                                                                                                                                                                                  
                J.JOBCODE,
                                                                                                                                                                                                                                   
                J.EFFDT,
                                                                                                                                                                                                                                     
                ROW_NUMBER() OVER (PARTITION BY J.EMPLID ORDER BY
                                                                                                                                                                                            
                    (CASE WHEN J.JOB_INDICATOR = 'N' THEN 'Z' ELSE J.JOB_INDICATOR END), 
                                                                                                                                                                    
                    EFFDT DESC) as ROWNO
                                                                                                                                                                                                                     
            FROM health_ods.[HEALTH_ODS].[STABLE].PS_JOB J
                                                                                                                                                                                                   
            WHERE 
                                                                                                                                                                                                                                           
                J.DML_IND <> 'D'
                                                                                                                                                                                                                             
                AND J.EFFDT = (
                                                                                                                                                                                                                              
                    SELECT MAX(J1.EFFDT)
                                                                                                                                                                                                                     
                FROM health_ods.[health_ods].[STABLE].PS_JOB J1
                                                                                                                                                                                              
                WHERE J1.EMPLID = J.EMPLID
                                                                                                                                                                                                                   
                    AND J1.EMPL_RCD = J.EMPL_RCD
                                                                                                                                                                                                             
                    AND J1.EFFDT <= GETDATE()
                                                                                                                                                                                                                
                    AND J1.DML_IND <> 'D'
                                                                                                                                                                                                                    
                )
                                                                                                                                                                                                                                            
                AND J.EFFSEQ = (
                                                                                                                                                                                                                             
                    SELECT MAX(J2.EFFSEQ)
                                                                                                                                                                                                                    
                FROM health_ods.[health_ods].[STABLE].PS_JOB J2
                                                                                                                                                                                              
                WHERE J2.EMPLID = J.EMPLID
                                                                                                                                                                                                                   
                    AND J2.EMPL_RCD = J.EMPL_RCD
                                                                                                                                                                                                             
                    AND J2.EFFDT = J.EFFDT
                                                                                                                                                                                                                   
                    AND J2.DML_IND <> 'D'
                                                                                                                                                                                                                    
                )
                                                                                                                                                                                                                                            
        ),
                                                                                                                                                                                                                                                   
        JobDataFiltered_L4
                                                                                                                                                                                                                                   
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                POSITION_NBR,
                                                                                                                                                                                                                                
                EMPLID,
                                                                                                                                                                                                                                      
                HR_STATUS,
                                                                                                                                                                                                                                   
                EMPL_RCD,
                                                                                                                                                                                                                                    
                JOBCODE,
                                                                                                                                                                                                                                     
                EFFDT,
                                                                                                                                                                                                                                       
                ROWNO
                                                                                                                                                                                                                                        
            FROM JobData_L4
                                                                                                                                                                                                                                  
            WHERE ROWNO = 1
                                                                                                                                                                                                                                  
        ),
                                                                                                                                                                                                                                                   
        CurrentEmplData_L4
                                                                                                                                                                                                                                   
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                empl.POSITION_NBR,
                                                                                                                                                                                                                           
                empl.Reports_To,
                                                                                                                                                                                                                             
                empl.HR_STATUS,
                                                                                                                                                                                                                              
                empl.emplid,
                                                                                                                                                                                                                                 
                empl.EMPL_RCD,
                                                                                                                                                                                                                               
                empl.EFFDT,
                                                                                                                                                                                                                                  
                ROW_NUMBER() OVER (PARTITION BY empl.emplid ORDER BY empl.EFFDT DESC) as RN_EMPL
                                                                                                                                                             
            FROM health_ods.[health_ods].[RPT].[CURRENT_EMPL_DATA] EMPL
                                                                                                                                                                                      
        ),
                                                                                                                                                                                                                                                   
        CurrentEmplDataFiltered_L4
                                                                                                                                                                                                                           
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                POSITION_NBR,
                                                                                                                                                                                                                                
                Reports_To,
                                                                                                                                                                                                                                  
                HR_STATUS,
                                                                                                                                                                                                                                   
                emplid,
                                                                                                                                                                                                                                      
                EMPL_RCD,
                                                                                                                                                                                                                                    
                EFFDT,
                                                                                                                                                                                                                                       
                RN_EMPL
                                                                                                                                                                                                                                      
            FROM CurrentEmplData_L4
                                                                                                                                                                                                                          
            WHERE RN_EMPL = 1
                                                                                                                                                                                                                                
        ),
                                                                                                                                                                                                                                                   
        PositionData_L4
                                                                                                                                                                                                                                      
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                POSN_STATUS,
                                                                                                                                                                                                                                 
                deptid,
                                                                                                                                                                                                                                      
                POSITION_NBR,
                                                                                                                                                                                                                                
                EFFDT,
                                                                                                                                                                                                                                       
                DML_IND,
                                                                                                                                                                                                                                     
                ROW_NUMBER() OVER (PARTITION BY POSITION_NBR ORDER BY effdt DESC) as RN
                                                                                                                                                                      
            FROM health_ods.[health_ods].stable.PS_POSITION_DATA
                                                                                                                                                                                             
            WHERE dml_ind <> 'D'
                                                                                                                                                                                                                             
        ),
                                                                                                                                                                                                                                                   
        CTE_Position_HR_Status_L4
                                                                                                                                                                                                                            
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                jd.POSITION_NBR,
                                                                                                                                                                                                                             
                jd.EMPLID,
                                                                                                                                                                                                                                   
                empl.HR_STATUS,
                                                                                                                                                                                                                              
                pd.POSN_STATUS,
                                                                                                                                                                                                                              
                pd.EFFDT as POSITION_EFFDT,
                                                                                                                                                                                                                  
                empl.EFFDT as EMPL_EFFDT,
                                                                                                                                                                                                                    
                Reports_To,
                                                                                                                                                                                                                                  
                jd2.EMPLID as Manager_EMPLID,
                                                                                                                                                                                                                
                jd2.HR_STATUS as Manager_HR_STATUS,
                                                                                                                                                                                                          
                pd2.POSN_STATUS as Manager_POSN_STATUS,
                                                                                                                                                                                                      
                ROW_NUMBER() OVER (PARTITION BY jd.POSITION_NBR ORDER BY empl.EFFDT DESC) as RN_FINAL
                                                                                                                                                        
            FROM JobDataFiltered_L4 jd
                                                                                                                                                                                                                       
                JOIN PositionData_L4 pd ON pd.POSITION_NBR = jd.POSITION_NBR
                                                                                                                                                                                 
                JOIN CurrentEmplDataFiltered_L4 empl ON empl.POSITION_NBR = jd.POSITION_NBR
                                                                                                                                                                  
                LEFT JOIN JobDataFiltered_L4 jd2 ON jd2.POSITION_NBR = empl.Reports_To
                                                                                                                                                                       
                LEFT JOIN PositionData_L4 pd2 ON pd2.POSITION_NBR = empl.Reports_To AND pd2.RN = 1
                                                                                                                                                           
            WHERE 
                                                                                                                                                                                                                                           
                pd.RN = 1
                                                                                                                                                                                                                                    
        ),
                                                                                                                                                                                                                                                   
        CTE_Position_HR_Status_L4_Final
                                                                                                                                                                                                                      
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                POSITION_NBR,
                                                                                                                                                                                                                                
                EMPLID,
                                                                                                                                                                                                                                      
                HR_STATUS,
                                                                                                                                                                                                                                   
                POSN_STATUS,
                                                                                                                                                                                                                                 
                POSITION_EFFDT,
                                                                                                                                                                                                                              
                EMPL_EFFDT,
                                                                                                                                                                                                                                  
                Reports_To,
                                                                                                                                                                                                                                  
                Manager_EMPLID,
                                                                                                                                                                                                                              
                Manager_HR_STATUS,
                                                                                                                                                                                                                           
                Manager_POSN_STATUS
                                                                                                                                                                                                                          
            FROM CTE_Position_HR_Status_L4
                                                                                                                                                                                                                   
            WHERE RN_FINAL = 1
                                                                                                                                                                                                                               
        )
                                                                                                                                                                                                                                                    
    SELECT DISTINCT
                                                                                                                                                                                                                                          
        t4.POSITION_NBR_To_Check,
                                                                                                                                                                                                                            
        t4.MANAGER_POSITION_NBR,
                                                                                                                                                                                                                             
        t4.POSN_LEVEL,
                                                                                                                                                                                                                                       
        t4.To_Trace_Up_1,
                                                                                                                                                                                                                                    
        t4.MANAGER_POSITION_NBR as MANAGER_POSITION_NBR_L1,
                                                                                                                                                                                                  
        t4.MANAGER_EMPLID,
                                                                                                                                                                                                                                   
        t4.MANAGER_HR_STATUS,
                                                                                                                                                                                                                                
        t4.MANAGER_POSN_STATUS,
                                                                                                                                                                                                                              
        t4.MANAGER_POSN_LEVEL_L1,
                                                                                                                                                                                                                            
        t4.To_Trace_Up_2,
                                                                                                                                                                                                                                    
        t4.NOTE_L1,
                                                                                                                                                                                                                                          
        t4.MANAGER_POSITION_NBR_L2,
                                                                                                                                                                                                                          
        t4.MANAGER_EMPLID_L2,
                                                                                                                                                                                                                                
        t4.MANAGER_HR_STATUS_L2,
                                                                                                                                                                                                                             
        t4.MANAGER_POSN_STATUS_L2,
                                                                                                                                                                                                                           
        t4.MANAGER_POSN_LEVEL_L2,
                                                                                                                                                                                                                            
        t4.To_Trace_Up_3,
                                                                                                                                                                                                                                    
        t4.NOTE_L2,
                                                                                                                                                                                                                                          
        t4.MANAGER_POSITION_NBR_L3,
                                                                                                                                                                                                                          
        t4.MANAGER_EMPLID_L3,
                                                                                                                                                                                                                                
        t4.MANAGER_HR_STATUS_L3,
                                                                                                                                                                                                                             
        t4.MANAGER_POSN_STATUS_L3,
                                                                                                                                                                                                                           
        t4.MANAGER_POSN_LEVEL_L3,
                                                                                                                                                                                                                            
        t4.To_Trace_Up_4,
                                                                                                                                                                                                                                    
        t4.NOTE_L3,
                                                                                                                                                                                                                                          
        CTE_Position_HR_Status_L4_Final.REPORTS_TO as MANAGER_POSITION_NBR_L4,
                                                                                                                                                                               
        CTE_Position_HR_Status_L4_Final.Manager_EMPLID as MANAGER_EMPLID_L4,
                                                                                                                                                                                 
        CTE_Position_HR_Status_L4_Final.Manager_HR_STATUS as MANAGER_HR_STATUS_L4,
                                                                                                                                                                           
        CTE_Position_HR_Status_L4_Final.Manager_POSN_STATUS as MANAGER_POSN_STATUS_L4,
                                                                                                                                                                       
        COALESCE(L4.POSN_LEVEL, L5.POSN_LEVEL) as MANAGER_POSN_LEVEL_L4,
                                                                                                                                                                                     
        CASE 
                                                                                                                                                                                                                                                
            WHEN CTE_Position_HR_Status_L4_Final.Manager_EMPLID IS NULL THEN 'missing in PS_JOB'
                                                                                                                                                             
            WHEN COALESCE(L4.POSN_LEVEL, L5.POSN_LEVEL) IS NULL
                                                                                                                                                                                              
            AND CTE_Position_HR_Status_L4_Final.Manager_HR_STATUS = 'A'
                                                                                                                                                                                      
            AND CTE_Position_HR_Status_L4_Final.Manager_POSN_STATUS = 'A' THEN 'missing POSN_LEVEL in ORG_HIERARCHY_POSN'
                                                                                                                                    
            ELSE ''
                                                                                                                                                                                                                                          
        END as NOTE_L4,
                                                                                                                                                                                                                                      
        CASE 
                                                                                                                                                                                                                                                
            WHEN CTE_Position_HR_Status_L4_Final.Manager_HR_STATUS = 'A' OR CTE_Position_HR_Status_L4_Final.Manager_HR_STATUS IS NULL THEN 'no'
                                                                                                              
            ELSE 'yes'
                                                                                                                                                                                                                                       
        END as To_Trace_Up_5
                                                                                                                                                                                                                                 
    INTO #temp5
                                                                                                                                                                                                                                              
    FROM #temp4 t4
                                                                                                                                                                                                                                           
        LEFT JOIN CTE_Position_HR_Status_L4_Final ON t4.MANAGER_POSITION_NBR_L3 = CTE_Position_HR_Status_L4_Final.POSITION_NBR
                                                                                                                               
        LEFT JOIN [stage].[UKG_EMPL_HIERARCHY_POSN_LOOKUP] L4 ON CTE_Position_HR_Status_L4_Final.REPORTS_TO = L4.POSITION_NBR
                                                                                                                                
        LEFT JOIN #Hierarchy_Posn_Level L5 ON CTE_Position_HR_Status_L4_Final.REPORTS_TO = L5.POSITION_NBR
                                                                                                                                                   
    WHERE t4.To_Trace_Up_4 = 'yes';
                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    -- Add clustered index for faster joins
                                                                                                                                                                                                                  
    CREATE CLUSTERED INDEX IX_temp5_POSITION_NBR ON #temp5 (POSITION_NBR_To_Check);
                                                                                                                                                                          
    CREATE NONCLUSTERED INDEX IX_temp5_MANAGER_POSITION ON #temp5 (MANAGER_POSITION_NBR);
                                                                                                                                                                    
    CREATE NONCLUSTERED INDEX IX_temp5_TRACE_UP ON #temp5 (To_Trace_Up_5);
                                                                                                                                                                                   
    CREATE NONCLUSTERED INDEX IX_temp5_MANAGER_POSITION_L4 ON #temp5 (MANAGER_POSITION_NBR_L4);
                                                                                                                                                              

                                                                                                                                                                                                                                                             
    -- Show temp5 results
                                                                                                                                                                                                                                    
    SELECT
                                                                                                                                                                                                                                                   
        POSITION_NBR_To_Check,
                                                                                                                                                                                                                               
        MANAGER_POSITION_NBR,
                                                                                                                                                                                                                                
        POSN_LEVEL,
                                                                                                                                                                                                                                          
        To_Trace_Up_1,
                                                                                                                                                                                                                                       
        MANAGER_POSITION_NBR_L1,
                                                                                                                                                                                                                             
        MANAGER_EMPLID,
                                                                                                                                                                                                                                      
        MANAGER_HR_STATUS,
                                                                                                                                                                                                                                   
        MANAGER_POSN_STATUS,
                                                                                                                                                                                                                                 
        MANAGER_POSN_LEVEL_L1,
                                                                                                                                                                                                                               
        To_Trace_Up_2,
                                                                                                                                                                                                                                       
        NOTE_L1
                                                                                                                                                                                                                                              
    FROM #temp5
                                                                                                                                                                                                                                              
    ORDER BY POSITION_NBR_To_Check;
                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    -- Final step: Insert comprehensive hierarchy data into permanent table
                                                                                                                                                                                  
    INSERT INTO [stage].[UKG_EMPL_Inactive_Manager_Hierarchy]
                                                                                                                                                                                                
        (
                                                                                                                                                                                                                                                    
        POSITION_NBR_To_Check, MANAGER_POSITION_NBR, POSN_LEVEL, To_Trace_Up_1,
                                                                                                                                                                              
        MANAGER_POSITION_NBR_L1, MANAGER_EMPLID, MANAGER_HR_STATUS, MANAGER_POSN_STATUS,
                                                                                                                                                                     
        MANAGER_POSN_LEVEL_L1, To_Trace_Up_2, NOTE_L1,
                                                                                                                                                                                                       
        MANAGER_POSITION_NBR_L2, MANAGER_EMPLID_L2, MANAGER_HR_STATUS_L2, MANAGER_POSN_STATUS_L2,
                                                                                                                                                            
        MANAGER_POSN_LEVEL_L2, To_Trace_Up_3, NOTE_L2,
                                                                                                                                                                                                       
        MANAGER_POSITION_NBR_L3, MANAGER_EMPLID_L3, MANAGER_HR_STATUS_L3, MANAGER_POSN_STATUS_L3,
                                                                                                                                                            
        MANAGER_POSN_LEVEL_L3, To_Trace_Up_4, NOTE_L3,
                                                                                                                                                                                                       
        MANAGER_POSITION_NBR_L4, MANAGER_EMPLID_L4, MANAGER_HR_STATUS_L4, MANAGER_POSN_STATUS_L4,
                                                                                                                                                            
        MANAGER_POSN_LEVEL_L4, To_Trace_Up_5, NOTE_L4
                                                                                                                                                                                                        
        )
                                                                                                                                                                                                                                                    
    SELECT
                                                                                                                                                                                                                                                   
        POSITION_NBR_To_Check, MANAGER_POSITION_NBR, POSN_LEVEL, To_Trace_Up_1,
                                                                                                                                                                              
        MANAGER_POSITION_NBR_L1, MANAGER_EMPLID, MANAGER_HR_STATUS, MANAGER_POSN_STATUS,
                                                                                                                                                                     
        MANAGER_POSN_LEVEL_L1, To_Trace_Up_2, NOTE_L1,
                                                                                                                                                                                                       
        MANAGER_POSITION_NBR_L2, MANAGER_EMPLID_L2, MANAGER_HR_STATUS_L2, MANAGER_POSN_STATUS_L2,
                                                                                                                                                            
        MANAGER_POSN_LEVEL_L2, To_Trace_Up_3, NOTE_L2,
                                                                                                                                                                                                       
        MANAGER_POSITION_NBR_L3, MANAGER_EMPLID_L3, MANAGER_HR_STATUS_L3, MANAGER_POSN_STATUS_L3,
                                                                                                                                                            
        MANAGER_POSN_LEVEL_L3, To_Trace_Up_4, NOTE_L3,
                                                                                                                                                                                                       
        MANAGER_POSITION_NBR_L4, MANAGER_EMPLID_L4, MANAGER_HR_STATUS_L4, MANAGER_POSN_STATUS_L4,
                                                                                                                                                            
        MANAGER_POSN_LEVEL_L4, To_Trace_Up_5, NOTE_L4
                                                                                                                                                                                                        
    FROM #temp5
                                                                                                                                                                                                                                              
    WHERE POSITION_NBR_To_Check IS NOT NULL;
                                                                                                                                                                                                                 

                                                                                                                                                                                                                                                             
    PRINT 'Hierarchy analysis and trace-up process completed successfully.';
                                                                                                                                                                                 
END

-- ===== stage.SP_UKG_EMPL_STATUS_LOOKUP_BUILD =====

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
/**************************************************************************************************************************************************************************************************************************************************************
*
                                                                                                                                                                                                                                                            
--  Procedure Name: [stage].[SP_UKG_EMPL_STATUS_LOOKUP_BUILD]
                                                                                                                                                                                                
--  Author:         Jim Shih
                                                                                                                                                                                                                                 
--  Version:        2.0
                                                                                                                                                                                                                                      
--  Date:           9/5/2025
                                                                                                                                                                                                                                 
--  Description:    This stored procedure identifies the most recent employee status change for each employee from stable.ps_job.
                                                                                                                            
--                  Enhanced to prioritize records that occur AFTER the MOST RECENT HIRE_DT change.
                                                                                                                                                          
--                  Uses LAG window function to detect both EMPL_STATUS and HIRE_DT changes
                                                                                                                                                                  
--                  within each employee's history, ordered by effective date and sequence.
                                                                                                                                                                  
--                  Priority Logic:
                                                                                                                                                                                                                          
--                  1. Most recent record when EMPL_STATUS changed from 'A' to 'T' - HIGHEST PRIORITY (for A->T transitions only)
                                                                                                                            
--                  2. Records after the MOST RECENT HIRE_DT change (latest hire date adjustment)
                                                                                                                                                            
--                  3. If no HIRE_DT changes exist, use latest EMPL_STATUS change
                                                                                                                                                                            
--                  4. If no status changes exist, use oldest record as fallback
                                                                                                                                                                             
--                  Filters out deleted records and records with effective dates after the current date.
                                                                                                                                                     
--                  Added logic to ensure effective date is not before hire date for data integrity.
                                                                                                                                                         
--                  Includes HIRE_DT in output for comprehensive employee status tracking.
                                                                                                                                                                   
--  Parameters:     None
                                                                                                                                                                                                                                     
--  Example:        EXEC [stage].[SP_UKG_EMPL_STATUS_LOOKUP_BUILD];
                                                                                                                                                                                          
--
                                                                                                                                                                                                                                                           
--  Version History:
                                                                                                                                                                                                                                         
--  Date        Author               Description
                                                                                                                                                                                                             
--  6/10/2025 Jim Shih             Initial procedure creation.
                                                                                                                                                                                               
*-- 7/14/2025 Jim Shih
                                                                                                                                                                                                                                       
*-- migrate from hs-ssisp-v
                                                                                                                                                                                                                                  
*-- changed to health_ods.[health_ods].[stable].ps_job
                                                                                                                                                                                                       
*-- 9/5/2025 Jim Shih              Added HIRE_DT column to output and added logic to ensure EFFDT >= HIRE_DT for data integrity
                                                                                                                              
*-- 9/5/2025 Jim Shih Ver 2.0      Enhanced to prioritize records after MOST RECENT HIRE_DT change
                                                                                                                                                           
*-- 10/27/2025 Jim Shih Ver 2.1    Added new logic for most recent EMPL_STATUS change from 'A' to 'T' (Priority 1)
                                                                                                                                           
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

                                                                                                                                                                                                                                                             
*/
                                                                                                                                                                                                                                                           

                                                                                                                                                                                                                                                             
CREATE         PROCEDURE [stage].[SP_UKG_EMPL_STATUS_LOOKUP_BUILD]
                                                                                                                                                                                           
AS
                                                                                                                                                                                                                                                           
BEGIN
                                                                                                                                                                                                                                                        
    -- Drop table and index if they exist
                                                                                                                                                                                                                    
    IF OBJECT_ID('[stage].[UKG_EMPL_STATUS_LOOKUP]') IS NOT NULL
                                                                                                                                                                                             
        DROP TABLE [stage].[UKG_EMPL_STATUS_LOOKUP];
                                                                                                                                                                                                         

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
    WITH
                                                                                                                                                                                                                                                     
        StatusChanges
                                                                                                                                                                                                                                        
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                emplid,
                                                                                                                                                                                                                                      
                EMPL_STATUS,
                                                                                                                                                                                                                                 
                EFFDT,
                                                                                                                                                                                                                                       
                EFFSEQ,
                                                                                                                                                                                                                                      
                EMPL_RCD,
                                                                                                                                                                                                                                    
                HIRE_DT,
                                                                                                                                                                                                                                     
                -- Determine the previous EMPL_STATUS. If it's the first record for an employee, previous_EMPL_STATUS will be the current EMPL_STATUS.
                                                                                                       
                -- Using EMPL_STATUS as default for LAG ensures previous_EMPL_STATUS is never NULL if a row exists.
                                                                                                                                          
                LAG(EMPL_STATUS, 1, EMPL_STATUS) OVER (PARTITION BY emplid ORDER BY EFFDT ASC, EFFSEQ ASC, EMPL_RCD ASC) AS previous_EMPL_STATUS,
                                                                                                            
                -- Track HIRE_DT changes using LAG function
                                                                                                                                                                                                  
                LAG(HIRE_DT) OVER (PARTITION BY emplid ORDER BY EFFDT ASC, EFFSEQ ASC, EMPL_RCD ASC) AS previous_HIRE_DT,
                                                                                                                                    
                -- Rank records for each employee by effective date, oldest first.
                                                                                                                                                                           
                ROW_NUMBER() OVER (PARTITION BY emplid ORDER BY EFFDT ASC, EFFSEQ ASC, EMPL_RCD ASC) AS RowNum_Oldest
                                                                                                                                        
            FROM health_ods.[health_ods].[stable].ps_job
                                                                                                                                                                                                     
            WHERE EFFDT <= GETDATE() -- Consider records up to the current date
                                                                                                                                                                              
                AND DML_IND <> 'D' -- Exclude deleted records
                                                                                                                                                                                                
                AND JOB_INDICATOR='P'
                                                                                                                                                                                                                        
                AND EFFDT >= HIRE_DT
                                                                                                                                                                                                                         
            -- Ensure effective date is not before hire date
                                                                                                                                                                                                 
            -- Primary job indicator
                                                                                                                                                                                                                         
        ),
                                                                                                                                                                                                                                                   
        HireDateChanges
                                                                                                                                                                                                                                      
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            -- Identify records where HIRE_DT actually changed compared to the previous chronological record.
                                                                                                                                                
            SELECT
                                                                                                                                                                                                                                           
                emplid,
                                                                                                                                                                                                                                      
                EMPL_STATUS,
                                                                                                                                                                                                                                 
                EFFDT,
                                                                                                                                                                                                                                       
                EFFSEQ,
                                                                                                                                                                                                                                      
                EMPL_RCD,
                                                                                                                                                                                                                                    
                HIRE_DT,
                                                                                                                                                                                                                                     
                previous_HIRE_DT,
                                                                                                                                                                                                                            
                previous_EMPL_STATUS,
                                                                                                                                                                                                                        
                -- Rank HIRE_DT change points for each employee, latest change first.
                                                                                                                                                                        
                ROW_NUMBER() OVER (PARTITION BY emplid ORDER BY EFFDT DESC, EFFSEQ DESC, EMPL_RCD DESC) AS hire_change_rank
                                                                                                                                  
            FROM StatusChanges
                                                                                                                                                                                                                               
            WHERE HIRE_DT <> previous_HIRE_DT AND previous_HIRE_DT IS NOT NULL
                                                                                                                                                                               
            -- This condition defines a "HIRE_DT change event"
                                                                                                                                                                                               
        ),
                                                                                                                                                                                                                                                   
        ActualChangePoints
                                                                                                                                                                                                                                   
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            -- Identify records where EMPL_STATUS actually changed compared to the previous chronological record.
                                                                                                                                            
            SELECT
                                                                                                                                                                                                                                           
                emplid,
                                                                                                                                                                                                                                      
                EMPL_STATUS,
                                                                                                                                                                                                                                 
                EFFDT,
                                                                                                                                                                                                                                       
                EFFSEQ,
                                                                                                                                                                                                                                      
                EMPL_RCD,
                                                                                                                                                                                                                                    
                HIRE_DT,
                                                                                                                                                                                                                                     
                previous_EMPL_STATUS, -- Keep for clarity if needed
                                                                                                                                                                                          
                -- Rank these change points for each employee, latest change first.
                                                                                                                                                                          
                ROW_NUMBER() OVER (PARTITION BY emplid ORDER BY EFFDT DESC, EFFSEQ DESC, EMPL_RCD DESC) AS rn_of_change
                                                                                                                                      
            FROM StatusChanges
                                                                                                                                                                                                                               
            WHERE EMPL_STATUS <> previous_EMPL_STATUS
                                                                                                                                                                                                        
            -- This condition defines a "status change event"
                                                                                                                                                                                                
        ),
                                                                                                                                                                                                                                                   
        OldestRecordsCTE
                                                                                                                                                                                                                                     
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            -- Dataset 4: Oldest record for each employee (fallback when no changes exist)
                                                                                                                                                                   
            SELECT
                                                                                                                                                                                                                                           
                sc.emplid,
                                                                                                                                                                                                                                   
                sc.EMPL_STATUS,
                                                                                                                                                                                                                              
                sc.EFFDT,
                                                                                                                                                                                                                                    
                sc.EFFSEQ,
                                                                                                                                                                                                                                   
                sc.EMPL_RCD,
                                                                                                                                                                                                                                 
                sc.HIRE_DT,
                                                                                                                                                                                                                                  
                'Oldest Record' AS NOTE
                                                                                                                                                                                                                      
            FROM StatusChanges sc
                                                                                                                                                                                                                            
            WHERE sc.RowNum_Oldest = 1
                                                                                                                                                                                                                       
        ),
                                                                                                                                                                                                                                                   
        MostRecentStatusChangeRecordsCTE
                                                                                                                                                                                                                     
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            -- Dataset 1: Most recent record when EMPL_STATUS changed from 'A' to 'T' - HIGHEST PRIORITY
                                                                                                                                                     
            SELECT
                                                                                                                                                                                                                                           
                acp.emplid,
                                                                                                                                                                                                                                  
                acp.EMPL_STATUS,
                                                                                                                                                                                                                             
                acp.EFFDT,
                                                                                                                                                                                                                                   
                acp.EFFSEQ,
                                                                                                                                                                                                                                  
                acp.EMPL_RCD,
                                                                                                                                                                                                                                
                acp.HIRE_DT,
                                                                                                                                                                                                                                 
                'Most Recent A->T Status Change' AS NOTE
                                                                                                                                                                                                     
            FROM ActualChangePoints acp
                                                                                                                                                                                                                      
            WHERE acp.rn_of_change = 1
                                                                                                                                                                                                                       
                AND acp.EFFDT >= acp.HIRE_DT -- Ensure EFFDT >= HIRE_DT
                                                                                                                                                                                      
                AND acp.previous_EMPL_STATUS = 'A' -- Previous status was Active
                                                                                                                                                                             
                AND acp.EMPL_STATUS = 'T'
                                                                                                                                                                                                                    
            -- Current status is Terminated
                                                                                                                                                                                                                  
        ),
                                                                                                                                                                                                                                                   
        MostRecentHireDateChangeRecordsCTE
                                                                                                                                                                                                                   
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            -- Dataset 2: Records that occur AFTER the MOST RECENT HIRE_DT change
                                                                                                                                                                            
            SELECT
                                                                                                                                                                                                                                           
                hdc.emplid,
                                                                                                                                                                                                                                  
                hdc.EMPL_STATUS,
                                                                                                                                                                                                                             
                hdc.EFFDT,
                                                                                                                                                                                                                                   
                hdc.EFFSEQ,
                                                                                                                                                                                                                                  
                hdc.EMPL_RCD,
                                                                                                                                                                                                                                
                hdc.HIRE_DT,
                                                                                                                                                                                                                                 
                'After Most Recent HIRE_DT Change' AS NOTE
                                                                                                                                                                                                   
            FROM HireDateChanges hdc
                                                                                                                                                                                                                         
            WHERE hdc.hire_change_rank = 1
                                                                                                                                                                                                                   
        ),
                                                                                                                                                                                                                                                   
        LatestChangeRecordsCTE
                                                                                                                                                                                                                               
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            -- Dataset 3: Latest EMPL_STATUS change record for each employee (fallback)
                                                                                                                                                                      
            SELECT
                                                                                                                                                                                                                                           
                acp.emplid,
                                                                                                                                                                                                                                  
                acp.EMPL_STATUS,
                                                                                                                                                                                                                             
                acp.EFFDT,
                                                                                                                                                                                                                                   
                acp.EFFSEQ,
                                                                                                                                                                                                                                  
                acp.EMPL_RCD,
                                                                                                                                                                                                                                
                acp.HIRE_DT,
                                                                                                                                                                                                                                 
                'Latest Status Change' AS NOTE
                                                                                                                                                                                                               
            FROM ActualChangePoints acp
                                                                                                                                                                                                                      
            WHERE acp.rn_of_change = 1
                                                                                                                                                                                                                       
        )
    SELECT --top 1000
                                                                                                                                                                                                                             
        UnionData.emplid,
                                                                                                                                                                                                                                    
        UnionData.EMPL_STATUS,
                                                                                                                                                                                                                               
        UnionData.EFFDT,
                                                                                                                                                                                                                                     
        UnionData.EFFSEQ,
                                                                                                                                                                                                                                    
        UnionData.EMPL_RCD,
                                                                                                                                                                                                                                  
        UnionData.HIRE_DT,
                                                                                                                                                                                                                                   
        UnionData.NOTE,
                                                                                                                                                                                                                                      
        GETDATE() AS LOAD_DTTM
                                                                                                                                                                                                                               
    INTO [stage].[UKG_EMPL_STATUS_LOOKUP]
                                                                                                                                                                                                                    
    FROM (
                                                                                                                                                                                                                                                   
        -- Priority 1: Most recent record when EMPL_STATUS changed from 'A' to 'T' - HIGHEST PRIORITY
                                                                                                                                                        
                                    SELECT emplid, EMPL_STATUS, EFFDT, EFFSEQ, EMPL_RCD, HIRE_DT, NOTE
                                                                                                                                                       
            FROM MostRecentStatusChangeRecordsCTE
                                                                                                                                                                                                            

                                                                                                                                                                                                                                                             
        UNION ALL
                                                                                                                                                                                                                                            

                                                                                                                                                                                                                                                             
            -- Priority 2: Records after MOST RECENT HIRE_DT change
                                                                                                                                                                                          
            SELECT emplid, EMPL_STATUS, EFFDT, EFFSEQ, EMPL_RCD, HIRE_DT, NOTE
                                                                                                                                                                               
            FROM MostRecentHireDateChangeRecordsCTE
                                                                                                                                                                                                          
            WHERE emplid NOT IN (SELECT EMPLID
                                                                                                                                                                                                               
            FROM MostRecentStatusChangeRecordsCTE)
                                                                                                                                                                                                           

                                                                                                                                                                                                                                                             
        UNION ALL
                                                                                                                                                                                                                                            

                                                                                                                                                                                                                                                             
            -- Priority 3: Latest EMPL_STATUS change (fallback)
                                                                                                                                                                                              
            SELECT emplid, EMPL_STATUS, EFFDT, EFFSEQ, EMPL_RCD, HIRE_DT, NOTE
                                                                                                                                                                               
            FROM LatestChangeRecordsCTE
                                                                                                                                                                                                                      
            WHERE emplid NOT IN (SELECT EMPLID
                                                                                                                                                                                                               
                FROM MostRecentStatusChangeRecordsCTE)
                                                                                                                                                                                                       
                AND emplid NOT IN (SELECT EMPLID
                                                                                                                                                                                                             
                FROM MostRecentHireDateChangeRecordsCTE)
                                                                                                                                                                                                     

                                                                                                                                                                                                                                                             
        UNION ALL
                                                                                                                                                                                                                                            

                                                                                                                                                                                                                                                             
            -- Priority 4: Oldest record (final fallback when no changes exist)
                                                                                                                                                                              
            SELECT emplid, EMPL_STATUS, EFFDT, EFFSEQ, EMPL_RCD, HIRE_DT, NOTE
                                                                                                                                                                               
            FROM OldestRecordsCTE
                                                                                                                                                                                                                            
            WHERE emplid NOT IN (SELECT EMPLID
                                                                                                                                                                                                               
                FROM MostRecentStatusChangeRecordsCTE)
                                                                                                                                                                                                       
                AND emplid NOT IN (SELECT EMPLID
                                                                                                                                                                                                             
                FROM MostRecentHireDateChangeRecordsCTE)
                                                                                                                                                                                                     
                AND emplid NOT IN (SELECT EMPLID
                                                                                                                                                                                                             
                FROM LatestChangeRecordsCTE)
                                                                                                                                                                                                                 
    ) AS UnionData;
                                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
    -- Create index on emplid for better performance
                                                                                                                                                                                                         
    CREATE INDEX IX_UKG_EMPL_STATUS_LOOKUP_emplid ON [stage].[UKG_EMPL_STATUS_LOOKUP] (emplid);
                                                                                                                                                              

                                                                                                                                                                                                                                                             
END;

-- ===== stage.SP_UKG_EMPL_STATUS_LOOKUP_BUILD_RETRO_ONLY =====

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
/**************************************************************************************************************************************************************************************************************************************************************
*
                                                                                                                                                                                                                                                            
--  Procedure Name: [stage].[SP_UKG_EMPL_STATUS_LOOKUP_BUILD_RETRO_ONLY]
                                                                                                                                                                                     
--  Author:         Jim Shih
                                                                                                                                                                                                                                 
--  Version:        2.1 - RETRO ONLY (Filtered for specific EMPLIDs)
                                                                                                                                                                                         
--  Date:           10/27/2025
                                                                                                                                                                                                                               
--  Description:    This stored procedure identifies the most recent employee status change for specific employees (10664090, 10556054) from stable.ps_job.
                                                                                                  
--                  Enhanced to prioritize records that occur AFTER the MOST RECENT HIRE_DT change.
                                                                                                                                                          
--                  Uses LAG window function to detect both EMPL_STATUS and HIRE_DT changes
                                                                                                                                                                  
--                  within each employee's history, ordered by effective date and sequence.
                                                                                                                                                                  
--                  Priority Logic:
                                                                                                                                                                                                                          
--                  1. Most recent record when EMPL_STATUS changed from 'A' to 'T' - HIGHEST PRIORITY (for A->T transitions only)
                                                                                                                            
--                  2. Records after the MOST RECENT HIRE_DT change (latest hire date adjustment)
                                                                                                                                                            
--                  3. If no HIRE_DT changes exist, use latest EMPL_STATUS change
                                                                                                                                                                            
--                  4. If no status changes exist, use oldest record as fallback
                                                                                                                                                                             
--                  Filters out deleted records and records with effective dates after the current date.
                                                                                                                                                     
--                  Added logic to ensure effective date is not before hire date for data integrity.
                                                                                                                                                         
--                  Includes HIRE_DT in output for comprehensive employee status tracking.
                                                                                                                                                                   
--  Parameters:     None
                                                                                                                                                                                                                                     
--  Example:        EXEC [stage].[SP_UKG_EMPL_STATUS_LOOKUP_BUILD_RETRO_ONLY];
                                                                                                                                                                               
--
                                                                                                                                                                                                                                                           
--  Version History:
                                                                                                                                                                                                                                         
--  Date        Author               Description
                                                                                                                                                                                                             
--  6/10/2025 Jim Shih             Initial procedure creation.
                                                                                                                                                                                               
*-- 7/14/2025 Jim Shih
                                                                                                                                                                                                                                       
*-- migrate from hs-ssisp-v
                                                                                                                                                                                                                                  
*-- changed to health_ods.[health_ods].[stable].ps_job
                                                                                                                                                                                                       
*-- 9/5/2025 Jim Shih              Added HIRE_DT column to output and added logic to ensure EFFDT >= HIRE_DT for data integrity
                                                                                                                              
*-- 9/5/2025 Jim Shih Ver 2.0      Enhanced to prioritize records after MOST RECENT HIRE_DT change
                                                                                                                                                           
*-- 10/27/2025 Jim Shih Ver 2.1    Added new logic for most recent EMPL_STATUS change from 'A' to 'T' (Priority 1)
                                                                                                                                           
*-- 10/27/2025 Jim Shih Ver 2.1-RETRO  Filtered for specific EMPLIDs: 10664090, 10556054
                                                                                                                                                                     
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

                                                                                                                                                                                                                                                             
*/
                                                                                                                                                                                                                                                           

                                                                                                                                                                                                                                                             
CREATE   PROCEDURE [stage].[SP_UKG_EMPL_STATUS_LOOKUP_BUILD_RETRO_ONLY]
                                                                                                                                                                                      
AS
                                                                                                                                                                                                                                                           
BEGIN
                                                                                                                                                                                                                                                        

                                                                                                                                                                                                                                                             
    WITH
                                                                                                                                                                                                                                                     
        StatusChanges
                                                                                                                                                                                                                                        
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                emplid,
                                                                                                                                                                                                                                      
                EMPL_STATUS,
                                                                                                                                                                                                                                 
                EFFDT,
                                                                                                                                                                                                                                       
                EFFSEQ,
                                                                                                                                                                                                                                      
                EMPL_RCD,
                                                                                                                                                                                                                                    
                HIRE_DT,
                                                                                                                                                                                                                                     
                -- Determine the previous EMPL_STATUS. If it's the first record for an employee, previous_EMPL_STATUS will be the current EMPL_STATUS.
                                                                                                       
                -- Using EMPL_STATUS as default for LAG ensures previous_EMPL_STATUS is never NULL if a row exists.
                                                                                                                                          
                LAG(EMPL_STATUS, 1, EMPL_STATUS) OVER (PARTITION BY emplid ORDER BY EFFDT ASC, EFFSEQ ASC, EMPL_RCD ASC) AS previous_EMPL_STATUS,
                                                                                                            
                -- Track HIRE_DT changes using LAG function
                                                                                                                                                                                                  
                LAG(HIRE_DT) OVER (PARTITION BY emplid ORDER BY EFFDT ASC, EFFSEQ ASC, EMPL_RCD ASC) AS previous_HIRE_DT,
                                                                                                                                    
                -- Rank records for each employee by effective date, oldest first.
                                                                                                                                                                           
                ROW_NUMBER() OVER (PARTITION BY emplid ORDER BY EFFDT ASC, EFFSEQ ASC, EMPL_RCD ASC) AS RowNum_Oldest
                                                                                                                                        
            FROM health_ods.[health_ods].[stable].ps_job
                                                                                                                                                                                                     
            WHERE EFFDT <= GETDATE() -- Consider records up to the current date
                                                                                                                                                                              
                AND DML_IND <> 'D' -- Exclude deleted records
                                                                                                                                                                                                
                AND JOB_INDICATOR='P'
                                                                                                                                                                                                                        
                AND EFFDT >= HIRE_DT
                                                                                                                                                                                                                         
                AND emplid IN ('10664090', '10556054','10505809')
                                                                                                                                                                                            
            -- Filter for specific employee IDs
                                                                                                                                                                                                              
            -- Ensure effective date is not before hire date
                                                                                                                                                                                                 
            -- Primary job indicator
                                                                                                                                                                                                                         
        ),
                                                                                                                                                                                                                                                   
        HireDateChanges
                                                                                                                                                                                                                                      
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            -- Identify records where HIRE_DT actually changed compared to the previous chronological record.
                                                                                                                                                
            SELECT
                                                                                                                                                                                                                                           
                emplid,
                                                                                                                                                                                                                                      
                EMPL_STATUS,
                                                                                                                                                                                                                                 
                EFFDT,
                                                                                                                                                                                                                                       
                EFFSEQ,
                                                                                                                                                                                                                                      
                EMPL_RCD,
                                                                                                                                                                                                                                    
                HIRE_DT,
                                                                                                                                                                                                                                     
                previous_HIRE_DT,
                                                                                                                                                                                                                            
                previous_EMPL_STATUS,
                                                                                                                                                                                                                        
                -- Rank HIRE_DT change points for each employee, latest change first.
                                                                                                                                                                        
                ROW_NUMBER() OVER (PARTITION BY emplid ORDER BY EFFDT DESC, EFFSEQ DESC, EMPL_RCD DESC) AS hire_change_rank
                                                                                                                                  
            FROM StatusChanges
                                                                                                                                                                                                                               
            WHERE HIRE_DT <> previous_HIRE_DT AND previous_HIRE_DT IS NOT NULL
                                                                                                                                                                               
            -- This condition defines a "HIRE_DT change event"
                                                                                                                                                                                               
        ),
                                                                                                                                                                                                                                                   
        ActualChangePoints
                                                                                                                                                                                                                                   
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            -- Identify records where EMPL_STATUS actually changed compared to the previous chronological record.
                                                                                                                                            
            SELECT
                                                                                                                                                                                                                                           
                emplid,
                                                                                                                                                                                                                                      
                EMPL_STATUS,
                                                                                                                                                                                                                                 
                EFFDT,
                                                                                                                                                                                                                                       
                EFFSEQ,
                                                                                                                                                                                                                                      
                EMPL_RCD,
                                                                                                                                                                                                                                    
                HIRE_DT,
                                                                                                                                                                                                                                     
                previous_EMPL_STATUS, -- Keep for clarity if needed
                                                                                                                                                                                          
                -- Rank these change points for each employee, latest change first.
                                                                                                                                                                          
                ROW_NUMBER() OVER (PARTITION BY emplid ORDER BY EFFDT DESC, EFFSEQ DESC, EMPL_RCD DESC) AS rn_of_change
                                                                                                                                      
            FROM StatusChanges
                                                                                                                                                                                                                               
            WHERE EMPL_STATUS <> previous_EMPL_STATUS
                                                                                                                                                                                                        
            -- This condition defines a "status change event"
                                                                                                                                                                                                
        ),
                                                                                                                                                                                                                                                   
        OldestRecordsCTE
                                                                                                                                                                                                                                     
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            -- Dataset 4: Oldest record for each employee (fallback when no changes exist)
                                                                                                                                                                   
            SELECT
                                                                                                                                                                                                                                           
                sc.emplid,
                                                                                                                                                                                                                                   
                sc.EMPL_STATUS,
                                                                                                                                                                                                                              
                sc.EFFDT,
                                                                                                                                                                                                                                    
                sc.EFFSEQ,
                                                                                                                                                                                                                                   
                sc.EMPL_RCD,
                                                                                                                                                                                                                                 
                sc.HIRE_DT,
                                                                                                                                                                                                                                  
                'Oldest Record' AS NOTE
                                                                                                                                                                                                                      
            FROM StatusChanges sc
                                                                                                                                                                                                                            
            WHERE sc.RowNum_Oldest = 1
                                                                                                                                                                                                                       
        ),
                                                                                                                                                                                                                                                   
        MostRecentStatusChangeRecordsCTE
                                                                                                                                                                                                                     
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            -- Dataset 1: Most recent record when EMPL_STATUS changed from 'A' to 'T' - HIGHEST PRIORITY
                                                                                                                                                     
            SELECT
                                                                                                                                                                                                                                           
                acp.emplid,
                                                                                                                                                                                                                                  
                acp.EMPL_STATUS,
                                                                                                                                                                                                                             
                acp.EFFDT,
                                                                                                                                                                                                                                   
                acp.EFFSEQ,
                                                                                                                                                                                                                                  
                acp.EMPL_RCD,
                                                                                                                                                                                                                                
                acp.HIRE_DT,
                                                                                                                                                                                                                                 
                'Most Recent A->T Status Change' AS NOTE
                                                                                                                                                                                                     
            FROM ActualChangePoints acp
                                                                                                                                                                                                                      
            WHERE acp.rn_of_change = 1
                                                                                                                                                                                                                       
                AND acp.EFFDT >= acp.HIRE_DT -- Ensure EFFDT >= HIRE_DT
                                                                                                                                                                                      
                AND acp.previous_EMPL_STATUS = 'A' -- Previous status was Active
                                                                                                                                                                             
                AND acp.EMPL_STATUS = 'T'
                                                                                                                                                                                                                    
            -- Current status is Terminated
                                                                                                                                                                                                                  
        ),
                                                                                                                                                                                                                                                   
        MostRecentHireDateChangeRecordsCTE
                                                                                                                                                                                                                   
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            -- Dataset 2: Records that occur AFTER the MOST RECENT HIRE_DT change
                                                                                                                                                                            
            SELECT
                                                                                                                                                                                                                                           
                hdc.emplid,
                                                                                                                                                                                                                                  
                hdc.EMPL_STATUS,
                                                                                                                                                                                                                             
                hdc.EFFDT,
                                                                                                                                                                                                                                   
                hdc.EFFSEQ,
                                                                                                                                                                                                                                  
                hdc.EMPL_RCD,
                                                                                                                                                                                                                                
                hdc.HIRE_DT,
                                                                                                                                                                                                                                 
                'After Most Recent HIRE_DT Change' AS NOTE
                                                                                                                                                                                                   
            FROM HireDateChanges hdc
                                                                                                                                                                                                                         
            WHERE hdc.hire_change_rank = 1
                                                                                                                                                                                                                   
        ),
                                                                                                                                                                                                                                                   
        LatestChangeRecordsCTE
                                                                                                                                                                                                                               
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            -- Dataset 3: Latest EMPL_STATUS change record for each employee (fallback)
                                                                                                                                                                      
            SELECT
                                                                                                                                                                                                                                           
                acp.emplid,
                                                                                                                                                                                                                                  
                acp.EMPL_STATUS,
                                                                                                                                                                                                                             
                acp.EFFDT,
                                                                                                                                                                                                                                   
                acp.EFFSEQ,
                                                                                                                                                                                                                                  
                acp.EMPL_RCD,
                                                                                                                                                                                                                                
                acp.HIRE_DT,
                                                                                                                                                                                                                                 
                'Latest Status Change' AS NOTE
                                                                                                                                                                                                               
            FROM ActualChangePoints acp
                                                                                                                                                                                                                      
            WHERE acp.rn_of_change = 1
                                                                                                                                                                                                                       
        )
                                                                                                                                                                                                                                                    
    MERGE [stage].[UKG_EMPL_STATUS_LOOKUP_RETRO_ONLY] AS TARGET
                                                                                                                                                                                              
    USING (
                                                                                                                                                                                                                                                  
        SELECT --top 1000
                                                                                                                                                                                                                                    
        UnionData.emplid,
                                                                                                                                                                                                                                    
        UnionData.EMPL_STATUS,
                                                                                                                                                                                                                               
        UnionData.EFFDT,
                                                                                                                                                                                                                                     
        UnionData.EFFSEQ,
                                                                                                                                                                                                                                    
        UnionData.EMPL_RCD,
                                                                                                                                                                                                                                  
        UnionData.HIRE_DT,
                                                                                                                                                                                                                                   
        UnionData.NOTE,
                                                                                                                                                                                                                                      
        GETDATE() AS LOAD_DTTM
                                                                                                                                                                                                                               
    FROM (
                                                                                                                                                                                                                                                   
        -- Priority 1: Most recent record when EMPL_STATUS changed from 'A' to 'T' - HIGHEST PRIORITY
                                                                                                                                                        
                                                                                                                                                                                                            SELECT emplid, EMPL_STATUS, EFFDT, EFFSEQ, EMPL_RCD
, HIRE_DT, NOTE
                                                                                                                                                                                                                                              
            FROM MostRecentStatusChangeRecordsCTE
                                                                                                                                                                                                            

                                                                                                                                                                                                                                                             
        UNION ALL
                                                                                                                                                                                                                                            

                                                                                                                                                                                                                                                             
            -- Priority 2: Records after MOST RECENT HIRE_DT change
                                                                                                                                                                                          
            SELECT emplid, EMPL_STATUS, EFFDT, EFFSEQ, EMPL_RCD, HIRE_DT, NOTE
                                                                                                                                                                               
            FROM MostRecentHireDateChangeRecordsCTE
                                                                                                                                                                                                          
            WHERE emplid NOT IN (SELECT EMPLID
                                                                                                                                                                                                               
            FROM MostRecentStatusChangeRecordsCTE)
                                                                                                                                                                                                           

                                                                                                                                                                                                                                                             
        UNION ALL
                                                                                                                                                                                                                                            

                                                                                                                                                                                                                                                             
            -- Priority 3: Latest EMPL_STATUS change (fallback)
                                                                                                                                                                                              
            SELECT emplid, EMPL_STATUS, EFFDT, EFFSEQ, EMPL_RCD, HIRE_DT, NOTE
                                                                                                                                                                               
            FROM LatestChangeRecordsCTE
                                                                                                                                                                                                                      
            WHERE emplid NOT IN (SELECT EMPLID
                                                                                                                                                                                                               
                FROM MostRecentStatusChangeRecordsCTE)
                                                                                                                                                                                                       
                AND emplid NOT IN (SELECT EMPLID
                                                                                                                                                                                                             
                FROM MostRecentHireDateChangeRecordsCTE)
                                                                                                                                                                                                     

                                                                                                                                                                                                                                                             
        UNION ALL
                                                                                                                                                                                                                                            

                                                                                                                                                                                                                                                             
            -- Priority 4: Oldest record (final fallback when no changes exist)
                                                                                                                                                                              
            SELECT emplid, EMPL_STATUS, EFFDT, EFFSEQ, EMPL_RCD, HIRE_DT, NOTE
                                                                                                                                                                               
            FROM OldestRecordsCTE
                                                                                                                                                                                                                            
            WHERE emplid NOT IN (SELECT EMPLID
                                                                                                                                                                                                               
                FROM MostRecentStatusChangeRecordsCTE)
                                                                                                                                                                                                       
                AND emplid NOT IN (SELECT EMPLID
                                                                                                                                                                                                             
                FROM MostRecentHireDateChangeRecordsCTE)
                                                                                                                                                                                                     
                AND emplid NOT IN (SELECT EMPLID
                                                                                                                                                                                                             
                FROM LatestChangeRecordsCTE)
                                                                                                                                                                                                                 
        ) AS UnionData
                                                                                                                                                                                                                                       
    ) AS SOURCE
                                                                                                                                                                                                                                              
    ON (TARGET.emplid = SOURCE.emplid
                                                                                                                                                                                                                        
        AND TARGET.EMPL_STATUS = SOURCE.EMPL_STATUS
                                                                                                                                                                                                          
        AND TARGET.EFFDT = SOURCE.EFFDT
                                                                                                                                                                                                                      
        AND TARGET.EFFSEQ = SOURCE.EFFSEQ
                                                                                                                                                                                                                    
        AND TARGET.EMPL_RCD = SOURCE.EMPL_RCD
                                                                                                                                                                                                                
        AND TARGET.HIRE_DT = SOURCE.HIRE_DT)
                                                                                                                                                                                                                 
    WHEN NOT MATCHED THEN
                                                                                                                                                                                                                                    
        INSERT (emplid, EMPL_STATUS, EFFDT, EFFSEQ, EMPL_RCD, HIRE_DT, NOTE, LOAD_DTTM)
                                                                                                                                                                      
        VALUES (SOURCE.emplid, SOURCE.EMPL_STATUS, SOURCE.EFFDT, SOURCE.EFFSEQ, SOURCE.EMPL_RCD, SOURCE.HIRE_DT, SOURCE.NOTE, SOURCE.LOAD_DTTM);
                                                                                                             

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
    -- Create index on emplid for better performance
                                                                                                                                                                                                         
    CREATE INDEX IX_UKG_EMPL_STATUS_LOOKUP_RETRO_ONLY_emplid ON [stage].[UKG_EMPL_STATUS_LOOKUP_RETRO_ONLY] (emplid);
                                                                                                                                        

                                                                                                                                                                                                                                                             
END;

-- ===== stage.SP_UKG_EMPL_Update_Manager_Flag-Step4 =====

                                                                                                                                                                                                                                                             
/***************************************
                                                                                                                                                                                                                     
* Created By: Jim Shih
                                                                                                                                                                                                                                       
* Procedure: stage.SP_UKG_EMPL_Update_Manager_Flag-Step4
                                                                                                                                                                                                     
* Purpose: Updates Manager Flag to 'F' for employees in vacant manager positions (positions flagged as managers but with no active direct reports)
                                                                                                           
* 
                                                                                                                                                                                                                                                           
* Performance Optimizations (12/03/2025):
                                                                                                                                                                                                                    
* - Added comprehensive indexing strategy for temporary tables:
                                                                                                                                                                                              
*   * #mPOSN_Manager_Flag_To_Update: PRIMARY KEY (position_nbr) - Fast UPDATE and JOIN operations
                                                                                                                                                            
*   * #TerminatedEmployees: Clustered on reports_to, nonclustered on emplid - Optimizes terminated employee lookups
                                                                                                                                          
*   * #ManagerPositions: Clustered on position_nbr, nonclustered on emplid - Optimizes manager position processing
                                                                                                                                           
* - Created reusable temporary tables to eliminate repetitive CTE calculations
                                                                                                                                                                               
* - Total: 6 performance indexes to optimize manager flag update operations
                                                                                                                                                                                  
* - Improved execution plans for large-scale manager flag corrections
                                                                                                                                                                                        
* 
                                                                                                                                                                                                                                                           
* EXEC [stage].[SP_UKG_EMPL_Update_Manager_Flag-Step4]
                                                                                                                                                                                                       
* -- 09/15/2025 Jim Shih: Created procedure based on 46.sql logic
                                                                                                                                                                                            
* --                      Uses CTE mPOSN_Manager_Flag_To_Update to identify vacant manager positions
                                                                                                                                                         
* --                      Updates Manager Flag to 'F' for employees whose position_nbr matches vacant manager positions
                                                                                                                                      
* --                      Vacant manager positions = positions where Manager Flag='T' but no active employees report to them
                                                                                                                                 
* --                      Update Manager Flag to 'T' for positions that have terminated employees reporting to them
                                                                                                                                          
* --                      These positions may still be considered manager positions due to historical reporting relationships
                                                                                                                                
* --                      Update Manager Flag to 'F' for positions with NO reports at all (active or terminated)
                                                                                                                                             
* --                      This corrects cases where Manager Flag was incorrectly set to 'T' during initial data load or manual settings
                                                                                                                      
* -- 09/17/2025 Jim Shih: Added third update step to set Manager Flag to 'F' for positions with no reports at all
                                                                                                                                            
* --                      This addresses cases where Manager Flag was incorrectly set to 'T' during initial data load or manual settings
                                                                                                                     
* -- 12/02/2025 Jim Shih: replace [dbo].[UKG_EMPLOYEE_DATA] with [dbo].[UKG_EMPLOYEE_DATA_TEMP]
                                                                                                                                                              
* -- 12/03/2025 Jim Shih: Added comprehensive performance optimization with indexed temporary tables
                                                                                                                                                         
******************************************/
                                                                                                                                                                                                                  

                                                                                                                                                                                                                                                             
CREATE   PROCEDURE [stage].[SP_UKG_EMPL_Update_Manager_Flag-Step4]
                                                                                                                                                                                           
AS
                                                                                                                                                                                                                                                           
BEGIN
                                                                                                                                                                                                                                                        
    SET NOCOUNT ON;
                                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    -- Performance Optimization: Create indexed temporary tables for reusable data
                                                                                                                                                                           

                                                                                                                                                                                                                                                             
    -- Create temp table for terminated employees (reusable across multiple operations)
                                                                                                                                                                      
    DROP TABLE IF EXISTS #TerminatedEmployees;
                                                                                                                                                                                                               
    CREATE TABLE #TerminatedEmployees
                                                                                                                                                                                                                        
    (
                                                                                                                                                                                                                                                        
        emplid VARCHAR(11),
                                                                                                                                                                                                                                  
        reports_to VARCHAR(20)
                                                                                                                                                                                                                               
    );
                                                                                                                                                                                                                                                       

                                                                                                                                                                                                                                                             
    INSERT INTO #TerminatedEmployees
                                                                                                                                                                                                                         
        (emplid, reports_to)
                                                                                                                                                                                                                                 
    SELECT emplid, reports_to
                                                                                                                                                                                                                                
    FROM [dbo].[UKG_EMPLOYEE_DATA_TEMP]
                                                                                                                                                                                                                      
    WHERE [hr_status] = 'I';
                                                                                                                                                                                                                                 

                                                                                                                                                                                                                                                             
    -- Add indexes for optimal performance
                                                                                                                                                                                                                   
    CREATE CLUSTERED INDEX IX_TerminatedEmployees_ReportsTo ON #TerminatedEmployees (reports_to);
                                                                                                                                                            
    CREATE NONCLUSTERED INDEX IX_TerminatedEmployees_EmplId ON #TerminatedEmployees (emplid);
                                                                                                                                                                

                                                                                                                                                                                                                                                             
    -- Create temp table for manager positions (reusable across multiple operations)
                                                                                                                                                                         
    DROP TABLE IF EXISTS #ManagerPositions;
                                                                                                                                                                                                                  
    CREATE TABLE #ManagerPositions
                                                                                                                                                                                                                           
    (
                                                                                                                                                                                                                                                        
        emplid VARCHAR(11),
                                                                                                                                                                                                                                  
        position_nbr VARCHAR(20),
                                                                                                                                                                                                                            
        manager_flag CHAR(1),
                                                                                                                                                                                                                                
        first_name VARCHAR(50),
                                                                                                                                                                                                                              
        last_name VARCHAR(50)
                                                                                                                                                                                                                                
    );
                                                                                                                                                                                                                                                       

                                                                                                                                                                                                                                                             
    INSERT INTO #ManagerPositions
                                                                                                                                                                                                                            
        (emplid, position_nbr, manager_flag, first_name, last_name)
                                                                                                                                                                                          
    SELECT emplid, [position_nbr], [Manager Flag], [First Name], [Last Name]
                                                                                                                                                                                 
    FROM [dbo].[UKG_EMPLOYEE_DATA_TEMP]
                                                                                                                                                                                                                      
    WHERE [Manager Flag] = 'T';
                                                                                                                                                                                                                              

                                                                                                                                                                                                                                                             
    -- Add indexes for optimal performance
                                                                                                                                                                                                                   
    CREATE CLUSTERED INDEX IX_ManagerPositions_Position ON #ManagerPositions (position_nbr);
                                                                                                                                                                 
    CREATE NONCLUSTERED INDEX IX_ManagerPositions_EmplId ON #ManagerPositions (emplid);
                                                                                                                                                                      

                                                                                                                                                                                                                                                             
    -- Create temp table to store vacant manager positions with enhanced structure
                                                                                                                                                                           
    DROP TABLE IF EXISTS #mPOSN_Manager_Flag_To_Update;
                                                                                                                                                                                                      
    CREATE TABLE #mPOSN_Manager_Flag_To_Update
                                                                                                                                                                                                               
    (
                                                                                                                                                                                                                                                        
        position_nbr VARCHAR(20) PRIMARY KEY,
                                                                                                                                                                                                                
        update_reason VARCHAR(100)
                                                                                                                                                                                                                           
    );
                                                                                                                                                                                                                                                       

                                                                                                                                                                                                                                                             
    -- Insert vacant manager positions into temp table using optimized indexed tables
                                                                                                                                                                        
    -- Enhanced CTE logic using pre-indexed temporary tables for better performance
                                                                                                                                                                          
    WITH
                                                                                                                                                                                                                                                     
        VacantPositions
                                                                                                                                                                                                                                      
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT DISTINCT
                                                                                                                                                                                                                                  
                mPOSN.[position_nbr]
                                                                                                                                                                                                                         
            FROM #ManagerPositions mPOSN
                                                                                                                                                                                                                     
                INNER JOIN health_ods.[health_ods].[RPT].[CURRENT_EMPL_DATA] empl
                                                                                                                                                                            
                ON mPOSN.position_nbr = empl.[POSITION_REPORTS_TO]
                                                                                                                                                                                           
            WHERE empl.MANAGER_EMPLID IS NOT NULL
                                                                                                                                                                                                            
            GROUP BY mPOSN.[position_nbr]
                                                                                                                                                                                                                    
            HAVING SUM(CASE WHEN empl.HR_STATUS = 'A' THEN 1 ELSE 0 END) = 0
                                                                                                                                                                                 
        )
                                                                                                                                                                                                                                                    
    INSERT INTO #mPOSN_Manager_Flag_To_Update
                                                                                                                                                                                                                
        (position_nbr, update_reason)
                                                                                                                                                                                                                        
    SELECT position_nbr, 'Vacant manager position - no active reports'
                                                                                                                                                                                       
    FROM VacantPositions;
                                                                                                                                                                                                                                    

                                                                                                                                                                                                                                                             
    -- Update Manager Flag to 'F' for employees in vacant manager positions
                                                                                                                                                                                  
    UPDATE E
                                                                                                                                                                                                                                                 
    SET [Manager Flag] = 'F'
                                                                                                                                                                                                                                 
    FROM [dbo].[UKG_EMPLOYEE_DATA_TEMP] E
                                                                                                                                                                                                                    
        INNER JOIN #mPOSN_Manager_Flag_To_Update VMP
                                                                                                                                                                                                         
        ON E.position_nbr = VMP.position_nbr;
                                                                                                                                                                                                                

                                                                                                                                                                                                                                                             
    -- Show summary of changes
                                                                                                                                                                                                                               
    SELECT
                                                                                                                                                                                                                                                   
        'Employees updated to Manager Flag = ''F''' as Description,
                                                                                                                                                                                          
        COUNT(*) as Count
                                                                                                                                                                                                                                    
    FROM [dbo].[UKG_EMPLOYEE_DATA_TEMP] E
                                                                                                                                                                                                                    
        INNER JOIN #mPOSN_Manager_Flag_To_Update VMP
                                                                                                                                                                                                         
        ON E.position_nbr = VMP.position_nbr;
                                                                                                                                                                                                                

                                                                                                                                                                                                                                                             
    -- Show the vacant positions that were updated
                                                                                                                                                                                                           
    PRINT 'Vacant manager positions updated:';
                                                                                                                                                                                                               
    SELECT DISTINCT
                                                                                                                                                                                                                                          
        E.position_nbr,
                                                                                                                                                                                                                                      
        E.emplid,
                                                                                                                                                                                                                                            
        E.[First Name] + ' ' + E.[Last Name] as Employee_Name,
                                                                                                                                                                                               
        E.[Manager Flag]
                                                                                                                                                                                                                                     
    FROM [dbo].[UKG_EMPLOYEE_DATA_TEMP] E
                                                                                                                                                                                                                    
        INNER JOIN #mPOSN_Manager_Flag_To_Update VMP
                                                                                                                                                                                                         
        ON E.position_nbr = VMP.position_nbr
                                                                                                                                                                                                                 
    ORDER BY E.position_nbr;
                                                                                                                                                                                                                                 

                                                                                                                                                                                                                                                             
    -- Update Manager Flag to 'T' for positions that have terminated employees reporting to them
                                                                                                                                                             
    -- Optimized using indexed temporary tables for better performance
                                                                                                                                                                                       
    UPDATE E
                                                                                                                                                                                                                                                 
    SET [Manager Flag] = 'T'
                                                                                                                                                                                                                                 
    FROM [dbo].[UKG_EMPLOYEE_DATA_TEMP] E
                                                                                                                                                                                                                    
        INNER JOIN (
                                                                                                                                                                                                                                         
        SELECT DISTINCT E2.emplid, E2.position_nbr
                                                                                                                                                                                                           
        FROM [dbo].[UKG_EMPLOYEE_DATA_TEMP] E2
                                                                                                                                                                                                               
            INNER JOIN #TerminatedEmployees TE ON E2.position_nbr = TE.reports_to
                                                                                                                                                                            
    ) mPOSN_Manager_Flag_To_Update_To_T
                                                                                                                                                                                                                      
        ON E.emplid = mPOSN_Manager_Flag_To_Update_To_T.emplid
                                                                                                                                                                                               
            AND E.position_nbr = mPOSN_Manager_Flag_To_Update_To_T.position_nbr;
                                                                                                                                                                             

                                                                                                                                                                                                                                                             
    -- Show summary of the second update using optimized indexed tables
                                                                                                                                                                                      
    PRINT 'Positions updated back to Manager Flag = ''T'' (have terminated employees):';
                                                                                                                                                                     
    SELECT
                                                                                                                                                                                                                                                   
        E.position_nbr,
                                                                                                                                                                                                                                      
        E.emplid,
                                                                                                                                                                                                                                            
        E.[First Name] + ' ' + E.[Last Name] as Employee_Name,
                                                                                                                                                                                               
        E.[Manager Flag],
                                                                                                                                                                                                                                    
        COUNT(TE.emplid) as Terminated_Reports_Count
                                                                                                                                                                                                         
    FROM [dbo].[UKG_EMPLOYEE_DATA_TEMP] E
                                                                                                                                                                                                                    
        INNER JOIN (
                                                                                                                                                                                                                                         
        SELECT DISTINCT E2.emplid, E2.position_nbr
                                                                                                                                                                                                           
        FROM [dbo].[UKG_EMPLOYEE_DATA_TEMP] E2
                                                                                                                                                                                                               
            INNER JOIN #TerminatedEmployees TE ON E2.position_nbr = TE.reports_to
                                                                                                                                                                            
    ) mPOSN_Manager_Flag_To_Update_To_T
                                                                                                                                                                                                                      
        ON E.emplid = mPOSN_Manager_Flag_To_Update_To_T.emplid
                                                                                                                                                                                               
            AND E.position_nbr = mPOSN_Manager_Flag_To_Update_To_T.position_nbr
                                                                                                                                                                              
        LEFT JOIN #TerminatedEmployees TE ON TE.reports_to = E.position_nbr
                                                                                                                                                                                  
    GROUP BY E.position_nbr, E.emplid, E.[First Name], E.[Last Name], E.[Manager Flag]
                                                                                                                                                                       
    ORDER BY E.position_nbr;
                                                                                                                                                                                                                                 

                                                                                                                                                                                                                                                             
    -- Update Manager Flag to 'F' for positions that have NO reports at all (active or terminated)
                                                                                                                                                           
    -- This handles cases where Manager Flag was incorrectly set to 'T' during initial data load or manual settings
                                                                                                                                          
    UPDATE E
                                                                                                                                                                                                                                                 
    SET [Manager Flag] = 'F'
                                                                                                                                                                                                                                 
    FROM [dbo].[UKG_EMPLOYEE_DATA_TEMP] E
                                                                                                                                                                                                                    
    WHERE E.[Manager Flag] = 'T'
                                                                                                                                                                                                                             
        AND NOT EXISTS (
                                                                                                                                                                                                                                     
            SELECT 1
                                                                                                                                                                                                                                         
        FROM [dbo].[UKG_EMPLOYEE_DATA_TEMP] reports
                                                                                                                                                                                                          
        WHERE reports.reports_to = E.position_nbr
                                                                                                                                                                                                            
            AND reports.emplid != E.emplid
                                                                                                                                                                                                                   
        );
                                                                                                                                                                                                                                                   

                                                                                                                                                                                                                                                             
    -- Show summary of the third update
                                                                                                                                                                                                                      
    PRINT 'Positions updated to Manager Flag = ''F'' (no reports found - initial load/manual setting issue):';
                                                                                                                                               
    SELECT
                                                                                                                                                                                                                                                   
        E.position_nbr,
                                                                                                                                                                                                                                      
        E.emplid,
                                                                                                                                                                                                                                            
        E.[First Name] + ' ' + E.[Last Name] as Employee_Name,
                                                                                                                                                                                               
        E.[Manager Flag],
                                                                                                                                                                                                                                    
        'No reports found - corrected from initial data load or manual setting' as Reason
                                                                                                                                                                    
    FROM [dbo].[UKG_EMPLOYEE_DATA_TEMP] E
                                                                                                                                                                                                                    
    WHERE E.[Manager Flag] = 'F'
                                                                                                                                                                                                                             
        AND NOT EXISTS (
                                                                                                                                                                                                                                     
            SELECT 1
                                                                                                                                                                                                                                         
        FROM [dbo].[UKG_EMPLOYEE_DATA_TEMP] reports
                                                                                                                                                                                                          
        WHERE reports.reports_to = E.position_nbr
                                                                                                                                                                                                            
            AND reports.emplid != E.emplid
                                                                                                                                                                                                                   
        )
                                                                                                                                                                                                                                                    
        AND E.emplid IN (
                                                                                                                                                                                                                                    
            -- Only show positions that were just updated in this step
                                                                                                                                                                                       
            SELECT emplid
                                                                                                                                                                                                                                    
        FROM [dbo].[UKG_EMPLOYEE_DATA_TEMP]
                                                                                                                                                                                                                  
        WHERE [Manager Flag] = 'F'
                                                                                                                                                                                                                           
            AND NOT EXISTS (
                                                                                                                                                                                                                                 
                    SELECT 1
                                                                                                                                                                                                                                 
            FROM [dbo].[UKG_EMPLOYEE_DATA_TEMP] reports
                                                                                                                                                                                                      
            WHERE reports.reports_to = position_nbr
                                                                                                                                                                                                          
                AND reports.emplid != emplid
                                                                                                                                                                                                                 
                )
                                                                                                                                                                                                                                            
        )
                                                                                                                                                                                                                                                    
    ORDER BY E.position_nbr;
                                                                                                                                                                                                                                 

                                                                                                                                                                                                                                                             
    -- Clean up all temporary tables for optimal resource management
                                                                                                                                                                                         
    DROP TABLE #mPOSN_Manager_Flag_To_Update;
                                                                                                                                                                                                                
    DROP TABLE #TerminatedEmployees;
                                                                                                                                                                                                                         
    DROP TABLE #ManagerPositions;
                                                                                                                                                                                                                            

                                                                                                                                                                                                                                                             
END;

-- ===== stage.SP_UKG_EMPLOYEE_DATA_DAILY_INCREMENTAL_HISTORY_INSERT =====

                                                                                                                                                                                                                                                             
/*
                                                                                                                                                                                                                                                           
    Stored Procedure: [stage].[SP_UKG_EMPLOYEE_DATA_DAILY_INCREMENTAL_HISTORY_INSERT]
                                                                                                                                                                        
    -- 10/08/2025 Jim Shih: Created
                                                                                                                                                                                                                          
    -- 12/03/2025 Jim Shih: Fixed match logic for proper incremental tracking
                                                                                                                                                                                
    -- 12/11/2025 Jim Shih: Enhanced Step 3 deletion logic to prevent duplicate records with same hash_value
                                                                                                                                                 
    
                                                                                                                                                                                                                                                         
    Description:
                                                                                                                                                                                                                                             
    This stored procedure incrementally inserts records from [dbo].[UKG_EMPLOYEE_DATA] into [dbo].[UKG_EMPLOYEE_DATA_DAILY_INCREMENTAL_HISTORY].
                                                                                                             
    - For each record, a hash value is calculated using HASHBYTES('md5', ...) on key columns to detect changes.
                                                                                                                                              
    - Uses three-way logic for comprehensive change tracking:
                                                                                                                                                                                                
      1. INSERT (NOTE='I'): New employees not in history
                                                                                                                                                                                                     
      2. UPDATE (NOTE='U'): Existing employees with changed data (hash mismatch)
                                                                                                                                                                             
      3. DELETE (NOTE='D'): Employees in history but no longer in current data
                                                                                                                                                                               
    - The current date is recorded as snapshot_date for each inserted record.
                                                                                                                                                                                
    - This enables complete tracking of all employee data changes over time.
                                                                                                                                                                                 

                                                                                                                                                                                                                                                             
    New Logic (12/03/2025):
                                                                                                                                                                                                                                  
    - If EMPLID exists in target but NOT in source ? Insert deletion record (NOTE='D')
                                                                                                                                                                       
    - If EMPLID matches but hash_value differs ? Insert update record (NOTE='U') 
                                                                                                                                                                            
    - If EMPLID from source NOT in target ? Insert new record (NOTE='I')
                                                                                                                                                                                     

                                                                                                                                                                                                                                                             
    Enhanced Logic (12/11/2025):
                                                                                                                                                                                                                             
    - Step 3 now prevents inserting duplicate deletion records when hash_value is the same
                                                                                                                                                                   
    - Only inserts deletion record if no prior deletion exists with same EMPLID and hash_value
                                                                                                                                                               
    - Maintains data integrity by avoiding redundant deletion entries
                                                                                                                                                                                        

                                                                                                                                                                                                                                                             
    Usage:
                                                                                                                                                                                                                                                   
    EXEC [stage].[SP_UKG_EMPLOYEE_DATA_DAILY_INCREMENTAL_HISTORY_INSERT]
                                                                                                                                                                                     
*/
                                                                                                                                                                                                                                                           

                                                                                                                                                                                                                                                             
CREATE   PROCEDURE [stage].[SP_UKG_EMPLOYEE_DATA_DAILY_INCREMENTAL_HISTORY_INSERT]
                                                                                                                                                                           
AS
                                                                                                                                                                                                                                                           
BEGIN
                                                                                                                                                                                                                                                        
    SET NOCOUNT ON;
                                                                                                                                                                                                                                          
    DECLARE @today DATE = CAST(GETDATE() AS DATE);
                                                                                                                                                                                                           
    DECLARE @recordsInserted INT = 0;
                                                                                                                                                                                                                        
    DECLARE @recordsUpdated INT = 0;
                                                                                                                                                                                                                         
    DECLARE @recordsDeleted INT = 0;
                                                                                                                                                                                                                         

                                                                                                                                                                                                                                                             
    BEGIN TRY
                                                                                                                                                                                                                                                
        BEGIN TRANSACTION;
                                                                                                                                                                                                                                   

                                                                                                                                                                                                                                                             
        -- Step 1: INSERT new records (NOTE='I') - EMPLIDs from source NOT in target history for today
                                                                                                                                                       
        INSERT INTO [dbo].[UKG_EMPLOYEE_DATA_DAILY_INCREMENTAL_HISTORY]
                                                                                                                                                                                      
        (
                                                                                                                                                                                                                                                    
        [DEPTID], [VC_CODE], [FDM_COMBO_CD], [COMBOCODE], [REPORTS_TO], [MANAGER_EMPLID], [NON_UKG_MANAGER_FLAG],
                                                                                                                                            
        [position_nbr], [EMPLID], [EMPL_RCD], [jobcode], [POSITION_DESCR], [hr_status], [FTE_SUM], [fte], [empl_Status],
                                                                                                                                     
        [JobGroup], [FundGroup], [Person Number], [First Name], [Last Name], [Middle Initial/Name], [Short Name],
                                                                                                                                            
        [Badge Number], [Hire Date], [Birth Date], [Seniority Date], [Manager Flag], [Phone 1], [Phone 2], [Email],
                                                                                                                                          
        [Address], [City], [State], [Postal Code], [Country], [Time Zone], [Employment Status], [Employment Status Effective Date],
                                                                                                                          
        [Reports to Manager], [Union Code], [Employee Type], [Employee Classification], [Pay Frequency], [Worker Type],
                                                                                                                                      
        [FTE %], [FTE Standard Hours], [FTE Full Time Hours], [Standard Hours - Daily], [Standard Hours - Weekly],
                                                                                                                                           
        [Standard Hours - Pay Period], [Base Wage Rate], [Base Wage Rate Effective Date], [User Account Name],
                                                                                                                                               
        [User Account Status], [User Password], [Home Business Structure Level 1 - Organization], [Home Business Structure Level 2 - Entity],
                                                                                                                
        [Home Business Structure Level 3 - Service Line], [Home Business Structure Level 4 - Financial Unit], [Home Business Structure Level 5 - Fund Group],
                                                                                                
        [Home Business Structure Level 6], [Home Business Structure Level 7], [Home Business Structure Level 8], [Home Business Structure Level 9],
                                                                                                          
        [Home/Primary Job], [Home Labor Category Level 1], [Home Labor Category Level 2], [Home Labor Category Level 3],
                                                                                                                                     
        [Home Labor Category Level 4], [Home Labor Category Level 5], [Home Labor Category Level 6], [Home Job and Labor Category Effective Date],
                                                                                                           
        [Custom Field 1], [Custom Field 2], [Custom Field 3], [Custom Field 4], [Custom Field 5], [Custom Field 6],
                                                                                                                                          
        [Custom Field 7], [Custom Field 8], [Custom Field 9], [Custom Field 10], [Custom Date 1], [Custom Date 2],
                                                                                                                                           
        [Custom Date 3], [Custom Date 4], [Custom Date 5], [Custom Field 11], [Custom Field 12], [Custom Field 13],
                                                                                                                                          
        [Custom Field 14], [Custom Field 15], [Custom Field 16], [Custom Field 17], [Custom Field 18], [Custom Field 19],
                                                                                                                                    
        [Custom Field 20], [Custom Field 21], [Custom Field 22], [Custom Field 23], [Custom Field 24], [Custom Field 25],
                                                                                                                                    
        [Custom Field 26], [Custom Field 27], [Custom Field 28], [Custom Field 29], [Custom Field 30], [Additional Fields for CRT lookups],
                                                                                                                  
        [termination_dt], [action], [action_dt], [hash_value], [NOTE], [snapshot_date]
                                                                                                                                                                       
        )
                                                                                                                                                                                                                                                    
    SELECT
                                                                                                                                                                                                                                                   
        src.[DEPTID], src.[VC_CODE], src.[FDM_COMBO_CD], src.[COMBOCODE], src.[REPORTS_TO], src.[MANAGER_EMPLID], src.[NON_UKG_MANAGER_FLAG],
                                                                                                                
        src.[position_nbr], src.[EMPLID], src.[EMPL_RCD], src.[jobcode], src.[POSITION_DESCR], src.[hr_status], src.[FTE_SUM], src.[fte], src.[empl_Status],
                                                                                                 
        src.[JobGroup], src.[FundGroup], src.[Person Number], src.[First Name], src.[Last Name], src.[Middle Initial/Name], src.[Short Name],
                                                                                                                
        src.[Badge Number], src.[Hire Date], src.[Birth Date], src.[Seniority Date], src.[Manager Flag], src.[Phone 1], src.[Phone 2], src.[Email],
                                                                                                          
        src.[Address], src.[City], src.[State], src.[Postal Code], src.[Country], src.[Time Zone], src.[Employment Status], src.[Employment Status Effective Date],
                                                                                          
        src.[Reports to Manager], src.[Union Code], src.[Employee Type], src.[Employee Classification], src.[Pay Frequency], src.[Worker Type],
                                                                                                              
        src.[FTE %], src.[FTE Standard Hours], src.[FTE Full Time Hours], src.[Standard Hours - Daily], src.[Standard Hours - Weekly],
                                                                                                                       
        src.[Standard Hours - Pay Period], src.[Base Wage Rate], src.[Base Wage Rate Effective Date], src.[User Account Name],
                                                                                                                               
        src.[User Account Status], src.[User Password], src.[Home Business Structure Level 1 - Organization], src.[Home Business Structure Level 2 - Entity],
                                                                                                
        src.[Home Business Structure Level 3 - Service Line], src.[Home Business Structure Level 4 - Financial Unit], src.[Home Business Structure Level 5 - Fund Group],
                                                                                    
        src.[Home Business Structure Level 6], src.[Home Business Structure Level 7], src.[Home Business Structure Level 8], src.[Home Business Structure Level 9],
                                                                                          
        src.[Home/Primary Job], src.[Home Labor Category Level 1], src.[Home Labor Category Level 2], src.[Home Labor Category Level 3],
                                                                                                                     
        src.[Home Labor Category Level 4], src.[Home Labor Category Level 5], src.[Home Labor Category Level 6], src.[Home Job and Labor Category Effective Date],
                                                                                           
        src.[Custom Field 1], src.[Custom Field 2], src.[Custom Field 3], src.[Custom Field 4], src.[Custom Field 5], src.[Custom Field 6],
                                                                                                                  
        src.[Custom Field 7], src.[Custom Field 8], src.[Custom Field 9], src.[Custom Field 10], src.[Custom Date 1], src.[Custom Date 2],
                                                                                                                   
        src.[Custom Date 3], src.[Custom Date 4], src.[Custom Date 5], src.[Custom Field 11], src.[Custom Field 12], src.[Custom Field 13],
                                                                                                                  
        src.[Custom Field 14], src.[Custom Field 15], src.[Custom Field 16], src.[Custom Field 17], src.[Custom Field 18], src.[Custom Field 19],
                                                                                                            
        src.[Custom Field 20], src.[Custom Field 21], src.[Custom Field 22], src.[Custom Field 23], src.[Custom Field 24], src.[Custom Field 25],
                                                                                                            
        src.[Custom Field 26], src.[Custom Field 27], src.[Custom Field 28], src.[Custom Field 29], src.[Custom Field 30], src.[Additional Fields for CRT lookups],
                                                                                          
        src.[termination_dt], src.[action], src.[action_dt],
                                                                                                                                                                                                 
        HASHBYTES('md5', CONCAT(src.EMPLID, src.DEPTID, src.VC_CODE, src.hr_status, src.empl_Status, src.termination_dt, src.action, src.action_dt)) AS hash_value,
                                                                                          
        'I' AS NOTE,
                                                                                                                                                                                                                                         
        @today AS snapshot_date
                                                                                                                                                                                                                              
    FROM [dbo].[UKG_EMPLOYEE_DATA] src
                                                                                                                                                                                                                       
    WHERE NOT EXISTS (
                                                                                                                                                                                                                                       
            SELECT 1
                                                                                                                                                                                                                                         
    FROM [dbo].[UKG_EMPLOYEE_DATA_DAILY_INCREMENTAL_HISTORY] hist
                                                                                                                                                                                            
    WHERE hist.EMPLID = src.EMPLID
                                                                                                                                                                                                                           
        );
                                                                                                                                                                                                                                                   

                                                                                                                                                                                                                                                             
        SET @recordsInserted = @@ROWCOUNT;
                                                                                                                                                                                                                   

                                                                                                                                                                                                                                                             
        -- Step 2: INSERT update records (NOTE='U') - EMPLIDs match but hash values differ
                                                                                                                                                                   
        INSERT INTO [dbo].[UKG_EMPLOYEE_DATA_DAILY_INCREMENTAL_HISTORY]
                                                                                                                                                                                      
        (
                                                                                                                                                                                                                                                    
        [DEPTID], [VC_CODE], [FDM_COMBO_CD], [COMBOCODE], [REPORTS_TO], [MANAGER_EMPLID], [NON_UKG_MANAGER_FLAG],
                                                                                                                                            
        [position_nbr], [EMPLID], [EMPL_RCD], [jobcode], [POSITION_DESCR], [hr_status], [FTE_SUM], [fte], [empl_Status],
                                                                                                                                     
        [JobGroup], [FundGroup], [Person Number], [First Name], [Last Name], [Middle Initial/Name], [Short Name],
                                                                                                                                            
        [Badge Number], [Hire Date], [Birth Date], [Seniority Date], [Manager Flag], [Phone 1], [Phone 2], [Email],
                                                                                                                                          
        [Address], [City], [State], [Postal Code], [Country], [Time Zone], [Employment Status], [Employment Status Effective Date],
                                                                                                                          
        [Reports to Manager], [Union Code], [Employee Type], [Employee Classification], [Pay Frequency], [Worker Type],
                                                                                                                                      
        [FTE %], [FTE Standard Hours], [FTE Full Time Hours], [Standard Hours - Daily], [Standard Hours - Weekly],
                                                                                                                                           
        [Standard Hours - Pay Period], [Base Wage Rate], [Base Wage Rate Effective Date], [User Account Name],
                                                                                                                                               
        [User Account Status], [User Password], [Home Business Structure Level 1 - Organization], [Home Business Structure Level 2 - Entity],
                                                                                                                
        [Home Business Structure Level 3 - Service Line], [Home Business Structure Level 4 - Financial Unit], [Home Business Structure Level 5 - Fund Group],
                                                                                                
        [Home Business Structure Level 6], [Home Business Structure Level 7], [Home Business Structure Level 8], [Home Business Structure Level 9],
                                                                                                          
        [Home/Primary Job], [Home Labor Category Level 1], [Home Labor Category Level 2], [Home Labor Category Level 3],
                                                                                                                                     
        [Home Labor Category Level 4], [Home Labor Category Level 5], [Home Labor Category Level 6], [Home Job and Labor Category Effective Date],
                                                                                                           
        [Custom Field 1], [Custom Field 2], [Custom Field 3], [Custom Field 4], [Custom Field 5], [Custom Field 6],
                                                                                                                                          
        [Custom Field 7], [Custom Field 8], [Custom Field 9], [Custom Field 10], [Custom Date 1], [Custom Date 2],
                                                                                                                                           
        [Custom Date 3], [Custom Date 4], [Custom Date 5], [Custom Field 11], [Custom Field 12], [Custom Field 13],
                                                                                                                                          
        [Custom Field 14], [Custom Field 15], [Custom Field 16], [Custom Field 17], [Custom Field 18], [Custom Field 19],
                                                                                                                                    
        [Custom Field 20], [Custom Field 21], [Custom Field 22], [Custom Field 23], [Custom Field 24], [Custom Field 25],
                                                                                                                                    
        [Custom Field 26], [Custom Field 27], [Custom Field 28], [Custom Field 29], [Custom Field 30], [Additional Fields for CRT lookups],
                                                                                                                  
        [termination_dt], [action], [action_dt], [hash_value], [NOTE], [snapshot_date]
                                                                                                                                                                       
        )
                                                                                                                                                                                                                                                    
    SELECT
                                                                                                                                                                                                                                                   
        src.[DEPTID], src.[VC_CODE], src.[FDM_COMBO_CD], src.[COMBOCODE], src.[REPORTS_TO], src.[MANAGER_EMPLID], src.[NON_UKG_MANAGER_FLAG],
                                                                                                                
        src.[position_nbr], src.[EMPLID], src.[EMPL_RCD], src.[jobcode], src.[POSITION_DESCR], src.[hr_status], src.[FTE_SUM], src.[fte], src.[empl_Status],
                                                                                                 
        src.[JobGroup], src.[FundGroup], src.[Person Number], src.[First Name], src.[Last Name], src.[Middle Initial/Name], src.[Short Name],
                                                                                                                
        src.[Badge Number], src.[Hire Date], src.[Birth Date], src.[Seniority Date], src.[Manager Flag], src.[Phone 1], src.[Phone 2], src.[Email],
                                                                                                          
        src.[Address], src.[City], src.[State], src.[Postal Code], src.[Country], src.[Time Zone], src.[Employment Status], src.[Employment Status Effective Date],
                                                                                          
        src.[Reports to Manager], src.[Union Code], src.[Employee Type], src.[Employee Classification], src.[Pay Frequency], src.[Worker Type],
                                                                                                              
        src.[FTE %], src.[FTE Standard Hours], src.[FTE Full Time Hours], src.[Standard Hours - Daily], src.[Standard Hours - Weekly],
                                                                                                                       
        src.[Standard Hours - Pay Period], src.[Base Wage Rate], src.[Base Wage Rate Effective Date], src.[User Account Name],
                                                                                                                               
        src.[User Account Status], src.[User Password], src.[Home Business Structure Level 1 - Organization], src.[Home Business Structure Level 2 - Entity],
                                                                                                
        src.[Home Business Structure Level 3 - Service Line], src.[Home Business Structure Level 4 - Financial Unit], src.[Home Business Structure Level 5 - Fund Group],
                                                                                    
        src.[Home Business Structure Level 6], src.[Home Business Structure Level 7], src.[Home Business Structure Level 8], src.[Home Business Structure Level 9],
                                                                                          
        src.[Home/Primary Job], src.[Home Labor Category Level 1], src.[Home Labor Category Level 2], src.[Home Labor Category Level 3],
                                                                                                                     
        src.[Home Labor Category Level 4], src.[Home Labor Category Level 5], src.[Home Labor Category Level 6], src.[Home Job and Labor Category Effective Date],
                                                                                           
        src.[Custom Field 1], src.[Custom Field 2], src.[Custom Field 3], src.[Custom Field 4], src.[Custom Field 5], src.[Custom Field 6],
                                                                                                                  
        src.[Custom Field 7], src.[Custom Field 8], src.[Custom Field 9], src.[Custom Field 10], src.[Custom Date 1], src.[Custom Date 2],
                                                                                                                   
        src.[Custom Date 3], src.[Custom Date 4], src.[Custom Date 5], src.[Custom Field 11], src.[Custom Field 12], src.[Custom Field 13],
                                                                                                                  
        src.[Custom Field 14], src.[Custom Field 15], src.[Custom Field 16], src.[Custom Field 17], src.[Custom Field 18], src.[Custom Field 19],
                                                                                                            
        src.[Custom Field 20], src.[Custom Field 21], src.[Custom Field 22], src.[Custom Field 23], src.[Custom Field 24], src.[Custom Field 25],
                                                                                                            
        src.[Custom Field 26], src.[Custom Field 27], src.[Custom Field 28], src.[Custom Field 29], src.[Custom Field 30], src.[Additional Fields for CRT lookups],
                                                                                          
        src.[termination_dt], src.[action], src.[action_dt],
                                                                                                                                                                                                 
        HASHBYTES('md5', CONCAT(src.EMPLID, src.DEPTID, src.VC_CODE, src.hr_status, src.empl_Status, src.termination_dt, src.action, src.action_dt)) AS hash_value,
                                                                                          
        'U' AS NOTE,
                                                                                                                                                                                                                                         
        @today AS snapshot_date
                                                                                                                                                                                                                              
    FROM [dbo].[UKG_EMPLOYEE_DATA] src
                                                                                                                                                                                                                       
        INNER JOIN (
                                                                                                                                                                                                                                         
            SELECT EMPLID, MAX(snapshot_date) AS latest_date
                                                                                                                                                                                                 
        FROM [dbo].[UKG_EMPLOYEE_DATA_DAILY_INCREMENTAL_HISTORY]
                                                                                                                                                                                             
        GROUP BY EMPLID
                                                                                                                                                                                                                                      
        ) latest ON src.EMPLID = latest.EMPLID
                                                                                                                                                                                                               
        INNER JOIN [dbo].[UKG_EMPLOYEE_DATA_DAILY_INCREMENTAL_HISTORY] hist
                                                                                                                                                                                  
        ON src.EMPLID = hist.EMPLID AND hist.snapshot_date = latest.latest_date
                                                                                                                                                                              
    WHERE hist.hash_value != HASHBYTES('md5', CONCAT(src.EMPLID, src.DEPTID, src.VC_CODE, src.hr_status, src.empl_Status, src.termination_dt, src.action, src.action_dt))
                                                                                    
        AND NOT EXISTS (
                                                                                                                                                                                                                                     
            SELECT 1
                                                                                                                                                                                                                                         
        FROM [dbo].[UKG_EMPLOYEE_DATA_DAILY_INCREMENTAL_HISTORY] check_today
                                                                                                                                                                                 
        WHERE check_today.EMPLID = src.EMPLID
                                                                                                                                                                                                                
            AND check_today.snapshot_date = @today
                                                                                                                                                                                                           
            AND check_today.NOTE IN ('I', 'U')
                                                                                                                                                                                                               
        );
                                                                                                                                                                                                                                                   

                                                                                                                                                                                                                                                             
        SET @recordsUpdated = @@ROWCOUNT;
                                                                                                                                                                                                                    

                                                                                                                                                                                                                                                             
        -- Step 3: INSERT deletion records (NOTE='D') - EMPLIDs in target but NOT in source
                                                                                                                                                                  
        INSERT INTO [dbo].[UKG_EMPLOYEE_DATA_DAILY_INCREMENTAL_HISTORY]
                                                                                                                                                                                      
        (
                                                                                                                                                                                                                                                    
        [DEPTID], [VC_CODE], [FDM_COMBO_CD], [COMBOCODE], [REPORTS_TO], [MANAGER_EMPLID], [NON_UKG_MANAGER_FLAG],
                                                                                                                                            
        [position_nbr], [EMPLID], [EMPL_RCD], [jobcode], [POSITION_DESCR], [hr_status], [FTE_SUM], [fte], [empl_Status],
                                                                                                                                     
        [JobGroup], [FundGroup], [Person Number], [First Name], [Last Name], [Middle Initial/Name], [Short Name],
                                                                                                                                            
        [Badge Number], [Hire Date], [Birth Date], [Seniority Date], [Manager Flag], [Phone 1], [Phone 2], [Email],
                                                                                                                                          
        [Address], [City], [State], [Postal Code], [Country], [Time Zone], [Employment Status], [Employment Status Effective Date],
                                                                                                                          
        [Reports to Manager], [Union Code], [Employee Type], [Employee Classification], [Pay Frequency], [Worker Type],
                                                                                                                                      
        [FTE %], [FTE Standard Hours], [FTE Full Time Hours], [Standard Hours - Daily], [Standard Hours - Weekly],
                                                                                                                                           
        [Standard Hours - Pay Period], [Base Wage Rate], [Base Wage Rate Effective Date], [User Account Name],
                                                                                                                                               
    [User Account Status], [User Password], [Home Business Structure Level 1 - Organization], [Home Business Structure Level 2 - Entity],
                                                                                                                    
        [Home Business Structure Level 3 - Service Line], [Home Business Structure Level 4 - Financial Unit], [Home Business Structure Level 5 - Fund Group],
                                                                                                
        [Home Business Structure Level 6], [Home Business Structure Level 7], [Home Business Structure Level 8], [Home Business Structure Level 9],
                                                                                                          
        [Home/Primary Job], [Home Labor Category Level 1], [Home Labor Category Level 2], [Home Labor Category Level 3],
                                                                                                                                     
        [Home Labor Category Level 4], [Home Labor Category Level 5], [Home Labor Category Level 6], [Home Job and Labor Category Effective Date],
                                                                                                           
        [Custom Field 1], [Custom Field 2], [Custom Field 3], [Custom Field 4], [Custom Field 5], [Custom Field 6],
                                                                                                                                          
        [Custom Field 7], [Custom Field 8], [Custom Field 9], [Custom Field 10], [Custom Date 1], [Custom Date 2],
                                                                                                                                           
        [Custom Date 3], [Custom Date 4], [Custom Date 5], [Custom Field 11], [Custom Field 12], [Custom Field 13],
                                                                                                                                          
        [Custom Field 14], [Custom Field 15], [Custom Field 16], [Custom Field 17], [Custom Field 18], [Custom Field 19],
                                                                                                                                    
        [Custom Field 20], [Custom Field 21], [Custom Field 22], [Custom Field 23], [Custom Field 24], [Custom Field 25],
                                                                                                                                    
        [Custom Field 26], [Custom Field 27], [Custom Field 28], [Custom Field 29], [Custom Field 30], [Additional Fields for CRT lookups],
                                                                                                                  
        [termination_dt], [action], [action_dt], [hash_value], [NOTE], [snapshot_date]
                                                                                                                                                                       
        )
                                                                                                                                                                                                                                                    
    SELECT
                                                                                                                                                                                                                                                   
        hist.[DEPTID], hist.[VC_CODE], hist.[FDM_COMBO_CD], hist.[COMBOCODE], hist.[REPORTS_TO], hist.[MANAGER_EMPLID], hist.[NON_UKG_MANAGER_FLAG],
                                                                                                         
        hist.[position_nbr], hist.[EMPLID], hist.[EMPL_RCD], hist.[jobcode], hist.[POSITION_DESCR], hist.[hr_status], hist.[FTE_SUM], hist.[fte], hist.[empl_Status],
                                                                                        
        hist.[JobGroup], hist.[FundGroup], hist.[Person Number], hist.[First Name], hist.[Last Name], hist.[Middle Initial/Name], hist.[Short Name],
                                                                                                         
        hist.[Badge Number], hist.[Hire Date], hist.[Birth Date], hist.[Seniority Date], hist.[Manager Flag], hist.[Phone 1], hist.[Phone 2], hist.[Email],
                                                                                                  
        hist.[Address], hist.[City], hist.[State], hist.[Postal Code], hist.[Country], hist.[Time Zone], hist.[Employment Status], hist.[Employment Status Effective Date],
                                                                                  
        hist.[Reports to Manager], hist.[Union Code], hist.[Employee Type], hist.[Employee Classification], hist.[Pay Frequency], hist.[Worker Type],
                                                                                                        
        hist.[FTE %], hist.[FTE Standard Hours], hist.[FTE Full Time Hours], hist.[Standard Hours - Daily], hist.[Standard Hours - Weekly],
                                                                                                                  
        hist.[Standard Hours - Pay Period], hist.[Base Wage Rate], hist.[Base Wage Rate Effective Date], hist.[User Account Name],
                                                                                                                           
        hist.[User Account Status], hist.[User Password], hist.[Home Business Structure Level 1 - Organization], hist.[Home Business Structure Level 2 - Entity],
                                                                                            
        hist.[Home Business Structure Level 3 - Service Line], hist.[Home Business Structure Level 4 - Financial Unit], hist.[Home Business Structure Level 5 - Fund Group],
                                                                                 
        hist.[Home Business Structure Level 6], hist.[Home Business Structure Level 7], hist.[Home Business Structure Level 8], hist.[Home Business Structure Level 9],
                                                                                      
        hist.[Home/Primary Job], hist.[Home Labor Category Level 1], hist.[Home Labor Category Level 2], hist.[Home Labor Category Level 3],
                                                                                                                 
        hist.[Home Labor Category Level 4], hist.[Home Labor Category Level 5], hist.[Home Labor Category Level 6], hist.[Home Job and Labor Category Effective Date],
                                                                                       
        hist.[Custom Field 1], hist.[Custom Field 2], hist.[Custom Field 3], hist.[Custom Field 4], hist.[Custom Field 5], hist.[Custom Field 6],
                                                                                                            
        hist.[Custom Field 7], hist.[Custom Field 8], hist.[Custom Field 9], hist.[Custom Field 10], hist.[Custom Date 1], hist.[Custom Date 2],
                                                                                                             
        hist.[Custom Date 3], hist.[Custom Date 4], hist.[Custom Date 5], hist.[Custom Field 11], hist.[Custom Field 12], hist.[Custom Field 13],
                                                                                                            
        hist.[Custom Field 14], hist.[Custom Field 15], hist.[Custom Field 16], hist.[Custom Field 17], hist.[Custom Field 18], hist.[Custom Field 19],
                                                                                                      
        hist.[Custom Field 20], hist.[Custom Field 21], hist.[Custom Field 22], hist.[Custom Field 23], hist.[Custom Field 24], hist.[Custom Field 25],
                                                                                                      
        hist.[Custom Field 26], hist.[Custom Field 27], hist.[Custom Field 28], hist.[Custom Field 29], hist.[Custom Field 30], hist.[Additional Fields for CRT lookups],
                                                                                    
        hist.[termination_dt], hist.[action], hist.[action_dt], hist.[hash_value],
                                                                                                                                                                           
        'D' AS NOTE,
                                                                                                                                                                                                                                         
        @today AS snapshot_date
                                                                                                                                                                                                                              
    FROM [dbo].[UKG_EMPLOYEE_DATA_DAILY_INCREMENTAL_HISTORY] hist
                                                                                                                                                                                            
        INNER JOIN (
                                                                                                                                                                                                                                         
            SELECT EMPLID, MAX(snapshot_date) AS latest_date
                                                                                                                                                                                                 
        FROM [dbo].[UKG_EMPLOYEE_DATA_DAILY_INCREMENTAL_HISTORY]
                                                                                                                                                                                             
        GROUP BY EMPLID
                                                                                                                                                                                                                                      
        ) latest ON hist.EMPLID = latest.EMPLID AND hist.snapshot_date = latest.latest_date
                                                                                                                                                                  
    WHERE NOT EXISTS (
                                                                                                                                                                                                                                       
            SELECT 1
                                                                                                                                                                                                                                         
        FROM [dbo].[UKG_EMPLOYEE_DATA] src
                                                                                                                                                                                                                   
        WHERE src.EMPLID = hist.EMPLID
                                                                                                                                                                                                                       
        )
                                                                                                                                                                                                                                                    
        AND NOT EXISTS (
                                                                                                                                                                                                                                     
            SELECT 1
                                                                                                                                                                                                                                         
        FROM [dbo].[UKG_EMPLOYEE_DATA_DAILY_INCREMENTAL_HISTORY] check_today
                                                                                                                                                                                 
        WHERE check_today.EMPLID = hist.EMPLID
                                                                                                                                                                                                               
            AND check_today.snapshot_date = @today
                                                                                                                                                                                                           
            AND check_today.NOTE = 'D'
                                                                                                                                                                                                                       
        )
                                                                                                                                                                                                                                                    
        AND NOT EXISTS (
                                                                                                                                                                                                                                     
            SELECT 1
                                                                                                                                                                                                                                         
        FROM [dbo].[UKG_EMPLOYEE_DATA_DAILY_INCREMENTAL_HISTORY] check_same_hash
                                                                                                                                                                             
        WHERE check_same_hash.EMPLID = hist.EMPLID
                                                                                                                                                                                                           
            AND check_same_hash.hash_value = hist.hash_value
                                                                                                                                                                                                 
            AND check_same_hash.NOTE = 'D'
                                                                                                                                                                                                                   
        );
                                                                                                                                                                                                                                                   

                                                                                                                                                                                                                                                             
        SET @recordsDeleted = @@ROWCOUNT;
                                                                                                                                                                                                                    

                                                                                                                                                                                                                                                             
        COMMIT TRANSACTION;
                                                                                                                                                                                                                                  

                                                                                                                                                                                                                                                             
        -- Return summary
                                                                                                                                                                                                                                    
        SELECT
                                                                                                                                                                                                                                               
        'Daily Incremental History Update Completed' AS Status,
                                                                                                                                                                                              
        @recordsInserted AS Records_Inserted_I,
                                                                                                                                                                                                              
        @recordsUpdated AS Records_Updated_U,
                                                                                                                                                                                                                
        @recordsDeleted AS Records_Deleted_D,
                                                                                                                                                                                                                
        (@recordsInserted + @recordsUpdated + @recordsDeleted) AS Total_Records_Processed,
                                                                                                                                                                   
        @today AS Snapshot_Date;
                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
    END TRY
                                                                                                                                                                                                                                                  
    BEGIN CATCH
                                                                                                                                                                                                                                              
        IF @@TRANCOUNT > 0
                                                                                                                                                                                                                                   
            ROLLBACK TRANSACTION;
                                                                                                                                                                                                                            

                                                                                                                                                                                                                                                             
        DECLARE @ErrorMessage NVARCHAR(4000) = ERROR_MESSAGE();
                                                                                                                                                                                              
        DECLARE @ErrorSeverity INT = ERROR_SEVERITY();
                                                                                                                                                                                                       
        DECLARE @ErrorState INT = ERROR_STATE();
                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
        RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);
                                                                                                                                                                                              
    END CATCH
                                                                                                                                                                                                                                                
END

-- ===== stage.SP_UKG_EMPLOYEE_DATA_DAILY_INCREMENTAL_HISTORY_UPDATE_PROB_END_DT =====

                                                                                                                                                                                                                                                             
-- ==========================================================================================
                                                                                                                                                                
-- Stored Procedure Name: SP_UKG_EMPLOYEE_DATA_DAILY_INCREMENTAL_HISTORY_UPDATE_PROB_END_DT
                                                                                                                                                                  
-- Description: Updates the [Custom Date 1] column in the UKG_EMPLOYEE_DATA_DAILY_INCREMENTAL_HISTORY table
                                                                                                                                                  
--              with the uc_prob_end_dt value from the stage.UKG_probation_dt_retain_lookup_V view.
                                                                                                                                                          
--              Also updates the [NOTE] column with a message indicating the update and timestamp.
                                                                                                                                                           
-- exec [stage].[SP_UKG_EMPLOYEE_DATA_DAILY_INCREMENTAL_HISTORY_UPDATE_PROB_END_DT]
                                                                                                                                                                          
-- Created By: Jim Shih
                                                                                                                                                                                                                                      
-- Created On: 2026-01-28
                                                                                                                                                                                                                                    
-- Version: 1.1
                                                                                                                                                                                                                                              
-- Updated: 2026-01-29 Jim Shih - Only update rows where NOTE does not already contain the probation retention message
                                                                                                                                       
-- ==========================================================================================
                                                                                                                                                                
CREATE   PROCEDURE [stage].[SP_UKG_EMPLOYEE_DATA_DAILY_INCREMENTAL_HISTORY_UPDATE_PROB_END_DT]
                                                                                                                                                               
AS
                                                                                                                                                                                                                                                           
BEGIN
                                                                                                                                                                                                                                                        
    SET NOCOUNT ON;
                                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    BEGIN TRY
                                                                                                                                                                                                                                                
        BEGIN TRANSACTION;
                                                                                                                                                                                                                                   

                                                                                                                                                                                                                                                             
        -- Update the [Custom Date 1] and [NOTE] columns
                                                                                                                                                                                                     
        UPDATE [dbo].[UKG_EMPLOYEE_DATA_DAILY_INCREMENTAL_HISTORY]
                                                                                                                                                                                           
        SET 
                                                                                                                                                                                                                                                 
            [Custom Date 1] = DATEADD(DAY, 1, lookup.uc_prob_end_dt),
                                                                                                                                                                                        
            [NOTE] = CONCAT('U, Custom Date 1 has retained prob_end_dt and was updated on ', CONVERT(VARCHAR, GETDATE(), 120))
                                                                                                                               
        FROM [dbo].[UKG_EMPLOYEE_DATA_DAILY_INCREMENTAL_HISTORY] history
                                                                                                                                                                                     
        JOIN health_ods.[health_ods].stage.UKG_probation_dt_retain_lookup_V lookup
                                                                                                                                                                           
        ON history.position_nbr = lookup.position_nbr
                                                                                                                                                                                                        
        WHERE history.position_nbr IS NOT NULL
                                                                                                                                                                                                               
        AND (history.[NOTE] IS NULL OR history.[NOTE] NOT LIKE 'U, Custom Date 1 has retained prob_end_dt%');
                                                                                                                                                

                                                                                                                                                                                                                                                             
        -- Commit the transaction
                                                                                                                                                                                                                            
        COMMIT TRANSACTION;
                                                                                                                                                                                                                                  

                                                                                                                                                                                                                                                             
    END TRY
                                                                                                                                                                                                                                                  
    BEGIN CATCH
                                                                                                                                                                                                                                              
        -- Rollback the transaction in case of an error
                                                                                                                                                                                                      
        IF @@TRANCOUNT > 0
                                                                                                                                                                                                                                   
            ROLLBACK TRANSACTION;
                                                                                                                                                                                                                            

                                                                                                                                                                                                                                                             
        -- Raise the error
                                                                                                                                                                                                                                   
        THROW;
                                                                                                                                                                                                                                               
    END CATCH;
                                                                                                                                                                                                                                               
END;

-- ===== stage.SP_UKG_EMPLOYEE_DATA_HISTORY_INSERT =====

                                                                                                                                                                                                                                                             
CREATE   PROCEDURE [stage].[SP_UKG_EMPLOYEE_DATA_HISTORY_INSERT]
                                                                                                                                                                                             
AS
                                                                                                                                                                                                                                                           
BEGIN
                                                                                                                                                                                                                                                        
    SET NOCOUNT ON;
                                                                                                                                                                                                                                          
    DECLARE @today DATE = CAST(GETDATE() AS DATE);
                                                                                                                                                                                                           

                                                                                                                                                                                                                                                             
    INSERT INTO [dbo].[UKG_EMPLOYEE_DATA_WITH_HISTORY]
                                                                                                                                                                                                       
    SELECT *,
                                                                                                                                                                                                                                                
        HASHBYTES('md5', CONCAT(
                                                                                                                                                                                                                             
            EMPLID, DEPTID, VC_CODE, hr_status, empl_Status, termination_dt, action, action_dt
                                                                                                                                                               
        )) AS hash_value,
                                                                                                                                                                                                                                    
        NULL AS NOTE,
                                                                                                                                                                                                                                        
        @today AS snapshot_date
                                                                                                                                                                                                                              
    FROM [dbo].[UKG_EMPLOYEE_DATA] src
                                                                                                                                                                                                                       
    WHERE NOT EXISTS (
                                                                                                                                                                                                                                       
        SELECT 1
                                                                                                                                                                                                                                             
    FROM [dbo].[UKG_EMPLOYEE_DATA_WITH_HISTORY] hist
                                                                                                                                                                                                         
    WHERE hist.EMPLID = src.EMPLID
                                                                                                                                                                                                                           
        AND hist.hash_value = HASHBYTES('md5', CONCAT(
                                                                                                                                                                                                       
                src.EMPLID, src.DEPTID, src.VC_CODE, src.hr_status, src.empl_Status, src.termination_dt, src.action, src.action_dt
                                                                                                                           
            ))
                                                                                                                                                                                                                                               
    );
                                                                                                                                                                                                                                                       
END

-- ===== stage.SP_UKG_EMPLOYEE_DATA_RETRO_ONLY_INSERT =====

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
/**************************************************************************************************************************************************************************************************************************************************************
*
                                                                                                                                                                                                                                                            
--  Procedure Name: [stage].[SP_UKG_EMPLOYEE_DATA_RETRO_ONLY_INSERT]
                                                                                                                                                                                         
--  Author:         Jim Shih
                                                                                                                                                                                                                                 
--  Version:        1.0
                                                                                                                                                                                                                                      
--  Date:           10/27/2025
                                                                                                                                                                                                                               
--  Description:    This stored procedure inserts employee data into [stage].[UKG_EMPLOYEE_DATA_RETRO_ONLY] 
                                                                                                                                                 
--                  by joining a source table with the status lookup table.
                                                                                                                                                                                  
--                  Uses dynamic SQL to support flexible source table names and employee ID filtering.
                                                                                                                                                       
--
                                                                                                                                                                                                                                                           
--  Parameters:     
                                                                                                                                                                                                                                         
--                  @p_source_table NVARCHAR(200) - Source table name (e.g., 'BCK.[UKG_EMPLOYEE_DATA_V_SNAPSHOT_2025-10-21]')
                                                                                                                                
--                  @p_emplid NVARCHAR(20) - Employee ID to filter (e.g., '10664090')
                                                                                                                                                                        
--
                                                                                                                                                                                                                                                           
--  Example:        EXEC [stage].[SP_UKG_EMPLOYEE_DATA_RETRO_ONLY_INSERT] 
                                                                                                                                                                                   
--                      @p_source_table = 'BCK.[UKG_EMPLOYEE_DATA_V_SNAPSHOT_2025-10-21]',
                                                                                                                                                                   
--                      @p_emplid = '10664090';
                                                                                                                                                                                                              
--
                                                                                                                                                                                                                                                           
--  Version History:
                                                                                                                                                                                                                                         
--  Date        Author               Description
                                                                                                                                                                                                             
--  10/27/2025  Jim Shih             Initial procedure creation based on 20.sql
                                                                                                                                                                              
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

                                                                                                                                                                                                                                                             
*/
                                                                                                                                                                                                                                                           

                                                                                                                                                                                                                                                             
Create   PROCEDURE [stage].[SP_UKG_EMPLOYEE_DATA_RETRO_ONLY_INSERT]
                                                                                                                                                                                          
    @p_source_table NVARCHAR(200),
                                                                                                                                                                                                                           
    @p_emplid NVARCHAR(20)
                                                                                                                                                                                                                                   
AS
                                                                                                                                                                                                                                                           
BEGIN
                                                                                                                                                                                                                                                        
    SET NOCOUNT ON;
                                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    DECLARE @sql NVARCHAR(MAX);
                                                                                                                                                                                                                              
    DECLARE @table_check_sql NVARCHAR(MAX);
                                                                                                                                                                                                                  
    DECLARE @table_exists INT = 0;
                                                                                                                                                                                                                           

                                                                                                                                                                                                                                                             
    -- Check if source table exists
                                                                                                                                                                                                                          
    SET @table_check_sql = N'IF OBJECT_ID(''' + @p_source_table + ''') IS NOT NULL SET @table_exists_out = 1 ELSE SET @table_exists_out = 0';
                                                                                                                

                                                                                                                                                                                                                                                             
    BEGIN TRY
                                                                                                                                                                                                                                                
        EXEC sp_executesql @table_check_sql, N'@table_exists_out INT OUTPUT', @table_exists_out = @table_exists OUTPUT;
                                                                                                                                      
    END TRY
                                                                                                                                                                                                                                                  
    BEGIN CATCH
                                                                                                                                                                                                                                              
        PRINT 'ERROR: Cannot verify if source table ''' + @p_source_table + ''' exists.';
                                                                                                                                                                    
        PRINT 'Error: ' + ERROR_MESSAGE();
                                                                                                                                                                                                                   
        RETURN;
                                                                                                                                                                                                                                              
    END CATCH
                                                                                                                                                                                                                                                

                                                                                                                                                                                                                                                             
    IF @table_exists = 0
                                                                                                                                                                                                                                     
    BEGIN
                                                                                                                                                                                                                                                    
        PRINT 'ERROR: Source table ''' + @p_source_table + ''' does not exist.';
                                                                                                                                                                             
        PRINT 'Please verify the table name and schema.';
                                                                                                                                                                                                    
        RETURN;
                                                                                                                                                                                                                                              
    END
                                                                                                                                                                                                                                                      

                                                                                                                                                                                                                                                             
    PRINT 'Source table ''' + @p_source_table + ''' found. Proceeding with insert...';
                                                                                                                                                                       

                                                                                                                                                                                                                                                             
    -- Build dynamic SQL statement
                                                                                                                                                                                                                           
    SET @sql = N'
                                                                                                                                                                                                                                            
MERGE [stage].[UKG_EMPLOYEE_DATA_RETRO_ONLY] AS TARGET
                                                                                                                                                                                                       
USING (
                                                                                                                                                                                                                                                      
SELECT DISTINCT
                                                                                                                                                                                                                                              
    [Person Number]
                                                                                                                                                                                                                                          
      , [First Name]
                                                                                                                                                                                                                                         
      , [Last Name]
                                                                                                                                                                                                                                          
      , [Middle Initial/Name]
                                                                                                                                                                                                                                
      , [Short Name]
                                                                                                                                                                                                                                         
      , [Badge Number]
                                                                                                                                                                                                                                       
      , [Hire Date]
                                                                                                                                                                                                                                          
      , [Birth Date]
                                                                                                                                                                                                                                         
      , [Seniority Date]
                                                                                                                                                                                                                                     
      , [Manager Flag]
                                                                                                                                                                                                                                       
      , [Phone 1]
                                                                                                                                                                                                                                            
      , [Phone 2]
                                                                                                                                                                                                                                            
      , '''' as [Email]  --make email blank until ready for testing
                                                                                                                                                                                          
      , [Address]
                                                                                                                                                                                                                                            
      , [City]
                                                                                                                                                                                                                                               
      , [State]
                                                                                                                                                                                                                                              
      , [Postal Code]
                                                                                                                                                                                                                                        
      , [Country]
                                                                                                                                                                                                                                            
      , [Time Zone]
                                                                                                                                                                                                                                          
      , [Employment Status]
                                                                                                                                                                                                                                  
      , [Employment Status Effective Date]
                                                                                                                                                                                                                   
      , [Reports to Manager]
                                                                                                                                                                                                                                 
      , [Union Code]
                                                                                                                                                                                                                                         
      , [Employee Type]
                                                                                                                                                                                                                                      
      , [Employee Classification]
                                                                                                                                                                                                                            
      , [Pay Frequency]
                                                                                                                                                                                                                                      
      , [Worker Type]
                                                                                                                                                                                                                                        
      , [FTE %]
                                                                                                                                                                                                                                              
      , [FTE Standard Hours]
                                                                                                                                                                                                                                 
      , [FTE Full Time Hours]
                                                                                                                                                                                                                                
      , [Standard Hours - Daily]
                                                                                                                                                                                                                             
      , [Standard Hours - Weekly]
                                                                                                                                                                                                                            
      , [Standard Hours - Pay Period]
                                                                                                                                                                                                                        
      , [Base Wage Rate]
                                                                                                                                                                                                                                     
      , [Base Wage Rate Effective Date]
                                                                                                                                                                                                                      
      , [User Account Name]
                                                                                                                                                                                                                                  
      , [User Account Status]
                                                                                                                                                                                                                                
      , [User Password]
                                                                                                                                                                                                                                      
      , [Home Business Structure Level 1 - Organization]
                                                                                                                                                                                                     
      , [Home Business Structure Level 2 - Entity]
                                                                                                                                                                                                           
      , [Home Business Structure Level 3 - Service Line]
                                                                                                                                                                                                     
      , [Home Business Structure Level 4 - Financial Unit]
                                                                                                                                                                                                   
      , [Home Business Structure Level 5 - Fund Group]
                                                                                                                                                                                                       
      , [Home Business Structure Level 6]
                                                                                                                                                                                                                    
      , [Home Business Structure Level 7]
                                                                                                                                                                                                                    
      , [Home Business Structure Level 8]
                                                                                                                                                                                                                    
      , [Home Business Structure Level 9]
                                                                                                                                                                                                                    
      , [Home/Primary Job]
                                                                                                                                                                                                                                   
      , [Home Labor Category Level 1]
                                                                                                                                                                                                                        
      , [Home Labor Category Level 2]
                                                                                                                                                                                                                        
      , [Home Labor Category Level 3]
                                                                                                                                                                                                                        
      , [Home Labor Category Level 4]
                                                                                                                                                                                                                        
      , [Home Labor Category Level 5]
                                                                                                                                                                                                                        
      , [Home Labor Category Level 6]
                                                                                                                                                                                                                        
      , [Home Job and Labor Category Effective Date]
                                                                                                                                                                                                         
      , [Custom Field 1]
                                                                                                                                                                                                                                     
      , [Custom Field 2]
                                                                                                                                                                                                                                     
      , [Custom Field 3]
                                                                                                                                                                                                                                     
      , [Custom Field 4]
                                                                                                                                                                                                                                     
      , [Custom Field 5]
                                                                                                                                                                                                                                     
      , [Custom Field 6]
                                                                                                                                                                                                                                     
      , [Custom Field 7]
                                                                                                                                                                                                                                     
      , [Custom Field 8]
                                                                                                                                                                                                                                     
      , [Custom Field 9]
                                                                                                                                                                                                                                     
      , [Custom Field 10]
                                                                                                                                                                                                                                    
      , [Custom Date 1] -- re-order after [Custom Field 10]
                                                                                                                                                                                                  
      , [Custom Date 2]
                                                                                                                                                                                                                                      
      , [Custom Date 3]
                                                                                                                                                                                                                                      
      , [Custom Date 4]
                                                                                                                                                                                                                                      
      , [Custom Date 5]
                                                                                                                                                                                                                                      
      , [Custom Field 11]
                                                                                                                                                                                                                                    
      , [Custom Field 12]
                                                                                                                                                                                                                                    
      , [Custom Field 13]
                                                                                                                                                                                                                                    
      , [Custom Field 14]
                                                                                                                                                                                                                                    
      , [Custom Field 15]
                                                                                                                                                                                                                                    
      , [Custom Field 16]
                                                                                                                                                                                                                                    
      , [Custom Field 17]
                                                                                                                                                                                                                                    
      , [Custom Field 18]
                                                                                                                                                                                                                                    
      , [Custom Field 19]
                                                                                                                                                                                                                                    
      , [Custom Field 20]
                                                                                                                                                                                                                                    
      , [Custom Field 21]
                                                                                                                                                                                                                                    
      , [Custom Field 22]
                                                                                                                                                                                                                                    
      , [Custom Field 23]
                                                                                                                                                                                                                                    
      , [Custom Field 24]
                                                                                                                                                                                                                                    
      , [Custom Field 25]
                                                                                                                                                                                                                                    
      , [Custom Field 26]
                                                                                                                                                                                                                                    
      , [Custom Field 27]
                                                                                                                                                                                                                                    
      , [Custom Field 28]
                                                                                                                                                                                                                                    
      , [Custom Field 29]
                                                                                                                                                                                                                                    
      , [Custom Field 30]
                                                                                                                                                                                                                                    
      , [Additional Fields for CRT lookups]
                                                                                                                                                                                                                  
FROM ' + @p_source_table + N' A
                                                                                                                                                                                                                              
WHERE [Person Number] = @p_emplid_param
                                                                                                                                                                                                                      
) AS SOURCE
                                                                                                                                                                                                                                                  
ON (TARGET.[Person Number] = SOURCE.[Person Number]
                                                                                                                                                                                                          
    AND TARGET.[Hire Date] = SOURCE.[Hire Date]
                                                                                                                                                                                                              
    AND TARGET.[Employment Status] = SOURCE.[Employment Status]
                                                                                                                                                                                              
    AND TARGET.[Employment Status Effective Date] = SOURCE.[Employment Status Effective Date])
                                                                                                                                                               
WHEN NOT MATCHED THEN
                                                                                                                                                                                                                                        
INSERT
                                                                                                                                                                                                                                                       
    ([Person Number]
                                                                                                                                                                                                                                         
    ,[First Name]
                                                                                                                                                                                                                                            
    ,[Last Name]
                                                                                                                                                                                                                                             
    ,[Middle Initial/Name]
                                                                                                                                                                                                                                   
    ,[Short Name]
                                                                                                                                                                                                                                            
    ,[Badge Number]
                                                                                                                                                                                                                                          
    ,[Hire Date]
                                                                                                                                                                                                                                             
    ,[Birth Date]
                                                                                                                                                                                                                                            
    ,[Seniority Date]
                                                                                                                                                                                                                                        
    ,[Manager Flag]
                                                                                                                                                                                                                                          
    ,[Phone 1]
                                                                                                                                                                                                                                               
    ,[Phone 2]
                                                                                                                                                                                                                                               
    ,[Email]
                                                                                                                                                                                                                                                 
    ,[Address]
                                                                                                                                                                                                                                               
    ,[City]
                                                                                                                                                                                                                                                  
    ,[State]
                                                                                                                                                                                                                                                 
    ,[Postal Code]
                                                                                                                                                                                                                                           
    ,[Country]
                                                                                                                                                                                                                                               
    ,[Time Zone]
                                                                                                                                                                                                                                             
    ,[Employment Status]
                                                                                                                                                                                                                                     
    ,[Employment Status Effective Date]
                                                                                                                                                                                                                      
    ,[Reports to Manager]
                                                                                                                                                                                                                                    
    ,[Union Code]
                                                                                                                                                                                                                                            
    ,[Employee Type]
                                                                                                                                                                                                                                         
    ,[Employee Classification]
                                                                                                                                                                                                                               
    ,[Pay Frequency]
                                                                                                                                                                                                                                         
    ,[Worker Type]
                                                                                                                                                                                                                                           
    ,[FTE %]
                                                                                                                                                                                                                                                 
    ,[FTE Standard Hours]
                                                                                                                                                                                                                                    
    ,[FTE Full Time Hours]
                                                                                                                                                                                                                                   
    ,[Standard Hours - Daily]
                                                                                                                                                                                                                                
    ,[Standard Hours - Weekly]
                                                                                                                                                                                                                               
    ,[Standard Hours - Pay Period]
                                                                                                                                                                                                                           
    ,[Base Wage Rate]
                                                                                                                                                                                                                                        
    ,[Base Wage Rate Effective Date]
                                                                                                                                                                                                                         
    ,[User Account Name]
                                                                                                                                                                                                                                     
    ,[User Account Status]
                                                                                                                                                                                                                                   
    ,[User Password]
                                                                                                                                                                                                                                         
    ,[Home Business Structure Level 1 - Organization]
                                                                                                                                                                                                        
    ,[Home Business Structure Level 2 - Entity]
                                                                                                                                                                                                              
    ,[Home Business Structure Level 3 - Service Line]
                                                                                                                                                                                                        
    ,[Home Business Structure Level 4 - Financial Unit]
                                                                                                                                                                                                      
    ,[Home Business Structure Level 5 - Fund Group]
                                                                                                                                                                                                          
    ,[Home Business Structure Level 6]
                                                                                                                                                                                                                       
    ,[Home Business Structure Level 7]
                                                                                                                                                                                                                       
    ,[Home Business Structure Level 8]
                                                                                                                                                                                                                       
    ,[Home Business Structure Level 9]
                                                                                                                                                                                                                       
    ,[Home/Primary Job]
                                                                                                                                                                                                                                      
    ,[Home Labor Category Level 1]
                                                                                                                                                                                                                           
    ,[Home Labor Category Level 2]
                                                                                                                                                                                                                           
    ,[Home Labor Category Level 3]
                                                                                                                                                                                                                           
    ,[Home Labor Category Level 4]
                                                                                                                                                                                                                           
    ,[Home Labor Category Level 5]
                                                                                                                                                                                                                           
    ,[Home Labor Category Level 6]
                                                                                                                                                                                                                           
    ,[Home Job and Labor Category Effective Date]
                                                                                                                                                                                                            
    ,[Custom Field 1]
                                                                                                                                                                                                                                        
    ,[Custom Field 2]
                                                                                                                                                                                                                                        
    ,[Custom Field 3]
                                                                                                                                                                                                                                        
    ,[Custom Field 4]
                                                                                                                                                                                                                                        
    ,[Custom Field 5]
                                                                                                                                                                                                                                        
    ,[Custom Field 6]
                                                                                                                                                                                                                                        
    ,[Custom Field 7]
                                                                                                                                                                                                                                        
    ,[Custom Field 8]
                                                                                                                                                                                                                                        
    ,[Custom Field 9]
                                                                                                                                                                                                                                        
    ,[Custom Field 10]
                                                                                                                                                                                                                                       
    ,[Custom Date 1]
                                                                                                                                                                                                                                         
    ,[Custom Date 2]
                                                                                                                                                                                                                                         
    ,[Custom Date 3]
                                                                                                                                                                                                                                         
    ,[Custom Date 4]
                                                                                                                                                                                                                                         
    ,[Custom Date 5]
                                                                                                                                                                                                                                         
    ,[Custom Field 11]
                                                                                                                                                                                                                                       
    ,[Custom Field 12]
                                                                                                                                                                                                                                       
    ,[Custom Field 13]
                                                                                                                                                                                                                                       
    ,[Custom Field 14]
                                                                                                                                                                                                                                       
    ,[Custom Field 15]
                                                                                                                                                                                                                                       
    ,[Custom Field 16]
                                                                                                                                                                                                                                       
    ,[Custom Field 17]
                                                                                                                                                                                                                                       
    ,[Custom Field 18]
                                                                                                                                                                                                                                       
    ,[Custom Field 19]
                                                                                                                                                                                                                                       
    ,[Custom Field 20]
                                                                                                                                                                                                                                       
    ,[Custom Field 21]
                                                                                                                                                                                                                                       
    ,[Custom Field 22]
                                                                                                                                                                                                                                       
    ,[Custom Field 23]
                                                                                                                                                                                                                                       
    ,[Custom Field 24]
                                                                                                                                                                                                                                       
    ,[Custom Field 25]
                                                                                                                                                                                                                                       
    ,[Custom Field 26]
                                                                                                                                                                                                                                       
    ,[Custom Field 27]
                                                                                                                                                                                                                                       
    ,[Custom Field 28]
                                                                                                                                                                                                                                       
    ,[Custom Field 29]
                                                                                                                                                                                                                                       
    ,[Custom Field 30]
                                                                                                                                                                                                                                       
    ,[Additional Fields for CRT lookups]
                                                                                                                                                                                                                     
    )
                                                                                                                                                                                                                                                        
VALUES (
                                                                                                                                                                                                                                                     
    SOURCE.[Person Number]
                                                                                                                                                                                                                                   
      , SOURCE.[First Name]
                                                                                                                                                                                                                                  
      , SOURCE.[Last Name]
                                                                                                                                                                                                                                   
      , SOURCE.[Middle Initial/Name]
                                                                                                                                                                                                                         
      , SOURCE.[Short Name]
                                                                                                                                                                                                                                  
      , SOURCE.[Badge Number]
                                                                                                                                                                                                                                
      , SOURCE.[Hire Date]
                                                                                                                                                                                                                                   
      , SOURCE.[Birth Date]
                                                                                                                                                                                                                                  
      , SOURCE.[Seniority Date]
                                                                                                                                                                                                                              
      , SOURCE.[Manager Flag]
                                                                                                                                                                                                                                
      , SOURCE.[Phone 1]
                                                                                                                                                                                                                                     
      , SOURCE.[Phone 2]
                                                                                                                                                                                                                                     
      , SOURCE.[Email]
                                                                                                                                                                                                                                       
      , SOURCE.[Address]
                                                                                                                                                                                                                                     
      , SOURCE.[City]
                                                                                                                                                                                                                                        
      , SOURCE.[State]
                                                                                                                                                                                                                                       
      , SOURCE.[Postal Code]
                                                                                                                                                                                                                                 
      , SOURCE.[Country]
                                                                                                                                                                                                                                     
      , SOURCE.[Time Zone]
                                                                                                                                                                                                                                   
      , SOURCE.[Employment Status]
                                                                                                                                                                                                                           
      , SOURCE.[Employment Status Effective Date]
                                                                                                                                                                                                            
      , SOURCE.[Reports to Manager]
                                                                                                                                                                                                                          
      , SOURCE.[Union Code]
                                                                                                                                                                                                                                  
      , SOURCE.[Employee Type]
                                                                                                                                                                                                                               
      , SOURCE.[Employee Classification]
                                                                                                                                                                                                                     
      , SOURCE.[Pay Frequency]
                                                                                                                                                                                                                               
      , SOURCE.[Worker Type]
                                                                                                                                                                                                                                 
      , SOURCE.[FTE %]
                                                                                                                                                                                                                                       
      , SOURCE.[FTE Standard Hours]
                                                                                                                                                                                                                          
      , SOURCE.[FTE Full Time Hours]
                                                                                                                                                                                                                         
      , SOURCE.[Standard Hours - Daily]
                                                                                                                                                                                                                      
      , SOURCE.[Standard Hours - Weekly]
                                                                                                                                                                                                                     
      , SOURCE.[Standard Hours - Pay Period]
                                                                                                                                                                                                                 
      , SOURCE.[Base Wage Rate]
                                                                                                                                                                                                                              
      , SOURCE.[Base Wage Rate Effective Date]
                                                                                                                                                                                                               
      , SOURCE.[User Account Name]
                                                                                                                                                                                                                           
      , SOURCE.[User Account Status]
                                                                                                                                                                                                                         
      , SOURCE.[User Password]
                                                                                                                                                                                                                               
      , SOURCE.[Home Business Structure Level 1 - Organization]
                                                                                                                                                                                              
      , SOURCE.[Home Business Structure Level 2 - Entity]
                                                                                                                                                                                                    
      , SOURCE.[Home Business Structure Level 3 - Service Line]
                                                                                                                                                                                              
      , SOURCE.[Home Business Structure Level 4 - Financial Unit]
                                                                                                                                                                                            
      , SOURCE.[Home Business Structure Level 5 - Fund Group]
                                                                                                                                                                                                
      , SOURCE.[Home Business Structure Level 6]
                                                                                                                                                                                                             
      , SOURCE.[Home Business Structure Level 7]
                                                                                                                                                                                                             
      , SOURCE.[Home Business Structure Level 8]
                                                                                                                                                                                                             
      , SOURCE.[Home Business Structure Level 9]
                                                                                                                                                                                                             
      , SOURCE.[Home/Primary Job]
                                                                                                                                                                                                                            
      , SOURCE.[Home Labor Category Level 1]
                                                                                                                                                                                                                 
      , SOURCE.[Home Labor Category Level 2]
                                                                                                                                                                                                                 
      , SOURCE.[Home Labor Category Level 3]
                                                                                                                                                                                                                 
      , SOURCE.[Home Labor Category Level 4]
                                                                                                                                                                                                                 
      , SOURCE.[Home Labor Category Level 5]
                                                                                                                                                                                                                 
      , SOURCE.[Home Labor Category Level 6]
                                                                                                                                                                                                                 
      , SOURCE.[Home Job and Labor Category Effective Date]
                                                                                                                                                                                                  
      , SOURCE.[Custom Field 1]
                                                                                                                                                                                                                              
      , SOURCE.[Custom Field 2]
                                                                                                                                                                                                                              
      , SOURCE.[Custom Field 3]
                                                                                                                                                                                                                              
      , SOURCE.[Custom Field 4]
                                                                                                                                                                                                                              
      , SOURCE.[Custom Field 5]
                                                                                                                                                                                                                              
      , SOURCE.[Custom Field 6]
                                                                                                                                                                                                                              
      , SOURCE.[Custom Field 7]
                                                                                                                                                                                                                              
      , SOURCE.[Custom Field 8]
                                                                                                                                                                                                                              
      , SOURCE.[Custom Field 9]
                                                                                                                                                                                                                              
      , SOURCE.[Custom Field 10]
                                                                                                                                                                                                                             
      , SOURCE.[Custom Date 1]
                                                                                                                                                                                                                               
      , SOURCE.[Custom Date 2]
                                                                                                                                                                                                                               
      , SOURCE.[Custom Date 3]
                                                                                                                                                                                                                               
      , SOURCE.[Custom Date 4]
                                                                                                                                                                                                                               
      , SOURCE.[Custom Date 5]
                                                                                                                                                                                                                               
      , SOURCE.[Custom Field 11]
                                                                                                                                                                                                                             
      , SOURCE.[Custom Field 12]
                                                                                                                                                                                                                             
      , SOURCE.[Custom Field 13]
                                                                                                                                                                                                                             
      , SOURCE.[Custom Field 14]
                                                                                                                                                                                                                             
      , SOURCE.[Custom Field 15]
                                                                                                                                                                                                                             
      , SOURCE.[Custom Field 16]
                                                                                                                                                                                                                             
      , SOURCE.[Custom Field 17]
                                                                                                                                                                                                                             
      , SOURCE.[Custom Field 18]
                                                                                                                                                                                                                             
      , SOURCE.[Custom Field 19]
                                                                                                                                                                                                                             
      , SOURCE.[Custom Field 20]
                                                                                                                                                                                                                             
      , SOURCE.[Custom Field 21]
                                                                                                                                                                                                                             
      , SOURCE.[Custom Field 22]
                                                                                                                                                                                                                             
      , SOURCE.[Custom Field 23]
                                                                                                                                                                                                                             
      , SOURCE.[Custom Field 24]
                                                                                                                                                                                                                             
      , SOURCE.[Custom Field 25]
                                                                                                                                                                                                                             
      , SOURCE.[Custom Field 26]
                                                                                                                                                                                                                             
      , SOURCE.[Custom Field 27]
                                                                                                                                                                                                                             
      , SOURCE.[Custom Field 28]
                                                                                                                                                                                                                             
      , SOURCE.[Custom Field 29]
                                                                                                                                                                                                                             
      , SOURCE.[Custom Field 30]
                                                                                                                                                                                                                             
      , SOURCE.[Additional Fields for CRT lookups]
                                                                                                                                                                                                           
);';
                                                                                                                                                                                                                                                         

                                                                                                                                                                                                                                                             
    -- Debug: Print the SQL being executed
                                                                                                                                                                                                                   
    PRINT 'Executing SQL:';
                                                                                                                                                                                                                                  
    PRINT SUBSTRING(@sql, 1, 4000);
                                                                                                                                                                                                                          
    -- Print first 4000 characters
                                                                                                                                                                                                                           
    IF LEN(@sql) > 4000
                                                                                                                                                                                                                                      
        PRINT SUBSTRING(@sql, 4001, 4000);
                                                                                                                                                                                                                   
    -- Print next 4000 characters if needed
                                                                                                                                                                                                                  

                                                                                                                                                                                                                                                             
    -- Execute dynamic SQL with parameter
                                                                                                                                                                                                                    
    EXEC sp_executesql @sql, 
                                                                                                                                                                                                                                
                       N'@p_emplid_param NVARCHAR(20)', 
                                                                                                                                                                                                     
                       @p_emplid_param = @p_emplid;
                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    -- Return row count for confirmation
                                                                                                                                                                                                                     
    DECLARE @rowcount INT = @@ROWCOUNT;
                                                                                                                                                                                                                      
    PRINT 'Rows inserted: ' + CAST(@rowcount AS VARCHAR(10));
                                                                                                                                                                                                

                                                                                                                                                                                                                                                             
END;

-- ===== stage.SP_UKG_EMPLOYEE_DATA_TERMINATED_BUILD =====

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
/***************************************
                                                                                                                                                                                                                     
* Created By: Jim Shih
                                                                                                                                                                                                                                       
* Procedure: dbo.SP_UKG_EMPLOYEE_DATA_TERMINATED_BUILD
                                                                                                                                                                                                       
* Purpose: Creates table [stage].[UKG_EMPLOYEE_DATA_TERMINATED] for terminated employees to upload to UKG
                                                                                                                                                    
* EXEC [stage].[SP_UKG_EMPLOYEE_DATA_TERMINATED_BUILD]
                                                                                                                                                                                                       
* -- 09/15/2025 Jim Shih: Created procedure for terminated employee data
                                                                                                                                                                                     
******************************************/
                                                                                                                                                                                                                  

                                                                                                                                                                                                                                                             
CREATE   PROCEDURE [stage].[SP_UKG_EMPLOYEE_DATA_TERMINATED_BUILD]
                                                                                                                                                                                           
AS
                                                                                                                                                                                                                                                           
BEGIN
                                                                                                                                                                                                                                                        
    SET NOCOUNT ON;
                                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    -- Drop table if exists
                                                                                                                                                                                                                                  
    DROP TABLE IF EXISTS [stage].[UKG_EMPLOYEE_DATA_TERMINATED];
                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
    -- Create terminated employee data table
                                                                                                                                                                                                                 
    SELECT DISTINCT
                                                                                                                                                                                                                                          
        EMPL.DEPTID,
                                                                                                                                                                                                                                         
        empl.VC_CODE,
                                                                                                                                                                                                                                        
        fin.FDM_COMBO_CD,
                                                                                                                                                                                                                                    
        UKG_BS.COMBOCODE,
                                                                                                                                                                                                                                    
        empl.REPORTS_TO,
                                                                                                                                                                                                                                     
        empl.MANAGER_EMPLID,
                                                                                                                                                                                                                                 
        'F' AS NON_UKG_MANAGER_FLAG, -- Terminated employees are not managers
                                                                                                                                                                                
        empl.position_nbr,
                                                                                                                                                                                                                                   
        EMPL.EMPLID,
                                                                                                                                                                                                                                         
        empl.EMPL_RCD,
                                                                                                                                                                                                                                       
        empl.jobcode,
                                                                                                                                                                                                                                        
        empl.POSITION_DESCR,
                                                                                                                                                                                                                                 
        empl.hr_status,
                                                                                                                                                                                                                                      
        0 AS FTE_SUM, -- Terminated employees have 0 FTE
                                                                                                                                                                                                     
        empl.fte,
                                                                                                                                                                                                                                            
        empl.empl_Status,
                                                                                                                                                                                                                                    
        UKG_JC.JobGroup,
                                                                                                                                                                                                                                     
        ukg_bs.FundGroup,
                                                                                                                                                                                                                                    
        ISNULL(EMPL.EMPLID, '') AS 'Person Number',
                                                                                                                                                                                                          
        EMPL.LIVED_FIRST_NAME AS 'First Name',
                                                                                                                                                                                                               
        ISNULL(CAST(EMPL.LAST_NAME AS VARCHAR), '') AS 'Last Name',
                                                                                                                                                                                          
        LEFT(EMPL.LIVED_MIDDLE_NAME,1) AS 'Middle Initial/Name',
                                                                                                                                                                                             
        '' AS 'Short Name',
                                                                                                                                                                                                                                  
        '' AS 'Badge Number',
                                                                                                                                                                                                                                
        ISNULL(CAST(EMPL.HIRE_DT AS VARCHAR), '') AS 'Hire Date',
                                                                                                                                                                                            
        '' AS 'Birth Date',
                                                                                                                                                                                                                                  
        '' AS 'Seniority Date',
                                                                                                                                                                                                                              
        'F' AS 'Manager Flag', -- Terminated employees are not managers
                                                                                                                                                                                      
        COALESCE(REPLACE(PH1.phone, '/', '-'), '') AS 'Phone 1',
                                                                                                                                                                                             
        COALESCE(REPLACE(PH2.phone, '/', '-'), '') AS 'Phone 2',
                                                                                                                                                                                             
        CASE WHEN VC_CODE IN ('VCHSH', 'VCHSS') THEN REPLACE(EMPL.BUSN_EMAIL_ADDR, '@ucsd.edu', '@health.ucsd.edu')
                                                                                                                                          
             ELSE EMPL.BUSN_EMAIL_ADDR END AS 'Email',
                                                                                                                                                                                                       
        '' AS 'Address',
                                                                                                                                                                                                                                     
        '' AS 'City',
                                                                                                                                                                                                                                        
        '' AS 'State',
                                                                                                                                                                                                                                       
        '' AS 'Postal Code',
                                                                                                                                                                                                                                 
        '' AS 'Country',
                                                                                                                                                                                                                                     
        'Pacific' AS 'Time Zone',
                                                                                                                                                                                                                            

                                                                                                                                                                                                                                                             
        ISNULL
                                                                                                                                                                                                                                               
(UKG_ES.empl_Status, '') AS 'Employment Status', -- Replace EMPL.HR_STATUS with EMPL.empl_Status
                                                                                                                                                             
        ISNULL
                                                                                                                                                                                                                                               
(CAST
                                                                                                                                                                                                                                                        
(UKG_ES.EFFDT AS VARCHAR), '')  AS 'Employment Status Effective Date', -- 9/3 Replace EMPL.EFFDT with UKG_ES.EFFDT     
                                                                                                                                      
        '' AS 'Reports to Manager', -- Terminated employees don't report to active managers
                                                                                                                                                                  
        '' AS 'Union Code',
                                                                                                                                                                                                                                  
        '' AS 'Employee Type',
                                                                                                                                                                                                                               
        '' AS 'Employee Classification',
                                                                                                                                                                                                                     
        '' AS 'Pay Frequency',
                                                                                                                                                                                                                               
        'T' AS 'Worker Type', -- Terminated
                                                                                                                                                                                                                  
        '0' AS 'FTE %',
                                                                                                                                                                                                                                      
        '' AS 'FTE Standard Hours',
                                                                                                                                                                                                                          
        '' AS 'FTE Full Time Hours',
                                                                                                                                                                                                                         
        '' AS 'Standard Hours - Daily',
                                                                                                                                                                                                                      
        '' AS 'Standard Hours - Weekly',
                                                                                                                                                                                                                     
        '' AS 'Standard Hours - Pay Period',
                                                                                                                                                                                                                 
        '' AS 'Base Wage Rate',
                                                                                                                                                                                                                              
        '' AS 'Base Wage Rate Effective Date',
                                                                                                                                                                                                               
        EMPL.EMPLID AS 'User Account Name',
                                                                                                                                                                                                                  
        'I' AS 'User Account Status', -- Inactive
                                                                                                                                                                                                            
        '' AS 'User Password',
                                                                                                                                                                                                                               
        '' AS 'Home Business Structure Level 1 - Organization',
                                                                                                                                                                                              
        '' AS 'Home Business Structure Level 2 - Entity',
                                                                                                                                                                                                    
        '' AS 'Home Business Structure Level 3 - Service Line',
                                                                                                                                                                                              
        '' AS 'Home Business Structure Level 4 - Financial Unit',
                                                                                                                                                                                            
        '' AS 'Home Business Structure Level 5 - Fund Group',
                                                                                                                                                                                                
        '' AS 'Home Business Structure Level 6',
                                                                                                                                                                                                             
        '' AS 'Home Business Structure Level 7',
                                                                                                                                                                                                             
        '' AS 'Home Business Structure Level 8',
                                                                                                                                                                                                             
        '' AS 'Home Business Structure Level 9',
                                                                                                                                                                                                             
        '' AS 'Home/Primary Job',
                                                                                                                                                                                                                            
        '' AS 'Home Labor Category Level 1',
                                                                                                                                                                                                                 
        '' AS 'Home Labor Category Level 2',
                                                                                                                                                                                                                 
        '' AS 'Home Labor Category Level 3',
                                                                                                                                                                                                                 
        '' AS 'Home Labor Category Level 4',
                                                                                                                                                                                                                 
        '' AS 'Home Labor Category Level 5',
                                                                                                                                                                                                                 
        '' AS 'Home Labor Category Level 6',
                                                                                                                                                                                                                 
        '' AS 'Home Job and Labor Category Effective Date',
                                                                                                                                                                                                  
        '' AS 'Custom Field 1',
                                                                                                                                                                                                                              
        '' AS 'Custom Field 2',
                                                                                                                                                                                                                              
        '' AS 'Custom Field 3',
                                                                                                                                                                                                                              
        '' AS 'Custom Field 4',
                                                                                                                                                                                                                              
        '' AS 'Custom Field 5',
                                                                                                                                                                                                                              
        '' AS 'Custom Field 6',
                                                                                                                                                                                                                              
        '' AS 'Custom Field 7',
                                                                                                                                                                                                                              
        '' AS 'Custom Field 8',
                                                                                                                                                                                                                              
        '' AS 'Custom Field 9',
                                                                                                                                                                                                                              
        '' AS 'Custom Field 10',
                                                                                                                                                                                                                             
        '' AS 'Custom Date 1',
                                                                                                                                                                                                                               
        '' AS 'Custom Date 2',
                                                                                                                                                                                                                               
        '' AS 'Custom Date 3',
                                                                                                                                                                                                                               
        ISNULL
                                                                                                                                                                                                                                               
(CAST
                                                                                                                                                                                                                                                        
(UKG_HS.EFFDT AS VARCHAR), '')  AS 'Custom Date 4', -- 9/3/2025  Replace EMPL.EFFDT with UKG_HS.EFFDT
                                                                                                                                                        
        '' AS 'Custom Date 5',
                                                                                                                                                                                                                               
        '' AS 'Custom Field 11',
                                                                                                                                                                                                                             
        '' AS 'Custom Field 12',
                                                                                                                                                                                                                             
        '' AS 'Custom Field 13',
                                                                                                                                                                                                                             
        '' AS 'Custom Field 14',
                                                                                                                                                                                                                             
        '' AS 'Custom Field 15',
                                                                                                                                                                                                                             
        '' AS 'Custom Field 16',
                                                                                                                                                                                                                             
        '' AS 'Custom Field 17',
                                                                                                                                                                                                                             
        '' AS 'Custom Field 18',
                                                                                                                                                                                                                             
        '' AS 'Custom Field 19',
                                                                                                                                                                                                                             
        '' AS 'Custom Field 20',
                                                                                                                                                                                                                             
        '' AS 'Custom Field 21',
                                                                                                                                                                                                                             
        '' AS 'Custom Field 22',
                                                                                                                                                                                                                             
        '' AS 'Custom Field 23',
                                                                                                                                                                                                                             
        '' AS 'Custom Field 24',
                                                                                                                                                                                                                             
        '' AS 'Custom Field 25',
                                                                                                                                                                                                                             
        '' AS 'Custom Field 26',
                                                                                                                                                                                                                             
        '' AS 'Custom Field 27',
                                                                                                                                                                                                                             
        '' AS 'Custom Field 28',
                                                                                                                                                                                                                             
        '' AS 'Custom Field 29',
                                                                                                                                                                                                                             
        '' AS 'Custom Field 30',
                                                                                                                                                                                                                             
        '' AS 'Additional Fields for CRT lookups',
                                                                                                                                                                                                           
        empl.termination_dt
                                                                                                                                                                                                                                  
    INTO [stage].[UKG_EMPLOYEE_DATA_TERMINATED]
                                                                                                                                                                                                              
    FROM health_ods.[health_ods].[RPT].CURRENT_EMPL_DATA EMPL
                                                                                                                                                                                                
        LEFT OUTER JOIN health_ods.[health_ods].[stable].PS_PERSONAL_PHONE PH1
                                                                                                                                                                               
        ON PH1.EMPLID = EMPL.EMPLID
                                                                                                                                                                                                                          
            AND PH1.DML_IND <> 'D'
                                                                                                                                                                                                                           
            AND PH1.PHONE_TYPE IN ('CEL2')
                                                                                                                                                                                                                   
        LEFT OUTER JOIN health_ods.[health_ods].[stable].PS_PERSONAL_PHONE PH2
                                                                                                                                                                               
        ON PH2.EMPLID = EMPL.EMPLID
                                                                                                                                                                                                                          
            AND PH2.DML_IND <> 'D'
                                                                                                                                                                                                                           
            AND PH2.PHONE_TYPE IN ('CELL')
                                                                                                                                                                                                                   
        LEFT OUTER JOIN health_ods.[HEALTH_ODS].[RPT].[CURRENT_POSITION_PRI_FIN_UNIT] FIN
                                                                                                                                                                    
        ON EMPL.POSITION_NBR = FIN.POSITION_NBR
                                                                                                                                                                                                              
            AND FIN.POSN_SEQ = (SELECT MIN_POSN_SEQ
                                                                                                                                                                                                          
            FROM (
                                                                                                                                                                                                                                           
                SELECT FIN2.POSITION_NBR, MIN(FIN2.POSN_SEQ) AS MIN_POSN_SEQ
                                                                                                                                                                                 
                FROM health_ods.[HEALTH_ODS].[RPT].[CURRENT_POSITION_PRI_FIN_UNIT] FIN2
                                                                                                                                                                      
                GROUP BY FIN2.POSITION_NBR
                                                                                                                                                                                                                   
            ) T
                                                                                                                                                                                                                                              
            WHERE FIN.POSITION_NBR = T.POSITION_NBR)
                                                                                                                                                                                                         
        LEFT OUTER JOIN [hts].[UKG_BusinessStructure] UKG_BS
                                                                                                                                                                                                 
        ON UKG_BS.COMBOCODE = FIN.FDM_COMBO_CD
                                                                                                                                                                                                               
        LEFT OUTER JOIN hts.UKG_JOBCODES UKG_JC
                                                                                                                                                                                                              
        ON UKG_JC.JOBCODE = EMPL.JOBCODE
                                                                                                                                                                                                                     
        LEFT JOIN [stage].[UKG_EMPL_STATUS_LOOKUP] UKG_ES
                                                                                                                                                                                                    
        ON EMPL.emplid = UKG_ES.emplid
                                                                                                                                                                                                                       
        LEFT JOIN [stage].[UKG_HR_STATUS_LOOKUP] UKG_HS
                                                                                                                                                                                                      
        ON EMPL.emplid = UKG_HS.emplid
                                                                                                                                                                                                                       
    WHERE EMPL.HR_STATUS = 'I' -- Only terminated employees
                                                                                                                                                                                                  
        AND CONVERT(DATE, EMPL.EFFDT) >= DATEADD(DAY, -7, GETDATE()) -- Last 7 days
                                                                                                                                                                          
        AND EMPL.PAY_FREQUENCY = 'B'
                                                                                                                                                                                                                         
        AND EMPL.EMPL_TYPE = 'H'
                                                                                                                                                                                                                             
        AND EMPL.JOB_INDICATOR = 'P'
                                                                                                                                                                                                                         
        AND (EMPL.VC_CODE = 'VCHSH' --MED CENTER
                                                                                                                                                                                                             
        OR (EMPL.DEPTID BETWEEN '002000' AND '002999' AND EMPL.DEPTID NOT IN ('002230','002231','002280') )	 -- PHSO
                                                                                                                                         
       )
                                                                                                                                                                                                                                                     
        AND EMPL.EMPLID NOT IN (SELECT emplid
                                                                                                                                                                                                                
        FROM STAGE.CTE_exclude_BYA)
                                                                                                                                                                                                                          
        AND NOT (EMPL.DEPTID IN ('002053','002056','003919') AND EMPL.JOBCODE IN ('000770','000771','000772','000775','000776'));
                                                                                                                            

                                                                                                                                                                                                                                                             
    PRINT 'UKG_EMPLOYEE_DATA_TERMINATED table created successfully';
                                                                                                                                                                                         

                                                                                                                                                                                                                                                             
    -- Show summary
                                                                                                                                                                                                                                          
    SELECT
                                                                                                                                                                                                                                                   
        'Terminated employees processed' as Description,
                                                                                                                                                                                                     
        COUNT(*) as Count
                                                                                                                                                                                                                                    
    FROM [stage].[UKG_EMPLOYEE_DATA_TERMINATED];
                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
END;

-- ===== stage.SP_UKG_EMPLOYEE_DATA_UPDATE_PROB_END_DT =====

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
Create     PROCEDURE [stage].[SP_UKG_EMPLOYEE_DATA_UPDATE_PROB_END_DT]
                                                                                                                                                                                       
AS
                                                                                                                                                                                                                                                           
BEGIN
                                                                                                                                                                                                                                                        
    SET NOCOUNT ON;
                                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
    BEGIN TRY
                                                                                                                                                                                                                                                
        BEGIN TRANSACTION;
                                                                                                                                                                                                                                   

                                                                                                                                                                                                                                                             
        -- Update the [Custom Date 1] 
                                                                                                                                                                                                                       
        UPDATE [dbo].[UKG_EMPLOYEE_DATA]
                                                                                                                                                                                                                     
        SET 
                                                                                                                                                                                                                                                 
            [Custom Date 1] = DATEADD(DAY, 1, lookup.uc_prob_end_dt)
                                                                                                                                                                                         
--            [NOTE] = CONCAT('U, Custom Date 1 has retained prob_end_dt and was updated on ', CONVERT(VARCHAR, GETDATE(), 120))
                                                                                                                             
        FROM [dbo].[UKG_EMPLOYEE_DATA] empl_data
                                                                                                                                                                                                             
        JOIN health_ods.[health_ods].stage.UKG_probation_dt_retain_lookup_V lookup
                                                                                                                                                                           
        ON empl_data.position_nbr = lookup.position_nbr
                                                                                                                                                                                                      
        WHERE empl_data.position_nbr IS NOT NULL
                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
        -- Commit the transaction
                                                                                                                                                                                                                            
        COMMIT TRANSACTION;
                                                                                                                                                                                                                                  

                                                                                                                                                                                                                                                             
    END TRY
                                                                                                                                                                                                                                                  
    BEGIN CATCH
                                                                                                                                                                                                                                              
        -- Rollback the transaction in case of an error
                                                                                                                                                                                                      
        IF @@TRANCOUNT > 0
                                                                                                                                                                                                                                   
            ROLLBACK TRANSACTION;
                                                                                                                                                                                                                            

                                                                                                                                                                                                                                                             
        -- Raise the error
                                                                                                                                                                                                                                   
        THROW;
                                                                                                                                                                                                                                               
    END CATCH;
                                                                                                                                                                                                                                               
END;

-- ===== stage.SP_UKG_GET_INACTIVE_EMPLID_BY_PAYPERIOD =====

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
/*
                                                                                                                                                                                                                                                           
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

                                                                                                                                                                                                                                                             
--  Procedure Name: [stage].[SP_UKG_GET_INACTIVE_EMPLID_BY_PAYPERIOD]
                                                                                                                                                                                        
--  Author:         Jim Shih
                                                                                                                                                                                                                                 
--  Create date:    05/19/2025 -- Please update with the original creation date
                                                                                                                                                                              
--  Description:    This stored procedure identifies employees from health_ods.[health_ods].].stable.PS_JOB who are considered inactive
                                                                                                                      
--                  or not managed under UKG for a specified pay period.
                                                                                                                                                                                     
--                  It achieves this by selecting employees who are:
                                                                                                                                                                                         
--                      1. Not present in [dbo].[UKG_EMPLOYEE_DATA] (specifically, those not having NON_UKG_MANAGER_FLAG != 'T',
                                                                                                                             
--                         meaning it excludes employees considered managed by UKG)._
                                                                                                                                                                        
--                      2. Meet specific departmental criteria (for some datasets):
                                                                                                                                                                          
--                         - Belong to 'VCHSH' (MED CENTER) via health_ods.[HEALTH_ODS].RPT.[DEPARTMENT_HIERARCHY].
                                                                                                                                          
--                         - Or, belong to PHSO departments (DEPTID range '002000'-'002999' with specific exclusions).
                                                                                                                                       
--                      3. Are not part of the ARC MSP POPULATION (specific DEPTID and JOBCODE exclusions for some datasets).
                                                                                                                                
--                      4. Have JOB_INDICATOR = 'P' (for some datasets), DML_IND <> 'D', GP_PAYGROUP = 'BIWEEKLY', and EMPL_TYPE = 'H' (Hourly).
                                                                                                             
--                      5. Meet one of the following EFFDT criteria:
                                                                                                                                                                                         
--                         a. (Dataset1) EFFDT is within the provided @paybeginddt AND @payenddt, using FilteredJobData.
                                                                                                                                     
--                         b. (Dataset2) EFFDT is on or before @paybeginddt and is the latest effective-dated record for active employees (using FilteredJobData),
                                                                                           
--                            EXCLUDING any EMPLID found in Dataset1 AND EXCLUDING any EMPLID found in Dataset3.
                                                                                                                                             
--                         c. (Dataset3) Identifies MAX effective-dated records within the pay period (using NonUKGjobInPayperiod, which itself excludes EMPLIDs from Dataset1)
                                                                              
--                            are used to filter Dataset2. The NOTE in Dataset3 clarifies its role.
                                                                                                                                                          
--                  The target table [stage].[UKG_INACTIVE_EMPLID_BY_PAYPERIOD] is dropped and recreated with each execution.
                                                                                                                                
--                  Additionally, intermediate tables for Dataset1, Dataset2, and Dataset3 are created for validation.
                                                                                                                                       
--                  The results (EMPLID, HR_STATUS, JOB_INDICATOR, TERMINATION_DT, deptid, VC_CODE, EFFDT, EFFSEQ, EMPL_RCD, UPD_BT_DTM, NOTE, LOAD_DTTM)
                                                                                                    
--                  are inserted into the newly created table, with the NOTE column indicating the reason for inclusion.
                                                                                                                                     
--
                                                                                                                                                                                                                                                           
--  Execution Example:
                                                                                                                                                                                                                                       
--  EXEC [stage].[SP_UKG_GET_INACTIVE_EMPLID_BY_PAYPERIOD] @payenddt = '2025-07-5';
                                                                                                                                                                          
--  obsolete EXEC [stage].[SP_UKG_GET_INACTIVE_EMPLID_BY_PAYPERIOD] @paybeginddt = '2025-04-27', @payenddt = '2025-05-10';
                                                                                                                                   

                                                                                                                                                                                                                                                             
--
                                                                                                                                                                                                                                                           
--  Version History:
                                                                                                                                                                                                                                         
--  Date        Author               Description
                                                                                                                                                                                                             
--  ----------- -------------------- --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-
                                                                                                                                                                                                                                                            
--  05/19/2025 Jim Shih             Initial procedure creation.
                                                                                                                                                                                              
--  05/20/2025 Jim Shih             Modified to union records with EFFDT <= @paybeginddt, using a CTE for clarity and adding a NOTE for each dataset._
                                                                                                       
--  05/21/2025 Jim Shih             Restructured the UNION ALL into separate CTEs (Dataset1, Dataset2, Dataset3) for better data manipulation capability,
                                                                                                    
--                                  Dataset2 excludes EMPLIDs from Dataset1 and Dataset3
                                                                                                                                                                     
*-- 7/16/2025 Jim Shih
                                                                                                                                                                                                                                       
*-- migrate from hs-ssisp-v
                                                                                                                                                                                                                                  
*-- @paybeginddt=DATEADD(day, -13, @payenddt)
                                                                                                                                                                                                                
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

                                                                                                                                                                                                                                                             
*/
                                                                                                                                                                                                                                                           
CREATE             PROCEDURE [stage].[SP_UKG_GET_INACTIVE_EMPLID_BY_PAYPERIOD]
                                                                                                                                                                               
--    @paybeginddt DATE,
                                                                                                                                                                                                                                     
    @payenddt DATE
                                                                                                                                                                                                                                           
AS
                                                                                                                                                                                                                                                           
BEGIN
                                                                                                                                                                                                                                                        
    SET NOCOUNT ON;
                                                                                                                                                                                                                                          
DECLARE @paybeginddt DATE; -- Declare the variable	
                                                                                                                                                                                                          
SET @paybeginddt = DATEADD(day, -13, @payenddt);
                                                                                                                                                                                                             
    -- Drop the main table if it already exists
                                                                                                                                                                                                              
    IF OBJECT_ID('[stage].[UKG_INACTIVE_EMPLID_BY_PAYPERIOD]', 'U') IS NOT NULL
                                                                                                                                                                              
        DROP TABLE [stage].[UKG_INACTIVE_EMPLID_BY_PAYPERIOD];
                                                                                                                                                                                               

                                                                                                                                                                                                                                                             
    -- Drop validation tables if they already exist
                                                                                                                                                                                                          
    IF OBJECT_ID('[stage].[UKG_INACTIVE_EMPLID_BY_PAYPERIOD_Dataset1]', 'U') IS NOT NULL
                                                                                                                                                                     
        DROP TABLE [stage].[UKG_INACTIVE_EMPLID_BY_PAYPERIOD_Dataset1];
                                                                                                                                                                                      
    IF OBJECT_ID('[stage].[UKG_INACTIVE_EMPLID_BY_PAYPERIOD_Dataset2]', 'U') IS NOT NULL
                                                                                                                                                                     
        DROP TABLE [stage].[UKG_INACTIVE_EMPLID_BY_PAYPERIOD_Dataset2];
                                                                                                                                                                                      
    IF OBJECT_ID('[stage].[UKG_INACTIVE_EMPLID_BY_PAYPERIOD_Dataset3]', 'U') IS NOT NULL
                                                                                                                                                                     
        DROP TABLE [stage].[UKG_INACTIVE_EMPLID_BY_PAYPERIOD_Dataset3];
                                                                                                                                                                                      

                                                                                                                                                                                                                                                             
    -- Create Dataset1 validation table
                                                                                                                                                                                                                      
    -- Define CTEs required for Dataset1
                                                                                                                                                                                                                     
    WITH FilteredJobData AS (
                                                                                                                                                                                                                                
        SELECT
                                                                                                                                                                                                                                               
            H.EMPLID,
                                                                                                                                                                                                                                        
            H.HR_STATUS,
                                                                                                                                                                                                                                     
            H.JOB_INDICATOR,
                                                                                                                                                                                                                                 
            H.TERMINATION_DT,
                                                                                                                                                                                                                                
            H.deptid,
                                                                                                                                                                                                                                        
            DT.DESCRSHORT AS DEPT_DESCR, -- Sourced from health_ods.[health_ods].].stable.PS_DEPT_TBL
                                                                                                                                                        
			DT.DESCR AS DEPT_DESCR_FULL,
                                                                                                                                                                                                                              
            V.VC_CODE,
                                                                                                                                                                                                                                       
            H.EFFDT,
                                                                                                                                                                                                                                         
            H.EFFSEQ,
                                                                                                                                                                                                                                        
            H.EMPL_RCD,
                                                                                                                                                                                                                                      
            H.UPD_BT_DTM
                                                                                                                                                                                                                                     
        FROM health_ods.[HEALTH_ODS].stable.PS_JOB H
                                                                                                                                                                                                         
        JOIN health_ods.[HEALTH_ODS].RPT.[DEPARTMENT_HIERARCHY] V
                                                                                                                                                                                            
            ON H.DEPTID = V.DEPTID
                                                                                                                                                                                                                           
        LEFT JOIN health_ods.[HEALTH_ODS].stable.PS_DEPT_TBL DT
                                                                                                                                                                                              
            ON H.SETID_DEPT = DT.SETID
                                                                                                                                                                                                                       
            AND H.DEPTID = DT.DEPTID
                                                                                                                                                                                                                         
            AND DT.DML_IND <> 'D' -- Ensure we don't pick up deleted department rows
                                                                                                                                                                         
            AND DT.EFFDT = (
                                                                                                                                                                                                                                 
                SELECT MAX(DT_SUB.EFFDT)
                                                                                                                                                                                                                     
                FROM health_ods.[HEALTH_ODS].stable.PS_DEPT_TBL DT_SUB
                                                                                                                                                                                       
                WHERE DT_SUB.SETID = DT.SETID
                                                                                                                                                                                                                
                  AND DT_SUB.DEPTID = DT.DEPTID
                                                                                                                                                                                                              
                  AND DT_SUB.EFFDT <= H.EFFDT -- Effective as of the job record's effective date
                                                                                                                                                             
                  AND DT_SUB.DML_IND <> 'D'
                                                                                                                                                                                                                  
            )
                                                                                                                                                                                                                                                
        WHERE
                                                                                                                                                                                                                                                
            NOT EXISTS (
                                                                                                                                                                                                                                     
                SELECT 1
                                                                                                                                                                                                                                     
                FROM [dbo].[UKG_EMPLOYEE_DATA] UED
                                                                                                                                                                                                           
                WHERE UED.EMPLID = H.EMPLID
                                                                                                                                                                                                                  
                  AND UED.NON_UKG_MANAGER_FLAG != 'T' -- or IS DISTINCT FROM 'T' if NULLs are a concern for NON_UKG_MANAGER_FLAG
                                                                                                                             
            )  -- UKG_EMPLOYEE_DATA has most of CURRENT UKG emplid
                                                                                                                                                                                           
            -- Filter for UKG
                                                                                                                                                                                                                                
            AND (V.VC_CODE = 'VCHSH'   	 --MED CENTER
                                                                                                                                                                                                        
                OR (H.DEPTID BETWEEN '002000' AND '002999' AND H.DEPTID NOT IN ('002230','002231','002280') )	 -- PHSO
                                                                                                                                       
                )
                                                                                                                                                                                                                                            
            AND NOT (H.DEPTID IN ('002053','002056','003919') AND H.JOBCODE IN ('000770','000771','000772','000775','000776'))	--exclude ARC MSP POPULATION
                                                                                                  
            AND H.JOB_INDICATOR = 'P'
                                                                                                                                                                                                                        
            AND H.DML_IND <> 'D'
                                                                                                                                                                                                                             
            AND H.GP_PAYGROUP = 'BIWEEKLY'
                                                                                                                                                                                                                   
            AND H.EMPL_TYPE = 'H' -- Biweekly and hourly empl only
                                                                                                                                                                                           
    ),
                                                                                                                                                                                                                                                       
    Dataset1 AS (
                                                                                                                                                                                                                                            
        SELECT
                                                                                                                                                                                                                                               
            FJD.EMPLID,
                                                                                                                                                                                                                                      
            FJD.HR_STATUS,
                                                                                                                                                                                                                                   
            FJD.JOB_INDICATOR,
                                                                                                                                                                                                                               
            FJD.TERMINATION_DT,
                                                                                                                                                                                                                              
            FJD.deptid,
                                                                                                                                                                                                                                      
            FJD.DEPT_DESCR,
                                                                                                                                                                                                                                  
            FJD.DEPT_DESCR_FULL,
                                                                                                                                                                                                                             
            FJD.VC_CODE,
                                                                                                                                                                                                                                     
            FJD.EFFDT,
                                                                                                                                                                                                                                       
            FJD.EFFSEQ,
                                                                                                                                                                                                                                      
            FJD.EMPL_RCD,
                                                                                                                                                                                                                                    
            FJD.UPD_BT_DTM,
                                                                                                                                                                                                                                  
            'UKG EFFDT is in Pay Period' AS NOTE,
                                                                                                                                                                                                            
            GETDATE() AS LOAD_DTTM
                                                                                                                                                                                                                           
        FROM FilteredJobData FJD
                                                                                                                                                                                                                             
        WHERE FJD.EFFDT BETWEEN @paybeginddt AND @payenddt
                                                                                                                                                                                                   
    )
                                                                                                                                                                                                                                                        
    SELECT *
                                                                                                                                                                                                                                                 
    INTO [stage].[UKG_INACTIVE_EMPLID_BY_PAYPERIOD_Dataset1]
                                                                                                                                                                                                 
    FROM Dataset1;
                                                                                                                                                                                                                                           

                                                                                                                                                                                                                                                             
    -- Create Dataset2 validation table
                                                                                                                                                                                                                      
    -- Define CTEs required for Dataset2
                                                                                                                                                                                                                     
    WITH FilteredJobData AS (
                                                                                                                                                                                                                                
        SELECT
                                                                                                                                                                                                                                               
            H.EMPLID,
                                                                                                                                                                                                                                        
            H.HR_STATUS,
                                                                                                                                                                                                                                     
            H.JOB_INDICATOR,
                                                                                                                                                                                                                                 
            H.TERMINATION_DT,
                                                                                                                                                                                                                                
            H.deptid,
                                                                                                                                                                                                                                        
            DT.DESCRSHORT AS DEPT_DESCR, -- Sourced from health_ods.[HEALTH_ODS].stable.PS_DEPT_TBL
                                                                                                                                                          
			DT.DESCR AS DEPT_DESCR_FULL,
                                                                                                                                                                                                                              
            V.VC_CODE,
                                                                                                                                                                                                                                       
            H.EFFDT,
                                                                                                                                                                                                                                         
            H.EFFSEQ,
                                                                                                                                                                                                                                        
            H.EMPL_RCD,
                                                                                                                                                                                                                                      
            H.UPD_BT_DTM
                                                                                                                                                                                                                                     
        FROM health_ods.[HEALTH_ODS].stable.PS_JOB H
                                                                                                                                                                                                         
        JOIN health_ods.[HEALTH_ODS].RPT.[DEPARTMENT_HIERARCHY] V
                                                                                                                                                                                            
            ON H.DEPTID = V.DEPTID
                                                                                                                                                                                                                           
        LEFT JOIN health_ods.[HEALTH_ODS].stable.PS_DEPT_TBL DT
                                                                                                                                                                                              
            ON H.SETID_DEPT = DT.SETID
                                                                                                                                                                                                                       
            AND H.DEPTID = DT.DEPTID
                                                                                                                                                                                                                         
            AND DT.DML_IND <> 'D'
                                                                                                                                                                                                                            
            AND DT.EFFDT = (
                                                                                                                                                                                                                                 
                SELECT MAX(DT_SUB.EFFDT)
                                                                                                                                                                                                                     
                FROM health_ods.[HEALTH_ODS].stable.PS_DEPT_TBL DT_SUB
                                                                                                                                                                                       
                WHERE DT_SUB.SETID = DT.SETID
                                                                                                                                                                                                                
                  AND DT_SUB.DEPTID = DT.DEPTID
                                                                                                                                                                                                              
                  AND DT_SUB.EFFDT <= H.EFFDT
                                                                                                                                                                                                                
                  AND DT_SUB.DML_IND <> 'D'
                                                                                                                                                                                                                  
            )
                                                                                                                                                                                                                                                
        WHERE
                                                                                                                                                                                                                                                
            NOT EXISTS (
                                                                                                                                                                                                                                     
                SELECT 1
                                                                                                                                                                                                                                     
                FROM [dbo].[UKG_EMPLOYEE_DATA] UED
                                                                                                                                                                                                           
                WHERE UED.EMPLID = H.EMPLID
                                                                                                                                                                                                                  
                  AND UED.NON_UKG_MANAGER_FLAG != 'T' -- or IS DISTINCT FROM 'T' if NULLs are a concern for NON_UKG_MANAGER_FLAG
                                                                                                                             
            )  -- UKG_EMPLOYEE_DATA has most of CURRENT UKG emplid
                                                                                                                                                                                           
            -- Filter for UKG
                                                                                                                                                                                                                                
            AND (V.VC_CODE = 'VCHSH'   	 --MED CENTER
                                                                                                                                                                                                        
                OR (H.DEPTID BETWEEN '002000' AND '002999' AND H.DEPTID NOT IN ('002230','002231','002280') )	 -- PHSO
                                                                                                                                       
                )
                                                                                                                                                                                                                                            
            AND NOT (H.DEPTID IN ('002053','002056','003919') AND H.JOBCODE IN ('000770','000771','000772','000775','000776'))	--exclude ARC MSP POPULATION
                                                                                                  
            AND H.JOB_INDICATOR = 'P'
                                                                                                                                                                                                                        
            AND H.DML_IND <> 'D'
                                                                                                                                                                                                                             
            AND H.GP_PAYGROUP = 'BIWEEKLY'
                                                                                                                                                                                                                   
            AND H.EMPL_TYPE = 'H' -- Biweekly and hourly empl only
                                                                                                                                                                                           
    ),
                                                                                                                                                                                                                                                       
    Dataset2 AS (
                                                                                                                                                                                                                                            
        SELECT
                                                                                                                                                                                                                                               
            FJD.EMPLID,
                                                                                                                                                                                                                                      
            FJD.HR_STATUS,
                                                                                                                                                                                                                                   
            FJD.JOB_INDICATOR,
                                                                                                                                                                                                                               
            FJD.TERMINATION_DT,
                                                                                                                                                                                                                              
            FJD.deptid,
                                                                                                                                                                                                                                      
            FJD.DEPT_DESCR,
                                                                                                                                                                                                                                  
            FJD.DEPT_DESCR_FULL,
                                                                                                                                                                                                                             
            FJD.VC_CODE,
                                                                                                                                                                                                                                     
            FJD.EFFDT,
                                                                                                                                                                                                                                       
            FJD.EFFSEQ,
                                                                                                                                                                                                                                      
            FJD.EMPL_RCD,
                                                                                                                                                                                                                                    
            FJD.UPD_BT_DTM,
                                                                                                                                                                                                                                  
            'UKG EFFDT is on or before Pay Period Begin' AS NOTE,
                                                                                                                                                                                            
            GETDATE() AS LOAD_DTTM
                                                                                                                                                                                                                           
        FROM FilteredJobData FJD
                                                                                                                                                                                                                             
        WHERE FJD.EFFDT <= @paybeginddt
                                                                                                                                                                                                                      
        AND FJD.HR_STATUS='A'
                                                                                                                                                                                                                                
        AND FJD.EFFDT =
                                                                                                                                                                                                                                      
            (SELECT MAX(D_ED.EFFDT) FROM health_ods.[HEALTH_ODS].stable.PS_JOB D_ED
                                                                                                                                                                          
              WHERE FJD.EMPLID = D_ED.EMPLID
                                                                                                                                                                                                                 
                AND FJD.EMPL_RCD = D_ED.EMPL_RCD
                                                                                                                                                                                                             
                AND D_ED.EFFDT <= @paybeginddt
                                                                                                                                                                                                               
                AND D_ED.DML_IND <> 'D')
                                                                                                                                                                                                                     
        AND FJD.EFFSEQ =
                                                                                                                                                                                                                                     
            (SELECT MAX(D_ES.EFFSEQ) FROM health_ods.[HEALTH_ODS].stable.PS_JOB D_ES
                                                                                                                                                                         
              WHERE FJD.EMPLID = D_ES.EMPLID
                                                                                                                                                                                                                 
                AND FJD.EMPL_RCD = D_ES.EMPL_RCD
                                                                                                                                                                                                             
                AND FJD.EFFDT = D_ES.EFFDT
                                                                                                                                                                                                                   
                AND D_ES.DML_IND <> 'D')
                                                                                                                                                                                                                     
    )
                                                                                                                                                                                                                                                        
    SELECT *
                                                                                                                                                                                                                                                 
    INTO [stage].[UKG_INACTIVE_EMPLID_BY_PAYPERIOD_Dataset2]
                                                                                                                                                                                                 
    FROM Dataset2;
                                                                                                                                                                                                                                           

                                                                                                                                                                                                                                                             
    -- Create Dataset3 validation table
                                                                                                                                                                                                                      
    -- Define CTEs required for Dataset3
                                                                                                                                                                                                                     
    WITH NonUKGjobInPayperiod AS (
                                                                                                                                                                                                                           
        SELECT
                                                                                                                                                                                                                                               
            H.EMPLID,
                                                                                                                                                                                                                                        
            H.HR_STATUS,
                                                                                                                                                                                                                                     
            H.JOB_INDICATOR,
                                                                                                                                                                                                                                 
            H.TERMINATION_DT,
                                                                                                                                                                                                                                
            H.deptid,
                                                                                                                                                                                                                                        
            DT.DESCRSHORT AS DEPT_DESCR, -- Sourced from health_ods.[HEALTH_ODS].stable.PS_DEPT_TBL
                                                                                                                                                          
			DT.DESCR AS DEPT_DESCR_FULL,
                                                                                                                                                                                                                              
            V.VC_CODE,
                                                                                                                                                                                                                                       
            H.EFFDT,
                                                                                                                                                                                                                                         
            H.EFFSEQ,
                                                                                                                                                                                                                                        
      H.EMPL_RCD,
                                                                                                                                                                                                                                            
            H.UPD_BT_DTM
                                                                                                                                                                                                                                     
        FROM health_ods.[HEALTH_ODS].stable.PS_JOB H
                                                                                                                                                                                                         
        JOIN health_ods.[HEALTH_ODS].RPT.[DEPARTMENT_HIERARCHY] V
                                                                                                                                                                                            
            ON H.DEPTID = V.DEPTID
                                                                                                                                                                                                                           
        LEFT JOIN health_ods.[HEALTH_ODS].stable.PS_DEPT_TBL DT
                                                                                                                                                                                              
            ON H.SETID_DEPT = DT.SETID
                                                                                                                                                                                                                       
            AND H.DEPTID = DT.DEPTID
                                                                                                                                                                                                                         
            AND DT.DML_IND <> 'D'
                                                                                                                                                                                                                            
            AND DT.EFFDT = (
                                                                                                                                                                                                                                 
                SELECT MAX(DT_SUB.EFFDT)
                                                                                                                                                                                                                     
                FROM health_ods.[HEALTH_ODS].stable.PS_DEPT_TBL DT_SUB
                                                                                                                                                                                       
                WHERE DT_SUB.SETID = DT.SETID
                                                                                                                                                                                                                
                  AND DT_SUB.DEPTID = DT.DEPTID
                                                                                                                                                                                                              
                  AND DT_SUB.EFFDT <= H.EFFDT
                                                                                                                                                                                                                
                  AND DT_SUB.DML_IND <> 'D'
                                                                                                                                                                                                                  
            )
                                                                                                                                                                                                                                                
        WHERE
                                                                                                                                                                                                                                                
            NOT EXISTS (
                                                                                                                                                                                                                                     
                SELECT 1
                                                                                                                                                                                                                                     
                FROM [dbo].[UKG_EMPLOYEE_DATA] UED
                                                                                                                                                                                                           
                WHERE UED.EMPLID = H.EMPLID
                                                                                                                                                                                                                  
                  AND UED.NON_UKG_MANAGER_FLAG != 'T' -- or IS DISTINCT FROM 'T' if NULLs are a concern for NON_UKG_MANAGER_FLAG
                                                                                                                             
            )  -- UKG_EMPLOYEE_DATA has most of CURRENT UKG emplid
                                                                                                                                                                                           
            AND NOT EXISTS ( -- Exclude EMPLIDs that are in Dataset1
                                                                                                                                                                                         
                SELECT 1
                                                                                                                                                                                                                                     
                FROM [stage].[UKG_INACTIVE_EMPLID_BY_PAYPERIOD_Dataset1] D1_Table
                                                                                                                                                                            
                WHERE D1_Table.EMPLID = H.EMPLID
                                                                                                                                                                                                             
            )
                                                                                                                                                                                                                                                
            -- The following filters are intentionally broader than FilteredJobData
                                                                                                                                                                          
            AND H.DML_IND <> 'D'
                                                                                                                                                                                                                             
            AND H.GP_PAYGROUP = 'BIWEEKLY'
                                                                                                                                                                                                                   
            AND H.EMPL_TYPE = 'H' -- Biweekly and hourly empl only
                                                                                                                                                                                           
            AND H.EFFDT BETWEEN @paybeginddt AND @payenddt -- Crucial filter for this CTE
                                                                                                                                                                    
    ),
                                                                                                                                                                                                                                                       
    Dataset3 AS (
                                                                                                                                                                                                                                            
        SELECT
                                                                                                                                                                                                                                               
            FJD.EMPLID,
                                                                                                                                                                                                                                      
            FJD.HR_STATUS,
                                                                                                                                                                                                                                   
            FJD.JOB_INDICATOR,
                                                                                                                                                                                                                               
            FJD.TERMINATION_DT,
                                                                                                                                                                                                                              
            FJD.deptid,
                                                                                                                                                                                                                                      
            FJD.DEPT_DESCR,
                                                                                                                                                                                                                                  
            FJD.DEPT_DESCR_FULL,
                                                                                                                                                                                                                             
            FJD.VC_CODE,
                                                                                                                                                                                                                                     
            FJD.EFFDT,
                                                                                                                                                                                                                                       
            FJD.EFFSEQ,
                                                                                                                                                                                                                                      
            FJD.EMPL_RCD,
                                                                                                                                                                                                                                    
            FJD.UPD_BT_DTM,
                                                                                                                                                                                                                                  
            'NON_UKG and MAX-EFFDT is in Pay Period, should be exculded from dataset2' AS NOTE,
                                                                                                                                                              
            GETDATE() AS LOAD_DTTM
                                                                                                                                                                                                                           
        FROM NonUKGjobInPayperiod FJD 
                                                                                                                                                                                                                       
        WHERE FJD.EFFDT BETWEEN @paybeginddt AND @payenddt 
                                                                                                                                                                                                  
 --       AND FJD.HR_STATUS='A' -- Kept commented 
                                                                                                                                                                                                           
        AND FJD.EFFDT =
                                                                                                                                                                                                                                      
            (SELECT MAX(D_ED.EFFDT) FROM health_ods.[HEALTH_ODS].stable.PS_JOB D_ED
                                                                                                                                                                          
              WHERE FJD.EMPLID = D_ED.EMPLID
                                                                                                                                                                                                                 
                AND FJD.EMPL_RCD = D_ED.EMPL_RCD
                                                                                                                                                                                                             
                AND D_ED.EFFDT BETWEEN @paybeginddt AND @payenddt
                                                                                                                                                                                            
                AND D_ED.DML_IND <> 'D')
                                                                                                                                                                                                                     
        AND FJD.EFFSEQ =
                                                                                                                                                                                                                                     
            (SELECT MAX(D_ES.EFFSEQ) FROM health_ods.[HEALTH_ODS].stable.PS_JOB D_ES
                                                                                                                                                                         
              WHERE FJD.EMPLID = D_ES.EMPLID
                                                                                                                                                                                                                 
                AND FJD.EMPL_RCD = D_ES.EMPL_RCD
                                                                                                                                                                                                             
                AND FJD.EFFDT = D_ES.EFFDT
                                                                                                                                                                                                                   
                AND D_ES.DML_IND <> 'D')
                                                                                                                                                                                                                     
    )
                                                                                                                                                                                                                                                        
    SELECT *
                                                                                                                                                                                                                                                 
    INTO [stage].[UKG_INACTIVE_EMPLID_BY_PAYPERIOD_Dataset3]
                                                                                                                                                                                                 
    FROM Dataset3;
                                                                                                                                                                                                                                           

                                                                                                                                                                                                                                                             
    -- Populate the final target table
                                                                                                                                                                                                                       
    SELECT
                                                                                                                                                                                                                                                   
        EMPLID,
                                                                                                                                                                                                                                              
        HR_STATUS,
                                                                                                                                                                                                                                           
        JOB_INDICATOR,
                                                                                                                                                                                                                                       
        TERMINATION_DT,
                                                                                                                                                                                                                                      
        deptid,
                                                                                                                                                                                                                                              
        DEPT_DESCR,
                                                                                                                                                                                                                                          
        DEPT_DESCR_FULL,
                                                                                                                                                                                                                                     
        VC_CODE,
                                                                                                                                                                                                                                             
        EFFDT,
                                                                                                                                                                                                                                               
        EFFSEQ,
                                                                                                                                                                                                                                              
        EMPL_RCD,
                                                                                                                                                                                                                                            
        UPD_BT_DTM,
                                                                                                                                                                                                                                          
        NOTE,
                                                                                                                                                                                                                                                
        LOAD_DTTM
                                                                                                                                                                                                                                            
    INTO [stage].[UKG_INACTIVE_EMPLID_BY_PAYPERIOD]
                                                                                                                                                                                                          
    FROM [stage].[UKG_INACTIVE_EMPLID_BY_PAYPERIOD_Dataset1] -- Use the created table
                                                                                                                                                                        

                                                                                                                                                                                                                                                             
    UNION ALL
                                                                                                                                                                                                                                                

                                                                                                                                                                                                                                                             
    SELECT
                                                                                                                                                                                                                                                   
        D2.EMPLID, 
                                                                                                                                                                                                                                          
        D2.HR_STATUS, 
                                                                                                                                                                                                                                       
        D2.JOB_INDICATOR,
                                                                                                                                                                                                                                    
        D2.TERMINATION_DT, 
                                                                                                                                                                                                                                  
        D2.deptid,
                                                                                                                                                                                                                                           
        D2.DEPT_DESCR,
                                                                                                                                                                                                                                       
        D2.DEPT_DESCR_FULL,
                                                                                                                                                                                                                                  
        D2.VC_CODE, 
                                                                                                                                                                                                                                         
        D2.EFFDT, 
                                                                                                                                                                                                                                           
        D2.EFFSEQ, 
                                                                                                                                                                                                                                          
        D2.EMPL_RCD, 
                                                                                                                                                                                                                                        
        D2.UPD_BT_DTM, 
                                                                                                                                                                                                                                      
        D2.NOTE, 
                                                                                                                                                                                                                                            
        D2.LOAD_DTTM
                                                                                                                                                                                                                                         
    FROM [stage].[UKG_INACTIVE_EMPLID_BY_PAYPERIOD_Dataset2] D2 -- Use the created table
                                                                                                                                                                     
    WHERE NOT EXISTS ( 
                                                                                                                                                                                                                                      
        SELECT 1
                                                                                                                                                                                                                                             
FROM [stage].[UKG_INACTIVE_EMPLID_BY_PAYPERIOD_Dataset3] D3 -- Use the created table
                                                                                                                                                                         
        WHERE D3.EMPLID = D2.EMPLID
                                                                                                                                                                                                                          
    )
                                                                                                                                                                                                                                                        
    AND NOT EXISTS ( 
                                                                                                                                                                                                                                        
        SELECT 1
                                                                                                                                                                                                                                             
        FROM [stage].[UKG_INACTIVE_EMPLID_BY_PAYPERIOD_Dataset1] D1 -- Use the created table
                                                                                                                                                                 
        WHERE D1.EMPLID = D2.EMPLID
                                                                                                                                                                                                                          
    )
                                                                                                                                                                                                                                                        
    ;
                                                                                                                                                                                                                                                        

                                                                                                                                                                                                                                                             
END

-- ===== stage.SP_UKG_HR_STATUS_LOOKUP_BUILD =====

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
/**************************************************************************************************************************************************************************************************************************************************************
*
                                                                                                                                                                                                                                                            
--  Procedure Name: [stage].[SP_UKG_HR_STATUS_LOOKUP_BUILD]
                                                                                                                                                                                                  
--  Author:         Jim Shih
                                                                                                                                                                                                                                 
--  Version:        1.0
                                                                                                                                                                                                                                      
--  Date:           9/6/2025
                                                                                                                                                                                                                                 
--  Description:    This stored procedure identifies the most recent employee HR status change for each employee from stable.ps_job.
                                                                                                                         
--                  Enhanced to prioritize records that occur AFTER the MOST RECENT HR_STATUS change.
                                                                                                                                                        
--                  Uses LAG window function to detect both HR_STATUS and HIRE_DT changes
                                                                                                                                                                    
--                  within each employee's history, ordered by effective date and sequence.
                                                                                                                                                                  
--                  Priority Logic:
                                                                                                                                                                                                                          
--                  1. Records after the MOST RECENT HR_STATUS change (latest HR status adjustment)
                                                                                                                                                          
--                  2. If no HR_STATUS changes exist, use latest HR_STATUS change
                                                                                                                                                                            
--                  3. If no status changes exist, use oldest record as fallback
                                                                                                                                                                             
--                  Filters out deleted records and records with effective dates after the current date.
                                                                                                                                                     
--                  Added logic to ensure effective date is not before hire date for data integrity.
                                                                                                                                                         
--                  Includes HIRE_DT in output for comprehensive employee status tracking.
                                                                                                                                                                   
--  Parameters:     None
                                                                                                                                                                                                                                     
--  Example:        EXEC [stage].[SP_UKG_HR_STATUS_LOOKUP_BUILD];
                                                                                                                                                                                            
--
                                                                                                                                                                                                                                                           
--  Version History:
                                                                                                                                                                                                                                         
--  Date        Author               Description
                                                                                                                                                                                                             
--  9/6/2025   Jim Shih             Initial procedure creation based on SP_UKG_EMPL_STATUS_LOOKUP_BUILD-ver4.sql
                                                                                                                                             
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

                                                                                                                                                                                                                                                             
*/
                                                                                                                                                                                                                                                           

                                                                                                                                                                                                                                                             
CREATE     PROCEDURE [stage].[SP_UKG_HR_STATUS_LOOKUP_BUILD]
                                                                                                                                                                                                 
AS
                                                                                                                                                                                                                                                           
BEGIN
                                                                                                                                                                                                                                                        
    -- Drop table and index if they exist
                                                                                                                                                                                                                    
    IF OBJECT_ID('[stage].[UKG_HR_STATUS_LOOKUP]') IS NOT NULL
                                                                                                                                                                                               
        DROP TABLE [stage].[UKG_HR_STATUS_LOOKUP];
                                                                                                                                                                                                           

                                                                                                                                                                                                                                                             
    -- -- Drop index if it exists (in case table was dropped but index wasn't)
                                                                                                                                                                               
    -- IF EXISTS (SELECT 1
                                                                                                                                                                                                                                   
    -- FROM sys.indexes
                                                                                                                                                                                                                                      
    -- WHERE object_id = OBJECT_ID('[stage].[UKG_HR_STATUS_LOOKUP]') AND name = 'IX_UKG_HR_STATUS_LOOKUP_emplid')
                                                                                                                                            
    --     DROP INDEX IX_UKG_HR_STATUS_LOOKUP_emplid ON [stage].[UKG_HR_STATUS_LOOKUP];
                                                                                                                                                                      

                                                                                                                                                                                                                                                             
    WITH
                                                                                                                                                                                                                                                     
        StatusChanges
                                                                                                                                                                                                                                        
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            SELECT
                                                                                                                                                                                                                                           
                emplid,
                                                                                                                                                                                                                                      
                HR_STATUS,
                                                                                                                                                                                                                                   
                EFFDT,
                                                                                                                                                                                                                                       
                EFFSEQ,
                                                                                                                                                                                                                                      
                EMPL_RCD,
                                                                                                                                                                                                                                    
                HIRE_DT,
                                                                                                                                                                                                                                     
                -- Determine the previous HR_STATUS. If it's the first record for an employee, previous_HR_STATUS will be the current HR_STATUS.
                                                                                                             
                -- Using HR_STATUS as default for LAG ensures previous_HR_STATUS is never NULL if a row exists.
                                                                                                                                              
                LAG(HR_STATUS, 1, HR_STATUS) OVER (PARTITION BY emplid ORDER BY EFFDT ASC, EFFSEQ ASC, EMPL_RCD ASC) AS previous_HR_STATUS,
                                                                                                                  
                -- Track HIRE_DT changes using LAG function
                                                                                                                                                                                                  
                LAG(HIRE_DT) OVER (PARTITION BY emplid ORDER BY EFFDT ASC, EFFSEQ ASC, EMPL_RCD ASC) AS previous_HIRE_DT,
                                                                                                                                    
                -- Rank records for each employee by effective date, oldest first.
                                                                                                                                                                           
                ROW_NUMBER() OVER (PARTITION BY emplid ORDER BY EFFDT ASC, EFFSEQ ASC, EMPL_RCD ASC) AS RowNum_Oldest
                                                                                                                                        
            FROM health_ods.[health_ods].[stable].ps_job
                                                                                                                                                                                                     
            WHERE EFFDT <= GETDATE() -- Consider records up to the current date
                                                                                                                                                                              
                AND DML_IND <> 'D' -- Exclude deleted records
                                                                                                                                                                                                
                AND JOB_INDICATOR='P'
                                                                                                                                                                                                                        
                AND EFFDT >= HIRE_DT
                                                                                                                                                                                                                         
            -- Ensure effective date is not before hire date
                                                                                                                                                                                                 
            -- Primary job indicator
                                                                                                                                                                                                                         
        ),
                                                                                                                                                                                                                                                   
        HRStatusChanges
                                                                                                                                                                                                                                      
 AS
                                                                                                                                                                                                                                                          
        (
                                                                                                                                                                                                                                                    
            -- Identify records where HR_STATUS actually changed compared to the previous chronological record.
                                                                                                                                              
            SELECT
                                                                                                                                                                                                                                           
                emplid,
                                                                                                                                                                                                                                      
                HR_STATUS,
                                                                                                                                                                                                                                   
                EFFDT,
                                                                                                                                                                                                                                       
                EFFSEQ,
                                                                                                                                                                                                                                      
                EMPL_RCD,
                                                                                                                                                                                                                                    
                HIRE_DT,
                                                                                                                                                                                                                                     
                previous_HIRE_DT,
                                                                                                                                                                                                                            
                previous_HR_STATUS,
                                                                                                                                                                                                                          
                -- Rank HR_STATUS change points for each employee, latest change first.
                                                                                                                                                                      
                ROW_NUMBER() OVER (PARTITION BY emplid ORDER BY EFFDT DESC, EFFSEQ DESC, EMPL_RCD DESC) AS hr_status_change_rank
                                                                                                                             
            FROM StatusChanges
                                                                                                                                                                                                                               
            WHERE HR_STATUS <> previous_HR_STATUS AND previous_HR_STATUS IS NOT NULL
                                                                                                                                                                         
            -- This condition defines a "HR_STATUS change event"
                                                                                                                                                                                             
        ),
                                                                                                                                                                                                                                                   
        ActualChangePoints
                                                                                                                                                                                                                                   
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            -- Identify records where HR_STATUS actually changed compared to the previous chronological record.
                                                                                                                                              
            SELECT
                                                                                                                                                                                                                                           
                emplid,
                                                                                                                                                                                                                                      
                HR_STATUS,
                                                                                                                                                                                                                                   
                EFFDT,
                                                                                                                                                                                                                                       
                EFFSEQ,
                                                                                                                                                                                                                                      
                EMPL_RCD,
                                                                                                                                                                                                                                    
                HIRE_DT,
                                                                                                                                                                                                                                     
                previous_HR_STATUS, -- Keep for clarity if needed
                                                                                                                                                                                            
                -- Rank these change points for each employee, latest change first.
                                                                                                                                                                          
                ROW_NUMBER() OVER (PARTITION BY emplid ORDER BY EFFDT DESC, EFFSEQ DESC, EMPL_RCD DESC) AS rn_of_change
                                                                                                                                      
            FROM StatusChanges
                                                                                                                                                                                                                               
            WHERE HR_STATUS <> previous_HR_STATUS
                                                                                                                                                                                                            
            -- This condition defines a "HR status change event"
                                                                                                                                                                                             
        ),
                                                                                                                                                                                                                                                   
        OldestRecordsCTE
                                                                                                                                                                                                                                     
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            -- Dataset 3: Oldest record for each employee (fallback when no changes exist)
                                                                                                                                                                   
            SELECT
                                                                                                                                                                                                                                           
                sc.emplid,
                                                                                                                                                                                                                                   
                sc.HR_STATUS,
                                                                                                                                                                                                                                
                sc.EFFDT,
                                                                                                                                                                                                                                    
                sc.EFFSEQ,
                                                                                                                                                                                                                                   
                sc.EMPL_RCD,
                                                                                                                                                                                                                                 
                sc.HIRE_DT,
                                                                                                                                                                                                                                  
                'Oldest Record' AS NOTE
                                                                                                                                                                                                                      
            FROM StatusChanges sc
                                                                                                                                                                                                                            
            WHERE sc.RowNum_Oldest = 1
                                                                                                                                                                                                                       
        ),
                                                                                                                                                                                                                                                   
        MostRecentHRStatusChangeRecordsCTE
                                                                                                                                                                                                                   
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            -- Dataset 1: Records that occur AFTER the MOST RECENT HR_STATUS change (highest priority)
                                                                                                                                                       
            SELECT
                                                                                                                                                                                                                                           
                hrsc.emplid,
                                                                                                                                                                                                                                 
                hrsc.HR_STATUS,
                                                                                                                                                                                                                              
                hrsc.EFFDT,
                                                                                                                                                                                                                                  
                hrsc.EFFSEQ,
                                                                                                                                                                                                                                 
                hrsc.EMPL_RCD,
                                                                                                                                                                                                                               
                hrsc.HIRE_DT,
                                                                                                                                                                                                                                
                'After Most Recent HR_STATUS Change' AS NOTE
                                                                                                                                                                                                 
            FROM HRStatusChanges hrsc
                                                                                                                                                                                                                        
            WHERE hrsc.hr_status_change_rank = 1
                                                                                                                                                                                                             
        ),
                                                                                                                                                                                                                                                   
        LatestChangeRecordsCTE
                                                                                                                                                                                                                               
        AS
                                                                                                                                                                                                                                                   
        (
                                                                                                                                                                                                                                                    
            -- Dataset 2: Latest HR_STATUS change record for each employee (when no HIRE_DT changes exist)
                                                                                                                                                   
            SELECT
                                                                                                                                                                                                                                           
                acp.emplid,
                                                                                                                                                                                                                                  
                acp.HR_STATUS,
                                                                                                                                                                                                                               
                acp.EFFDT,
                                                                                                                                                                                                                                   
                acp.EFFSEQ,
                                                                                                                                                                                                                                  
                acp.EMPL_RCD,
                                                                                                                                                                                                                                
                acp.HIRE_DT,
                                                                                                                                                                                                                                 
                'Latest HR Status Change' AS NOTE
                                                                                                                                                                                                            
            FROM ActualChangePoints acp
                                                                                                                                                                                                                      
            WHERE acp.rn_of_change = 1
                                                                                                                                                                                                                       
        )
                                                                                                                                                                                                                                                    
    SELECT --top 1000
                                                                                                                                                                                                                                        
        UnionData.emplid,
                                                                                                                                                                                                                                    
        UnionData.HR_STATUS,
                                                                                                                                                                                                                                 
        UnionData.EFFDT,
                                                                                                                                                                                                                                     
        UnionData.EFFSEQ,
                                                                                                                                                                                                                                    
        UnionData.EMPL_RCD,
                                                                                                                                                                                                                                  
        UnionData.HIRE_DT,
                                                                                                                                                                                                                                   
        UnionData.NOTE,
                                                                                                                                                                                                                                      
        GETDATE() AS LOAD_DTTM
                                                                                                                                                                                                                               
    INTO [stage].[UKG_HR_STATUS_LOOKUP]
                                                                                                                                                                                                                      
    FROM (
                                                                                                                                                                                                                                                   
        -- Priority 1: Records after MOST RECENT HR_STATUS change (highest priority)
                                                                                                                                                                         
                                                                                                            SELECT emplid, HR_STATUS, EFFDT, EFFSEQ, EMPL_RCD, HIRE_DT, NOTE
                                                                                 
            FROM MostRecentHRStatusChangeRecordsCTE
                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             
        UNION ALL
                                                                                                                                                                                                                                            

                                                                                                                                                                                                                                                             
            -- Priority 2: Latest HR_STATUS change (when no HR_STATUS changes exist)
                                                                                                                                                                         
            SELECT emplid, HR_STATUS, EFFDT, EFFSEQ, EMPL_RCD, HIRE_DT, NOTE
                                                                                                                                                                                 
            FROM LatestChangeRecordsCTE
                                                                                                                                                                                                                      
            WHERE emplid NOT IN (SELECT EMPLID
                                                                                                                                                                                                               
            FROM MostRecentHRStatusChangeRecordsCTE)
                                                                                                                                                                                                         

                                                                                                                                                                                                                                                             
        UNION ALL
                                                                                                                                                                                                                                            

                                                                                                                                                                                                                                                             
            -- Priority 3: Oldest record (fallback when no changes exist)
                                                                                                                                                                                    
            SELECT emplid, HR_STATUS, EFFDT, EFFSEQ, EMPL_RCD, HIRE_DT, NOTE
                                                                                                                                                                                 
            FROM OldestRecordsCTE
                                                                                                                                                                                                                            
            WHERE emplid NOT IN (SELECT EMPLID
                                                                                                                                                                                                               
                FROM MostRecentHRStatusChangeRecordsCTE)
                                                                                                                                                                                                     
                AND emplid NOT IN (SELECT EMPLID
                                                                                                                                                                                                             
                FROM LatestChangeRecordsCTE)
                                                                                                                                                                                                                 
    ) AS UnionData;
                                                                                                                                                                                                                                          

                                                                                                                                                                                                                                                             

                                                                                                                                                                                                                                                             
    -- Create index on emplid for better performance
                                                                                                                                                                                                         
    CREATE INDEX IX_UKG_HR_STATUS_LOOKUP_emplid ON [stage].[UKG_HR_STATUS_LOOKUP] (emplid);
                                                                                                                                                                  

                                                                                                                                                                                                                                                             
END;


